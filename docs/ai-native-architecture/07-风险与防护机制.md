# 07 - 关键风险与防护机制

> **所属文档**: AI 原生架构升级规划  
> **章节**: 九（风险部分）
> **重要性**: 以下三个风险是架构落地过程中最容易"悄悄炸掉"的地方，必须在设计阶段就建立防护机制。

---

## 风险 1：Agent 变成"超级黑盒"

### 问题描述

意图识别 → 任务规划 → 工具执行 → 结果整合，这个流程在架构上是对的，但如果不刻意设计"规划过程的可见性"，Agent 会变成一个"看起来很聪明，但不可理解"的东西。

### 风险表现

- 用户不知道 AI 为什么选了这个工具
- 用户不知道 AI 接下来要做什么
- 用户无法在执行前修正 AI 的计划
- 从"假交互 Workbench"变成"真执行但黑盒的超级 Agent"

### 🔴 红线约束

> **Agent 的"规划结果"必须是结构化、可展示、可修改的。**

### 具体要求

```
┌─────────────────────────────────────────────────────────────────────┐
│  🧠 AI 正在规划...                                                   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📋 执行计划                                      [可编辑]    │   │
│  │                                                              │   │
│  │  1. 🔍 搜索客户「XX公司」                                    │   │
│  │     理由：需要获取客户ID                                     │   │
│  │                                                              │   │
│  │  2. 📄 调用「合同生成」工具                                   │   │
│  │     理由：用户要求创建合同                                   │   │
│  │     参数：客户ID, 模板=设计合同                              │   │
│  │                                                              │   │
│  │  3. ⚠️ 调用「风险扫描」工具                                   │   │
│  │     理由：自动检查生成的合同                                 │   │
│  │                                                              │   │
│  │  [✏️ 修改计划]  [▶️ 确认执行]  [❌ 取消]                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**必须暴露的信息**：

| 信息 | 说明 |
|------|------|
| **计划步骤列表** | 清晰列出要执行的每一步 |
| **选用的工具清单** | 每一步用什么工具 |
| **每一步的理由** | 简要说明为什么这么做 |
| **关键参数** | 显示将要传入的参数 |

**用户权限**：
- ✅ 可以修改计划顺序
- ✅ 可以删除某个步骤
- ✅ 可以添加步骤
- ✅ 可以修改参数
- ✅ 可以取消整个计划

---

## 风险 2：能力太多反噬体验

### 问题描述

入口统一了、能力清晰了，但如果 AI 的决策逻辑不被限制，用户会从"不知道点哪里"变成"不知道 AI 在干嘛"，造成心理失控感。

### 风险表现

- AI 自动做了很多事，用户感到不安
- 用户不知道 AI 会不会"搞砸"
- 用户不敢让 AI 处理重要任务
- 强 Agent + 强工具 = 强焦虑

### 🔴 红线约束

> **引入"AI 决策透明度分级"，根据任务影响程度决定自动化程度。**

### 分级机制

| 级别 | 任务类型 | AI 行为 | 示例 |
|------|---------|---------|------|
| **L1 - 自动** | 只读/查询/分析 | 直接执行，事后告知 | 搜索客户、查看统计、分析报告 |
| **L2 - 告知** | 小范围修改 | 先说明，再执行 | 更新单个字段、添加备注 |
| **L3 - 确认** | 创建/删除/重要修改 | 必须确认执行计划 | 创建合同、删除客户、批量修改 |
| **L4 - 逐步** | 复杂多步骤流程 | 每一步都需确认 | 合同全流程、批量操作 |

### 交互示例

```
L1（自动执行）：
┌────────────────────────────────────┐
│ 🤖 已搜索到 3 个匹配的客户         │
│    [查看结果]                      │
└────────────────────────────────────┘

L2（先说明再执行）：
┌────────────────────────────────────┐
│ 🤖 我将把联系人电话更新为          │
│    138xxxx1234                     │
│    正在执行...                     │
└────────────────────────────────────┘

L3（必须确认）：
┌────────────────────────────────────┐
│ 🤖 我将为 XX公司 创建一份设计合同  │
│    使用模板：标准设计合同          │
│    预计金额：50,000 元             │
│                                    │
│    [确认创建] [修改参数] [取消]    │
└────────────────────────────────────┘

L4（逐步确认）：
┌────────────────────────────────────┐
│ 🤖 合同全流程（共4步）             │
│    ✅ 步骤1: 选择客户 - 已完成     │
│    ▶️ 步骤2: 生成合同 - 待确认     │
│    ⏸️ 步骤3: 风险扫描              │
│    ⏸️ 步骤4: 发送审批              │
│                                    │
│    [继续步骤2] [跳过] [终止流程]   │
└────────────────────────────────────┘
```

**用户可配置**：
- 用户可以调整自己的分级偏好（更激进 / 更保守）
- 某些工具可以被用户标记为"总是确认"
- 历史上出过问题的操作，自动提升确认级别

---

## 风险 3：IDE 化形似神不似

### 问题描述

IDE 化真正的难点不在布局（命令面板、快捷键、工具栏），而在于"Everything is a Command"。如果底层操作依然是页面事件触发，IDE 化会是形似神不似。

### 风险表现

- AI 调用的是一套逻辑
- 人在画布点的是另一套逻辑
- "人机双轨等价"被破坏
- 出现"AI 能做但人做不了"或"人能做但 AI 做不了"的情况

### 🔴 红线约束

> **任何画布上的操作，背后都必须是 Command。人和 AI 共享同一套命令层。**

### 架构要求

```
                    ┌─────────────────┐
                    │   Command Layer │
                    │   (统一命令层)   │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
        ┌─────────┐   ┌─────────┐   ┌─────────┐
        │ AI 调用  │   │ UI 点击  │   │ 快捷键   │
        └─────────┘   └─────────┘   └─────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  Tool Executor  │
                    │   (工具执行器)   │
                    └─────────────────┘
```

### 具体要求

| 约束 | 说明 |
|------|------|
| **统一命令定义** | 每个操作都有唯一的 Command 定义 |
| **三种触发方式** | 同一 Command 可被 AI / UI / 快捷键触发 |
| **参数一致** | 无论谁触发，参数格式完全一致 |
| **结果一致** | 无论谁触发，执行结果完全相同 |
| **可追溯** | 所有执行都记录到统一的操作日志 |

### 命令定义示例

```typescript
// 每个操作都是一个 Command
interface Command {
  id: string;                    // 唯一标识，如 'client.create'
  name: string;                  // 显示名称
  description: string;           // 功能描述
  params: ParamSchema;           // 参数定义
  execute: (params) => Promise;  // 执行函数
  canUndo: boolean;              // 是否可撤销
  level: 'L1' | 'L2' | 'L3' | 'L4';  // 决策级别
}

// 三种触发方式，调用同一个 Command
// 1. AI 调用
await executeCommand('client.create', { name: 'XX公司', ... });

// 2. UI 按钮点击
<Button onClick={() => executeCommand('client.create', formData)} />

// 3. 快捷键
registerShortcut('Ctrl+Shift+C', () => openCommandDialog('client.create'));
```

### 验证标准

- ✅ 画布上的每个按钮，都能找到对应的 Command
- ✅ AI 执行的每个操作，人都能通过画布完成
- ✅ 操作日志不区分"AI操作"和"人工操作"
- ✅ 快捷键列表 = 命令列表 = AI 工具列表

---

## 下一步

- [08-核心原则与红线](./08-核心原则与红线.md) - 了解完整的核心原则和架构红线
- [09-架构审计与改进方案](./09-架构审计与改进方案.md) - 了解架构审计和改进方案

