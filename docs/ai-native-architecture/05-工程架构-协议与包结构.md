# 05 - å·¥ç¨‹æ¶æ„ï¼šåè®®ä¸åŒ…ç»“æ„

> **æ‰€å±æ–‡æ¡£**: AI åŸç”Ÿæ¶æ„å‡çº§è§„åˆ’  
> **ç« èŠ‚**: å…«
> **æ ¸å¿ƒè®¤çŸ¥**: åŒ…ä¸æ˜¯ç›®çš„ï¼Œåè®®æ‰æ˜¯ç›®çš„ã€‚ç¢ç‰‡åŒ–ä¸æ˜¯è¶Šç¢è¶Šå¥½ï¼Œè€Œæ˜¯"å¯ç¼–æ’ç²’åº¦"æœ€å°åŒ–ã€‚

---

## å…«ã€å·¥ç¨‹æ¶æ„ï¼šåè®®ä¸åŒ…ç»“æ„

### 8.1 ä¸¤ä¸ªæ ¸å¿ƒåè®®

è¦è®© AI çœŸæ­£èƒ½"éšæ—¶éšåœ°è°ƒç”¨ä¸€åˆ‡èµ„æº"ï¼Œå¿…é¡»å…ˆå®šä¹‰ä¸¤ä¸ªåè®®ï¼š

| åè®® | èŒè´£ | å…³é”®çº¦æŸ |
|------|------|---------|
| **Tool Protocol** | AI å¦‚ä½•è°ƒç”¨åç«¯èƒ½åŠ› | å•ä¸€èŒè´£ã€æ˜ç¡® schemaã€å¯å¹‚ç­‰ã€å¯å®¡è®¡ |
| **UI Protocol** | AI å¦‚ä½•è¯·æ±‚æ¸²æŸ“äº¤äº’ç»„ä»¶ | ç»“æ„åŒ– specã€äº‹ä»¶å›ä¼ ã€ä¸è¾“å‡º JSX |

æ²¡æœ‰åè®®ï¼ŒåšåŒ…åªä¼šå˜æˆ"æ¨¡å—åŒ–çš„ä»£ç ä»“åº“"ï¼ŒAI ä»ç„¶æ— æ³•ç¨³å®šæ“ä½œã€‚

---

### 8.2 Backend å·¥å…·åŒ…ç»“æ„

**æ­£ç¡®å•ä½**ï¼šToolï¼ˆå¯å®¡è®¡ã€å¯å¹‚ç­‰ã€å¯å›æ”¾ï¼‰

æ¯ä¸ªå·¥å…·å¿…é¡»æ»¡è¶³ï¼š
- âœ… å•ä¸€èŒè´£
- âœ… æ˜ç¡®è¾“å…¥/è¾“å‡º schemaï¼ˆZodï¼‰
- âœ… å¹‚ç­‰æˆ–å…·å¤‡ requestId
- âœ… æœ‰æƒé™è¾¹ç•Œä¸å®¡è®¡æ—¥å¿—
- âœ… å¯åœ¨æ—  UI æƒ…å†µä¸‹å®Œæ•´æ‰§è¡Œ

**åŒ…ç»“æ„**ï¼š

```
packages/ai-tools/
  src/
    tools/
      contract/
        parse.tool.ts           // è§£æåˆåŒ
        risk_scan.tool.ts       // é£é™©æ‰«æ
        propose_patch.tool.ts   // ç”Ÿæˆä¿®è®¢å»ºè®®
        apply_patch.tool.ts     // åº”ç”¨ä¿®è®¢
        generate.tool.ts        // ç”ŸæˆåˆåŒ
      crm/
        create_client.tool.ts   // åˆ›å»ºå®¢æˆ·
        search_client.tool.ts   // æœç´¢å®¢æˆ·
        link_contact.tool.ts    // å…³è”è”ç³»äºº
      quote/
        create_quote.tool.ts    // åˆ›å»ºæŠ¥ä»·
        calculate.tool.ts       // è®¡ç®—ä»·æ ¼
      files/
        upload.tool.ts          // ä¸Šä¼ æ–‡ä»¶
        extract_text.tool.ts    // æå–æ–‡æœ¬
    registry.ts                 // å·¥å…·æ³¨å†Œè¡¨ + å…ƒæ•°æ®
    schemas/                    // Zod schema å®šä¹‰
    policy/                     // æƒé™ã€é™æµ
    audit/                      // å®¡è®¡æ—¥å¿—
```

**Tool è¿”å›å€¼è§„èŒƒ**ï¼š

```typescript
interface ToolResult<T> {
  success: boolean;
  data?: T;
  
  // å¯ç»§ç»­ç¼–æ’çš„æœ€å°çŠ¶æ€
  artifacts?: {
    id: string;
    type: string;
    // ç»“æ„åŒ–äº§ç‰©ï¼Œå¦‚ contractId, clientId
  };
  
  // å¯é€‰ï¼šä¸‹ä¸€æ­¥å»ºè®®
  nextHints?: string[];
  
  // å¯é€‰ï¼šæ¨èå±•ç¤ºçš„ UI ç»„ä»¶
  uiSuggestion?: {
    componentId: string;
    props: Record<string, any>;
  };
  
  error?: {
    code: string;
    message: string;
  };
}
```

---

### 8.3 Frontend äº¤äº’åŸè¯­åŒ…ç»“æ„

**æ ¸å¿ƒè®¤çŸ¥**ï¼šä¸æ˜¯"ç»„ä»¶åº“"ï¼Œæ˜¯"äº¤äº’åŸè¯­ç³»ç»Ÿ"ã€‚AI ä¸ç”Ÿæˆç»„ä»¶ï¼ŒAI åªé€‰æ‹©å¹¶é©±åŠ¨å·²å®ç°çš„ç»„ä»¶ã€‚

**åŒ…ç»“æ„**ï¼š

```
packages/ai-ui/
  src/
    components/
      AiForm.tsx              // schema é©±åŠ¨çš„è¡¨å•
      AiPicker.tsx            // å•é€‰/å¤šé€‰/æšä¸¾é€‰æ‹©
      AiList.tsx              // åˆ—è¡¨ + è¿‡æ»¤ + é€‰ä¸­
      AiDetails.tsx           // è¯¦æƒ…å±•ç¤ºï¼ˆç»“æ„åŒ–å­—æ®µï¼‰
      AiModalConfirm.tsx      // ç¡®è®¤/è­¦å‘Š/å¼ºåˆ¶ç¡®è®¤
      AiReviewPanel.tsx       // å¯¹æ¯”/å‹¾é€‰/å®¡æ‰¹
      AiStepper.tsx           // çŠ¶æ€æœºè¿›åº¦ï¼ˆçœŸå®çŠ¶æ€ï¼‰
      AiConsole.tsx           // è¿‡ç¨‹æ—¥å¿—/äº‹ä»¶æµ
    host/
      AIInteractionHost.tsx   // ç»Ÿä¸€ç»„ä»¶å®¿ä¸»
      ComponentRegistry.ts    // ç»„ä»¶æ³¨å†Œè¡¨
    renderer/
      renderFromSpec.tsx      // UI Spec -> React
    schemas/
      ui-spec.schema.ts       // UI Spec schema
      events.schema.ts        // äº‹ä»¶ schema
```

**8 ä¸ªäº¤äº’åŸè¯­ç»„ä»¶**ï¼ˆè¦†ç›– 80% åœºæ™¯ï¼‰ï¼š

| ç»„ä»¶ | èŒè´£ | å…¸å‹åœºæ™¯ |
|------|------|---------|
| **AiForm** | è¡¥å……ä¿¡æ¯/åˆ›å»º/ç¼–è¾‘ | åˆ›å»ºå®¢æˆ·ã€ç¼–è¾‘åˆåŒ |
| **AiPicker** | å•é€‰/å¤šé€‰/æšä¸¾ | é€‰æ‹©æ¨¡æ¿ã€é€‰æ‹©æœåŠ¡ |
| **AiList** | åˆ—è¡¨+è¿‡æ»¤+é€‰ä¸­ | æœç´¢å®¢æˆ·ã€é€‰æ‹©åˆåŒ |
| **AiDetails** | è¯¦æƒ…å±•ç¤º | å®¢æˆ·è¯¦æƒ…ã€åˆåŒæ‘˜è¦ |
| **AiModalConfirm** | ç¡®è®¤/è­¦å‘Š | åˆ é™¤ç¡®è®¤ã€é‡è¦æ“ä½œç¡®è®¤ |
| **AiReviewPanel** | å¯¹æ¯”/å‹¾é€‰/å®¡æ‰¹ | é£é™©ä¿®è®¢ã€åˆåŒå¯¹æ¯” |
| **AiStepper** | çŠ¶æ€æœºè¿›åº¦ | å·¥ä½œæµæ­¥éª¤å±•ç¤º |
| **AiConsole** | äº‹ä»¶æµ/æ—¥å¿— | æ‰§è¡Œè¿‡ç¨‹ã€å¯å›æ”¾è®°å½• |

**ç»„ä»¶çº¦æŸï¼ˆç¡¬è§„åˆ™ï¼‰**ï¼š

- âœ… ä¸¥æ ¼ shadcn/uiï¼ˆä¸é­”æ”¹ï¼Œä¸å¼•ç¬¬äºŒå¥—ï¼‰
- âœ… ä¸ä½¿ç”¨ emoji
- âœ… è¾“å…¥æ˜¯ schemaï¼ˆpropsï¼‰
- âœ… è¾“å‡ºæ˜¯ schemaï¼ˆeventsï¼‰
- âŒ ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆä¸šåŠ¡é€»è¾‘åœ¨ tools/workflowï¼‰
- âœ… å¯ç”± AI å£°æ˜å¼æ¸²æŸ“

---

### 8.4 UI Protocolï¼šAI å¦‚ä½•è°ƒç”¨ç»„ä»¶

**æ ¸å¿ƒåŸåˆ™**ï¼šAI ä¸è¾“å‡º JSXï¼ŒAI è¾“å‡º UI Spec

**AI è¯·æ±‚æ¸²æŸ“**ï¼š

```json
{
  "ui": {
    "componentId": "AiForm",
    "props": {
      "title": "è¡¥å……åˆåŒåŸºç¡€ä¿¡æ¯",
      "schemaId": "contract.basic",
      "initialValues": { "partyA": "", "partyB": "" }
    }
  }
}
```

**ç”¨æˆ·æ“ä½œåå›ä¼ **ï¼š

```json
{
  "event": {
    "type": "ui.submit",
    "componentId": "AiForm",
    "payload": { "partyA": "XXå…¬å¸", "partyB": "YYå…¬å¸" }
  }
}
```

**äº‹ä»¶ç±»å‹ï¼ˆæœ‰é™é›†åˆï¼‰**ï¼š

| äº‹ä»¶ | è¯´æ˜ |
|------|------|
| `ui.submit` | è¡¨å•æäº¤ |
| `ui.cancel` | å–æ¶ˆæ“ä½œ |
| `ui.select` | é€‰ä¸­é¡¹ç›® |
| `ui.approve` | å®¡æ‰¹é€šè¿‡ |
| `ui.reject` | å®¡æ‰¹æ‹’ç» |
| `ui.update` | å­—æ®µæ›´æ–° |

---

### 8.5 Interaction Orchestratorï¼šäº¤äº’è°ƒåº¦å™¨çš„æœ€ç»ˆè£å†³æƒ

> **ğŸ”´ ä¸å¯è¿åçš„çº¢çº¿**ï¼š
> 
> **AIï¼ˆä»»ä½•è§’è‰²ï¼‰æ°¸è¿œä¸èƒ½ç›´æ¥å†³å®š UI çš„å‘ˆç°æ–¹å¼ï¼Œåªèƒ½æå‡ºè¯·æ±‚ã€‚**

**èŒè´£åˆ†ç¦»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI å†³ç­–æƒå½’å±                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  âŒ é”™è¯¯ï¼šRole ç›´æ¥å†³å®š UI                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   Role   â”‚ â”€â”€â”€â”€ ç›´æ¥æ¸²æŸ“ â”€â”€â”€â†’ â”‚     UI       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                     â”‚
â”‚  âœ… æ­£ç¡®ï¼šRole æå‡ºè¯·æ±‚ â†’ Orchestrator è£å†³ â†’ UI æ¸²æŸ“               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  uiSuggestion  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  å†³å®š  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Role   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ Interaction â”‚ â”€â”€â”€â”€â”€â†’ â”‚    UI    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ Orchestratorâ”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                    â”‚                               â”‚
â”‚                                    â†“                               â”‚
â”‚                            æœ€ç»ˆè£å†³æƒï¼š                             â”‚
â”‚                            â€¢ æ˜¯å¦å‘ˆç°                              â”‚
â”‚                            â€¢ ä»¥ä»€ä¹ˆå½¢å¼å‘ˆç°                         â”‚
â”‚                            â€¢ æ˜¯å¦æ‰“æ–­å½“å‰æ“ä½œ                       â”‚
â”‚                            â€¢ ä½•æ—¶å‘ˆç°                              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Interaction Orchestrator çš„èŒè´£**ï¼š

| èŒè´£ | è¯´æ˜ |
|------|------|
| **æ¥æ”¶è¯·æ±‚** | æ¥æ”¶ Role çš„ uiSuggestion |
| **æ ¡éªŒåˆæ³•æ€§** | æ£€æŸ¥ componentId æ˜¯å¦å­˜åœ¨ã€props æ˜¯å¦åˆè§„ |
| **åˆ¤æ–­ä¼˜å…ˆçº§** | å½“å‰æ˜¯å¦å…è®¸å‘ˆç°ã€æ˜¯å¦éœ€è¦æ’é˜Ÿ |
| **å†³å®šå‘ˆç°æ–¹å¼** | åœ¨ç”»å¸ƒä¸­å‘ˆç° / å¼¹çª— / Toast / å¿½ç•¥ |
| **ç®¡ç†æ‰“æ–­é€»è¾‘** | æ˜¯å¦å…è®¸æ‰“æ–­ç”¨æˆ·å½“å‰æ“ä½œ |
| **äº‹ä»¶è·¯ç”±** | å°†ç”¨æˆ·æ“ä½œäº‹ä»¶è·¯ç”±å›æ­£ç¡®çš„ Role/Workflow |

**ç¡¬çº¦æŸï¼ˆå†™è¿›ä»£ç çš„é˜²æŠ¤ï¼‰**ï¼š

```typescript
// Interaction Orchestrator æ˜¯ UI æ¸²æŸ“çš„å”¯ä¸€å…¥å£
class InteractionOrchestrator {
  // æ¥æ”¶ Role çš„ UI è¯·æ±‚
  requestUI(request: UIRequest): UIDecision {
    // 1. æ ¡éªŒè¯·æ±‚åˆæ³•æ€§
    if (!this.uiRegistry.has(request.componentId)) {
      return { action: 'reject', reason: 'component_not_found' };
    }
    
    // 2. æ ¡éªŒ props
    const validation = this.validateProps(request.componentId, request.props);
    if (!validation.valid) {
      return { action: 'reject', reason: 'invalid_props', errors: validation.errors };
    }
    
    // 3. åˆ¤æ–­æ˜¯å¦å…è®¸å‘ˆç°ï¼ˆå½“å‰çŠ¶æ€ã€ç”¨æˆ·æ“ä½œä¸­ç­‰ï¼‰
    if (this.shouldDefer(request)) {
      return { action: 'defer', reason: 'user_busy' };
    }
    
    // 4. å†³å®šå‘ˆç°æ–¹å¼
    return {
      action: 'render',
      target: this.decideTarget(request),  // canvas | modal | toast
      timing: this.decideTiming(request)   // immediate | afterCurrent | queued
    };
  }
  
  // âŒ ç¦æ­¢ï¼šRole ç›´æ¥è°ƒç”¨ render
  // âœ… å¿…é¡»ï¼šé€šè¿‡ requestUI èµ° Orchestrator
}
```

---

### 8.6 AIInteractionHostï¼šç»Ÿä¸€ç»„ä»¶å®¿ä¸»

**èŒè´£**ï¼šè®©"AI å¯ä»¥éšæ—¶è°ƒç”¨ç»„ä»¶"çš„çœŸæ­£è£…ç½®

```typescript
interface AIInteractionHost {
  // ç»„ä»¶æ³¨å†Œè¡¨
  registry: Map<string, React.ComponentType>;
  
  // æ¸²æŸ“ç»„ä»¶
  render(spec: UISpec): React.ReactNode;
  
  // æ ¡éªŒ propsï¼ˆç”¨ zodï¼‰
  validateProps(componentId: string, props: any): ValidationResult;
  
  // ç»Ÿä¸€äº‹ä»¶å›ä¼ 
  onEvent(handler: (event: UIEvent) => void): void;
  
  // ç»Ÿä¸€çŠ¶æ€ç®¡ç†
  setLoading(loading: boolean): void;
  setError(error: Error | null): void;
  setReadOnly(readOnly: boolean): void;
}
```

**Host çš„ç¡¬çº¦æŸ**ï¼š

| çº¦æŸ | è¯´æ˜ |
|------|------|
| **Registry æ ¡éªŒ** | AI åªèƒ½è¾“å‡ºå·²æ³¨å†Œçš„ componentIdï¼Œå¦åˆ™æ‹’ç»æ¸²æŸ“ |
| **Props æ ¡éªŒ** | æ‰€æœ‰ props å¿…é¡»é€šè¿‡ schema æ ¡éªŒï¼Œå¦åˆ™æ‹’ç»æ¸²æŸ“å¹¶å›ä¼ é”™è¯¯ |
| **äº‹ä»¶é™åˆ¶** | ç»„ä»¶åªèƒ½å‘å‡ºæœ‰é™äº‹ä»¶ç±»å‹ |
| **æ— ä¸šåŠ¡é€»è¾‘** | ç»„ä»¶åªè´Ÿè´£æ”¶é›†è¾“å…¥/å‘ˆç°çŠ¶æ€ |
| **åªè¯» State** | UI åªè¯» stateï¼Œå¼‚æ­¥åŠ¨ä½œå¿…é¡»ç”± tool æ‰§è¡Œ |

---

### 8.7 Workflow çŠ¶æ€æœºè®¾è®¡

**æ ¸å¿ƒè®¤çŸ¥**ï¼šAI ä¸æ˜¯éšä¾¿è°ƒå·¥å…·ï¼Œè€Œæ˜¯åœ¨"å—æ§è½¨é“"å†…ç¼–æ’

æ¯ä¸ª Workflow å®šä¹‰ï¼š

```typescript
interface WorkflowDefinition {
  id: string;
  name: string;
  
  // çŠ¶æ€å®šä¹‰
  states: {
    [stateName: string]: {
      // è¯¥çŠ¶æ€å¯è°ƒç”¨çš„å·¥å…·
      allowedTools: string[];
      
      // è¯¥çŠ¶æ€å¿…é¡»æ”¶é›†çš„è¾“å…¥
      requiredInputs?: string[];
      
      // è¯¥çŠ¶æ€å¯æ¸²æŸ“çš„ UI ç»„ä»¶
      uiSlots: string[];
      
      // çŠ¶æ€è¿ç§»è§„åˆ™
      transitions: {
        [eventType: string]: string;  // äº‹ä»¶ -> ä¸‹ä¸€çŠ¶æ€
      };
    };
  };
  
  initialState: string;
  finalStates: string[];
}
```

**AI åœ¨ Workflow ä¸­çš„èŒè´£**ï¼š

| èŒè´£ | çº¦æŸ |
|------|------|
| é€‰æ‹© Tool | åªèƒ½ä» `allowedTools` ä¸­é€‰ |
| ç”Ÿæˆ UI Spec | åªèƒ½ä» `uiSlots` ä¸­é€‰ç»„ä»¶ |
| æ”¶é›†è¾“å…¥ | å¿…é¡»æ»¡è¶³ `requiredInputs` |
| è§¦å‘è¿ç§» | åªèƒ½é€šè¿‡å®šä¹‰çš„ `transitions` |

**ç¤ºä¾‹ï¼šanalyze_document å·¥ä½œæµ**

```typescript
const analyzeDocumentWorkflow: WorkflowDefinition = {
  id: 'analyze_document',
  name: 'æ–‡æ¡£åˆ†æ',
  
  states: {
    'upload': {
      allowedTools: ['files.upload', 'files.extract_text'],
      uiSlots: ['AiForm'],
      transitions: {
        'file.uploaded': 'analyzing'
      }
    },
    'analyzing': {
      allowedTools: ['contract.parse', 'contract.risk_scan'],
      uiSlots: ['AiStepper', 'AiConsole'],
      transitions: {
        'analysis.complete': 'review'
      }
    },
    'review': {
      allowedTools: ['contract.propose_patch'],
      uiSlots: ['AiReviewPanel', 'AiDetails'],
      transitions: {
        'user.approve': 'applying',
        'user.reject': 'done'
      }
    },
    'applying': {
      allowedTools: ['contract.apply_patch'],
      uiSlots: ['AiModalConfirm', 'AiConsole'],
      transitions: {
        'patch.applied': 'done'
      }
    },
    'done': {
      allowedTools: [],
      uiSlots: ['AiDetails'],
      transitions: {}
    }
  },
  
  initialState: 'upload',
  finalStates: ['done']
};
```

---

### 8.8 å¤šè§’è‰²ç³»ç»Ÿ

> **æ ¸å¿ƒè®¤çŸ¥**ï¼šè§’è‰²æ˜¯"è¡Œä¸ºä¸æƒé™çš„çº¦æŸå™¨"ï¼Œä¸æ˜¯"æ¢ä¸ªæç¤ºè¯çš„çš®è‚¤"ã€‚

#### 8.8.1 è§’è‰²ç³»ç»Ÿåœ¨æ¶æ„ä¸­çš„ä½ç½®

è§’è‰²ç³»ç»Ÿä½œä¸º **Agent å±‚çš„å­ç³»ç»Ÿ**ï¼Œä¸æ”¹å˜ UI ç³»ç»Ÿï¼Œåªæ”¹å˜"è§„åˆ’ä¸å·¥å…·è°ƒç”¨æ–¹å¼"ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Agent Layer                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Role System                             â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚  â”‚ Role Router â”‚  â”‚Role Policiesâ”‚  â”‚Role Context â”‚         â”‚   â”‚
â”‚  â”‚  â”‚ è§’è‰²è·¯ç”±     â”‚  â”‚ æƒé™ç­–ç•¥    â”‚  â”‚ è§’è‰²ä¸Šä¸‹æ–‡  â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚                                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                             â”‚                                       â”‚
â”‚                             â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Intent â†’ Plan â†’ Execute â†’ Review                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 8.8.2 ä¸‰å±‚è§’è‰²è®¾è®¡

**A. é€šç”¨ç³»ç»Ÿè§’è‰²ï¼ˆå…¨å±€å…±ç”¨ï¼‰**

| è§’è‰² | èŒè´£ | å…³é”®çº¦æŸ |
|------|------|---------|
| **Orchestratorï¼ˆè°ƒåº¦å®˜ï¼‰** | è§„åˆ’æ­¥éª¤ã€é€‰æ‹© workflowã€å†³å®šæ˜¯å¦éœ€è¦ UI | ä¸ç›´æ¥æ‰§è¡Œå·¥å…·ï¼Œåªåšè§„åˆ’ |
| **Executorï¼ˆä½œä¸šå‘˜ï¼‰** | æŒ‰æŒ‡ä»¤è°ƒç”¨å·¥å…·ã€ç”Ÿæˆäº§ç‰© | å¿…é¡»æŒ‰ Orchestrator è®¡åˆ’æ‰§è¡Œ |
| **Reviewerï¼ˆè´¨æ£€å®˜ï¼‰** | å®¡æŸ¥äº§ç‰©ï¼Œç»™é€šè¿‡/é©³å›/ä¿®æ”¹æ„è§ | æœ‰å¦å†³æƒï¼Œå¯æ‰“å›é‡åš |

**B. é¢†åŸŸä¸“å®¶è§’è‰²ï¼ˆæŒ‰æ¿å—æŒ‚è½½ï¼‰**

| æ¿å— | ä¸“å®¶è§’è‰² | å…³æ³¨ç‚¹ |
|------|---------|--------|
| **åˆåŒ** | Legal Expertï¼ˆæ³•åŠ¡ä¸“å®¶ï¼‰ | æ¡æ¬¾é£é™©ã€åˆè§„æ€§ã€ä¿®è®¢ç­–ç•¥ |
| **æŠ¥ä»·** | Pricing Analystï¼ˆå®šä»·åˆ†æå¸ˆï¼‰ | ä»·æ ¼ç»“æ„ã€åˆ©æ¶¦ç‡ã€ç«äº‰åŠ› |
| **CRM** | Account Managerï¼ˆå®¢æˆ·ç»ç†ï¼‰ | å®¢æˆ·ç”»åƒã€è·Ÿè¿›ç­–ç•¥ã€å…³ç³»ç»´æŠ¤ |
| **é¡¹ç›®** | PM / Delivery Leadï¼ˆé¡¹ç›®ç»ç†ï¼‰ | è¿›åº¦ã€é£é™©ã€äº¤ä»˜è´¨é‡ |
| **è´¢åŠ¡** | Finance Controllerï¼ˆè´¢åŠ¡ç®¡æ§ï¼‰ | è´¦æœŸã€æ”¶æ¬¾ã€æˆæœ¬æ§åˆ¶ |

**C. å·¥å…·å‹è§’è‰²ï¼ˆå¯é€‰ï¼‰**

| è§’è‰² | èŒè´£ | çº¦æŸ |
|------|------|------|
| **Data Clerkï¼ˆæ•°æ®å‘˜ï¼‰** | æ•°æ®æ¸…æ´—ã€ç»“æ„åŒ–ã€æ ¼å¼è½¬æ¢ | åªå¤„ç†æ•°æ®ï¼Œä¸åšå†³ç­– |
| **Navigatorï¼ˆå¯¼èˆªå‘˜ï¼‰** | é¡µé¢è·³è½¬ã€å®šä½ã€ä¸Šä¸‹æ–‡åˆ‡æ¢ | å— Orchestrator çº¦æŸï¼Œä¸èƒ½éšæ„æ‰“æ–­ |

#### 8.8.3 è§’è‰²ç¡¬çº¦æŸï¼ˆå¿…é¡»éµå®ˆï¼‰

**çº¦æŸ 1ï¼šè§’è‰²å¿…é¡»ç»‘å®š Tool ç™½åå•**

```typescript
interface RoleDefinition {
  id: string;
  name: string;
  
  // å·¥å…·ç™½åå•ï¼šåªèƒ½è°ƒç”¨è¿™äº›å·¥å…·
  allowedTools: string[];
  
  // å·¥å…·é»‘åå•ï¼šç»å¯¹ç¦æ­¢çš„å·¥å…·
  forbiddenTools?: string[];
  
  // éœ€è¦å®¡æ‰¹æ‰èƒ½è°ƒç”¨çš„å·¥å…·
  requiresApproval?: string[];
}

// ç¤ºä¾‹
const legalExpert: RoleDefinition = {
  id: 'legal_expert',
  name: 'æ³•åŠ¡ä¸“å®¶',
  allowedTools: [
    'contract.parse',
    'contract.risk_scan',
    'contract.propose_patch',
    'contract.classify_clause'
  ],
  forbiddenTools: [
    'contract.apply_patch',  // ä¸èƒ½ç›´æ¥åº”ç”¨ä¿®æ”¹
    'contract.delete'        // ä¸èƒ½åˆ é™¤åˆåŒ
  ]
};
```

**çº¦æŸ 2ï¼šè§’è‰²å¿…é¡»ç»‘å®šäº§ç‰©æ ¼å¼ï¼ˆSchemaï¼‰**

```typescript
// ç¤ºä¾‹ï¼šLegal Expert çš„è¾“å‡º schema
const legalExpertOutput = z.object({
  risks: z.array(z.object({
    id: z.string(),
    clauseLocation: z.object({
      section: z.string(),
      paragraph: z.number(),
      lineRange: z.tuple([z.number(), z.number()])
    }),
    riskType: z.enum(['high', 'medium', 'low']),
    description: z.string(),
    suggestedAction: z.enum([
      'modify', 'delete', 'add_clause', 'negotiate', 'accept'
    ]),
    evidence: z.string(),
    patchSuggestion: z.string().optional()
  })),
  
  summary: z.object({
    totalRisks: z.number(),
    highRisks: z.number(),
    overallAssessment: z.string()
  }),
  
  uiSuggestion: z.object({
    componentId: z.string(),
    props: z.record(z.any())
  }).optional()
});
```

**çº¦æŸ 3ï¼šå”¯ä¸€äº‹å®æºå…±äº«**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        State Storeï¼ˆå”¯ä¸€äº‹å®æºï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   artifacts: { contractId, parsedContent, riskReport, patches }    â”‚
â”‚   eventLog: [ event1, event2, ... ]                                â”‚
â”‚   sessionState: { currentStep, decisions, approvals }              â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           â†‘              â†‘              â†‘              â†‘            â”‚
â”‚       è¯»å–/å†™å…¥       åªè¯»            åªè¯»          è¯»å–/å†™å…¥        â”‚
â”‚           â”‚              â”‚              â”‚              â”‚            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚ Orchestratorâ”‚ â”‚Legal Expertâ”‚ â”‚  Executor â”‚ â”‚  Reviewer   â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â”‚   âŒ è§’è‰²ä¸è®¸å„è‡ª"ç¼–æ•…äº‹"ï¼Œå¼•ç”¨çš„æ•°æ®å¿…é¡»æ¥è‡ªåŒä¸€äº‹å®æº              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 8.9 å››å¤§æ ¸å¿ƒæœºåˆ¶

æ²¡æœ‰è¿™å››æ ·ï¼Œ"åŒ…"åªä¼šæˆä¸ºä»£ç ç»„ç»‡æ–¹å¼ï¼Œè€Œä¸æ˜¯ AI æ“ä½œç³»ç»Ÿã€‚

**1. Tool Registryï¼ˆå·¥å…·æ³¨å†Œè¡¨ï¼‰**

```typescript
interface ToolRegistry {
  tools: Map<string, ToolDefinition>;
  getSchema(toolId: string): ZodSchema;
  getPermissions(toolId: string): Permission[];
  getVersion(toolId: string): string;
}
```

**2. UI Registryï¼ˆç»„ä»¶æ³¨å†Œè¡¨ï¼‰**

```typescript
interface UIRegistry {
  components: Map<string, React.ComponentType>;
  getPropsSchema(componentId: string): ZodSchema;
  getEventsSchema(componentId: string): ZodSchema;
}
```

**3. Role Registryï¼ˆè§’è‰²æ³¨å†Œè¡¨ï¼‰**

```typescript
interface RoleRegistry {
  roles: Map<string, RoleDefinition>;
  getRole(roleId: string): RoleDefinition;
  canUseTool(roleId: string, toolId: string): boolean;
  requiresApproval(roleId: string, toolId: string): boolean;
  getOutputSchema(roleId: string): ZodSchema;
  getRolesForModule(moduleId: string): string[];
}
```

**4. State Storeï¼ˆçŠ¶æ€å­˜å‚¨ï¼‰**

```typescript
interface StateStore {
  sessions: Map<string, WorkflowSession>;
  artifacts: Map<string, Artifact>;
  eventLog: EventLog;
  approvals: Map<string, ApprovalRecord>;
  
  getSession(sessionId: string): WorkflowSession;
  saveArtifact(artifact: Artifact): void;
  appendEvent(event: Event): void;
  replay(sessionId: string): Event[];
  
  submitForApproval(item: ApprovalItem): void;
  approve(itemId: string, reviewerId: string): void;
  reject(itemId: string, reviewerId: string, reason: string): void;
}
```

---

### 8.10 å®Œæ•´æ‰§è¡Œé“¾è·¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®Œæ•´æ‰§è¡Œé“¾è·¯                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. Workflow Runtime å†³å®šå½“å‰ state                                 â”‚
â”‚                         â†“                                           â”‚
â”‚  2. AI åœ¨è¯¥ state å†…ï¼š                                              â”‚
â”‚     â”œâ”€ è°ƒç”¨åç«¯ Toolï¼ˆé€šè¿‡ Tool Executorï¼‰                          â”‚
â”‚     â”‚   â†’ é‰´æƒ â†’ é™æµ â†’ æ‰§è¡Œ â†’ å®¡è®¡                                 â”‚
â”‚     â”‚                                                               â”‚
â”‚     â””â”€ è¯·æ±‚ UIï¼ˆè¾“å‡º UI Specï¼‰                                      â”‚
â”‚         â†’ æ ¡éªŒ Spec â†’ æ¸²æŸ“ç»„ä»¶                                      â”‚
â”‚                         â†“                                           â”‚
â”‚  3. UI Host æ¸²æŸ“ç»„ä»¶ï¼Œæ”¶é›†ç”¨æˆ·è¾“å…¥                                  â”‚
â”‚                         â†“                                           â”‚
â”‚  4. ç”¨æˆ·æ“ä½œäº§ç”Ÿ Eventï¼Œå›ä¼ ç»™ Workflow                             â”‚
â”‚                         â†“                                           â”‚
â”‚  5. Workflow æ ¹æ® Event è¿ç§» State                                  â”‚
â”‚                         â†“                                           â”‚
â”‚  6. ç»§ç»­ä¸‹ä¸€è½®ï¼Œç›´åˆ° Final State                                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä¿éšœ**ï¼š
- AI éšæ—¶å¯è°ƒä¸€åˆ‡åç«¯èƒ½åŠ›ï¼ˆToolï¼‰âœ…
- AI éšæ—¶å¯è°ƒä¸€åˆ‡å‰ç«¯äº¤äº’ï¼ˆComponentï¼‰âœ…
- æ‰€æœ‰ä¸œè¥¿éƒ½åœ¨"è½¨é“"é‡Œ âœ…
- ä¸è‡ªç”±å‘æŒ¥ UI âœ…
- ä¸ç ´å shadcn âœ…

---

## ä¸‹ä¸€æ­¥

- [06-MVPéªŒè¯ä¸å®æ–½è·¯çº¿](./06-MVPéªŒè¯ä¸å®æ–½è·¯çº¿.md) - äº†è§£å¦‚ä½•éªŒè¯å’Œå®æ–½
- [07-é£é™©ä¸é˜²æŠ¤æœºåˆ¶](./07-é£é™©ä¸é˜²æŠ¤æœºåˆ¶.md) - äº†è§£é£é™©é˜²æŠ¤è®¾è®¡

