# 09 - 架构审计与改进方案

> **所属文档**: AI 原生架构升级规划  
> **章节**: 十一
> **审计日期**: 2024-12-28  
> **审计角色**: 首席架构师  
> **审计维度**: 战略前瞻性、架构稳定性、技术选型闭环、工程化落地

---

## 11.1 审计总结

### 11.1.1 宏观审计结论

**审计结论：高度一致且极具野心。**

| 维度 | 评价 |
|------|------|
| **战略定位** | dhs-atlas 被定义为"AI 原生的业务操作系统（AI-Native Business OS）"，试图通过底层协议抽象，将 AI 变成系统的一等公民执行者 |
| **设计哲学** | "原则先于能力"和"真实交互"的宪章，通过立法方式限制 AI 的"魔法权力"，解决不可预测性和不可审计性 |
| **核心亮点** | 人机同轨（共享 Tool/Workflow 接口）、架构多租户体验单租户（Phase 0 策略） |

### 11.1.2 四大协议审计结论

**审计结论：协议设计逻辑严密，是系统的灵魂。**

| 协议 | 评价 | 改进建议 |
|------|------|---------|
| **Tool Protocol** | 强制单一职责、明确 Schema (Zod)、幂等性设计是构建可靠 Agent 系统的基石 | ✅ `enterpriseId` 校验必须在 Tool Runner 底层切面强制注入 |
| **UI Protocol** | "AI 不生成 UI"的决策极具洞察力，通过 8 个交互原语约束 AI | ✅ 已实现 |
| **Workflow Protocol** | 状态机抽象使 AI 决策空间被限制在可预期范围内 | ⚠️ 需补充异常分支处理协议 |
| **Event/Artifact Protocol** | 支持完整回放和审计 | ⚠️ 需定义生命周期管理策略 |

### 11.1.3 多租户与部署架构审计结论

**审计结论：隔离模式分级（Shared/D1/D2）设计非常专业。**

| 评价点 | 说明 |
|--------|------|
| **平面分离** | Control Plane / Tenant Plane 划分符合现代 SaaS 架构趋势 |
| **隔离路线图** | Phase 1 (Shared) → Phase 2 (D1) → Phase 3 (D2) 路径清晰 |
| **审计警告** | ⚠️ D1/D2 模式下 AI Gateway 的 Prompt 传输需确保租户级数据脱敏 |

### 11.1.4 领域驱动设计审计结论

**审计结论：9+1 的领域划分科学，边界清晰。**

| 评价点 | 说明 |
|--------|------|
| **领域解耦** | 业务域作为插件接入平台层，禁止跨域直连 |
| **平台域独立** | Platform 作为业务无关的 OS 层，负责租户隔离和 AI 网关 |
| **关键依赖** | `fin` (财务域) 是最终闭环点，建议采用异步核算机制 |

---

## 11.2 风险识别与改进方案

### 11.2.1 风险 1：AI Gateway 性能瓶颈

**问题诊断**：所有 AI 调用均走平台网关，在高并发下可能成为单点故障。

**改进方案：BYOK 分级路由**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    AI Gateway 分级路由方案                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Shared 租户（默认）                                               │
│   ┌─────────────┐                                                  │
│   │   Tenant    │────────► AI Gateway ────────► Model Provider    │
│   │  Instance   │           (Platform)                             │
│   └─────────────┘                                                  │
│                                                                     │
│   Dedicated 租户（D2 模式 + BYOK）                                  │
│   ┌─────────────┐                                                  │
│   │   Tenant    │────┬───► AI Gateway ────────► Platform Model    │
│   │  Instance   │    │      (审计/计量)                            │
│   └─────────────┘    │                                             │
│                      └───► Direct Connect ─────► Customer's Model  │
│                             (BYOK Mode)         (自带 API Key)     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**BYOK 模式约束**：

| 约束 | 说明 |
|------|------|
| **准入条件** | 仅限 D2 级别租户 |
| **法律要求** | 必须签署数据责任豁免协议 |
| **审计要求** | 元数据仍需上报（不含 prompt 内容） |
| **扩展支持** | 支持 BYO Model（自部署模型） |

### 11.2.2 风险 2：Event Log 回放挑战

**问题诊断**：对于跨多个 Tool 和 Workflow 步骤的长会话，Event Log 的存储量将极其庞大，回放时需要从零开始执行所有 Log。

**改进方案：冷热分离 + Snapshot 机制**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Event Log 生命周期管理                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   热存储（Hot Storage）                                             │
│   • 存储位置：PostgreSQL                                           │
│   • 保留周期：最近 7 天                                             │
│   • 访问模式：高频读写、实时查询                                    │
│                                                                     │
│   温存储（Warm Storage）                                            │
│   • 存储位置：对象存储（压缩）                                      │
│   • 保留周期：7 天 - 90 天                                          │
│   • 访问模式：低频读取、批量查询                                    │
│                                                                     │
│   冷存储（Cold Storage）                                            │
│   • 存储位置：归档存储                                              │
│   • 保留周期：根据合规要求（1-7 年）                                │
│   • 数据内容：Snapshot + 增量 Log                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**回放优化**：
- 传统方式：回放 200 个事件
- 优化方式：加载 1 个 Snapshot + 回放 50 个事件
- 性能提升：约 75%

### 11.2.3 风险 3：开发伦理的强制执行

**问题诊断**："全项目禁止 Emoji"和"禁止伪造进度"是高标准，但在团队协作中极易被破坏。

**改进方案：CI/CD 强制检查**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    开发伦理 CI/CD 检查体系                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Pre-commit Hooks                                                  │
│   1. emoji-check      检测 UI 文件中的 Emoji                        │
│   2. event-check      检测 Tool 是否产生真实 Event                  │
│   3. command-check    检测 UI 操作是否有对应 Command                │
│                                                                     │
│   CI Pipeline Checks                                                │
│   1. tool-schema      验证 Tool Input/Output Schema 完整性          │
│   2. ui-registry      验证 UI 组件是否已注册                        │
│   3. workflow-state   验证 Workflow 状态机完整性                    │
│   4. ai-operability   验证功能 AI 可操作性                          │
│                                                                     │
│   PR Review Checklist（自动生成）                                   │
│   [ ] 功能是否 AI 可操作（关掉 UI 后 AI 能否完成）                  │
│   [ ] Tool 是否产生真实 Event                                       │
│   [ ] UI 是否使用已注册原语                                         │
│   [ ] 进度展示是否来自真实 Event Stream                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 11.2.4 风险 4：D1 模式数据库连接池管理

**问题诊断**：在 D1 模式（每租户独立 DB）下，应用层的连接池管理极其复杂。租户量达到一定规模后，应用节点的 DB 连接数会耗尽。

**改进方案：引入 PgBouncer 代理层**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    D1 模式连接池管理方案                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   问题场景：N 个租户 = N 个连接池，当 N > 100 时连接数耗尽          │
│                                                                     │
│   解决方案：引入 PgBouncer 代理层                                   │
│                                                                     │
│   App Node                                                          │
│       │ 单一连接                                                    │
│       ▼                                                             │
│   PgBouncer 代理层                                                  │
│   • 连接池模式：transaction                                         │
│   • 最大服务端连接：每 DB 20                                        │
│   • 最大客户端连接：10000                                           │
│       │           │           │                                     │
│       ▼           ▼           ▼                                     │
│     DB A        DB B        DB C  ...                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 11.3 补充协议：Workflow 异常处理

### 11.3.1 异常状态定义

```typescript
type WorkflowExceptionState = 
  | 'stuck'              // 卡住（等待超时）
  | 'failed'             // 失败（Tool 执行失败）
  | 'needs_human'        // 需要人工介入
  | 'rollback_pending'   // 待回滚
  | 'rollback_failed';   // 回滚失败
```

### 11.3.2 人工求助协议

当 Workflow 卡住或失败时，AI 应主动发起人工求助：
- 明确说明卡住原因
- 展示已尝试的操作
- 提供建议选项
- 设置响应超时

### 11.3.3 自动回滚协议

定义回滚步骤和条件，确保异常状态可恢复。

---

## 11.4 补充协议：租户级数据脱敏

针对 D1/D2 模式下 AI Gateway Prompt 传输的数据脱敏需求：

- 定义脱敏规则（字段名、正则、PII 检测）
- 支持 redact / hash / encrypt / tokenize 方式
- 例外白名单配置
- PII 自动检测

---

## 11.5 审计改进追踪

| 风险项 | 状态 | 改进方案 | 验收标准 |
|--------|------|---------|---------|
| AI Gateway 性能瓶颈 | ✅ 已补充 | BYOK 分级路由 | D2 租户可配置直连模式 |
| Event Log 回放挑战 | ✅ 已补充 | 冷热分离 + Snapshot | 回放性能提升 70%+ |
| 开发伦理强制执行 | ✅ 已补充 | CI/CD Lint 规则 | PR 自动检查通过率 100% |
| D1 连接池管理 | ✅ 已补充 | PgBouncer 代理层 | 支持 1000+ 租户 |
| Workflow 异常处理 | ✅ 已补充 | 人工求助 + 自动回滚协议 | 异常状态可恢复 |
| 租户数据脱敏 | ✅ 已补充 | 脱敏策略 + PII 检测 | D1/D2 模式合规 |
| 财务域异步核算 | 📋 待实施 | 异步核算机制 | fin 域不阻塞上游 |

---

## 下一步

- [10-UIUX进化设计规范](./10-UIUX进化设计规范.md) - 了解 UI/UX 进化设计
- [附录](./附录.md) - 术语定义与参考设计

