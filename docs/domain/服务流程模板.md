# dhs-atlas 服务流程模板（Service Workflow Templates）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 领域架构文档  
> **相关文档**: [服务抽象模型](./服务抽象模型.md) · [服务类型定义](./服务类型定义.md)

---

## 一、核心概念

### 1.1 Workflow Template 的定位

> **Workflow Template 是 AI OS 真正的价值所在。**

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Workflow Template 定位                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   每个 Service 可以绑定一个默认 Workflow Template                    │
│                                                                     │
│   Workflow Template 定义：                                          │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  • 阶段（Phases）          → 服务的执行阶段划分               │   │
│   │  • 可执行工具（Tools）      → 每阶段允许的操作                 │   │
│   │  • 客户参与点（Touchpoints）→ 需要客户确认的节点               │   │
│   │  • 验收点（Checkpoints）    → 阶段性验收条件                  │   │
│   │  • 产物类型（Artifacts）    → 每阶段的交付物类型               │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   AI 不是"即兴发挥"，而是：                                         │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                                                             │   │
│   │     在模板约束下自动推进、生成、提醒、审查                     │   │
│   │                                                             │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 与 Workflow Engine 的关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                 Template vs Instance                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Workflow Template                    Workflow Session             │
│   （模板：定义）                        （实例：执行）               │
│   ┌────────────────────┐              ┌────────────────────┐       │
│   │                    │   创建实例   │                    │       │
│   │  • 阶段定义         │────────────►│  • 当前阶段         │       │
│   │  • 工具白名单       │              │  • 执行状态         │       │
│   │  • 验收条件         │              │  • 产物列表         │       │
│   │  • 产物类型         │              │  • 事件日志         │       │
│   │                    │              │                    │       │
│   └────────────────────┘              └────────────────────┘       │
│                                                                     │
│   一个 Template 可以创建多个 Session（一对多）                       │
│   Session 在 Workflow Engine 中执行                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、Workflow Template 数据模型

### 2.1 核心结构

```typescript
/**
 * 工作流模板
 */
interface WorkflowTemplate {
  id: string;
  enterpriseId: string;          // 平台级模板为 'platform'
  
  // 基础信息
  name: string;
  description: string;
  
  // 适用服务类型
  serviceTypes: ServiceType[];
  
  // 阶段定义
  phases: WorkflowPhaseTemplate[];
  
  // 全局配置
  config: WorkflowTemplateConfig;
  
  // 版本
  version: string;
  
  // 状态
  status: 'draft' | 'active' | 'deprecated';
  
  // 来源
  source: 'platform' | 'enterprise' | 'custom';
  
  createdAt: Date;
  updatedAt: Date;
}

/**
 * 阶段模板
 */
interface WorkflowPhaseTemplate {
  id: string;
  name: string;
  description: string;
  
  // 排序
  order: number;
  
  // 预估时间（天）
  estimatedDays: number;
  
  // 允许的工具
  allowedTools: string[];
  
  // 允许的 UI 组件
  allowedUIComponents: string[];
  
  // 客户参与点
  customerTouchpoints: CustomerTouchpoint[];
  
  // 验收点
  checkpoints: Checkpoint[];
  
  // 产物类型
  artifactTypes: ArtifactTypeSpec[];
  
  // 状态转换规则
  transitions: PhaseTransition[];
  
  // 阶段配置
  config: PhaseConfig;
}

/**
 * 客户参与点
 */
interface CustomerTouchpoint {
  id: string;
  name: string;
  type: 'approval' | 'feedback' | 'confirmation' | 'review';
  description: string;
  required: boolean;
  
  // 触发条件
  triggerCondition?: string;
  
  // 超时配置
  timeoutDays?: number;
  timeoutAction?: 'remind' | 'escalate' | 'auto_proceed';
}

/**
 * 验收点
 */
interface Checkpoint {
  id: string;
  name: string;
  description: string;
  
  // 验收条件
  criteria: CheckpointCriteria[];
  
  // 是否必须
  required: boolean;
  
  // 验收方
  approver: 'customer' | 'internal' | 'auto';
}

interface CheckpointCriteria {
  id: string;
  description: string;
  type: 'artifact_exists' | 'artifact_approved' | 'manual_check' | 'auto_check';
  config?: Record<string, unknown>;
}

/**
 * 产物类型规格
 */
interface ArtifactTypeSpec {
  typeCode: string;              // 如 'design_file', 'document', 'report'
  name: string;
  description: string;
  required: boolean;
  multiple: boolean;             // 是否允许多个
  acceptedFormats?: string[];    // 允许的文件格式
}

/**
 * 阶段转换规则
 */
interface PhaseTransition {
  fromPhase: string;             // 当前阶段 ID
  toPhase: string;               // 目标阶段 ID
  
  // 触发条件
  conditions: TransitionCondition[];
  
  // 自动/手动
  automatic: boolean;
}

interface TransitionCondition {
  type: 'checkpoint_passed' | 'approval_received' | 'artifact_uploaded' | 'manual';
  config?: Record<string, unknown>;
}
```

### 2.2 数据库 Schema

```sql
-- 工作流模板表
CREATE TABLE workflow_template (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  enterprise_id VARCHAR(64) NOT NULL,  -- 'platform' 表示平台级模板
  
  -- 基础信息
  name VARCHAR(256) NOT NULL,
  description TEXT,
  
  -- 适用服务类型
  service_types JSONB NOT NULL DEFAULT '[]',
  
  -- 阶段定义
  phases JSONB NOT NULL DEFAULT '[]',
  
  -- 全局配置
  config JSONB DEFAULT '{}',
  
  -- 版本
  version VARCHAR(32) NOT NULL DEFAULT '1.0.0',
  
  -- 状态
  status VARCHAR(32) NOT NULL DEFAULT 'draft',
  
  -- 来源
  source VARCHAR(32) NOT NULL DEFAULT 'platform',
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_wf_template_enterprise ON workflow_template(enterprise_id);
CREATE INDEX idx_wf_template_status ON workflow_template(status);
CREATE INDEX idx_wf_template_service_types ON workflow_template USING gin(service_types);

-- 工作流实例表
CREATE TABLE workflow_session (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  enterprise_id UUID NOT NULL REFERENCES enterprise(id),
  
  -- 关联
  template_id UUID NOT NULL REFERENCES workflow_template(id),
  service_id UUID REFERENCES service(id),
  project_id UUID REFERENCES project(id),
  
  -- 当前状态
  current_phase_id VARCHAR(64) NOT NULL,
  status VARCHAR(32) NOT NULL DEFAULT 'active',
  
  -- 阶段状态快照
  phase_states JSONB NOT NULL DEFAULT '{}',
  
  -- 上下文数据
  context JSONB DEFAULT '{}',
  
  -- 时间
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMPTZ,
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_wf_session_enterprise ON workflow_session(enterprise_id);
CREATE INDEX idx_wf_session_template ON workflow_session(template_id);
CREATE INDEX idx_wf_session_project ON workflow_session(project_id);
CREATE INDEX idx_wf_session_status ON workflow_session(status);
```

---

## 三、平台级模板库

### 3.1 视觉创意服务模板

```typescript
const visualDesignTemplate: WorkflowTemplate = {
  id: 'wf-visual-design',
  enterpriseId: 'platform',
  
  name: '视觉创意服务流程',
  description: '适用于平面设计、插画、视觉创意类服务的标准工作流程',
  
  serviceTypes: ['creative.visual', 'creative.branding'],
  
  phases: [
    {
      id: 'phase-1-discovery',
      name: '需求调研',
      description: '深入了解客户需求，收集项目背景信息',
      order: 1,
      estimatedDays: 3,
      
      allowedTools: [
        'svc.service.get',
        'crm.customer.get',
        'artifact.create',
        'artifact.list',
        'note.create',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-brief-confirm',
          name: '需求确认',
          type: 'confirmation',
          description: '确认需求调研结论和项目方向',
          required: true,
          timeoutDays: 3,
          timeoutAction: 'remind',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-brief-complete',
          name: '调研完成',
          description: '需求调研报告已完成并获得客户确认',
          criteria: [
            { id: 'c1', description: '调研报告已上传', type: 'artifact_exists', config: { artifactType: 'document' } },
            { id: 'c2', description: '客户已确认', type: 'manual_check' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'document',
          name: '需求调研报告',
          description: '包含项目背景、目标、需求要点的调研文档',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'docx', 'md'],
        },
        {
          typeCode: 'reference',
          name: '参考资料',
          description: '客户提供的参考图片、文档等',
          required: false,
          multiple: true,
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-1-discovery',
          toPhase: 'phase-2-concept',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-brief-complete' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-2-concept',
      name: '概念设计',
      description: '基于需求进行创意探索，输出概念方案',
      order: 2,
      estimatedDays: 5,
      
      allowedTools: [
        'artifact.create',
        'artifact.update',
        'artifact.list',
        'note.create',
        'ai.generate',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiReviewPanel',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-concept-review',
          name: '概念评审',
          type: 'review',
          description: '客户评审概念方案，选择方向',
          required: true,
          timeoutDays: 5,
          timeoutAction: 'escalate',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-concept-approved',
          name: '概念通过',
          description: '客户已选定概念方向',
          criteria: [
            { id: 'c1', description: '概念方案已上传', type: 'artifact_exists', config: { artifactType: 'design_concept' } },
            { id: 'c2', description: '客户已选定方向', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'design_concept',
          name: '概念方案',
          description: '创意概念设计方案（通常 2-3 个方向）',
          required: true,
          multiple: true,
          acceptedFormats: ['pdf', 'png', 'jpg'],
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-2-concept',
          toPhase: 'phase-3-design',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-concept-approved' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-3-design',
      name: '设计执行',
      description: '基于选定方向进行完整设计',
      order: 3,
      estimatedDays: 7,
      
      allowedTools: [
        'artifact.create',
        'artifact.update',
        'artifact.list',
        'note.create',
        'ai.generate',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiReviewPanel',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-design-feedback',
          name: '设计反馈',
          type: 'feedback',
          description: '客户对设计稿提出修改意见',
          required: false,
        },
        {
          id: 'tp-design-approval',
          name: '设计确认',
          type: 'approval',
          description: '客户确认最终设计方案',
          required: true,
          timeoutDays: 5,
          timeoutAction: 'remind',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-design-complete',
          name: '设计完成',
          description: '设计稿已完成并获得客户确认',
          criteria: [
            { id: 'c1', description: '设计稿已上传', type: 'artifact_exists', config: { artifactType: 'design_file' } },
            { id: 'c2', description: '客户已确认', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'design_file',
          name: '设计稿',
          description: '完整的设计文件',
          required: true,
          multiple: true,
          acceptedFormats: ['pdf', 'png', 'jpg', 'psd', 'ai'],
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-3-design',
          toPhase: 'phase-4-delivery',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-design-complete' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-4-delivery',
      name: '交付验收',
      description: '整理并交付最终成果，完成项目验收',
      order: 4,
      estimatedDays: 2,
      
      allowedTools: [
        'artifact.create',
        'artifact.finalize',
        'artifact.list',
        'project.complete',
      ],
      
      allowedUIComponents: [
        'AiList',
        'AiDetails',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-final-acceptance',
          name: '最终验收',
          type: 'approval',
          description: '客户确认项目完成，进行最终验收',
          required: true,
          timeoutDays: 7,
          timeoutAction: 'escalate',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-delivery-complete',
          name: '交付完成',
          description: '所有成果已交付并获得验收',
          criteria: [
            { id: 'c1', description: '源文件已上传', type: 'artifact_exists', config: { artifactType: 'source_file' } },
            { id: 'c2', description: '客户已验收', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'source_file',
          name: '源文件',
          description: '可编辑的设计源文件',
          required: true,
          multiple: true,
          acceptedFormats: ['psd', 'ai', 'sketch', 'figma'],
        },
        {
          typeCode: 'export_file',
          name: '导出文件',
          description: '最终导出的设计文件',
          required: true,
          multiple: true,
          acceptedFormats: ['pdf', 'png', 'jpg', 'svg'],
        },
      ],
      
      transitions: [],  // 最终阶段，无后续转换
      
      config: {},
    },
  ],
  
  config: {
    allowParallelPhases: false,
    requireSequentialCompletion: true,
    autoStartNextPhase: true,
    notifyCustomerOnPhaseChange: true,
  },
  
  version: '1.0.0',
  status: 'active',
  source: 'platform',
  
  createdAt: new Date(),
  updatedAt: new Date(),
};
```

### 3.2 战略咨询服务模板

```typescript
const strategyConsultingTemplate: WorkflowTemplate = {
  id: 'wf-strategy-consulting',
  enterpriseId: 'platform',
  
  name: '战略咨询服务流程',
  description: '适用于战略规划、管理咨询类服务的标准工作流程',
  
  serviceTypes: ['consulting.strategy', 'consulting.management', 'consulting.digital'],
  
  phases: [
    {
      id: 'phase-1-diagnosis',
      name: '诊断评估',
      description: '全面了解企业现状，识别问题与机会',
      order: 1,
      estimatedDays: 14,
      
      allowedTools: [
        'svc.service.get',
        'crm.customer.get',
        'artifact.create',
        'artifact.list',
        'note.create',
        'interview.schedule',
        'survey.create',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiStepper',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-kickoff',
          name: '项目启动会',
          type: 'confirmation',
          description: '确认项目范围、时间表、关键里程碑',
          required: true,
        },
        {
          id: 'tp-interview-schedule',
          name: '访谈安排',
          type: 'confirmation',
          description: '确认访谈对象和时间安排',
          required: true,
        },
        {
          id: 'tp-diagnosis-report',
          name: '诊断报告汇报',
          type: 'review',
          description: '汇报诊断评估结论，获取反馈',
          required: true,
          timeoutDays: 5,
          timeoutAction: 'remind',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-diagnosis-complete',
          name: '诊断完成',
          description: '诊断评估报告已完成并获得认可',
          criteria: [
            { id: 'c1', description: '诊断报告已完成', type: 'artifact_exists', config: { artifactType: 'diagnosis_report' } },
            { id: 'c2', description: '客户已认可结论', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'diagnosis_report',
          name: '诊断评估报告',
          description: '包含现状分析、问题识别、机会发现的综合报告',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'pptx'],
        },
        {
          typeCode: 'interview_record',
          name: '访谈记录',
          description: '高管和关键人员访谈记录',
          required: false,
          multiple: true,
          acceptedFormats: ['docx', 'pdf'],
        },
        {
          typeCode: 'data_analysis',
          name: '数据分析',
          description: '相关数据分析报告',
          required: false,
          multiple: true,
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-1-diagnosis',
          toPhase: 'phase-2-strategy',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-diagnosis-complete' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-2-strategy',
      name: '战略规划',
      description: '制定战略方向、目标体系、实施路径',
      order: 2,
      estimatedDays: 21,
      
      allowedTools: [
        'artifact.create',
        'artifact.update',
        'artifact.list',
        'note.create',
        'ai.analyze',
        'ai.generate',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiReviewPanel',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-strategy-workshop',
          name: '战略研讨会',
          type: 'review',
          description: '与高管团队共同研讨战略方向',
          required: true,
        },
        {
          id: 'tp-strategy-approval',
          name: '战略方案审批',
          type: 'approval',
          description: '高层审批战略规划方案',
          required: true,
          timeoutDays: 7,
          timeoutAction: 'escalate',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-strategy-approved',
          name: '战略通过',
          description: '战略规划方案已获得高层批准',
          criteria: [
            { id: 'c1', description: '战略白皮书已完成', type: 'artifact_exists', config: { artifactType: 'strategy_whitepaper' } },
            { id: 'c2', description: '高层已批准', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'strategy_whitepaper',
          name: '战略白皮书',
          description: '完整的战略规划文档',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'pptx'],
        },
        {
          typeCode: 'goal_system',
          name: '目标体系',
          description: '战略目标分解与KPI体系',
          required: true,
          multiple: false,
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-2-strategy',
          toPhase: 'phase-3-roadmap',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-strategy-approved' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-3-roadmap',
      name: '路线制定',
      description: '制定详细实施路线图、资源计划、风险预案',
      order: 3,
      estimatedDays: 14,
      
      allowedTools: [
        'artifact.create',
        'artifact.update',
        'artifact.list',
        'note.create',
        'project.plan',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiStepper',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-roadmap-review',
          name: '路线图评审',
          type: 'review',
          description: '评审实施路线图的可行性',
          required: true,
        },
        {
          id: 'tp-final-acceptance',
          name: '项目验收',
          type: 'approval',
          description: '咨询项目最终验收',
          required: true,
          timeoutDays: 7,
          timeoutAction: 'escalate',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-roadmap-complete',
          name: '路线完成',
          description: '实施路线图已完成并获得验收',
          criteria: [
            { id: 'c1', description: '路线图已完成', type: 'artifact_exists', config: { artifactType: 'implementation_roadmap' } },
            { id: 'c2', description: '项目已验收', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'implementation_roadmap',
          name: '实施路线图',
          description: '详细的分阶段实施计划',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'pptx', 'xlsx'],
        },
        {
          typeCode: 'resource_plan',
          name: '资源计划',
          description: '实施所需的资源配置计划',
          required: true,
          multiple: false,
        },
        {
          typeCode: 'risk_contingency',
          name: '风险预案',
          description: '风险识别与应对预案',
          required: false,
          multiple: false,
        },
      ],
      
      transitions: [],  // 最终阶段
      
      config: {},
    },
  ],
  
  config: {
    allowParallelPhases: false,
    requireSequentialCompletion: true,
    autoStartNextPhase: true,
    notifyCustomerOnPhaseChange: true,
    requireExecutiveSponsor: true,
  },
  
  version: '1.0.0',
  status: 'active',
  source: 'platform',
  
  createdAt: new Date(),
  updatedAt: new Date(),
};
```

### 3.3 技术开发服务模板

```typescript
const techDevelopmentTemplate: WorkflowTemplate = {
  id: 'wf-tech-development',
  enterpriseId: 'platform',
  
  name: '技术开发服务流程',
  description: '适用于应用开发、系统开发类服务的标准工作流程',
  
  serviceTypes: ['tech.development', 'tech.implementation'],
  
  phases: [
    {
      id: 'phase-1-requirements',
      name: '需求与设计',
      description: '明确需求，完成技术方案和UI设计',
      order: 1,
      estimatedDays: 14,
      
      allowedTools: [
        'svc.service.get',
        'crm.customer.get',
        'artifact.create',
        'artifact.list',
        'note.create',
        'ai.analyze',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-requirements-confirm',
          name: '需求确认',
          type: 'approval',
          description: '确认需求规格说明书',
          required: true,
          timeoutDays: 5,
          timeoutAction: 'remind',
        },
        {
          id: 'tp-design-review',
          name: '设计评审',
          type: 'review',
          description: '评审技术方案和UI设计',
          required: true,
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-design-approved',
          name: '设计通过',
          description: '需求和设计方案已获得确认',
          criteria: [
            { id: 'c1', description: '需求规格已完成', type: 'artifact_exists', config: { artifactType: 'requirements_spec' } },
            { id: 'c2', description: '技术方案已完成', type: 'artifact_exists', config: { artifactType: 'technical_design' } },
            { id: 'c3', description: '客户已确认', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'requirements_spec',
          name: '需求规格说明书',
          description: '详细的功能需求文档',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'docx', 'md'],
        },
        {
          typeCode: 'technical_design',
          name: '技术方案',
          description: '系统架构和技术设计文档',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'docx', 'md'],
        },
        {
          typeCode: 'ui_design',
          name: 'UI设计稿',
          description: '用户界面设计',
          required: false,
          multiple: true,
          acceptedFormats: ['figma', 'sketch', 'pdf', 'png'],
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-1-requirements',
          toPhase: 'phase-2-development',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-design-approved' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-2-development',
      name: '开发实现',
      description: '按计划进行功能开发',
      order: 2,
      estimatedDays: 30,
      
      allowedTools: [
        'artifact.create',
        'artifact.update',
        'artifact.list',
        'note.create',
        'task.create',
        'task.update',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiStepper',
        'AiConsole',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-progress-report',
          name: '进度汇报',
          type: 'feedback',
          description: '定期汇报开发进度',
          required: false,
        },
        {
          id: 'tp-demo',
          name: '功能演示',
          type: 'review',
          description: '阶段性功能演示',
          required: true,
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-development-complete',
          name: '开发完成',
          description: '功能开发完成，准备进入测试',
          criteria: [
            { id: 'c1', description: '代码已提交', type: 'artifact_exists', config: { artifactType: 'code_repository' } },
            { id: 'c2', description: '单元测试通过', type: 'auto_check', config: { checkType: 'unit_test' } },
            { id: 'c3', description: '功能演示通过', type: 'approval_received' },
          ],
          required: true,
          approver: 'internal',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'code_repository',
          name: '代码仓库',
          description: '项目代码仓库链接',
          required: true,
          multiple: false,
        },
        {
          typeCode: 'api_documentation',
          name: '接口文档',
          description: 'API接口文档',
          required: true,
          multiple: false,
        },
        {
          typeCode: 'test_report',
          name: '测试报告',
          description: '单元测试报告',
          required: false,
          multiple: true,
        },
      ],
      
      transitions: [
        {
          fromPhase: 'phase-2-development',
          toPhase: 'phase-3-testing',
          conditions: [
            { type: 'checkpoint_passed', config: { checkpointId: 'cp-development-complete' } },
          ],
          automatic: true,
        },
      ],
      
      config: {},
    },
    
    {
      id: 'phase-3-testing',
      name: '测试验收',
      description: '进行集成测试、UAT测试，完成部署上线',
      order: 3,
      estimatedDays: 14,
      
      allowedTools: [
        'artifact.create',
        'artifact.update',
        'artifact.list',
        'note.create',
        'task.create',
        'deployment.execute',
      ],
      
      allowedUIComponents: [
        'AiForm',
        'AiList',
        'AiDetails',
        'AiConsole',
        'AiModalConfirm',
      ],
      
      customerTouchpoints: [
        {
          id: 'tp-uat',
          name: 'UAT测试',
          type: 'review',
          description: '客户进行用户验收测试',
          required: true,
        },
        {
          id: 'tp-go-live-approval',
          name: '上线审批',
          type: 'approval',
          description: '确认系统可以上线',
          required: true,
        },
        {
          id: 'tp-final-acceptance',
          name: '最终验收',
          type: 'approval',
          description: '项目最终验收',
          required: true,
          timeoutDays: 7,
          timeoutAction: 'escalate',
        },
      ],
      
      checkpoints: [
        {
          id: 'cp-testing-passed',
          name: '测试通过',
          description: '所有测试通过，可以上线',
          criteria: [
            { id: 'c1', description: '集成测试通过', type: 'auto_check', config: { checkType: 'integration_test' } },
            { id: 'c2', description: 'UAT测试通过', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
        {
          id: 'cp-delivery-complete',
          name: '交付完成',
          description: '系统已上线，项目已验收',
          criteria: [
            { id: 'c1', description: '系统已部署', type: 'artifact_exists', config: { artifactType: 'deployment_record' } },
            { id: 'c2', description: '运维文档已交付', type: 'artifact_exists', config: { artifactType: 'operations_manual' } },
            { id: 'c3', description: '项目已验收', type: 'approval_received' },
          ],
          required: true,
          approver: 'customer',
        },
      ],
      
      artifactTypes: [
        {
          typeCode: 'uat_report',
          name: 'UAT测试报告',
          description: '用户验收测试报告',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'docx'],
        },
        {
          typeCode: 'deployment_record',
          name: '部署记录',
          description: '系统部署记录',
          required: true,
          multiple: false,
        },
        {
          typeCode: 'operations_manual',
          name: '运维手册',
          description: '系统运维文档',
          required: true,
          multiple: false,
          acceptedFormats: ['pdf', 'docx', 'md'],
        },
      ],
      
      transitions: [],  // 最终阶段
      
      config: {},
    },
  ],
  
  config: {
    allowParallelPhases: false,
    requireSequentialCompletion: true,
    autoStartNextPhase: true,
    notifyCustomerOnPhaseChange: true,
    trackCodeQuality: true,
    requireCodeReview: true,
  },
  
  version: '1.0.0',
  status: 'active',
  source: 'platform',
  
  createdAt: new Date(),
  updatedAt: new Date(),
};
```

---

## 四、模板注册表

### 4.1 平台级模板列表

```typescript
/**
 * 平台级工作流模板注册表
 */
export const PLATFORM_WORKFLOW_TEMPLATES: Record<string, WorkflowTemplate> = {
  'wf-visual-design': visualDesignTemplate,
  'wf-branding': brandingTemplate,
  'wf-motion-design': motionDesignTemplate,
  'wf-ux-design': uxDesignTemplate,
  
  'wf-copywriting': copywritingTemplate,
  'wf-video-production': videoProductionTemplate,
  
  'wf-strategy-consulting': strategyConsultingTemplate,
  'wf-management-consulting': managementConsultingTemplate,
  'wf-digital-consulting': digitalConsultingTemplate,
  
  'wf-tech-development': techDevelopmentTemplate,
  'wf-implementation': implementationTemplate,
  'wf-tech-support': techSupportTemplate,
};

/**
 * 根据服务类型获取推荐模板
 */
export function getRecommendedTemplate(serviceType: ServiceType): WorkflowTemplate | undefined {
  // 1. 从服务类型元数据获取默认模板
  const metadata = SERVICE_TYPE_METADATA[serviceType];
  if (metadata?.defaultWorkflowTemplateId) {
    return PLATFORM_WORKFLOW_TEMPLATES[metadata.defaultWorkflowTemplateId];
  }
  
  // 2. 查找适用于该服务类型的模板
  return Object.values(PLATFORM_WORKFLOW_TEMPLATES).find(
    template => template.serviceTypes.includes(serviceType)
  );
}
```

---

## 五、与 AI OS 的集成

### 5.1 Workflow Engine 集成

```typescript
/**
 * 从模板创建工作流实例
 */
async function createWorkflowSession(
  template: WorkflowTemplate,
  context: {
    enterpriseId: string;
    serviceId?: string;
    projectId?: string;
    customConfig?: Record<string, unknown>;
  }
): Promise<WorkflowSession> {
  const firstPhase = template.phases.find(p => p.order === 1);
  if (!firstPhase) {
    throw new Error('Template must have at least one phase');
  }
  
  const session: WorkflowSession = {
    id: generateId(),
    enterpriseId: context.enterpriseId,
    templateId: template.id,
    serviceId: context.serviceId,
    projectId: context.projectId,
    
    currentPhaseId: firstPhase.id,
    status: 'active',
    
    phaseStates: template.phases.reduce((acc, phase) => ({
      ...acc,
      [phase.id]: {
        status: phase.id === firstPhase.id ? 'in_progress' : 'pending',
        checkpointStates: {},
        artifactIds: [],
        startedAt: phase.id === firstPhase.id ? new Date() : undefined,
      },
    }), {}),
    
    context: context.customConfig || {},
    
    startedAt: new Date(),
    createdAt: new Date(),
    updatedAt: new Date(),
  };
  
  // 保存到数据库
  await workflowSessionRepo.create(session);
  
  // 发送事件
  await eventBus.emit('workflow.session.created', {
    sessionId: session.id,
    templateId: template.id,
    enterpriseId: context.enterpriseId,
  });
  
  return session;
}
```

### 5.2 Tool Gate 集成

```typescript
/**
 * 检查工具是否允许在当前阶段执行
 */
async function checkToolAllowedInPhase(
  sessionId: string,
  toolId: string
): Promise<boolean> {
  const session = await workflowSessionRepo.get(sessionId);
  const template = await workflowTemplateRepo.get(session.templateId);
  
  const currentPhase = template.phases.find(p => p.id === session.currentPhaseId);
  if (!currentPhase) {
    return false;
  }
  
  return currentPhase.allowedTools.includes(toolId);
}
```

### 5.3 UI Protocol 集成

```typescript
/**
 * 获取当前阶段允许的 UI 组件
 */
async function getAllowedUIComponents(
  sessionId: string
): Promise<string[]> {
  const session = await workflowSessionRepo.get(sessionId);
  const template = await workflowTemplateRepo.get(session.templateId);
  
  const currentPhase = template.phases.find(p => p.id === session.currentPhaseId);
  if (!currentPhase) {
    return [];
  }
  
  return currentPhase.allowedUIComponents;
}
```

---

## 六、企业自定义模板

### 6.1 从平台模板派生

```typescript
/**
 * 从平台模板创建企业自定义模板
 */
async function deriveTemplateFromPlatform(
  platformTemplateId: string,
  enterpriseId: string,
  customizations: {
    name?: string;
    description?: string;
    phases?: Partial<WorkflowPhaseTemplate>[];
    config?: Partial<WorkflowTemplateConfig>;
  }
): Promise<WorkflowTemplate> {
  const platformTemplate = PLATFORM_WORKFLOW_TEMPLATES[platformTemplateId];
  if (!platformTemplate) {
    throw new Error(`Platform template ${platformTemplateId} not found`);
  }
  
  const derivedTemplate: WorkflowTemplate = {
    ...platformTemplate,
    id: generateId(),
    enterpriseId,
    name: customizations.name || `${platformTemplate.name}（自定义）`,
    description: customizations.description || platformTemplate.description,
    phases: mergePhases(platformTemplate.phases, customizations.phases),
    config: { ...platformTemplate.config, ...customizations.config },
    version: '1.0.0',
    status: 'draft',
    source: 'enterprise',
    createdAt: new Date(),
    updatedAt: new Date(),
  };
  
  // 保存到数据库
  await workflowTemplateRepo.create(derivedTemplate);
  
  return derivedTemplate;
}
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [服务抽象模型](./服务抽象模型.md)
- [服务类型定义](./服务类型定义.md)
- [总体架构设计](../architecture/总体架构设计.md)

