# dhs-atlas 用户后台功能架构（Tenant Console）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 领域架构文档  
> **相关文档**: [服务抽象模型](./服务抽象模型.md) · [总体架构设计](../architecture/总体架构设计.md)

---

## 一、概述

### 1.1 用户后台定位

用户后台（Tenant Console）是 **租户运营管理界面**，服务于企业内部用户进行日常业务操作。

```
┌─────────────────────────────────────────────────────────────────────┐
│                      两后台体系                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   Platform Console（平台后台）          Tenant Console（用户后台）   │
│   ┌────────────────────────┐          ┌────────────────────────┐   │
│   │                        │          │                        │   │
│   │  • 租户管理            │          │  • 项目管理            │   │
│   │  • 订阅/配额           │          │  • 财务管理            │   │
│   │  • 部署/迁移           │          │  • 合同管理            │   │
│   │  • 全局审计            │          │  • 服务管理            │   │
│   │  • 版本治理            │          │  • 客户管理            │   │
│   │                        │          │  • 文件系统            │   │
│   │  平台运营者使用        │          │  • 组织管理            │   │
│   │                        │          │  • 内容管理            │   │
│   └────────────────────────┘          │  • 系统设置            │   │
│                                        │                        │   │
│                                        │  企业用户使用          │   │
│                                        └────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心约束

| 约束 | 说明 |
|------|------|
| **enterprise_id 强制** | 所有数据必须绑定 enterprise_id |
| **Tool-First** | 所有操作必须有对应的 Tool |
| **UI 是状态视图** | UI 只呈现状态，不包含业务逻辑 |
| **AI 可操作** | 任何 UI 能做的，AI 必须能做 |

---

## 二、功能模块总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                      用户后台功能模块                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   项目管理   │  │   财务管理   │  │   合同管理   │               │
│   │  (project)  │  │  (finance)  │  │  (contract) │               │
│   ├─────────────┤  ├─────────────┤  ├─────────────┤               │
│   │ 项目管理    │  │ 订单        │  │ 合同管理    │               │
│   │ 提案管理    │  │ 结算单      │  │ 合同范本    │               │
│   │ 交付管理    │  │ 发票        │  │ 合同预检    │               │
│   │             │  │ 收入        │  │ 占位符      │               │
│   │             │  │ 绩效        │  │ 规则语义库  │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   服务管理   │  │   客户管理   │  │   文件系统   │               │
│   │  (service)  │  │    (crm)    │  │   (file)    │               │
│   ├─────────────┤  ├─────────────┤  ├─────────────┤               │
│   │ 服务管理    │  │ 客户管理    │  │ 文件列表    │               │
│   │ 服务分类    │  │ 联系人      │  │ 交付资产    │               │
│   │ 流程管理    │  │ 客户分类    │  │ 文件设置    │               │
│   │ 价格政策    │  │             │  │             │               │
│   │ 附加配置    │  │             │  │             │               │
│   │ 报价单      │  │             │  │             │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   组织管理   │  │   内容管理   │  │   系统设置   │               │
│   │    (org)    │  │    (cms)    │  │  (settings) │               │
│   ├─────────────┤  ├─────────────┤  ├─────────────┤               │
│   │ 企业信息    │  │ 页面        │  │ 通用设置    │               │
│   │ 部门管理    │  │ 文章        │  │ 集成配置    │               │
│   │ 员工管理    │  │ 文章分类    │  │ 通知设置    │               │
│   │ 权限管理    │  │ 菜单        │  │ AI 配置     │               │
│   │             │  │ 知识库      │  │             │               │
│   │             │  │ 官网设置    │  │             │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、各模块详细设计

### 3.1 项目管理（project）

**域定位**：已成交服务的执行态管理

#### 3.1.1 项目管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 项目列表 | 按状态、客户、时间筛选 | ✅ |
| 项目详情 | 基础信息、阶段、任务、团队 | ✅ |
| 项目创建 | 从报价单/服务创建 | ✅ |
| 阶段推进 | 阶段状态变更、验收 | ✅ |
| 任务管理 | 任务创建、分配、状态更新 | ✅ |
| 团队管理 | 项目成员分配 | ✅ |
| 进度跟踪 | 进度统计、甘特图 | ✅ |

**数据模型**：

```typescript
interface Project {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  code: string;                      // 项目编号
  description?: string;
  
  // 关联
  customerId: string;
  serviceId: string;
  quoteId?: string;
  contractId?: string;
  
  // 阶段（从 Workflow Template 派生）
  phases: ProjectPhase[];
  currentPhaseId?: string;
  
  // 团队
  managerId?: string;
  members: ProjectMember[];
  
  // 状态
  status: ProjectStatus;
  progress: number;                  // 0-100
  
  // 时间
  startDate?: Date;
  estimatedEndDate?: Date;
  actualEndDate?: Date;
  
  // 财务
  budgetAmount?: number;
  actualAmount?: number;
  
  // 元数据
  tags?: string[];
  metadata?: Record<string, unknown>;
  
  createdAt: Date;
  updatedAt: Date;
}

type ProjectStatus = 
  | 'draft'        // 草稿
  | 'planning'     // 规划中
  | 'in_progress'  // 进行中
  | 'review'       // 验收中
  | 'completed'    // 已完成
  | 'on_hold'      // 暂停
  | 'cancelled';   // 已取消
```

**Tool 清单**：

```typescript
const projectTools = [
  'project.list',
  'project.get',
  'project.create',
  'project.update',
  'project.delete',
  'project.archive',
  
  'project.phase.list',
  'project.phase.get',
  'project.phase.start',
  'project.phase.complete',
  
  'project.task.list',
  'project.task.create',
  'project.task.update',
  'project.task.assign',
  'project.task.complete',
  
  'project.member.list',
  'project.member.add',
  'project.member.remove',
];
```

#### 3.1.2 提案管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 提案列表 | 待定/进行中/已完成提案 | ✅ |
| 提案详情 | 提案内容、历史版本 | ✅ |
| 提案创建 | 基于服务/报价生成提案 | ✅ |
| 提案编辑 | 内容编辑、版本管理 | ✅ |
| 提案发送 | 发送给客户 | ✅ |
| 提案状态 | 已发送/已查看/已接受/已拒绝 | ✅ |

**数据模型**：

```typescript
interface Proposal {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  title: string;
  content: string;                   // Markdown/HTML
  
  // 关联
  customerId: string;
  serviceId?: string;
  quoteId?: string;
  
  // 版本
  version: number;
  versions: ProposalVersion[];
  
  // 状态
  status: ProposalStatus;
  sentAt?: Date;
  viewedAt?: Date;
  respondedAt?: Date;
  
  // 有效期
  validUntil?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

type ProposalStatus = 
  | 'draft'      // 草稿
  | 'sent'       // 已发送
  | 'viewed'     // 已查看
  | 'accepted'   // 已接受
  | 'rejected'   // 已拒绝
  | 'expired';   // 已过期
```

#### 3.1.3 交付管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 交付物列表 | 按项目/阶段查看交付物 | ✅ |
| 交付物上传 | 上传文件、关联阶段 | ✅ |
| 交付审核 | 内部审核流程 | ✅ |
| 客户验收 | 发送验收、获取反馈 | ✅ |
| 版本管理 | 交付物版本历史 | ✅ |

**数据模型**：

```typescript
interface Deliverable {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  description?: string;
  type: DeliverableType;
  
  // 关联
  projectId: string;
  phaseId: string;
  
  // 文件
  fileId?: string;
  fileUrl?: string;
  fileSize?: number;
  mimeType?: string;
  
  // 版本
  version: number;
  versions: DeliverableVersion[];
  
  // 状态
  status: DeliverableStatus;
  
  // 审核
  internalReview?: ReviewRecord;
  customerAcceptance?: AcceptanceRecord;
  
  createdAt: Date;
  updatedAt: Date;
}

type DeliverableStatus = 
  | 'draft'             // 草稿
  | 'pending_review'    // 待审核
  | 'approved'          // 已通过
  | 'rejected'          // 已驳回
  | 'delivered'         // 已交付
  | 'accepted';         // 已验收
```

---

### 3.2 财务管理（finance）

**域定位**：订单、结算、发票、收入的财务闭环

#### 3.2.1 订单管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 订单列表 | 按状态、客户、时间筛选 | ✅ |
| 订单详情 | 订单信息、关联项目/合同 | ✅ |
| 订单创建 | 从报价单/合同创建 | ✅ |
| 订单状态 | 待确认/进行中/已完成/已取消 | ✅ |

**数据模型**：

```typescript
interface Order {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  orderNo: string;                   // 订单编号
  
  // 关联
  customerId: string;
  quoteId?: string;
  contractId?: string;
  projectId?: string;
  
  // 金额
  items: OrderItem[];
  subtotal: number;
  discount?: number;
  tax?: number;
  total: number;
  currency: string;
  
  // 状态
  status: OrderStatus;
  
  // 时间
  orderDate: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

interface OrderItem {
  id: string;
  serviceId?: string;
  description: string;
  quantity: number;
  unitPrice: number;
  amount: number;
}

type OrderStatus = 
  | 'pending'      // 待确认
  | 'confirmed'    // 已确认
  | 'in_progress'  // 进行中
  | 'completed'    // 已完成
  | 'cancelled';   // 已取消
```

#### 3.2.2 结算单管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 结算单列表 | 按状态、项目、时间筛选 | ✅ |
| 结算单详情 | 结算项目、金额明细 | ✅ |
| 结算单创建 | 基于阶段/里程碑生成 | ✅ |
| 结算审核 | 内部审核流程 | ✅ |
| 转发票 | 生成发票申请 | ✅ |

**数据模型**：

```typescript
interface Settlement {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  settlementNo: string;
  
  // 关联
  customerId: string;
  projectId?: string;
  orderId?: string;
  
  // 结算项
  items: SettlementItem[];
  subtotal: number;
  adjustments?: number;
  total: number;
  currency: string;
  
  // 状态
  status: SettlementStatus;
  
  // 审核
  reviewedBy?: string;
  reviewedAt?: Date;
  
  // 时间
  periodStart?: Date;
  periodEnd?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

interface SettlementItem {
  id: string;
  description: string;
  
  // 来源
  sourceType: 'milestone' | 'phase' | 'service' | 'adjustment';
  sourceId?: string;
  
  quantity: number;
  unitPrice: number;
  amount: number;
}

type SettlementStatus = 
  | 'draft'           // 草稿
  | 'pending_review'  // 待审核
  | 'approved'        // 已审核
  | 'invoiced'        // 已开票
  | 'cancelled';      // 已取消
```

#### 3.2.3 发票管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 发票列表 | 按状态、客户、时间筛选 | ✅ |
| 发票详情 | 发票信息、开票明细 | ✅ |
| 发票申请 | 创建开票申请 | ✅ |
| 发票开具 | 记录开票信息 | ✅ |
| 发票冲红 | 发票作废/冲红 | ✅ |

**数据模型**：

```typescript
interface Invoice {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  invoiceNo?: string;                // 发票号
  invoiceType: InvoiceType;
  
  // 关联
  customerId: string;
  settlementId?: string;
  orderId?: string;
  
  // 开票信息
  sellerInfo: InvoicePartyInfo;
  buyerInfo: InvoicePartyInfo;
  
  // 明细
  items: InvoiceItem[];
  subtotal: number;
  taxRate: number;
  taxAmount: number;
  total: number;
  currency: string;
  
  // 状态
  status: InvoiceStatus;
  
  // 时间
  invoiceDate?: Date;
  dueDate?: Date;
  
  // 支付
  paidAmount?: number;
  paidAt?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

type InvoiceType = 'normal' | 'vat_normal' | 'vat_special';

type InvoiceStatus = 
  | 'draft'        // 草稿
  | 'pending'      // 待开票
  | 'issued'       // 已开票
  | 'sent'         // 已发送
  | 'paid'         // 已付款
  | 'overdue'      // 已逾期
  | 'voided';      // 已作废
```

#### 3.2.4 收入管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 收入概览 | 收入统计、趋势图 | ✅ |
| 收入明细 | 按项目/客户/时间查看 | ✅ |
| 回款记录 | 记录实际回款 | ✅ |
| 应收账款 | 应收账龄分析 | ✅ |

**数据模型**：

```typescript
interface Payment {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  paymentNo: string;
  
  // 关联
  customerId: string;
  invoiceId?: string;
  orderId?: string;
  
  // 金额
  amount: number;
  currency: string;
  
  // 支付信息
  paymentMethod: PaymentMethod;
  paymentDate: Date;
  
  // 备注
  remark?: string;
  
  createdAt: Date;
  updatedAt: Date;
}

type PaymentMethod = 
  | 'bank_transfer'  // 银行转账
  | 'alipay'         // 支付宝
  | 'wechat'         // 微信
  | 'cash'           // 现金
  | 'other';         // 其他
```

#### 3.2.5 绩效管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 绩效概览 | 团队/个人绩效统计 | ✅ |
| 项目绩效 | 项目利润、成本分析 | ✅ |
| 人员绩效 | 员工产出、工时统计 | ✅ |
| 绩效报表 | 周报/月报/季报 | ✅ |

---

### 3.3 合同管理（contract）

**域定位**：合同全生命周期管理，支持 AI 预检

#### 3.3.1 合同管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 合同列表 | 按状态、客户、类型筛选 | ✅ |
| 合同详情 | 合同内容、历史版本 | ✅ |
| 合同创建 | 从范本/报价单创建 | ✅ |
| 合同编辑 | 内容编辑、变量替换 | ✅ |
| 合同审核 | 内部审核流程 | ✅ |
| 合同签署 | 发送签署、状态跟踪 | ✅ |
| 合同归档 | 归档管理 | ✅ |

**数据模型**：

```typescript
interface Contract {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  contractNo: string;
  title: string;
  type: ContractType;
  
  // 关联
  customerId: string;
  quoteId?: string;
  templateId?: string;
  
  // 内容
  content: string;                   // Markdown/HTML
  
  // 金额
  totalAmount?: number;
  currency?: string;
  
  // 甲乙方
  partyA: ContractParty;
  partyB: ContractParty;
  
  // 版本
  version: number;
  versions: ContractVersion[];
  
  // 状态
  status: ContractStatus;
  
  // 签署
  signedByA?: SignatureRecord;
  signedByB?: SignatureRecord;
  
  // 时间
  effectiveDate?: Date;
  expiryDate?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

type ContractType = 
  | 'service'        // 服务合同
  | 'framework'      // 框架协议
  | 'nda'            // 保密协议
  | 'supplement'     // 补充协议
  | 'other';         // 其他

type ContractStatus = 
  | 'draft'          // 草稿
  | 'pending_review' // 待审核
  | 'approved'       // 已审核
  | 'pending_sign'   // 待签署
  | 'signed'         // 已签署
  | 'effective'      // 生效中
  | 'expired'        // 已到期
  | 'terminated'     // 已终止
  | 'archived';      // 已归档
```

#### 3.3.2 合同范本

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 范本列表 | 按类型、标签筛选 | ✅ |
| 范本详情 | 范本内容、变量定义 | ✅ |
| 范本创建 | 创建新范本 | ✅ |
| 范本编辑 | 编辑范本内容 | ✅ |
| 范本复制 | 复制为新范本 | ✅ |

**数据模型**：

```typescript
interface ContractTemplate {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  description?: string;
  type: ContractType;
  
  // 内容
  content: string;                   // 带占位符的模板
  
  // 变量
  variables: TemplateVariable[];
  
  // 分类
  category?: string;
  tags?: string[];
  
  // 状态
  status: 'draft' | 'active' | 'archived';
  
  // 使用统计
  useCount: number;
  
  createdAt: Date;
  updatedAt: Date;
}

interface TemplateVariable {
  key: string;                       // 如 {{customer_name}}
  name: string;                      // 展示名称
  type: 'text' | 'date' | 'number' | 'select';
  required: boolean;
  defaultValue?: string;
  options?: string[];                // select 类型的选项
}
```

#### 3.3.3 合同预检

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 预检触发 | 对合同执行 AI 预检 | ✅ |
| 预检报告 | 查看预检结果 | ✅ |
| 风险提示 | 风险点标注与建议 | ✅ |
| 规则配置 | 配置预检规则 | ✅ |

**数据模型**：

```typescript
interface ContractReview {
  id: string;
  enterpriseId: string;
  
  // 关联
  contractId: string;
  
  // 预检结果
  status: 'pending' | 'completed' | 'failed';
  score?: number;                    // 0-100
  
  // 风险项
  risks: RiskItem[];
  
  // 建议
  suggestions: Suggestion[];
  
  // AI 元数据
  aiModel?: string;
  aiRequestId?: string;
  
  createdAt: Date;
  completedAt?: Date;
}

interface RiskItem {
  id: string;
  level: 'high' | 'medium' | 'low';
  category: string;
  description: string;
  location?: string;                 // 位置标记
  suggestion?: string;
}
```

#### 3.3.4 占位符管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 占位符列表 | 系统/自定义占位符 | ✅ |
| 占位符创建 | 创建自定义占位符 | ✅ |
| 占位符编辑 | 编辑占位符定义 | ✅ |
| 占位符预览 | 预览占位符效果 | ✅ |

#### 3.3.5 规则语义库

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 规则列表 | 预检规则库 | ✅ |
| 规则创建 | 创建新规则 | ✅ |
| 规则编辑 | 编辑规则定义 | ✅ |
| 规则测试 | 测试规则效果 | ✅ |

---

### 3.4 服务管理（service）

**域定位**：服务能力定义与定价管理

> 详细模型见 [服务抽象模型](./服务抽象模型.md)

#### 3.4.1 服务管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 服务列表 | 按类型、状态筛选 | ✅ |
| 服务详情 | 服务信息、定价、流程 | ✅ |
| 服务创建 | 创建新服务 | ✅ |
| 服务编辑 | 编辑服务信息 | ✅ |
| 服务发布 | 发布/下架服务 | ✅ |

#### 3.4.2 服务分类

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 分类列表 | 分类树形结构 | ✅ |
| 分类创建 | 创建新分类 | ✅ |
| 分类编辑 | 编辑分类信息 | ✅ |
| 分类排序 | 调整分类顺序 | ✅ |

#### 3.4.3 流程管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 流程列表 | Workflow Template 列表 | ✅ |
| 流程详情 | 阶段、验收点、产物 | ✅ |
| 流程创建 | 从平台模板派生 | ✅ |
| 流程编辑 | 编辑流程定义 | ✅ |

> 详细模型见 [服务流程模板](./服务流程模板.md)

#### 3.4.4 价格政策

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 政策列表 | 定价策略列表 | ✅ |
| 政策详情 | 定价规则、适用范围 | ✅ |
| 政策创建 | 创建新政策 | ✅ |
| 政策编辑 | 编辑政策规则 | ✅ |

**数据模型**：

```typescript
interface PricingPolicy {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  description?: string;
  
  // 适用范围
  scope: {
    type: 'all' | 'service' | 'category' | 'customer';
    targetIds?: string[];
  };
  
  // 规则
  rules: PricingRule[];
  
  // 优先级
  priority: number;
  
  // 有效期
  effectiveFrom?: Date;
  effectiveTo?: Date;
  
  // 状态
  status: 'draft' | 'active' | 'inactive';
  
  createdAt: Date;
  updatedAt: Date;
}

interface PricingRule {
  id: string;
  type: 'discount' | 'markup' | 'fixed' | 'tiered';
  
  // 条件
  condition?: {
    minQuantity?: number;
    maxQuantity?: number;
    minAmount?: number;
    customerLevel?: string;
  };
  
  // 值
  value: number;
  unit: 'percent' | 'amount';
}
```

#### 3.4.5 附加配置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 配置列表 | 附加项列表 | ✅ |
| 配置详情 | 附加项详情 | ✅ |
| 配置创建 | 创建附加项 | ✅ |
| 配置编辑 | 编辑附加项 | ✅ |

**数据模型**：

```typescript
interface AddonConfig {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  description?: string;
  
  // 定价
  pricingType: 'fixed' | 'unit' | 'percent';
  price: number;
  unit?: string;                     // 如 "次"、"天"
  
  // 适用范围
  applicableServices?: string[];
  
  // 状态
  status: 'active' | 'inactive';
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### 3.4.6 报价单

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 报价列表 | 按状态、客户筛选 | ✅ |
| 报价详情 | 报价信息、明细 | ✅ |
| 报价创建 | 创建新报价 | ✅ |
| 报价编辑 | 编辑报价内容 | ✅ |
| 报价发送 | 发送给客户 | ✅ |
| 报价转换 | 转订单/合同/项目 | ✅ |

**数据模型**：

```typescript
interface Quote {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  quoteNo: string;
  title?: string;
  
  // 关联
  customerId: string;
  contactId?: string;
  
  // 明细
  items: QuoteItem[];
  
  // 金额
  subtotal: number;
  discount?: number;
  tax?: number;
  total: number;
  currency: string;
  
  // 交付说明
  deliveryDescription?: string;
  estimatedDeliveryDays?: number;
  
  // 条款
  terms?: string;
  paymentTerms?: string;
  
  // 状态
  status: QuoteStatus;
  
  // 有效期
  validUntil?: Date;
  
  // 版本
  version: number;
  
  createdAt: Date;
  updatedAt: Date;
}

interface QuoteItem {
  id: string;
  serviceId?: string;
  name: string;
  description?: string;
  
  // 定价
  pricingModel: PricingModel;
  quantity: number;
  unitPrice: number;
  amount: number;
  
  // 附加项
  addons?: QuoteAddon[];
}

type QuoteStatus = 
  | 'draft'      // 草稿
  | 'sent'       // 已发送
  | 'viewed'     // 已查看
  | 'accepted'   // 已接受
  | 'rejected'   // 已拒绝
  | 'expired'    // 已过期
  | 'converted'; // 已转换
```

---

### 3.5 客户管理（crm）

**域定位**：客户信息与关系管理

#### 3.5.1 客户管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 客户列表 | 按状态、分类、标签筛选 | ✅ |
| 客户详情 | 客户信息、交易历史 | ✅ |
| 客户创建 | 创建新客户 | ✅ |
| 客户编辑 | 编辑客户信息 | ✅ |
| 客户合并 | 合并重复客户 | ✅ |
| 客户导入 | 批量导入客户 | ✅ |

**数据模型**：

```typescript
interface Customer {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  shortName?: string;
  type: CustomerType;
  
  // 联系方式
  phone?: string;
  email?: string;
  address?: string;
  
  // 企业信息（企业客户）
  companyInfo?: {
    registrationNo?: string;
    legalPerson?: string;
    industry?: string;
    scale?: string;
  };
  
  // 分类
  categoryId?: string;
  tags?: string[];
  
  // 级别
  level?: CustomerLevel;
  
  // 状态
  status: CustomerStatus;
  
  // 负责人
  ownerId?: string;
  
  // 来源
  source?: string;
  
  // 备注
  remark?: string;
  
  createdAt: Date;
  updatedAt: Date;
}

type CustomerType = 'company' | 'individual';

type CustomerLevel = 'vip' | 'important' | 'normal' | 'potential';

type CustomerStatus = 'active' | 'inactive' | 'blocked';
```

**Tool 清单**：

```typescript
const crmTools = [
  'crm.customer.list',
  'crm.customer.get',
  'crm.customer.create',
  'crm.customer.update',
  'crm.customer.delete',
  'crm.customer.merge',
  'crm.customer.import',
  'crm.customer.export',
  
  'crm.contact.list',
  'crm.contact.get',
  'crm.contact.create',
  'crm.contact.update',
  'crm.contact.delete',
  
  'crm.category.list',
  'crm.category.create',
  'crm.category.update',
  'crm.category.delete',
];
```

#### 3.5.2 联系人管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 联系人列表 | 按客户、角色筛选 | ✅ |
| 联系人详情 | 联系人信息 | ✅ |
| 联系人创建 | 创建新联系人 | ✅ |
| 联系人编辑 | 编辑联系人信息 | ✅ |

**数据模型**：

```typescript
interface Contact {
  id: string;
  enterpriseId: string;
  
  // 关联
  customerId: string;
  
  // 基础信息
  name: string;
  title?: string;                    // 职位
  department?: string;
  
  // 联系方式
  phone?: string;
  email?: string;
  wechat?: string;
  
  // 角色
  role?: ContactRole;
  isPrimary: boolean;
  
  // 备注
  remark?: string;
  
  createdAt: Date;
  updatedAt: Date;
}

type ContactRole = 
  | 'decision_maker'  // 决策者
  | 'influencer'      // 影响者
  | 'user'            // 使用者
  | 'gatekeeper'      // 把关者
  | 'other';          // 其他
```

#### 3.5.3 客户分类

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 分类列表 | 分类树形结构 | ✅ |
| 分类创建 | 创建新分类 | ✅ |
| 分类编辑 | 编辑分类信息 | ✅ |
| 分类排序 | 调整分类顺序 | ✅ |

---

### 3.6 文件系统（file）

**域定位**：文件存储与交付资产管理

#### 3.6.1 文件列表

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 文件浏览 | 按目录、类型浏览 | ✅ |
| 文件上传 | 上传文件 | ✅ |
| 文件下载 | 下载文件 | ✅ |
| 文件预览 | 在线预览 | ✅ |
| 文件搜索 | 按名称、类型搜索 | ✅ |
| 文件移动 | 移动到其他目录 | ✅ |

**数据模型**：

```typescript
interface File {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  originalName: string;
  
  // 存储
  storageKey: string;                // 存储路径
  storageProvider: string;           // 存储提供商
  
  // 文件属性
  mimeType: string;
  size: number;
  extension: string;
  
  // 目录
  folderId?: string;
  
  // 关联
  relatedType?: 'project' | 'deliverable' | 'contract' | 'customer';
  relatedId?: string;
  
  // 元数据
  metadata?: {
    width?: number;
    height?: number;
    duration?: number;
    pages?: number;
  };
  
  // 状态
  status: 'uploading' | 'active' | 'archived' | 'deleted';
  
  // 访问控制
  visibility: 'private' | 'team' | 'customer';
  
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}

interface Folder {
  id: string;
  enterpriseId: string;
  
  name: string;
  parentId?: string;
  
  // 关联
  relatedType?: 'project' | 'customer';
  relatedId?: string;
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### 3.6.2 交付资产

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 资产列表 | 按项目、类型筛选 | ✅ |
| 资产详情 | 资产信息、版本历史 | ✅ |
| 资产上传 | 上传交付资产 | ✅ |
| 资产分享 | 生成分享链接 | ✅ |

#### 3.6.3 文件设置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 存储配置 | 存储空间、配额 | ✅ |
| 类型配置 | 允许的文件类型 | ✅ |
| 回收站 | 已删除文件管理 | ✅ |

---

### 3.7 组织管理（org）

**域定位**：企业组织架构与权限管理

#### 3.7.1 企业信息

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 基本信息 | 企业名称、简介、Logo | ✅ |
| 联系信息 | 地址、电话、邮箱 | ✅ |
| 工商信息 | 营业执照、税务信息 | ✅ |
| 品牌信息 | 品牌色、字体等 | ✅ |

**数据模型**：

```typescript
interface Enterprise {
  id: string;
  
  // 基础信息
  name: string;
  shortName?: string;
  logo?: string;
  description?: string;
  
  // 联系信息
  phone?: string;
  email?: string;
  address?: string;
  website?: string;
  
  // 工商信息
  businessInfo?: {
    registrationNo?: string;
    legalPerson?: string;
    registeredCapital?: string;
    establishedDate?: Date;
    businessScope?: string;
  };
  
  // 税务信息
  taxInfo?: {
    taxNo?: string;
    taxType?: string;
    bankName?: string;
    bankAccount?: string;
  };
  
  // 品牌设置
  brandSettings?: {
    primaryColor?: string;
    secondaryColor?: string;
    fontFamily?: string;
  };
  
  // 状态
  status: 'active' | 'suspended';
  
  // 订阅
  planId?: string;
  planExpiresAt?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### 3.7.2 部门管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 部门列表 | 部门树形结构 | ✅ |
| 部门详情 | 部门信息、成员 | ✅ |
| 部门创建 | 创建新部门 | ✅ |
| 部门编辑 | 编辑部门信息 | ✅ |
| 部门调整 | 调整部门结构 | ✅ |

**数据模型**：

```typescript
interface Department {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  name: string;
  code?: string;
  
  // 层级
  parentId?: string;
  path: string;                      // 如 "/root/dept1/dept2"
  level: number;
  
  // 负责人
  managerId?: string;
  
  // 排序
  sortOrder: number;
  
  // 状态
  status: 'active' | 'inactive';
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### 3.7.3 员工管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 员工列表 | 按部门、角色筛选 | ✅ |
| 员工详情 | 员工信息、权限 | ✅ |
| 员工邀请 | 邀请新员工 | ✅ |
| 员工编辑 | 编辑员工信息 | ✅ |
| 员工调岗 | 调整部门/角色 | ✅ |
| 员工禁用 | 禁用/启用账号 | ✅ |

**数据模型**：

```typescript
interface Employee {
  id: string;
  enterpriseId: string;
  
  // 关联用户
  userId: string;
  
  // 基础信息
  name: string;
  avatar?: string;
  employeeNo?: string;
  
  // 联系方式
  phone?: string;
  email?: string;
  
  // 组织
  departmentId?: string;
  position?: string;
  
  // 角色
  roleIds: string[];
  
  // 状态
  status: EmployeeStatus;
  
  // 入职信息
  joinDate?: Date;
  leaveDate?: Date;
  
  createdAt: Date;
  updatedAt: Date;
}

type EmployeeStatus = 
  | 'pending'   // 待加入
  | 'active'    // 在职
  | 'inactive'  // 已禁用
  | 'left';     // 已离职
```

#### 3.7.4 权限管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 角色列表 | 系统/自定义角色 | ✅ |
| 角色详情 | 角色权限配置 | ✅ |
| 角色创建 | 创建自定义角色 | ✅ |
| 角色编辑 | 编辑角色权限 | ✅ |
| 权限配置 | 功能权限/数据权限 | ✅ |

**数据模型**：

```typescript
interface Role {
  id: string;
  enterpriseId: string;              // 'system' 为系统角色
  
  // 基础信息
  name: string;
  code: string;
  description?: string;
  
  // 类型
  type: 'system' | 'custom';
  
  // 权限
  permissions: Permission[];
  
  // 数据范围
  dataScope: DataScope;
  
  // 状态
  status: 'active' | 'inactive';
  
  createdAt: Date;
  updatedAt: Date;
}

interface Permission {
  module: string;                    // 如 'project', 'finance'
  action: string;                    // 如 'view', 'create', 'update', 'delete'
  resource?: string;                 // 资源限定
}

type DataScope = 
  | 'all'          // 全部数据
  | 'department'   // 本部门
  | 'self';        // 仅自己
```

---

### 3.8 内容管理（cms）

**域定位**：官网内容与知识库管理

#### 3.8.1 页面管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 页面列表 | 按类型、状态筛选 | ✅ |
| 页面详情 | 页面内容、SEO | ✅ |
| 页面创建 | 创建新页面 | ✅ |
| 页面编辑 | 编辑页面内容 | ✅ |
| 页面发布 | 发布/下架页面 | ✅ |
| 页面预览 | 预览页面效果 | ✅ |

**数据模型**：

```typescript
interface Page {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  title: string;
  slug: string;                      // URL 路径
  type: PageType;
  
  // 内容
  content: string;                   // JSON/HTML
  excerpt?: string;
  
  // 封面
  coverImage?: string;
  
  // SEO
  seo?: {
    title?: string;
    description?: string;
    keywords?: string[];
    ogImage?: string;
  };
  
  // 状态
  status: PageStatus;
  publishedAt?: Date;
  
  // 排序
  sortOrder: number;
  
  createdBy: string;
  createdAt: Date;
  updatedAt: Date;
}

type PageType = 
  | 'home'       // 首页
  | 'about'      // 关于我们
  | 'service'    // 服务页
  | 'case'       // 案例页
  | 'contact'    // 联系我们
  | 'custom';    // 自定义页

type PageStatus = 'draft' | 'published' | 'archived';
```

#### 3.8.2 文章管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 文章列表 | 按分类、状态筛选 | ✅ |
| 文章详情 | 文章内容、标签 | ✅ |
| 文章创建 | 创建新文章 | ✅ |
| 文章编辑 | 编辑文章内容 | ✅ |
| 文章发布 | 发布/下架文章 | ✅ |

**数据模型**：

```typescript
interface Article {
  id: string;
  enterpriseId: string;
  
  // 基础信息
  title: string;
  slug: string;
  
  // 内容
  content: string;
  excerpt?: string;
  
  // 封面
  coverImage?: string;
  
  // 分类
  categoryId?: string;
  tags?: string[];
  
  // 作者
  authorId?: string;
  
  // SEO
  seo?: {
    title?: string;
    description?: string;
    keywords?: string[];
  };
  
  // 状态
  status: ArticleStatus;
  publishedAt?: Date;
  
  // 统计
  viewCount: number;
  
  createdAt: Date;
  updatedAt: Date;
}

type ArticleStatus = 'draft' | 'published' | 'archived';
```

#### 3.8.3 文章分类

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 分类列表 | 分类树形结构 | ✅ |
| 分类创建 | 创建新分类 | ✅ |
| 分类编辑 | 编辑分类信息 | ✅ |
| 分类排序 | 调整分类顺序 | ✅ |

#### 3.8.4 菜单管理

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 菜单列表 | 导航菜单结构 | ✅ |
| 菜单创建 | 创建菜单项 | ✅ |
| 菜单编辑 | 编辑菜单项 | ✅ |
| 菜单排序 | 调整菜单顺序 | ✅ |

**数据模型**：

```typescript
interface MenuItem {
  id: string;
  enterpriseId: string;
  
  // 所属菜单组
  menuGroup: 'main' | 'footer' | 'mobile';
  
  // 基础信息
  title: string;
  
  // 链接
  linkType: 'page' | 'url' | 'none';
  pageId?: string;
  url?: string;
  target?: '_self' | '_blank';
  
  // 层级
  parentId?: string;
  level: number;
  
  // 排序
  sortOrder: number;
  
  // 状态
  status: 'active' | 'inactive';
  
  createdAt: Date;
  updatedAt: Date;
}
```

#### 3.8.5 知识库

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 知识库列表 | 知识库分类 | ✅ |
| 文档列表 | 知识文档列表 | ✅ |
| 文档创建 | 创建知识文档 | ✅ |
| 文档编辑 | 编辑知识文档 | ✅ |
| 文档搜索 | 全文搜索 | ✅ |

#### 3.8.6 官网设置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 基础设置 | 站点名称、Logo、Favicon | ✅ |
| 域名设置 | 自定义域名 | ✅ |
| SEO 设置 | 全局 SEO 配置 | ✅ |
| 样式设置 | 主题色、字体 | ✅ |
| 代码设置 | 统计代码、自定义代码 | ✅ |

---

### 3.9 系统设置（settings）

**域定位**：企业级系统配置

#### 3.9.1 通用设置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 时区设置 | 系统时区 | ✅ |
| 语言设置 | 界面语言 | ✅ |
| 货币设置 | 默认货币 | ✅ |
| 编号规则 | 单据编号规则 | ✅ |

#### 3.9.2 集成配置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 邮件配置 | SMTP 配置 | ✅ |
| 短信配置 | 短信通道配置 | ✅ |
| 存储配置 | 对象存储配置 | ✅ |
| 支付配置 | 支付渠道配置 | ✅ |
| 第三方集成 | API 集成配置 | ✅ |

#### 3.9.3 通知设置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| 通知模板 | 通知内容模板 | ✅ |
| 通知规则 | 触发条件配置 | ✅ |
| 通知渠道 | 站内/邮件/短信 | ✅ |

#### 3.9.4 AI 配置

| 功能 | 说明 | AI 可操作 |
|------|------|----------|
| AI 开关 | 启用/禁用 AI 功能 | ✅ |
| 模型配置 | AI 模型选择 | ✅ |
| 用量统计 | AI 调用统计 | ✅ |

---

## 四、Tool 清单汇总

### 4.1 按模块分类

```typescript
// 完整 Tool 清单
const allTools = {
  // 项目管理
  project: [
    'project.list', 'project.get', 'project.create', 'project.update',
    'project.delete', 'project.archive',
    'project.phase.list', 'project.phase.start', 'project.phase.complete',
    'project.task.list', 'project.task.create', 'project.task.update',
    'project.task.assign', 'project.task.complete',
    'project.member.list', 'project.member.add', 'project.member.remove',
    'project.proposal.list', 'project.proposal.create', 'project.proposal.send',
    'project.deliverable.list', 'project.deliverable.upload',
    'project.deliverable.review', 'project.deliverable.accept',
  ],
  
  // 财务管理
  finance: [
    'finance.order.list', 'finance.order.get', 'finance.order.create',
    'finance.order.update', 'finance.order.cancel',
    'finance.settlement.list', 'finance.settlement.create',
    'finance.settlement.review', 'finance.settlement.approve',
    'finance.invoice.list', 'finance.invoice.create',
    'finance.invoice.issue', 'finance.invoice.void',
    'finance.payment.list', 'finance.payment.record',
    'finance.report.revenue', 'finance.report.receivable',
  ],
  
  // 合同管理
  contract: [
    'contract.list', 'contract.get', 'contract.create', 'contract.update',
    'contract.submit_review', 'contract.approve', 'contract.send_sign',
    'contract.sign', 'contract.archive',
    'contract.template.list', 'contract.template.create',
    'contract.template.update', 'contract.template.delete',
    'contract.review.trigger', 'contract.review.get',
    'contract.placeholder.list', 'contract.placeholder.create',
    'contract.rule.list', 'contract.rule.create',
  ],
  
  // 服务管理
  service: [
    'service.list', 'service.get', 'service.create', 'service.update',
    'service.publish', 'service.archive',
    'service.category.list', 'service.category.create',
    'service.workflow.list', 'service.workflow.create',
    'service.pricing.list', 'service.pricing.create',
    'service.addon.list', 'service.addon.create',
    'service.quote.list', 'service.quote.create', 'service.quote.send',
    'service.quote.convert',
  ],
  
  // 客户管理
  crm: [
    'crm.customer.list', 'crm.customer.get', 'crm.customer.create',
    'crm.customer.update', 'crm.customer.merge', 'crm.customer.import',
    'crm.contact.list', 'crm.contact.create', 'crm.contact.update',
    'crm.category.list', 'crm.category.create',
  ],
  
  // 文件系统
  file: [
    'file.list', 'file.get', 'file.upload', 'file.download',
    'file.move', 'file.delete', 'file.share',
    'file.folder.list', 'file.folder.create', 'file.folder.delete',
  ],
  
  // 组织管理
  org: [
    'org.enterprise.get', 'org.enterprise.update',
    'org.department.list', 'org.department.create', 'org.department.update',
    'org.employee.list', 'org.employee.invite', 'org.employee.update',
    'org.employee.transfer', 'org.employee.disable',
    'org.role.list', 'org.role.create', 'org.role.update',
    'org.permission.list', 'org.permission.update',
  ],
  
  // 内容管理
  cms: [
    'cms.page.list', 'cms.page.create', 'cms.page.update', 'cms.page.publish',
    'cms.article.list', 'cms.article.create', 'cms.article.update',
    'cms.article.publish',
    'cms.category.list', 'cms.category.create',
    'cms.menu.list', 'cms.menu.update',
    'cms.knowledge.list', 'cms.knowledge.create', 'cms.knowledge.search',
    'cms.settings.get', 'cms.settings.update',
  ],
  
  // 系统设置
  settings: [
    'settings.general.get', 'settings.general.update',
    'settings.integration.list', 'settings.integration.update',
    'settings.notification.list', 'settings.notification.update',
    'settings.ai.get', 'settings.ai.update',
  ],
};
```

---

## 五、与 AI OS 的集成

### 5.1 AI 助手入口

每个模块都支持通过 AI 助手进行操作：

```typescript
// AI 可以调用的模块能力
interface AiModuleCapability {
  module: string;
  description: string;
  availableTools: string[];
  examplePrompts: string[];
}

const moduleCapabilities: AiModuleCapability[] = [
  {
    module: 'project',
    description: '项目管理，包括项目、提案、交付物管理',
    availableTools: allTools.project,
    examplePrompts: [
      '创建一个新项目',
      '查看项目进度',
      '推进项目到下一阶段',
    ],
  },
  {
    module: 'finance',
    description: '财务管理，包括订单、结算、发票、收入',
    availableTools: allTools.finance,
    examplePrompts: [
      '生成本月结算单',
      '查看应收账款',
      '创建发票',
    ],
  },
  // ... 其他模块
];
```

### 5.2 跨模块工作流

AI 可以编排跨模块的工作流：

```typescript
// 示例：从报价到回款的完整流程
const quoteToPaymentWorkflow = {
  name: '报价到回款',
  steps: [
    { tool: 'service.quote.create', description: '创建报价单' },
    { tool: 'service.quote.send', description: '发送给客户' },
    { tool: 'contract.create', description: '生成合同' },
    { tool: 'contract.send_sign', description: '发起签署' },
    { tool: 'project.create', description: '创建项目' },
    { tool: 'project.phase.complete', description: '完成阶段' },
    { tool: 'finance.settlement.create', description: '创建结算单' },
    { tool: 'finance.invoice.create', description: '开具发票' },
    { tool: 'finance.payment.record', description: '记录回款' },
  ],
};
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [服务抽象模型](./服务抽象模型.md)
- [服务类型定义](./服务类型定义.md)
- [服务流程模板](./服务流程模板.md)
- [总体架构设计](../architecture/总体架构设计.md)

