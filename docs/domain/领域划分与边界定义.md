# dhs-atlas 领域划分与边界定义

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 架构宪章  
> **相关文档**: [总体架构设计](../architecture/总体架构设计.md) · [用户后台功能架构](./用户后台功能架构.md)

---

## 一、核心问题：谁是一等公民？

### 1.1 判断标准

从"可长期演进 + AI OS + 多租户 + 迁移"的角度，一级域必须满足：

| 标准 | 说明 |
|------|------|
| **独立边界上下文** | 有明确的领域边界，不与其他域混杂 |
| **独立数据主权** | 拥有自己的核心实体，不依赖其他域的数据定义 |
| **独立演进能力** | 可以独立迭代，不被其他域牵制 |
| **AI 可独立操作** | 有完整的 Tool 集，AI 可以独立完成域内任务 |
| **迁移可分离** | 在租户迁移时可以作为独立单元处理 |

### 1.2 域层级定义

```
┌─────────────────────────────────────────────────────────────────────┐
│                         域层级架构                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                    平台域 (Platform)                         │   │
│   │              租户 · 订阅 · AI网关 · 审计 · 事件              │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                              ▲                                      │
│                              │ 平台能力                             │
│   ┌──────────────────────────┴──────────────────────────────────┐   │
│   │                                                             │   │
│   │   ╔═══════════════════════════════════════════════════════╗ │   │
│   │   ║              核心业务域 (Core Business)                ║ │   │
│   │   ║                                                       ║ │   │
│   │   ║   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ ║ │   │
│   │   ║   │   服务   │  │   客户   │  │   项目   │  │   财务   │ ║ │   │
│   │   ║   │  (svc)  │  │  (crm)  │  │  (proj) │  │  (fin)  │ ║ │   │
│   │   ║   └─────────┘  └─────────┘  └─────────┘  └─────────┘ ║ │   │
│   │   ║                                                       ║ │   │
│   │   ╚═══════════════════════════════════════════════════════╝ │   │
│   │                                                             │   │
│   │   ┌─────────────────────────────────────────────────────┐   │   │
│   │   │              支撑域 (Supporting)                     │   │   │
│   │   │                                                     │   │   │
│   │   │   ┌─────────┐  ┌─────────┐                         │   │   │
│   │   │   │   合同   │  │   内容   │                         │   │   │
│   │   │   │(contract)│  │  (cms)  │                         │   │   │
│   │   │   └─────────┘  └─────────┘                         │   │   │
│   │   │                                                     │   │   │
│   │   └─────────────────────────────────────────────────────┘   │   │
│   │                                                             │   │
│   │   ┌─────────────────────────────────────────────────────┐   │   │
│   │   │              通用域 (Generic)                        │   │   │
│   │   │                                                     │   │   │
│   │   │   ┌─────────┐  ┌─────────┐  ┌─────────┐            │   │   │
│   │   │   │   组织   │  │   文件   │  │   设置   │            │   │   │
│   │   │   │  (org)  │  │  (file) │  │(settings)│            │   │   │
│   │   │   └─────────┘  └─────────┘  └─────────┘            │   │   │
│   │   │                                                     │   │   │
│   │   └─────────────────────────────────────────────────────┘   │   │
│   │                                                             │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 二、一级域定义（9 + 1）

### 2.1 域清单

| 域代码 | 域名称 | 层级 | 核心职责 |
|--------|--------|------|---------|
| `platform` | 平台域 | 平台 | 租户、订阅、AI、审计 |
| `svc` | 服务域 | 核心 | 服务定义、定价、报价 |
| `crm` | 客户域 | 核心 | 客户、联系人、分类 |
| `proj` | 项目域 | 核心 | 项目、提案、交付 |
| `fin` | 财务域 | 核心 | 订单、结算、发票、收入 |
| `contract` | 合同域 | 支撑 | 合同、范本、预检 |
| `cms` | 内容域 | 支撑 | 页面、文章、官网 |
| `org` | 组织域 | 通用 | 企业、部门、员工、权限 |
| `file` | 文件域 | 通用 | 文件存储、资产管理 |
| `settings` | 设置域 | 通用 | 系统配置 |

### 2.2 域之间的依赖关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                         域依赖关系                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                        ┌──────────┐                                │
│                        │ platform │                                │
│                        └────┬─────┘                                │
│                             │ 所有域都依赖                          │
│     ┌───────────────────────┼───────────────────────┐              │
│     │                       │                       │              │
│     ▼                       ▼                       ▼              │
│ ┌───────┐  ◄────────   ┌───────┐  ────────►   ┌───────┐           │
│ │  crm  │   客户        │  svc  │   服务定义   │  proj │           │
│ └───┬───┘              └───┬───┘              └───┬───┘           │
│     │                      │                      │                │
│     │   客户               │ 报价                 │ 项目            │
│     │                      ▼                      │                │
│     │              ┌─────────────┐                │                │
│     └─────────────►│  contract   │◄───────────────┘                │
│                    └──────┬──────┘                                 │
│                           │ 合同                                   │
│                           ▼                                        │
│                    ┌─────────────┐                                 │
│                    │     fin     │                                 │
│                    └─────────────┘                                 │
│                                                                     │
│   ───────────────────────────────────────────────────────────      │
│                                                                     │
│   ┌───────┐         ┌───────┐         ┌───────┐                   │
│   │  org  │         │ file  │         │  cms  │                   │
│   └───────┘         └───────┘         └───────┘                   │
│       ▲                 ▲                 │                        │
│       │                 │                 │                        │
│       └─────────────────┴─────────────────┘                        │
│                    被多个域依赖                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 依赖规则

| 规则 | 说明 |
|------|------|
| **核心域可以依赖通用域** | `svc` / `crm` / `proj` / `fin` 可以依赖 `org` / `file` |
| **核心域之间通过事件通信** | `svc` → `proj` 通过事件，不直接依赖 |
| **支撑域可以依赖核心域** | `contract` 可以依赖 `crm` / `svc` |
| **通用域不依赖业务域** | `org` / `file` 不依赖 `svc` / `crm` 等 |
| **所有域依赖平台域** | 所有业务域都依赖 `platform` 提供的能力 |

---

## 三、各域详细定义

### 3.1 平台域（platform）

**职责**：提供跨业务域的平台级能力

```
┌─────────────────────────────────────────────────────────────────────┐
│                        平台域 (platform)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   Tenant    │  │Subscription │  │   AIUsage   │               │
│   │   租户运行时 │  │   订阅计划   │  │  AI 用量    │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  EventLog   │  │  Artifact   │  │  AuditLog   │               │
│   │   事件日志   │  │   AI 产物   │  │   审计日志   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   核心能力：                                                         │
│   • 租户生命周期管理（创建/迁移/升降级）                             │
│   • 订阅与功能开关（Entitlements）                                  │
│   • AI 网关（调用/计量/审计）                                       │
│   • 事件系统（Event Bus）                                          │
│   • 全局审计                                                        │
│                                                                     │
│   Tool 前缀：platform.*                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**核心实体**：

```typescript
// 平台域实体（不绑定 enterpriseId，而是管理 enterpriseId）
interface Tenant { ... }           // 租户运行时
interface Subscription { ... }     // 订阅计划
interface FeatureFlag { ... }      // 功能开关
interface AIUsage { ... }          // AI 用量
interface EventLog { ... }         // 事件日志
interface AuditLog { ... }         // 审计日志
```

---

### 3.2 服务域（svc）

**职责**：定义企业能够提供的服务能力

```
┌─────────────────────────────────────────────────────────────────────┐
│                         服务域 (svc)                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   Service   │  │   Quote     │  │  Workflow   │               │
│   │    服务     │  │   报价单    │  │  Template   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  Category   │  │   Pricing   │  │   Addon     │               │
│   │   服务分类   │  │   Policy    │  │   Config    │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   边界内功能：                                                       │
│   • 服务管理（定义、分类、发布）                                     │
│   • 流程管理（Workflow Template）                                   │
│   • 价格政策（定价规则、折扣策略）                                   │
│   • 附加配置（增值服务项）                                          │
│   • 报价单（创建、发送、转换）                                      │
│                                                                     │
│   Tool 前缀：svc.*                                                  │
│                                                                     │
│   对外暴露：                                                         │
│   • Service（服务定义）→ 被 proj/contract/fin 引用                  │
│   • Quote（报价单）→ 可转换为 Contract/Project/Order                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**核心实体**：

```typescript
// 服务域实体（绑定 enterpriseId）
interface Service {
  id: string;
  enterpriseId: string;
  name: string;
  serviceType: ServiceType;
  pricingModel: PricingModel;
  deliveryModel: DeliveryModel;
  workflowTemplateId?: string;
  status: 'draft' | 'active' | 'archived';
}

interface Quote {
  id: string;
  enterpriseId: string;
  customerId: string;              // 引用 CRM 域
  items: QuoteItem[];
  status: QuoteStatus;
}

interface WorkflowTemplate {
  id: string;
  enterpriseId: string;
  phases: WorkflowPhaseTemplate[];
}
```

**边界事件（发出）**：

```typescript
// 服务域发出的事件
type SvcEvents = 
  | 'svc.service.created'
  | 'svc.service.updated'
  | 'svc.service.published'
  | 'svc.quote.created'
  | 'svc.quote.sent'
  | 'svc.quote.accepted'          // 触发 contract/proj/fin 创建
  | 'svc.quote.rejected';
```

---

### 3.3 客户域（crm）

**职责**：管理客户信息与关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                         客户域 (crm)                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  Customer   │  │   Contact   │  │  Category   │               │
│   │    客户     │  │   联系人    │  │   客户分类   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   边界内功能：                                                       │
│   • 客户管理（创建、编辑、合并、导入）                               │
│   • 联系人管理                                                      │
│   • 客户分类（行业、级别、标签）                                     │
│                                                                     │
│   Tool 前缀：crm.*                                                  │
│                                                                     │
│   对外暴露：                                                         │
│   • Customer（客户）→ 被所有业务域引用                              │
│   • Contact（联系人）→ 被 contract/proj 引用                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**核心实体**：

```typescript
// 客户域实体
interface Customer {
  id: string;
  enterpriseId: string;
  name: string;
  type: 'company' | 'individual';
  level?: CustomerLevel;
  status: CustomerStatus;
}

interface Contact {
  id: string;
  enterpriseId: string;
  customerId: string;
  name: string;
  isPrimary: boolean;
}
```

**被引用方式**：

```typescript
// 其他域通过 customerId 引用，不直接操作 Customer 实体
interface Quote {
  customerId: string;              // 引用 CRM
}

interface Project {
  customerId: string;              // 引用 CRM
}

interface Contract {
  customerId: string;              // 引用 CRM
}
```

---

### 3.4 项目域（proj）

**职责**：管理服务的执行与交付

```
┌─────────────────────────────────────────────────────────────────────┐
│                         项目域 (proj)                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   Project   │  │  Proposal   │  │ Deliverable │               │
│   │    项目     │  │    提案     │  │   交付物    │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   Phase     │  │    Task     │  │   Member    │               │
│   │   项目阶段   │  │    任务     │  │   项目成员   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   边界内功能：                                                       │
│   • 项目管理（创建、阶段推进、状态跟踪）                             │
│   • 提案管理（创建、版本、发送、状态）                               │
│   • 交付管理（上传、审核、验收）                                    │
│   • 任务管理（创建、分配、完成）                                    │
│   • 团队管理（成员分配）                                            │
│                                                                     │
│   Tool 前缀：proj.*                                                 │
│                                                                     │
│   依赖：                                                            │
│   • svc.Service（服务定义）                                         │
│   • svc.WorkflowTemplate（流程模板）                                │
│   • crm.Customer（客户）                                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**核心实体**：

```typescript
// 项目域实体
interface Project {
  id: string;
  enterpriseId: string;
  
  // 引用
  customerId: string;              // 引用 CRM
  serviceId: string;               // 引用 SVC
  quoteId?: string;                // 引用 SVC
  contractId?: string;             // 引用 Contract
  
  // 自有
  name: string;
  phases: ProjectPhase[];
  status: ProjectStatus;
}

interface Proposal {
  id: string;
  enterpriseId: string;
  customerId: string;
  content: string;
  status: ProposalStatus;
}

interface Deliverable {
  id: string;
  enterpriseId: string;
  projectId: string;
  phaseId: string;
  fileId?: string;                 // 引用 File 域
  status: DeliverableStatus;
}
```

**边界事件（发出）**：

```typescript
type ProjEvents = 
  | 'proj.project.created'
  | 'proj.phase.started'
  | 'proj.phase.completed'         // 触发 fin 结算
  | 'proj.deliverable.accepted'
  | 'proj.project.completed';      // 触发 fin 最终结算
```

---

### 3.5 财务域（fin）

**职责**：管理订单、结算、发票、收入

```
┌─────────────────────────────────────────────────────────────────────┐
│                         财务域 (fin)                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │    Order    │  │ Settlement  │  │   Invoice   │               │
│   │    订单     │  │   结算单    │  │    发票     │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐                                │
│   │   Payment   │  │ Performance │                                │
│   │    回款     │  │    绩效     │                                │
│   └─────────────┘  └─────────────┘                                │
│                                                                     │
│   边界内功能：                                                       │
│   • 订单管理（创建、确认、取消）                                    │
│   • 结算管理（创建、审核、开票）                                    │
│   • 发票管理（申请、开具、冲红）                                    │
│   • 收入管理（回款记录、应收账龄）                                  │
│   • 绩效管理（项目利润、人员绩效）                                  │
│                                                                     │
│   Tool 前缀：fin.*                                                  │
│                                                                     │
│   依赖：                                                            │
│   • crm.Customer（客户）                                            │
│   • proj.Project（项目）                                            │
│   • contract.Contract（合同）                                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**核心实体**：

```typescript
// 财务域实体
interface Order {
  id: string;
  enterpriseId: string;
  
  customerId: string;              // 引用 CRM
  quoteId?: string;                // 引用 SVC
  contractId?: string;             // 引用 Contract
  projectId?: string;              // 引用 Proj
  
  items: OrderItem[];
  total: number;
  status: OrderStatus;
}

interface Settlement {
  id: string;
  enterpriseId: string;
  
  customerId: string;
  projectId?: string;
  
  items: SettlementItem[];
  total: number;
  status: SettlementStatus;
}

interface Invoice {
  id: string;
  enterpriseId: string;
  
  customerId: string;
  settlementId?: string;
  
  total: number;
  status: InvoiceStatus;
}

interface Payment {
  id: string;
  enterpriseId: string;
  
  customerId: string;
  invoiceId?: string;
  
  amount: number;
  paymentDate: Date;
}
```

---

### 3.6 合同域（contract）

**职责**：管理合同全生命周期

```
┌─────────────────────────────────────────────────────────────────────┐
│                        合同域 (contract)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  Contract   │  │  Template   │  │   Review    │               │
│   │    合同     │  │   合同范本   │  │   预检结果   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐                                │
│   │ Placeholder │  │    Rule     │                                │
│   │   占位符    │  │  规则语义库  │                                │
│   └─────────────┘  └─────────────┘                                │
│                                                                     │
│   边界内功能：                                                       │
│   • 合同管理（创建、审核、签署、归档）                               │
│   • 合同范本（创建、变量定义）                                      │
│   • 合同预检（AI 预检、风险识别）                                   │
│   • 占位符（系统/自定义占位符）                                     │
│   • 规则语义库（预检规则定义）                                      │
│                                                                     │
│   Tool 前缀：contract.*                                             │
│                                                                     │
│   依赖：                                                            │
│   • crm.Customer（客户）                                            │
│   • svc.Quote（报价单）                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.7 内容域（cms）

**职责**：管理官网内容与知识库

```
┌─────────────────────────────────────────────────────────────────────┐
│                         内容域 (cms)                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │    Page     │  │   Article   │  │  Knowledge  │               │
│   │    页面     │  │    文章     │  │   知识文档   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │  Category   │  │    Menu     │  │   Settings  │               │
│   │   文章分类   │  │    菜单     │  │   官网设置   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   边界内功能：                                                       │
│   • 页面管理（首页、关于、服务页等）                                │
│   • 文章管理（创建、分类、发布）                                    │
│   • 知识库（知识文档、全文搜索）                                    │
│   • 菜单管理（导航菜单）                                            │
│   • 官网设置（域名、SEO、样式）                                     │
│                                                                     │
│   Tool 前缀：cms.*                                                  │
│                                                                     │
│   相对独立，主要被 file 域依赖                                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.8 组织域（org）

**职责**：管理组织架构与权限

```
┌─────────────────────────────────────────────────────────────────────┐
│                         组织域 (org)                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │ Enterprise  │  │ Department  │  │  Employee   │               │
│   │    企业     │  │    部门     │  │    员工     │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   ┌─────────────┐  ┌─────────────┐                                │
│   │    Role     │  │ Permission  │                                │
│   │    角色     │  │    权限     │                                │
│   └─────────────┘  └─────────────┘                                │
│                                                                     │
│   边界内功能：                                                       │
│   • 企业信息（基本信息、工商税务）                                  │
│   • 部门管理（组织架构）                                            │
│   • 员工管理（邀请、调岗、禁用）                                    │
│   • 权限管理（角色、权限配置）                                      │
│                                                                     │
│   Tool 前缀：org.*                                                  │
│                                                                     │
│   被所有业务域依赖（员工、部门、权限）                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**特殊说明**：

```typescript
// Enterprise 是特殊实体，是多租户的核心
interface Enterprise {
  id: string;                      // 就是 enterpriseId
  name: string;
  status: 'active' | 'suspended';
  // ...
}

// Employee 关联 User（跨域）
interface Employee {
  id: string;
  enterpriseId: string;
  userId: string;                  // 引用 Platform 域的 User
  // ...
}
```

---

### 3.9 文件域（file）

**职责**：管理文件存储与资产

```
┌─────────────────────────────────────────────────────────────────────┐
│                         文件域 (file)                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   核心实体：                                                         │
│   ┌─────────────┐  ┌─────────────┐                                │
│   │    File     │  │   Folder    │                                │
│   │    文件     │  │   文件夹    │                                │
│   └─────────────┘  └─────────────┘                                │
│                                                                     │
│   边界内功能：                                                       │
│   • 文件管理（上传、下载、预览）                                    │
│   • 文件夹管理（创建、移动）                                        │
│   • 交付资产（关联项目的资产）                                      │
│   • 存储配置（配额、清理策略）                                      │
│                                                                     │
│   Tool 前缀：file.*                                                 │
│                                                                     │
│   被多个域依赖（proj.Deliverable, cms.Article 等）                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 3.10 设置域（settings）

**职责**：管理系统配置

```
┌─────────────────────────────────────────────────────────────────────┐
│                        设置域 (settings)                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   配置分类：                                                         │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │
│   │   General   │  │ Integration │  │Notification │               │
│   │   通用设置   │  │   集成配置   │  │   通知设置   │               │
│   └─────────────┘  └─────────────┘  └─────────────┘               │
│                                                                     │
│   边界内功能：                                                       │
│   • 通用设置（时区、语言、货币、编号规则）                          │
│   • 集成配置（邮件、短信、存储、支付）                              │
│   • 通知设置（模板、规则、渠道）                                    │
│   • AI 配置（开关、模型选择）                                       │
│                                                                     │
│   Tool 前缀：settings.*                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 四、核心业务流的域协作

### 4.1 报价到回款全流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                      报价到回款全流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   1. 获客阶段                                                       │
│   ┌───────┐                                                        │
│   │  crm  │ ─────► Customer 创建                                   │
│   └───────┘                                                        │
│       │                                                            │
│       ▼                                                            │
│   2. 报价阶段                                                       │
│   ┌───────┐                                                        │
│   │  svc  │ ─────► Quote 创建 → 发送 → 接受                        │
│   └───────┘        │                                               │
│       │            │ svc.quote.accepted                            │
│       ▼            ▼                                               │
│   3. 合同阶段                                                       │
│   ┌───────────┐                                                    │
│   │ contract  │ ─────► Contract 创建 → 审核 → 签署                 │
│   └───────────┘        │                                           │
│       │                │ contract.signed                           │
│       ▼                ▼                                           │
│   4. 项目阶段                                                       │
│   ┌───────┐                                                        │
│   │  proj │ ─────► Project 创建 → 阶段推进 → 交付验收               │
│   └───────┘        │                                               │
│       │            │ proj.phase.completed                          │
│       ▼            ▼                                               │
│   5. 财务阶段                                                       │
│   ┌───────┐                                                        │
│   │  fin  │ ─────► Settlement → Invoice → Payment                  │
│   └───────┘                                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 事件驱动的域协作

```typescript
// 域之间通过事件协作，不直接调用
// 示例：报价接受后的联动

// SVC 域发出事件
await eventBus.emit('svc.quote.accepted', {
  enterpriseId,
  quoteId,
  customerId,
  serviceId,
  totalAmount,
});

// Contract 域监听
eventBus.on('svc.quote.accepted', async (event) => {
  // 自动创建合同草稿
  await contractService.createFromQuote(event.quoteId);
});

// Proj 域监听
eventBus.on('svc.quote.accepted', async (event) => {
  // 自动创建项目草稿
  await projectService.createFromQuote(event.quoteId);
});

// Fin 域监听
eventBus.on('svc.quote.accepted', async (event) => {
  // 自动创建订单
  await orderService.createFromQuote(event.quoteId);
});
```

---

## 五、Monorepo 目录结构

### 5.1 按域组织

```
dhs-atlas/
├── apps/
│   ├── console/                   # 用户后台（Tenant Console）
│   └── platform/                  # 平台后台（Platform Console）
│
├── packages/
│   ├── platform/                  # 平台域
│   │   ├── tenant/
│   │   ├── subscription/
│   │   ├── ai-gateway/
│   │   ├── event-bus/
│   │   └── audit/
│   │
│   ├── shared/                    # 共享工具
│   │   ├── types/
│   │   ├── schemas/
│   │   └── utils/
│   │
│   └── ui/                        # UI 组件（shadcn/ui）
│
├── domains/                       # 业务域
│   ├── svc/                       # 服务域
│   │   ├── entities/
│   │   ├── tools/
│   │   ├── workflows/
│   │   └── events/
│   │
│   ├── crm/                       # 客户域
│   │   ├── entities/
│   │   ├── tools/
│   │   └── events/
│   │
│   ├── proj/                      # 项目域
│   │   ├── entities/
│   │   ├── tools/
│   │   ├── workflows/
│   │   └── events/
│   │
│   ├── fin/                       # 财务域
│   │   ├── entities/
│   │   ├── tools/
│   │   └── events/
│   │
│   ├── contract/                  # 合同域
│   │   ├── entities/
│   │   ├── tools/
│   │   └── events/
│   │
│   ├── cms/                       # 内容域
│   │   ├── entities/
│   │   ├── tools/
│   │   └── events/
│   │
│   ├── org/                       # 组织域
│   │   ├── entities/
│   │   ├── tools/
│   │   └── events/
│   │
│   ├── file/                      # 文件域
│   │   ├── entities/
│   │   ├── tools/
│   │   └── events/
│   │
│   └── settings/                  # 设置域
│       ├── entities/
│       └── tools/
│
└── docs/
```

### 5.2 域内结构规范

```
domains/{domain}/
├── entities/                      # 领域实体
│   ├── {entity}.ts
│   └── index.ts
│
├── tools/                         # 域工具
│   ├── {entity}.{action}.ts
│   └── index.ts
│
├── workflows/                     # 域工作流（如有）
│   ├── {workflow}.ts
│   └── index.ts
│
├── events/                        # 域事件定义
│   ├── types.ts
│   └── handlers.ts
│
├── repos/                         # 数据访问
│   ├── {entity}.repo.ts
│   └── index.ts
│
└── index.ts                       # 域入口
```

---

## 六、迁移与隔离

### 6.1 域级数据迁移

```typescript
// 每个域的数据可以独立迁移
interface DomainMigrationUnit {
  domain: string;
  tables: string[];
  dependencies: string[];          // 依赖的其他域
}

const migrationUnits: DomainMigrationUnit[] = [
  // 通用域先迁移（无依赖）
  { domain: 'org', tables: ['enterprise', 'department', 'employee', 'role'], dependencies: [] },
  { domain: 'file', tables: ['file', 'folder'], dependencies: [] },
  { domain: 'settings', tables: ['settings'], dependencies: [] },
  
  // 核心域按依赖顺序迁移
  { domain: 'crm', tables: ['customer', 'contact', 'customer_category'], dependencies: ['org'] },
  { domain: 'svc', tables: ['service', 'quote', 'workflow_template', ...], dependencies: ['org', 'crm'] },
  { domain: 'contract', tables: ['contract', 'contract_template', ...], dependencies: ['crm', 'svc'] },
  { domain: 'proj', tables: ['project', 'proposal', 'deliverable', ...], dependencies: ['crm', 'svc', 'contract'] },
  { domain: 'fin', tables: ['order', 'settlement', 'invoice', 'payment'], dependencies: ['crm', 'proj', 'contract'] },
  
  // 支撑域
  { domain: 'cms', tables: ['page', 'article', 'menu', ...], dependencies: ['file'] },
];
```

### 6.2 域级功能开关

```typescript
// 每个域可以独立控制功能开关
const domainFeatures: Record<string, string[]> = {
  svc: ['svc.service.manage', 'svc.quote.create', 'svc.workflow.manage'],
  crm: ['crm.customer.manage', 'crm.contact.manage'],
  proj: ['proj.project.manage', 'proj.proposal.manage', 'proj.delivery.manage'],
  fin: ['fin.order.manage', 'fin.settlement.manage', 'fin.invoice.manage'],
  contract: ['contract.manage', 'contract.template.manage', 'contract.review'],
  cms: ['cms.page.manage', 'cms.article.manage', 'cms.knowledge.manage'],
  org: ['org.department.manage', 'org.employee.manage', 'org.role.manage'],
  file: ['file.manage', 'file.asset.manage'],
  settings: ['settings.manage'],
};
```

---

## 七、总结

### 7.1 一等公民清单

| 层级 | 域 | 代码 | 核心价值 |
|------|-----|------|---------|
| **平台** | 平台域 | `platform` | 租户、订阅、AI、审计 |
| **核心** | 服务域 | `svc` | 定义"卖什么" |
| **核心** | 客户域 | `crm` | 管理"卖给谁" |
| **核心** | 项目域 | `proj` | 管理"怎么交付" |
| **核心** | 财务域 | `fin` | 管理"收多少钱" |
| **支撑** | 合同域 | `contract` | 法律保障 |
| **支撑** | 内容域 | `cms` | 获客与品牌 |
| **通用** | 组织域 | `org` | 组织与权限 |
| **通用** | 文件域 | `file` | 文件存储 |
| **通用** | 设置域 | `settings` | 系统配置 |

### 7.2 核心原则

| 原则 | 说明 |
|------|------|
| **边界清晰** | 每个域有明确的职责边界 |
| **依赖单向** | 核心域可依赖通用域，反之不行 |
| **事件驱动** | 域之间通过事件协作，不直接调用 |
| **独立演进** | 每个域可以独立迭代 |
| **迁移可分** | 域级数据可独立迁移 |

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [总体架构设计](../architecture/总体架构设计.md)
- [用户后台功能架构](./用户后台功能架构.md)
- [服务抽象模型](./服务抽象模型.md)

