# 小模型优化规范

## Small Model Optimization Specification

本文档定义了如何设计工具、提示词和系统架构，使小参数模型（8B 以下）能够稳定、高效地驱动复杂业务系统。

---

## 核心理念

> **让 AI 做它擅长的事（理解、表达），把它不擅长的事（计算、推理）交给系统。**

小模型的优势：
- 响应速度快（毫秒级）
- 成本低（本地部署/便宜 API）
- 意图识别准确（这是模型的核心能力）

小模型的劣势：
- 复杂多步推理弱
- 数学计算不准确
- 长上下文容易丢失信息

**解决思路：不要让小模型做它不擅长的事。**

---

## 一、工具命名：一眼看懂

### 原则：名字即文档

小模型的上下文窗口有限，工具名字必须**自解释**。

```
❌ 差的命名（需要看描述才懂）
- process_data
- handle_request  
- do_action
- run_query

✅ 好的命名（一眼看懂）
- search_client_by_name
- count_projects_by_status
- get_contact_stats
- create_new_invoice
```

### 命名公式

```
{动词}_{对象}[_by_{条件}]

动词（动作）：
  search  搜索（模糊匹配）
  get     获取（精确获取）
  list    列表（获取多个）
  count   计数
  create  创建
  update  更新
  delete  删除
  stats   统计

对象（目标）：
  client, project, contact, invoice, contract...

条件（可选）：
  by_name, by_status, by_date, by_client...
```

### 示例对比

| 业务需求 | ❌ 模糊命名 | ✅ 清晰命名 |
|----------|-----------|------------|
| 按名称搜索客户 | `query_db` | `search_client_by_name` |
| 统计项目数量 | `get_stats` | `count_projects_by_status` |
| 获取联系人统计 | `analyze` | `get_contact_stats_for_client` |
| 创建新发票 | `process` | `create_invoice` |

---

## 二、工具描述：精准简短

### 原则：20 字以内

小模型的注意力有限，描述必须**精准且简短**。

```
❌ 差的描述（太长，关键信息被稀释）
"这个工具用于在数据库中搜索客户信息，支持按名称、地址、
分类等多种条件进行模糊匹配查询，返回匹配的客户列表，
包含客户的基本信息、联系方式、开票信息等完整数据..."

✅ 好的描述（精准简短）
"按名称搜索客户，返回匹配列表"
```

### 描述模板

```
{动作} + {对象} + [条件] + {返回值}

示例：
- "按名称搜索客户，返回匹配列表"
- "统计客户的联系人项目数"
- "创建新客户，需要名称"
- "获取项目详情，按 ID"
```

### 描述检查清单

- [ ] 不超过 20 个中文字符
- [ ] 包含核心动作
- [ ] 说明返回什么
- [ ] 不包含技术细节

---

## 三、参数设计：最小化

### 原则：能省则省

参数越少，小模型出错的概率越低。

```
❌ 差的设计（参数太多）
{
  "collection": "clients",
  "operation": "find",
  "query": {"name": {"$regex": "xxx"}},
  "projection": {"_id": 1, "name": 1},
  "limit": 10,
  "skip": 0,
  "sort": {"createdAt": -1}
}

✅ 好的设计（参数最少）
{
  "keyword": "中信出版社"
}
```

### 参数设计规则

| 规则 | 说明 | 示例 |
|------|------|------|
| **必需最小化** | 只保留必须的参数 | `keyword` 是必须的 |
| **默认值覆盖** | 常用值设为默认 | `limit` 默认 10 |
| **业务语义** | 用业务术语 | `clientName` 而非 `query.name` |
| **类型简单** | 优先用 string/number | 避免复杂嵌套对象 |

### 参数数量建议

| 工具类型 | 建议参数数 | 说明 |
|----------|-----------|------|
| 搜索 | 1-2 | keyword + limit |
| 获取详情 | 1 | id |
| 统计 | 1-2 | targetName + options |
| 创建 | 2-5 | 核心字段 |

---

## 四、返回值设计：可直接使用

### 原则：零加工

小模型不应该对返回数据做任何"理解"或"计算"。

```
❌ 差的返回（需要 AI 加工）
{
  "projects": [
    {"contact": "张三", "amount": 100},
    {"contact": "张三", "amount": 200},
    {"contact": "李四", "amount": 150}
  ]
}
// AI 需要：遍历 → 分组 → 求和 → 排序
// 小模型很容易出错

✅ 好的返回（可直接使用）
{
  "stats": [
    {"name": "张三", "total": 300, "count": 2},
    {"name": "李四", "total": 150, "count": 1}
  ],
  "top": "张三（¥300）"
}
// AI 只需：格式化输出
// 小模型轻松胜任
```

### 返回值设计规则

| 规则 | 说明 |
|------|------|
| **预计算** | 统计、求和、排序在工具层完成 |
| **扁平化** | 避免超过 2 层嵌套 |
| **包含总结** | 提供 `summary` 或 `top` 字段 |
| **格式一致** | 同类工具返回格式统一 |

### 返回值模板

```typescript
// 列表类
{
  items: Array<{id, name, ...}>,
  total: number,
  hasMore: boolean
}

// 详情类
{
  id: string,
  name: string,
  ...其他字段
}

// 统计类
{
  items: Array<{name, value, ...}>,
  summary: {
    total: number,
    top: string,      // "张三（100）"
    average?: number
  }
}

// 操作类
{
  success: boolean,
  id?: string,
  message: string
}
```

---

## 五、示例设计：3 个足够

### 原则：精准 > 数量

小模型的上下文有限，3 个精准示例比 10 个模糊示例更有效。

### 示例结构

```
示例 1：最常见场景
示例 2：边界场景  
示例 3：空结果场景
```

### 示例模板

```markdown
**示例 1：常见查询**
用户: "查一下中信出版社"
工具: search_client_by_name(keyword="中信出版社")
返回: {items: [{name: "中信出版社", ...}], total: 1}

**示例 2：模糊查询**
用户: "有没有出版社的客户"
工具: search_client_by_name(keyword="出版社")
返回: {items: [...], total: 5}

**示例 3：无结果**
用户: "找一下 ABC 公司"
工具: search_client_by_name(keyword="ABC")
返回: {items: [], total: 0}
输出: "未找到 ABC 公司的记录"
```

---

## 六、系统提示词：极简

### 原则：角色 + 能力 + 约束

小模型的系统提示词应该极简，只包含必要信息。

```
❌ 差的提示词（太长，信息过载）

你是一个专业的客户关系管理助手，负责帮助用户管理客户信息。
你需要遵循以下规则：
1. 始终保持专业和友好的态度
2. 回答用户问题时要简洁明了
3. 如果不确定，要主动询问用户
4. 不要编造数据
5. 使用 Markdown 格式输出
6. 表格数据用表格展示
7. ...（更多规则）
```

```
✅ 好的提示词（极简有效）

你是客户管理助手。

你的工具：
- search_client_by_name: 搜索客户
- get_contact_stats: 联系人统计
- create_client: 创建客户

规则：
- 用工具查数据，不要编造
- 用 Markdown 表格输出
```

### 提示词模板

```markdown
你是{角色}。

你的工具：
{工具列表，每个一行}

规则：
- 用工具查数据
- 用 Markdown 输出
- 不编造数据
```

### 字数限制

| 模型规模 | 系统提示词建议长度 |
|----------|-------------------|
| 70B+ | 2000 tokens |
| 8-30B | 500-1000 tokens |
| 1-8B | < 500 tokens |

---

## 七、对话设计：单轮优先

### 原则：减少上下文依赖

小模型的多轮对话能力较弱，设计时应优先考虑单轮完成。

```
❌ 多轮依赖（小模型容易丢失上下文）

用户: "查一下中信出版社"
AI: "找到了中信出版社"
用户: "他们有多少项目？"  // 需要记住"中信出版社"
AI: ???  // 小模型可能忘记了

✅ 单轮完成（无上下文依赖）

用户: "查一下中信出版社有多少项目"
AI: 调用 get_project_count(clientName="中信出版社")
AI: "中信出版社有 7 个项目"
```

### 设计策略

| 策略 | 说明 |
|------|------|
| **参数完整** | 工具调用包含所有必要参数 |
| **结果自包含** | 返回值包含完整上下文 |
| **提示补全** | 引导用户提供完整信息 |

---

## 八、错误处理：明确反馈

### 原则：告诉用户发生了什么

小模型不擅长处理异常情况，系统应该提供明确的错误信息。

```typescript
// 工具返回标准错误格式
{
  success: false,
  error: {
    code: "NOT_FOUND",
    message: "未找到客户：ABC 公司",
    suggestion: "请检查名称是否正确，或尝试模糊搜索"
  }
}
```

### 常见错误码

| 错误码 | 含义 | 建议回复 |
|--------|------|----------|
| `NOT_FOUND` | 未找到 | "未找到 XXX" |
| `INVALID_PARAM` | 参数错误 | "请提供 XXX" |
| `NO_PERMISSION` | 无权限 | "您没有权限执行此操作" |
| `SYSTEM_ERROR` | 系统错误 | "系统繁忙，请稍后重试" |

---

## 九、完整示例：小模型友好的工具定义

### 工具定义

```typescript
{
  id: "search_client",
  name: "搜索客户",
  description: "按名称搜索客户，返回匹配列表",
  
  params: {
    keyword: {
      type: "string",
      required: true,
      description: "客户名称关键词"
    }
  },
  
  examples: [
    {
      input: "查中信出版社",
      call: 'search_client(keyword="中信出版社")',
      output: '{items: [{name: "中信出版社"}], total: 1}'
    }
  ]
}
```

### 系统提示词

```
你是客户管理助手。

工具：
- search_client(keyword): 搜索客户
- get_contact_stats(clientName): 联系人统计

规则：用工具查数据，Markdown 表格输出。
```

### 对话流程

```
用户: 查一下中信出版社的联系人情况

AI 思考: 需要联系人统计 → 调用 get_contact_stats

工具调用: get_contact_stats(clientName="中信出版社")

工具返回:
{
  "contacts": [
    {"name": "丁媛媛", "count": 2},
    {"name": "立晓", "count": 1}
  ],
  "top": "丁媛媛（2个项目）"
}

AI 输出:
| 联系人 | 项目数 |
|--------|--------|
| 丁媛媛 | 2 |
| 立晓 | 1 |

项目最多的是 **丁媛媛**（2个项目）。
```

---

## 十、检查清单

设计小模型友好的系统时，使用此清单：

### 工具设计
- [ ] 工具名 ≤ 30 字符，自解释
- [ ] 描述 ≤ 20 中文字符
- [ ] 必需参数 ≤ 3 个
- [ ] 返回值扁平，包含 summary
- [ ] 示例 3 个，覆盖常见/边界/空结果

### 系统提示词
- [ ] 总长度 < 500 tokens（小模型）
- [ ] 只包含角色、工具、核心规则
- [ ] 不包含冗长的约束条款

### 对话设计
- [ ] 单轮可完成优先
- [ ] 工具参数自包含
- [ ] 错误信息明确

---

## 十一、推荐模型配置

### 本地部署推荐

| 场景 | 推荐模型 | 参数量 | VRAM 需求 |
|------|----------|--------|-----------|
| 开发测试 | Qwen2.5-3B | 3B | 4GB |
| 生产基础 | Llama-3.2-8B | 8B | 8GB |
| 生产增强 | Qwen2.5-14B | 14B | 16GB |

### API 服务推荐

| 场景 | 推荐模型 | 成本 |
|------|----------|------|
| 开发测试 | GPT-4o-mini | 极低 |
| 生产基础 | Claude-3-Haiku | 低 |
| 生产增强 | GPT-4o | 中 |

### 模型配置

```typescript
// 推荐配置（小模型优化）
{
  temperature: 0.3,     // 降低随机性
  max_tokens: 1000,     // 限制输出长度
  top_p: 0.9,           // 略微收紧采样
  presence_penalty: 0,  // 不惩罚重复
  frequency_penalty: 0  // 不惩罚频率
}
```

---

## 总结

> **好的架构让小模型变成大师，差的架构让大模型变成笨蛋。**

遵循以下原则，8B 模型足以驱动复杂的 B 端系统：

1. **命名自解释** - 工具名即文档
2. **描述极简** - 20 字以内
3. **参数最少** - 能省则省
4. **返回直用** - 零加工
5. **示例精准** - 3 个足够
6. **提示极简** - 500 tokens 以内
7. **单轮优先** - 减少上下文依赖

---

*文档版本：v1.0*
*最后更新：2024年12月*

