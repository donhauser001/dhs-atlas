# AI 原生架构升级规划

> **文档版本**: v1.0  
> **创建日期**: 2024-12-28  
> **文档性质**: 战略规划文档  
> **核心理念**: 从「带有 AI 功能的传统工具」升级为「以 AI 为核心的原生应用」

---

## 一、现状问题诊断

### 1.1 核心问题总结

当前系统的 AI 能力存在以下结构性问题：

| 问题类型 | 具体表现 |
|----------|---------|
| **碎片化** | AI 功能分散在 6+ 个独立模块，每个页面独立入口 |
| **机械感** | 固定流程、进度条、结果列表，交互不自然 |
| **能力分散** | 解析/分析/扫描/生成各自为战，用户需手动串联 |
| **无系统架构** | 服务之间不知道彼此存在，缺少统一协调层 |
| **填充式体验** | 在传统 CRUD 页面上添加 AI 按钮，而非重新设计 |

### 1.2 根本原因

**缺少「AI Agent 层」**：系统按「功能模块」组织，而非按「用户任务」组织。用户需要学习工具的结构、记住功能的位置、手动串联流程，而不是直接表达需求让 AI 来完成。

### 1.3 当前 vs 应有体验对比

| 维度 | 当前系统（填充式） | AI 原生应有的体验 |
|------|-------------------|-------------------|
| **入口** | 6+ 个分散入口 | 单一对话入口，AI 自动路由 |
| **交互模式** | 表单 + 按钮触发 | 自然语言对话 |
| **上下文** | 每个会话独立 | 全局上下文感知 |
| **主动性** | 被动等待操作 | 主动提示、建议、预警 |
| **任务编排** | 用户手动串联 | AI 自动编排多步骤 |
| **反馈形式** | 进度条 + 列表 | 对话式解释和讨论 |

---

## 二、核心理念

### 2.1 统一 AI 助手

**核心思想**：不为每个模块单独开发 AI 组件，而是做一个整体的统一 AI 助手组件。

**形态设计**：
- 悬浮在页面右下角，随时可唤起
- 支持快捷键唤起（如 Cmd/Ctrl + K）
- 不打断用户当前工作流

**核心能力**：
- 自动感知当前页面所属模块
- 根据上下文推断可用操作
- 调用合适的工具和工作流
- 必要时自动切换页面

### 2.2 工具调用化

**概念**：将系统的各项能力抽象为「工具」，AI 根据用户意图自动选择和调用。

**工具分类**：
| 类型 | 示例 |
|------|------|
| 合同工具 | 解析合同、风险扫描、生成合同、导出文档 |
| 客户工具 | 查询客户、分析合作历史、创建客户 |
| 项目工具 | 创建项目、查询进度、任务分配 |
| 报价工具 | 计算报价、生成报价单、价格策略分析 |
| 系统工具 | 页面导航、发送通知、文件操作 |

**工具特性**：
- 每个工具有清晰的输入/输出定义
- 工具可标注适用的模块范围
- 工具支持进度报告（用于实时反馈）

### 2.3 工作流调用化

**概念**：将常见的多步骤任务编排为「工作流」，AI 可识别并自动执行。

**工作流示例**：
| 工作流 | 包含步骤 |
|--------|---------|
| 合同导入流程 | 上传 → 解析 → 结构分析 → 风险扫描 → 汇总报告 |
| 新合同创建流程 | 收集信息 → 匹配模板 → 生成合同 → 审核建议 |
| 客户跟进流程 | 查询客户 → 分析历史 → 生成建议 → 创建任务 |

**工作流特性**：
- 可通过关键词或意图触发
- 步骤之间自动传递数据
- 支持条件分支和错误处理
- 中间结果实时反馈

### 2.4 页面感知机制

**概念**：AI 助手能自动感知用户当前所在的页面和上下文。

**感知内容**：
| 信息类型 | 说明 |
|----------|------|
| 当前模块 | 合同/客户/项目/报价/模板等 |
| 页面类型 | 列表/详情/编辑/创建 |
| 当前实体 | 正在查看的具体记录（如某份合同） |
| 选中状态 | 列表中选中的项目 |
| 表单数据 | 编辑中的表单内容 |
| 可用操作 | 当前页面可执行的操作列表 |

**应用场景**：
- 用户在合同详情页说「分析风险」→ AI 知道要分析哪份合同
- 用户在列表页选中 3 个项目说「对比一下」→ AI 知道对比哪 3 个
- 用户说「创建项目」→ AI 根据当前页面判断是否需要跳转

### 2.5 跨模块导航

**概念**：当任务需要跨模块操作时，AI 可自动切换页面。

**交互模式**：
1. AI 判断需要跳转
2. 向用户说明原因（如「我需要跳转到客户详情页查看合作历史」）
3. 自动执行导航
4. 在新页面继续任务

**原则**：
- 导航前告知用户
- 导航后保持对话上下文
- 支持用户拒绝导航

### 2.6 IDE 化设计理念

**核心思想**：借鉴现代 IDE（如 VS Code、Cursor）的设计思路，让整个后台工具化，更利于 AI 工作，同时保留人工操作的完整能力。

**为什么选择 IDE 化**：

| 传统企业后台 | IDE 化设计 |
|-------------|-----------|
| 页面驱动，功能分散 | 工作区驱动，功能集中 |
| 菜单层层嵌套 | 命令面板快速定位 |
| 鼠标点击为主 | 键盘操作优先 |
| 难以被 AI 控制 | 操作可编程，AI 友好 |
| 功能入口隐藏在各处 | 统一的命令接口 |

**IDE 核心元素借鉴**：

| IDE 元素 | 在本系统中的对应 |
|----------|-----------------|
| **命令面板** (Cmd+P) | 全局命令搜索，快速执行任何操作 |
| **侧边栏** | 模块导航 + 当前上下文信息 |
| **编辑器区** | 主工作区，显示当前正在处理的内容 |
| **面板区** | AI 助手、输出日志、预览等 |
| **状态栏** | 当前状态、快捷信息 |
| **快捷键系统** | 常用操作都有快捷键 |

**命令面板设计**：
- 按 `Cmd/Ctrl + P` 唤起
- 支持模糊搜索所有可用命令
- 显示命令的快捷键
- 最近使用的命令优先
- AI 和人使用同一套命令接口

### 2.7 人机双轨操作原则

**核心思想**：任何一个操作，都必须确保人可以手动完成。AI 不是替代人，而是给人提供另一种更高效的操作方式。

**双轨设计**：
```
              ┌─────────────────────────────────────┐
              │           系统操作层                 │
              │  (统一的命令/工具/API 接口)         │
              └───────────────┬─────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
       ┌─────────────┐                ┌─────────────┐
       │   人工轨道   │                │   AI 轨道   │
       │             │                │             │
       │ • 点击按钮  │                │ • 自然语言  │
       │ • 表单填写  │                │ • 意图识别  │
       │ • 快捷键    │                │ • 自动调用  │
       │ • 命令面板  │                │ • 智能编排  │
       └─────────────┘                └─────────────┘
              │                               │
              └───────────────┬───────────────┘
                              │
                              ▼
                      ┌─────────────┐
                      │  执行结果   │
                      │  (相同的)   │
                      └─────────────┘
```

**关键原则**：

| 原则 | 说明 |
|------|------|
| **操作等价** | AI 执行的操作，人也能通过 UI 完成 |
| **结果一致** | 无论谁触发，最终效果完全相同 |
| **可审计** | 能看到 AI 做了什么，等价于人做了什么 |
| **可接管** | 任何时候人都可以接管，继续手动操作 |
| **可回退** | AI 的操作可以被人撤销或修改 |

**具体体现**：

1. **每个工具都有 UI 入口**
   - AI 调用 `scan_risks` 工具
   - 人可以点击「风险扫描」按钮，效果相同

2. **每个工作流都可手动执行**
   - AI 自动执行「合同导入流程」
   - 人可以一步步手动完成：上传 → 解析 → 分析 → 扫描

3. **命令面板是人机共用的接口**
   - 人输入命令：`scan risks`
   - AI 识别意图后调用同一命令

4. **AI 操作可视化**
   - AI 执行时，UI 上相应的按钮/区域会高亮
   - 让人知道「如果我手动做，应该点这里」

---

## 三、实时交互原则

### 3.1 核心原则：真实交互，禁止表演

**禁止的模式（假交互）**：
```
后台静默执行所有工具 → 等全部完成 → 用动画「演」给用户看
```

**正确的模式（真实交互）**：
```
AI 思考（真的在思考）→ 调用工具（真的在执行）→ 实时反馈（真实结果）
```

### 3.2 实时反馈机制

| 阶段 | 用户看到的 |
|------|-----------|
| AI 思考 | 「正在理解你的需求...」|
| 工具开始 | 显示工具名称和描述 |
| 工具执行中 | 真实的进度条和状态文字 |
| 工具完成 | 真实的执行结果和耗时 |
| AI 总结 | 基于真实结果的分析和建议 |

### 3.3 进度报告规范

工具执行时应报告真实进度：
- 进度百分比（基于真实执行阶段）
- 当前正在做什么（如「扫描条款 5/12」）
- 中间发现（如「已发现 2 个风险点」）

### 3.4 可中断性

- 用户可随时中断正在执行的操作
- 中断后显示已完成的部分结果
- AI 询问是否继续或放弃

### 3.5 错误透明

- 工具执行失败时如实告知
- 显示失败原因
- 提供重试或替代方案

---

## 四、体验设计

### 4.1 IDE 化整体布局

**布局结构**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  顶部栏：Logo + 全局搜索/命令面板入口 + 用户信息                      │
├───────────┬─────────────────────────────────────────┬───────────────┤
│           │                                         │               │
│  侧边栏   │              主工作区                    │   AI 助手    │
│           │                                         │   面板       │
│  • 模块   │   当前正在处理的内容                     │               │
│    导航   │   （列表/详情/编辑/预览）                │  • 对话      │
│           │                                         │  • 工具执行  │
│  • 收藏   │                                         │  • 快捷操作  │
│           │                                         │               │
│  • 最近   │                                         │               │
│                                                     │               │
├───────────┴─────────────────────────────────────────┴───────────────┤
│  状态栏：当前位置 + 选中状态 + 操作提示 + AI 状态                      │
└─────────────────────────────────────────────────────────────────────┘
```

**区域说明**：

| 区域 | 功能 | 特点 |
|------|------|------|
| **顶部栏** | 全局导航和命令入口 | 命令面板入口、全局搜索 |
| **侧边栏** | 模块导航、上下文信息 | 可折叠、显示当前位置 |
| **主工作区** | 核心内容展示和编辑 | 响应式、支持多种视图 |
| **AI 面板** | AI 助手交互区 | 可展开/收起、可拖拽调整宽度 |
| **状态栏** | 状态信息和快捷入口 | 显示当前上下文、AI 状态 |

### 4.2 命令面板设计

**唤起方式**：`Cmd/Ctrl + P` 或点击顶部搜索框

**功能**：
- 搜索并执行任何命令
- 模糊匹配，智能排序
- 显示快捷键
- 最近使用优先

**命令分类**：

| 类别 | 示例命令 |
|------|---------|
| 导航 | `前往合同列表`、`打开客户 XX` |
| 操作 | `新建合同`、`扫描风险`、`导出报告` |
| 视图 | `切换列表视图`、`显示筛选面板` |
| AI | `让 AI 分析`、`让 AI 生成` |

**交互流程**：
```
Cmd+P → 输入关键词 → 模糊匹配 → 选择命令 → 执行
         ↑                              │
         └── AI 也可以调用同样的命令 ────┘
```

### 4.3 AI 助手双区设计：对话流 + 画布

**核心概念**：AI 助手界面分为两个区域——**对话流**用于人机交流，**画布**用于实时操作。

**布局结构**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                         AI 助手面板                                  │
├─────────────────────────────┬───────────────────────────────────────┤
│                             │                                       │
│        对话流区域            │              画布区域                  │
│                             │                                       │
│   ┌─────────────────────┐  │   ┌───────────────────────────────┐   │
│   │ 🤖 我来帮你创建客户 │  │   │                               │   │
│   └─────────────────────┘  │   │   ┌─────────────────────────┐ │   │
│                             │   │   │ 新建客户                │ │   │
│   ┌─────────────────────┐  │   │   ├─────────────────────────┤ │   │
│   │ 👤 好的             │  │   │   │ 客户名称: [██████████] │ │   │
│   └─────────────────────┘  │   │   │ 联系人:   [          ] │ │   │
│                             │   │   │ 电话:     [          ] │ │   │
│   ┌─────────────────────┐  │   │   │ 地址:     [          ] │ │   │
│   │ 🤖 请确认客户名称   │  │   │   └─────────────────────────┘ │   │
│   │    我已填入表单     │  │   │                               │   │
│   └─────────────────────┘  │   │   [保存]  [取消]              │   │
│                             │   │                               │   │
│   [输入消息...]      [发送] │   └───────────────────────────────┘   │
│                             │                                       │
└─────────────────────────────┴───────────────────────────────────────┘
```

**两个区域的职责**：

| 区域 | 职责 | 内容 |
|------|------|------|
| **对话流** | 人机交流、指令下达、结果说明 | 消息气泡、工具执行状态、AI 解释 |
| **画布** | 实际操作界面、数据展示 | 工具栏、表单、列表、详情卡片、预览、对比视图 |

### 4.4 画布顶部：AI 能力工具栏

**核心理念**：每个页面/模块切换时，画布顶部呈现当前可用的工具和工作流，让用户一目了然知道 AI 能做什么。

**布局结构**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                           画布区域                                   │
├─────────────────────────────────────────────────────────────────────┤
│  📍 当前：客户管理                                                   │
│  ─────────────────────────────────────────────────────────────────  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  🛠️ AI 工具                                                  │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐                    │   │
│  │  │ 🔍  │ │ ➕  │ │ 📊  │ │ 📧  │ │ 📥  │                    │   │
│  │  │搜索 │ │新建 │ │分析 │ │发送 │ │导入 │                    │   │
│  │  │客户 │ │客户 │ │客户 │ │邮件 │ │客户 │                    │   │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘                    │   │
│  │                                                              │   │
│  │  ⚡ 工作流                                                    │   │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐      │   │
│  │  │ 📋 完整客户    │ │ 💰 客户报价    │ │ 📄 客户合同    │      │   │
│  │  │    建档流程    │ │    生成流程    │ │    签署流程    │      │   │
│  │  └───────────────┘ └───────────────┘ └───────────────┘      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      [当前操作内容区]                         │   │
│  │                       表单/列表/预览                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**不同模块的 AI 能力展示**：

| 模块 | AI 工具 | AI 工作流 |
|------|--------|---------|
| **客户管理** | 搜索客户、新建客户、分析客户、发送邮件、导入客户 | 完整建档、报价生成、合同签署 |
| **报价管理** | 创建报价、计算价格、对比报价、发送报价 | 智能报价、批量报价、报价转合同 |
| **合同管理** | 解析合同、风险扫描、生成合同、导出合同 | 合同全流程、模板分析、批量审核 |
| **项目管理** | 创建项目、分配任务、统计进度、生成报告 | 项目规划、进度追踪、结算流程 |
| **财务管理** | 生成发票、核对账单、统计收款、催款提醒 | 开票流程、对账流程、催款流程 |

**工具栏的交互设计**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  🛠️ AI 工具                                              [收起 ▼]   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                                                              │   │
│  │  ┌─────┐    点击工具图标                                     │   │
│  │  │ 🔍  │  ──────────────→  直接执行（无需输入参数时）        │   │
│  │  │搜索 │                                                     │   │
│  │  │客户 │  ──────────────→  弹出参数输入框（需要参数时）      │   │
│  │  └─────┘                                                     │   │
│  │     │                                                        │   │
│  │     │    悬停显示                                            │   │
│  │     ↓                                                        │   │
│  │  ┌───────────────────────────────────────┐                   │   │
│  │  │ 🔍 搜索客户                            │                   │   │
│  │  │                                        │                   │   │
│  │  │ 按名称、联系人、电话等搜索客户         │                   │   │
│  │  │                                        │                   │   │
│  │  │ 快捷键: Ctrl+F                         │                   │   │
│  │  │ 示例: "搜索上海的客户"                 │                   │   │
│  │  └───────────────────────────────────────┘                   │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**工作流卡片的交互**：

```
┌───────────────────────────────────────────────────────────────────┐
│  ⚡ 工作流                                                        │
│                                                                   │
│  ┌─────────────────────────────────────┐                         │
│  │ 📋 完整客户建档流程                   │  ← 点击展开详情         │
│  │                                      │                         │
│  │ 从零开始，引导完成客户所有信息录入    │                         │
│  │                                      │                         │
│  │ 包含步骤：                           │                         │
│  │ 1. 基本信息 → 2. 联系人 → 3. 地址   │                         │
│  │ → 4. 合作历史 → 5. 信用评估          │                         │
│  │                                      │                         │
│  │ 预计耗时: 5-10 分钟                  │                         │
│  │                                      │                         │
│  │ [🚀 开始流程]                        │  ← 点击启动              │
│  └─────────────────────────────────────┘                         │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

**能力发现的多种方式**：

| 方式 | 说明 | 适用场景 |
|------|------|---------|
| **工具栏浏览** | 直接看到当前模块所有可用工具 | 不知道能做什么时 |
| **悬停提示** | 了解工具的具体功能和用法 | 想了解某个工具时 |
| **搜索工具** | 在工具栏中搜索特定功能 | 知道想做什么但不知道哪个工具 |
| **对话询问** | 直接问 AI「你能做什么」 | 喜欢对话方式时 |

**工具栏的智能特性**：

1. **常用优先** - 用户常用的工具排在前面
2. **上下文感知** - 根据选中的数据显示相关工具（如选中客户后显示「发送邮件」）
3. **状态指示** - 工具不可用时灰显，并显示原因
4. **快捷键提示** - 悬停时显示快捷键
5. **可折叠** - 用户可以收起工具栏，节省空间

**工具栏收起后的呈现**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  📍 客户管理  │  🛠️ 5个工具  ⚡ 3个工作流  [展开 ▶]                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                      [当前操作内容区]                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**画布的核心特性**：

1. **AI 可投射内容**
   - AI 根据对话上下文，将对应的操作界面投射到画布
   - 如：用户说「创建客户」→ 画布显示新建客户表单

2. **人可直接操作**
   - 画布中的表单、列表等，人可以直接手动填写、选择
   - 与普通页面中的表单体验完全一致

3. **AI 可直接操作**
   - AI 可以自动填写表单字段
   - AI 可以自动选择列表项
   - 操作时有视觉反馈（高亮、动画）

4. **实时同步**
   - 画布中的任何变化，AI 都能感知
   - 人修改了表单，AI 知道当前内容是什么

**画布可承载的内容类型**：

| 类型 | 场景 | 示例 |
|------|------|------|
| **表单** | 创建/编辑数据 | 新建客户、编辑合同、创建项目 |
| **列表** | 选择/筛选数据 | 选择客户、选择模板、查看搜索结果 |
| **详情卡片** | 查看信息 | 客户详情、合同摘要、风险报告 |
| **对比视图** | 比较分析 | 合同条款对比、版本差异、报价对比 |
| **预览** | 查看结果 | 合同预览、报告预览、邮件预览 |
| **编辑器** | 内容编辑 | 合同编辑、模板编辑 |

### 4.4 对话流与画布的协作模式

**模式一：AI 投射 + 人操作**
```
对话流                          画布
──────                          ────
🤖 我打开客户创建表单了         →  [显示新建客户表单]
   你可以直接填写

                                    用户手动填写表单
                                    ↓
🤖 我看到你填了 XX 公司        ←  [表单内容变化]
   需要我帮你补充其他信息吗？
```

**模式二：AI 投射 + AI 操作**
```
对话流                          画布
──────                          ────
👤 帮我创建客户 XX 公司

🤖 好的，我来创建               →  [显示新建客户表单]
                                    [AI 自动填写: 客户名称]
🤖 正在填写客户信息...          →  [AI 自动填写: 其他字段]
                                    [字段依次高亮]

🤖 已填写完成，请确认           →  [表单已填写完毕]
   
👤 确认

🤖 创建成功！                   →  [显示客户详情卡片]
```

**模式三：人机交替操作**
```
对话流                          画布
──────                          ────
👤 帮我创建报价单

🤖 好的，请先选择客户           →  [显示客户选择列表]

                                    用户点击选择 XX 公司
                                    ↓
🤖 选择了 XX 公司               ←  [客户选中]
   我来帮你添加服务项

🤖 根据历史记录推荐             →  [显示服务项表单]
   以下服务项...                    [AI 自动添加推荐项]

👤 再加一个 Logo 设计

🤖 已添加                       →  [添加 Logo 设计行项]

👤 价格改成 8000

                                    用户手动修改价格字段
                                    ↓
🤖 价格已更新为 8000            ←  [价格变更]
   总金额 23,000 元
```

### 4.5 画布的视觉状态

**AI 操作时的视觉反馈**：

| 状态 | 视觉表现 |
|------|---------|
| AI 正在填写 | 字段边框高亮 + 打字动画 |
| AI 正在选择 | 选项悬停效果 + 点击动画 |
| AI 填写完成 | 短暂的成功色闪烁 |
| 等待人确认 | 确认按钮脉冲动画 |

**人操作时的 AI 感知**：
- 对话流显示「检测到你修改了 XXX」
- AI 可主动回应修改（如验证、建议）

### 4.6 AI 预判与备选指令设计

**核心理念**：AI 不仅响应用户，还要主动预判下一步，减少用户思考和输入成本。

**预判指令的呈现位置**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│   🤖 客户 XX 公司已创建成功！                                        │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │  💡 下一步你可能想：                                          │  │
│   │                                                              │  │
│   │  [为这个客户创建报价单]  [添加联系人]  [查看客户列表]          │  │
│   │                                                              │  │
│   │  [创建合同]  [关联到项目]                                     │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│   [输入消息，或点击上方快捷指令...]                          [发送]  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**预判指令的生成逻辑**：

| 依据 | 说明 | 示例 |
|------|------|------|
| **刚完成的操作** | 根据操作类型推荐后续步骤 | 创建客户 → 推荐创建报价/合同 |
| **当前页面上下文** | 根据所在模块推荐相关操作 | 在报价单页 → 推荐发送/转合同 |
| **业务流程** | 根据标准业务流推荐下一环节 | 报价确认 → 推荐生成合同 |
| **历史行为** | 根据用户习惯推荐常用操作 | 用户常在创建客户后添加联系人 |
| **未完成事项** | 提示待处理的任务 | 有 3 份合同待审核 |

**预判指令的类型**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  💡 快捷指令（可直接执行的操作）                                      │
│                                                                     │
│  [📝 为这个客户创建报价单]     ← 点击直接执行                         │
│  [👤 添加联系人]                                                     │
│  [📄 创建设计合同]                                                   │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  💬 提示词模板（需要补充信息）                                        │
│                                                                     │
│  [帮我给 XX 公司发送报价单，服务内容是___]    ← 点击填入输入框        │
│  [分析一下这个客户的历史合作情况]                                     │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│  ❓ 追问建议（引导深入探索）                                          │
│                                                                     │
│  [这个报价合理吗？]                                                   │
│  [有没有类似的历史报价参考？]                                         │
│  [行业平均价格是多少？]                                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**不同场景的预判指令示例**：

| 场景 | 刚完成的操作 | 预判指令 |
|------|-------------|---------|
| **创建客户后** | 新建了客户 XX 公司 | • 为这个客户创建报价单<br>• 添加联系人<br>• 创建项目<br>• 查看客户列表 |
| **生成报价后** | 生成了报价单 | • 发送给客户<br>• 转为正式合同<br>• 调整价格<br>• 添加服务项 |
| **合同风险扫描后** | 发现 3 个风险 | • 自动修复所有风险<br>• 查看风险详情<br>• 只修复高风险项<br>• 忽略此风险 |
| **查看客户详情时** | 打开了客户详情 | • 创建报价单<br>• 查看历史合同<br>• 编辑客户信息<br>• 查看应收款 |
| **合同签署后** | 合同状态变为已签署 | • 创建项目<br>• 生成首付款发票<br>• 安排设计师<br>• 发送确认邮件 |

**动态预判的实现**：

```typescript
// 预判指令接口
interface PredictedAction {
  id: string;
  type: 'execute' | 'template' | 'question';  // 执行/模板/追问
  label: string;           // 显示文字
  icon: string;            // 图标
  prompt?: string;         // 模板类型时，填入输入框的内容
  tool?: string;           // 执行类型时，直接调用的工具
  params?: Record<string, any>;  // 工具参数
  confidence: number;      // 预测置信度 0-1
}

// AI 每次响应后返回预判指令
interface AIResponse {
  message: string;
  canvas?: CanvasContent;
  predictedActions: PredictedAction[];  // 预判的下一步指令
}
```

**🔴 预判指令的核心约束**：

> **任何 Predicted Action，默认必须是"需人确认"的。**
> 
> 哪怕是 execute 类型，也必须：明确显示"将执行什么"、可被取消、可被拒绝。
> 
> **绝对禁止**：AI 看你可能要做 → 就帮你做了。

**预判指令的正确交互流程**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  ❌ 错误：点击即执行                                                 │
│  ┌─────────────────────┐                                           │
│  │ [为客户创建报价单]   │ ──点击──→ 立刻执行（危险！）              │
│  └─────────────────────┘                                           │
├─────────────────────────────────────────────────────────────────────┤
│  ✅ 正确：点击 → 确认 → 执行                                        │
│  ┌─────────────────────┐                                           │
│  │ [为客户创建报价单]   │ ──点击──→ 显示执行计划 ──确认──→ 执行    │
│  └─────────────────────┘              ↓                            │
│                                   可取消/可修改                     │
└─────────────────────────────────────────────────────────────────────┘
```

**点击预判指令后的行为**：

| 类型 | 点击后行为 | 关键约束 |
|------|-----------|---------|
| **execute（执行类）** | 显示执行计划 → 等待确认 → 执行 | ⚠️ 必须确认，不能直接执行 |
| **template（模板类）** | 填入输入框 → 光标定位空白处 → 等待用户补充 | 必须用户完成输入 |
| **question（追问类）** | 显示问题预览 → 确认发送 | 可直接发送（低风险） |

**execute 类指令的确认流程**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  用户点击：[为客户创建报价单]                                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📋 即将执行                                                  │   │
│  │                                                              │   │
│  │  操作：为客户创建报价单                                       │   │
│  │  目标客户：XX 设计公司                                        │   │
│  │  使用模板：标准报价单                                         │   │
│  │                                                              │   │
│  │  这将打开报价单创建表单，并自动填入客户信息。                  │   │
│  │                                                              │   │
│  │  [✅ 确认执行]  [✏️ 修改参数]  [❌ 取消]                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**预判指令的其他交互细节**：

| 操作 | 行为 |
|------|------|
| **悬停指令** | 显示该操作的简要说明 |
| **键盘快捷键** | `1`/`2`/`3` 快速选择（弹出确认，不是直接执行） |
| **右键指令** | 显示更多选项（修改参数、忽略、不再显示此建议） |

**智能优化**：

1. **使用频率排序** - 用户常用的指令排在前面
2. **去重合并** - 相似指令合并，避免选择困难
3. **最多显示 5 个** - 避免选项过多造成干扰
4. **可折叠** - 用户可以收起预判指令区域
5. **记忆学习** - 根据用户选择习惯，优化未来预判

### 4.7 对话面板设计

**头部区域**：
- 显示当前上下文（如「合同管理 · 查看合同详情」）
- 关闭按钮

**消息区域**：
- 用户消息（右侧）
- AI 消息（左侧）
- 工具执行卡片（嵌入式）
- 流式文本输出（打字机效果）

**快捷操作区**：
- 根据当前页面推荐 3-5 个常用操作
- 点击即发送对应指令

**输入区域**：
- 文本输入框
- 发送按钮
- 执行中显示「停止」按钮

### 4.3 工具执行卡片

**运行中状态**：
- 工具图标（旋转动画）
- 工具名称和描述
- 进度条（真实进度）
- 状态文字（如「识别条款结构...」）

**完成状态**：
- 成功/失败图标
- 执行耗时
- 结果摘要（可展开查看详情）

**失败状态**：
- 错误图标
- 错误信息
- 重试按钮

### 4.4 人机双轨交互示例

**同一个操作的两种触发方式**：

| 操作 | 人工方式 | AI 方式 |
|------|---------|---------|
| 扫描合同风险 | 点击「风险扫描」按钮 | 说「帮我扫描风险」 |
| 创建新客户 | 点击「新建」→ 填表单 | 说「创建客户 XX 公司」 |
| 导出报告 | 点击「导出」→ 选格式 | 说「导出 PDF 报告」 |
| 查找合同 | 使用筛选器筛选 | 说「找一下 XX 公司的合同」 |

**AI 操作时的 UI 联动**：

当 AI 执行操作时，对应的 UI 元素会有视觉反馈：
- 相关按钮短暂高亮
- 相关面板自动展开
- 操作位置滚动到可视区域

这让用户知道：「如果我手动做，应该操作这里」

### 4.5 典型交互流程

**场景 1：AI 辅助分析（AI 轨道）**

```
用户：「帮我看看这份合同」
      [上传文件]

AI：「好的，我来分析这份合同。」

    ┌─────────────────────────────┐
    │ 🔄 解析合同文件              │
    │ ████████░░░░░░  52%         │
    │ 识别条款结构...              │
    └─────────────────────────────┘

    ┌─────────────────────────────┐
    │ ✅ 解析合同文件    1,234ms   │
    │    共 12 个条款              │
    └─────────────────────────────┘

    ┌─────────────────────────────┐
    │ 🔄 扫描风险                  │
    │ ██████░░░░░░░░  38%         │
    │ 扫描条款 4/12: 知识产权      │
    └─────────────────────────────┘

    ┌─────────────────────────────┐
    │ ✅ 扫描风险        3,891ms   │
    │    发现 3 个高风险           │
    └─────────────────────────────┘

AI：「分析完成！这份合同整体风险评分 62/100。

     ⚠️ 需要关注的问题：
     1. 付款条款风险较高 - 验收后60天付款
     2. 知识产权条款不利 - 签约即转让
     
     需要我帮你修改这些条款吗？」
```

**场景 2：人工操作（人工轨道，执行相同任务）**

```
1. 进入合同导入页面
2. 点击「上传文件」按钮
3. 选择文件，点击「开始解析」
4. 查看解析结果（12 个条款）
5. 点击「风险扫描」按钮
6. 查看风险报告（3 个高风险）
7. 手动查看每个风险详情
```

**两种方式的结果完全一致**，只是交互路径不同。

**场景 3：人机协作 + 画布联动（完整示例）**

```
┌─────────────────────────────┬───────────────────────────────────────┐
│          对话流              │                画布                   │
├─────────────────────────────┼───────────────────────────────────────┤
│                             │                                       │
│ 👤 帮我分析这份合同         │                                       │
│    [上传文件]               │                                       │
│                             │                                       │
│ 🤖 好的，正在分析...        │   ┌─────────────────────────────┐     │
│                             │   │ 📄 合同解析中...             │     │
│    ┌───────────────────┐   │   │ ████████░░░░  68%           │     │
│    │ 🔄 解析合同        │   │   │                             │     │
│    │ ██████░░ 52%       │   │   └─────────────────────────────┘     │
│    └───────────────────┘   │                                       │
│                             │                                       │
│ 🤖 分析完成！发现 3 个      │   ┌─────────────────────────────┐     │
│    高风险问题               │   │ 📊 风险扫描报告              │     │
│                             │   ├─────────────────────────────┤     │
│    ⚠️ 付款条款风险高        │   │ 评分: 62/100                │     │
│    ⚠️ 知识产权条款不利      │   │                             │     │
│    ⚠️ 缺少取消补偿          │   │ ⚠️ 高风险 (3)               │     │
│                             │   │ • 付款条款 - 验收后60天     │     │
│    需要我帮你修改吗？       │   │ • 知识产权 - 签约即转让     │     │
│                             │   │ • 取消条款 - 无补偿         │     │
│                             │   │                             │     │
│ 👤 第一个付款条款我自己改   │   │ [查看详情] [一键修复]       │     │
│                             │   └─────────────────────────────┘     │
│                             │                                       │
│ 🤖 好的，我把付款条款打开   │   ┌─────────────────────────────┐     │
│    你可以直接编辑           │   │ ✏️ 编辑付款条款              │     │
│                             │   ├─────────────────────────────┤     │
│    [AI 在画布中打开编辑器]  │   │                             │     │
│                             │   │ 甲方应于验收合格后【60】   │     │
│                             │   │ 日内支付全部款项...         │     │
│                             │   │         ↑                   │     │
│                             │   │    [光标定位到此处]         │     │
│                             │   │                             │     │
│                             │   │ 💡 AI 建议: 改为 15-30 天   │     │
│                             │   │                             │     │
│                             │   └─────────────────────────────┘     │
│                             │                                       │
│                             │      [用户在画布中手动修改]          │
│                             │      将 60 改为 15                    │
│                             │                 ↓                     │
│ 🤖 检测到你把付款周期       │   ┌─────────────────────────────┐     │
│    从 60 天改为 15 天       │   │ ✏️ 编辑付款条款              │     │
│                             │   ├─────────────────────────────┤     │
│    这是个好修改！风险降低   │   │                             │     │
│                             │   │ 甲方应于验收合格后【15】   │     │
│                             │   │ 日内支付全部款项...         │     │
│                             │   │                             │     │
│ 👤 其他两个帮我自动改       │   │ ✅ 已修改                   │     │
│                             │   └─────────────────────────────┘     │
│                             │                                       │
│ 🤖 好的，我来处理剩下两个   │   ┌─────────────────────────────┐     │
│                             │   │ ✏️ 知识产权条款              │     │
│    ┌───────────────────┐   │   ├─────────────────────────────┤     │
│    │ 🔄 修改知识产权    │   │   │                             │     │
│    │ AI 正在编辑...     │   │   │ 原: 签约后版权归甲方       │     │
│    └───────────────────┘   │   │        ↓ [AI 正在修改]       │     │
│                             │   │ 改: 付清全款后版权归甲方   │     │
│ 🤖 已修改知识产权条款       │   │                             │     │
│    版权转让条件改为付清后   │   │ ✅ AI 已修改                │     │
│                             │   └─────────────────────────────┘     │
│    ┌───────────────────┐   │                                       │
│    │ 🔄 添加取消补偿    │   │   ┌─────────────────────────────┐     │
│    │ AI 正在添加...     │   │   │ ➕ 新增取消补偿条款         │     │
│    └───────────────────┘   │   ├─────────────────────────────┤     │
│                             │   │                             │     │
│ 🤖 已添加取消补偿条款       │   │ 如甲方取消项目，应按已      │     │
│                             │   │ 完成工作量比例支付费用...   │     │
│    全部修改完成！           │   │                             │     │
│    风险评分提升到 89/100    │   │ ✅ AI 已添加                │     │
│                             │   └─────────────────────────────┘     │
│    需要我导出修订版吗？     │                                       │
│                             │                                       │
│ [输入消息...]        [发送] │                                       │
└─────────────────────────────┴───────────────────────────────────────┘
```

---

## 五、架构概览

### 5.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端应用                              │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                   当前页面内容                         │  │
│  │                                        ┌────────────┐ │  │
│  │                                        │ AI 助手    │ │  │
│  │                                        │  (悬浮)    │ │  │
│  │                                        └────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
│                             │                                │
│                             ▼                                │
│  ┌───────────────────────────────────────────────────────┐  │
│  │              AIAssistant 核心组件                      │  │
│  │  • 页面感知    • 对话管理    • 工具调度               │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                      后端 Agent 服务                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  意图识别 → 任务规划 → 工具执行 → 结果整合          │   │
│  └─────────────────────────────────────────────────────┘   │
│                             │                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    工具注册表                         │   │
│  │  合同解析 | 风险扫描 | 客户查询 | 报价计算 | ...     │   │
│  └─────────────────────────────────────────────────────┘   │
│                             │                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   工作流注册表                        │   │
│  │  合同导入流程 | 合同创建流程 | 客户跟进流程 | ...    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 数据流

```
用户输入
    │
    ▼
页面上下文收集
    │
    ▼
发送到 Agent 服务
    │
    ├──→ 意图识别（理解用户想做什么）
    │
    ├──→ 任务规划（确定需要哪些工具/工作流）
    │
    ├──→ 工具执行（实时流式反馈）
    │        │
    │        ├──→ 工具开始事件
    │        ├──→ 工具进度事件（多次）
    │        └──→ 工具完成事件
    │
    └──→ 结果整合（生成自然语言回复）
              │
              ▼
         流式返回前端
              │
              ▼
         实时渲染展示
```

### 5.3 关键组件

| 组件 | 职责 |
|------|------|
| **页面感知器** | 收集当前页面上下文信息 |
| **意图识别器** | 理解用户自然语言意图 |
| **任务规划器** | 规划执行步骤，选择工具/工作流 |
| **工具执行器** | 执行具体工具，报告进度 |
| **工作流执行器** | 编排多步骤工作流 |
| **响应组合器** | 将结果转化为自然语言回复 |

---

## 六、与现有系统的关系

### 6.1 复用现有能力

现有的 AI 服务将作为「工具」被复用：

| 现有服务 | 转化为工具 |
|----------|-----------|
| ContractParserService | parse_contract 工具 |
| RiskScanService | scan_risks 工具 |
| TemplateAnalysisService | analyze_template 工具 |
| ContractAIService | generate_contract 工具 |
| ContractConversationService | 融入对话流程 |
| PreflightService | 融入工作流 |

### 6.2 渐进式迁移

**阶段一**：
- 构建统一 AI 助手框架
- 将现有服务封装为工具
- 保留原有页面入口

**阶段二**：
- 完善工作流编排
- 优化页面感知
- 丰富快捷操作

**阶段三**：
- 简化原有页面（移除冗余 AI 入口）
- AI 助手成为主要交互方式
- 原有入口作为备用

---

## 七、成功指标

### 7.1 体验指标

| 指标 | 目标 |
|------|------|
| 任务完成步骤数 | 减少 50%（AI 自动编排） |
| 页面跳转次数 | 减少 70%（AI 自动导航） |
| 用户学习成本 | 接近零（对话即操作） |

### 7.2 效率指标

| 指标 | 目标 |
|------|------|
| 合同分析完成时间 | 从 10 分钟降至 2 分钟 |
| 新合同创建时间 | 从 30 分钟降至 5 分钟 |
| 信息查询时间 | 即问即答 |

### 7.3 技术指标

| 指标 | 目标 |
|------|------|
| 工具调用准确率 | > 95% |
| 意图识别准确率 | > 90% |
| 响应延迟（首字符） | < 500ms |
| 工具执行可见性 | 100% 实时反馈 |

---

## 八、工程架构：协议与包结构

> **核心认知**：包不是目的，协议才是目的。碎片化不是越碎越好，而是"可编排粒度"最小化。

### 8.1 两个核心协议

要让 AI 真正能"随时随地调用一切资源"，必须先定义两个协议：

| 协议 | 职责 | 关键约束 |
|------|------|---------|
| **Tool Protocol** | AI 如何调用后端能力 | 单一职责、明确 schema、可幂等、可审计 |
| **UI Protocol** | AI 如何请求渲染交互组件 | 结构化 spec、事件回传、不输出 JSX |

没有协议，做包只会变成"模块化的代码仓库"，AI 仍然无法稳定操作。

---

### 8.2 Backend 工具包结构

**正确单位**：Tool（可审计、可幂等、可回放）

每个工具必须满足：
- ✅ 单一职责
- ✅ 明确输入/输出 schema（Zod）
- ✅ 幂等或具备 requestId
- ✅ 有权限边界与审计日志
- ✅ 可在无 UI 情况下完整执行

**包结构**：

```
packages/ai-tools/
  src/
    tools/
      contract/
        parse.tool.ts           // 解析合同
        risk_scan.tool.ts       // 风险扫描
        propose_patch.tool.ts   // 生成修订建议
        apply_patch.tool.ts     // 应用修订
        generate.tool.ts        // 生成合同
      crm/
        create_client.tool.ts   // 创建客户
        search_client.tool.ts   // 搜索客户
        link_contact.tool.ts    // 关联联系人
      quote/
        create_quote.tool.ts    // 创建报价
        calculate.tool.ts       // 计算价格
      files/
        upload.tool.ts          // 上传文件
        extract_text.tool.ts    // 提取文本
    registry.ts                 // 工具注册表 + 元数据
    schemas/                    // Zod schema 定义
    policy/                     // 权限、限流
    audit/                      // 审计日志
```

**Tool 返回值规范**：

```typescript
interface ToolResult<T> {
  success: boolean;
  data?: T;
  
  // 可继续编排的最小状态
  artifacts?: {
    id: string;
    type: string;
    // 结构化产物，如 contractId, clientId
  };
  
  // 可选：下一步建议
  nextHints?: string[];
  
  // 可选：推荐展示的 UI 组件
  uiSuggestion?: {
    componentId: string;
    props: Record<string, any>;
  };
  
  error?: {
    code: string;
    message: string;
  };
}
```

---

### 8.3 Frontend 交互原语包结构

**核心认知**：不是"组件库"，是"交互原语系统"。AI 不生成组件，AI 只选择并驱动已实现的组件。

**包结构**：

```
packages/ai-ui/
  src/
    components/
      AiForm.tsx              // schema 驱动的表单
      AiPicker.tsx            // 单选/多选/枚举选择
      AiList.tsx              // 列表 + 过滤 + 选中
      AiDetails.tsx           // 详情展示（结构化字段）
      AiModalConfirm.tsx      // 确认/警告/强制确认
      AiReviewPanel.tsx       // 对比/勾选/审批
      AiStepper.tsx           // 状态机进度（真实状态）
      AiConsole.tsx           // 过程日志/事件流
    host/
      AIInteractionHost.tsx   // 统一组件宿主
      ComponentRegistry.ts    // 组件注册表
    renderer/
      renderFromSpec.tsx      // UI Spec -> React
    schemas/
      ui-spec.schema.ts       // UI Spec schema
      events.schema.ts        // 事件 schema
```

**8 个交互原语组件**（覆盖 80% 场景）：

| 组件 | 职责 | 典型场景 |
|------|------|---------|
| **AiForm** | 补充信息/创建/编辑 | 创建客户、编辑合同 |
| **AiPicker** | 单选/多选/枚举 | 选择模板、选择服务 |
| **AiList** | 列表+过滤+选中 | 搜索客户、选择合同 |
| **AiDetails** | 详情展示 | 客户详情、合同摘要 |
| **AiModalConfirm** | 确认/警告 | 删除确认、重要操作确认 |
| **AiReviewPanel** | 对比/勾选/审批 | 风险修订、合同对比 |
| **AiStepper** | 状态机进度 | 工作流步骤展示 |
| **AiConsole** | 事件流/日志 | 执行过程、可回放记录 |

**组件约束（硬规则）**：

- ✅ 严格 shadcn/ui（不魔改，不引第二套）
- ✅ 不使用 emoji
- ✅ 输入是 schema（props）
- ✅ 输出是 schema（events）
- ❌ 不包含业务逻辑（业务逻辑在 tools/workflow）
- ✅ 可由 AI 声明式渲染

---

### 8.4 UI Protocol：AI 如何调用组件

**核心原则**：AI 不输出 JSX，AI 输出 UI Spec

**AI 请求渲染**：

```json
{
  "ui": {
    "componentId": "AiForm",
    "props": {
      "title": "补充合同基础信息",
      "schemaId": "contract.basic",
      "initialValues": { "partyA": "", "partyB": "" }
    }
  }
}
```

**用户操作后回传**：

```json
{
  "event": {
    "type": "ui.submit",
    "componentId": "AiForm",
    "payload": { "partyA": "XX公司", "partyB": "YY公司" }
  }
}
```

**事件类型（有限集合）**：

| 事件 | 说明 |
|------|------|
| `ui.submit` | 表单提交 |
| `ui.cancel` | 取消操作 |
| `ui.select` | 选中项目 |
| `ui.approve` | 审批通过 |
| `ui.reject` | 审批拒绝 |
| `ui.update` | 字段更新 |

---

### 8.5 Interaction Orchestrator：交互调度器的最终裁决权

> **🔴 不可违反的红线**：
> 
> **AI（任何角色）永远不能直接决定 UI 的呈现方式，只能提出请求。**

**职责分离**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        UI 决策权归属                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ❌ 错误：Role 直接决定 UI                                          │
│  ┌──────────┐                    ┌──────────────┐                  │
│  │   Role   │ ──── 直接渲染 ───→ │     UI       │                  │
│  └──────────┘                    └──────────────┘                  │
│                                                                     │
│  ✅ 正确：Role 提出请求 → Orchestrator 裁决 → UI 渲染               │
│  ┌──────────┐  uiSuggestion  ┌─────────────┐  决定  ┌──────────┐  │
│  │   Role   │ ─────────────→ │ Interaction │ ─────→ │    UI    │  │
│  └──────────┘                │ Orchestrator│        └──────────┘  │
│                              └─────────────┘                       │
│                                    │                               │
│                                    ↓                               │
│                            最终裁决权：                             │
│                            • 是否呈现                              │
│                            • 以什么形式呈现                         │
│                            • 是否打断当前操作                       │
│                            • 何时呈现                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Interaction Orchestrator 的职责**：

| 职责 | 说明 |
|------|------|
| **接收请求** | 接收 Role 的 uiSuggestion |
| **校验合法性** | 检查 componentId 是否存在、props 是否合规 |
| **判断优先级** | 当前是否允许呈现、是否需要排队 |
| **决定呈现方式** | 在画布中呈现 / 弹窗 / Toast / 忽略 |
| **管理打断逻辑** | 是否允许打断用户当前操作 |
| **事件路由** | 将用户操作事件路由回正确的 Role/Workflow |

**硬约束（写进代码的防护）**：

```typescript
// Interaction Orchestrator 是 UI 渲染的唯一入口
class InteractionOrchestrator {
  // 接收 Role 的 UI 请求
  requestUI(request: UIRequest): UIDecision {
    // 1. 校验请求合法性
    if (!this.uiRegistry.has(request.componentId)) {
      return { action: 'reject', reason: 'component_not_found' };
    }
    
    // 2. 校验 props
    const validation = this.validateProps(request.componentId, request.props);
    if (!validation.valid) {
      return { action: 'reject', reason: 'invalid_props', errors: validation.errors };
    }
    
    // 3. 判断是否允许呈现（当前状态、用户操作中等）
    if (this.shouldDefer(request)) {
      return { action: 'defer', reason: 'user_busy' };
    }
    
    // 4. 决定呈现方式
    return {
      action: 'render',
      target: this.decideTarget(request),  // canvas | modal | toast
      timing: this.decideTiming(request)   // immediate | afterCurrent | queued
    };
  }
  
  // ❌ 禁止：Role 直接调用 render
  // ✅ 必须：通过 requestUI 走 Orchestrator
}
```

**这条规则存在的意义**：

防止未来某个开发"图省事"，把 UI 决策偷偷塞回 Agent，导致架构退化。

---

### 8.6 AIInteractionHost：统一组件宿主

**职责**：让"AI 可以随时调用组件"的真正装置

```typescript
interface AIInteractionHost {
  // 组件注册表
  registry: Map<string, React.ComponentType>;
  
  // 渲染组件
  render(spec: UISpec): React.ReactNode;
  
  // 校验 props（用 zod）
  validateProps(componentId: string, props: any): ValidationResult;
  
  // 统一事件回传
  onEvent(handler: (event: UIEvent) => void): void;
  
  // 统一状态管理
  setLoading(loading: boolean): void;
  setError(error: Error | null): void;
  setReadOnly(readOnly: boolean): void;
}
```

**Host 的硬约束**：

| 约束 | 说明 |
|------|------|
| **Registry 校验** | AI 只能输出已注册的 componentId，否则拒绝渲染 |
| **Props 校验** | 所有 props 必须通过 schema 校验，否则拒绝渲染并回传错误 |
| **事件限制** | 组件只能发出有限事件类型 |
| **无业务逻辑** | 组件只负责收集输入/呈现状态 |
| **只读 State** | UI 只读 state，异步动作必须由 tool 执行 |

---

### 8.6 Workflow 状态机设计

**核心认知**：AI 不是随便调工具，而是在"受控轨道"内编排

每个 Workflow 定义：

```typescript
interface WorkflowDefinition {
  id: string;
  name: string;
  
  // 状态定义
  states: {
    [stateName: string]: {
      // 该状态可调用的工具
      allowedTools: string[];
      
      // 该状态必须收集的输入
      requiredInputs?: string[];
      
      // 该状态可渲染的 UI 组件
      uiSlots: string[];
      
      // 状态迁移规则
      transitions: {
        [eventType: string]: string;  // 事件 -> 下一状态
      };
    };
  };
  
  initialState: string;
  finalStates: string[];
}
```

**AI 在 Workflow 中的职责**：

| 职责 | 约束 |
|------|------|
| 选择 Tool | 只能从 `allowedTools` 中选 |
| 生成 UI Spec | 只能从 `uiSlots` 中选组件 |
| 收集输入 | 必须满足 `requiredInputs` |
| 触发迁移 | 只能通过定义的 `transitions` |

**示例：analyze_document 工作流**

```typescript
const analyzeDocumentWorkflow: WorkflowDefinition = {
  id: 'analyze_document',
  name: '文档分析',
  
  states: {
    'upload': {
      allowedTools: ['files.upload', 'files.extract_text'],
      uiSlots: ['AiForm'],
      transitions: {
        'file.uploaded': 'analyzing'
      }
    },
    'analyzing': {
      allowedTools: ['contract.parse', 'contract.risk_scan'],
      uiSlots: ['AiStepper', 'AiConsole'],
      transitions: {
        'analysis.complete': 'review'
      }
    },
    'review': {
      allowedTools: ['contract.propose_patch'],
      uiSlots: ['AiReviewPanel', 'AiDetails'],
      transitions: {
        'user.approve': 'applying',
        'user.reject': 'done'
      }
    },
    'applying': {
      allowedTools: ['contract.apply_patch'],
      uiSlots: ['AiModalConfirm', 'AiConsole'],
      transitions: {
        'patch.applied': 'done'
      }
    },
    'done': {
      allowedTools: [],
      uiSlots: ['AiDetails'],
      transitions: {}
    }
  },
  
  initialState: 'upload',
  finalStates: ['done']
};
```

---

### 8.7 多角色系统

> **核心认知**：角色是"行为与权限的约束器"，不是"换个提示词的皮肤"。

#### 8.7.1 角色系统在架构中的位置

角色系统作为 **Agent 层的子系统**，不改变 UI 系统，只改变"规划与工具调用方式"。

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Agent Layer                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      Role System                             │   │
│  │                                                              │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │
│  │  │ Role Router │  │Role Policies│  │Role Context │         │   │
│  │  │ 角色路由     │  │ 权限策略    │  │ 角色上下文  │         │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                       │
│                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              Intent → Plan → Execute → Review                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 8.7.2 三层角色设计

**A. 通用系统角色（全局共用）**

| 角色 | 职责 | 关键约束 |
|------|------|---------|
| **Orchestrator（调度官）** | 规划步骤、选择 workflow、决定是否需要 UI | 不直接执行工具，只做规划 |
| **Executor（作业员）** | 按指令调用工具、生成产物 | 必须按 Orchestrator 计划执行 |
| **Reviewer（质检官）** | 审查产物，给通过/驳回/修改意见 | 有否决权，可打回重做 |

这三者是"骨架"，任何业务板块都用得上。

**B. 领域专家角色（按板块挂载）**

| 板块 | 专家角色 | 关注点 |
|------|---------|--------|
| **合同** | Legal Expert（法务专家） | 条款风险、合规性、修订策略 |
| **报价** | Pricing Analyst（定价分析师） | 价格结构、利润率、竞争力 |
| **CRM** | Account Manager（客户经理） | 客户画像、跟进策略、关系维护 |
| **项目** | PM / Delivery Lead（项目经理） | 进度、风险、交付质量 |
| **财务** | Finance Controller（财务管控） | 账期、收款、成本控制 |

每个模块只挂 1-2 个专家，避免角色膨胀。

**C. 工具型角色（可选）**

| 角色 | 职责 | 约束 |
|------|------|------|
| **Data Clerk（数据员）** | 数据清洗、结构化、格式转换 | 只处理数据，不做决策 |
| **Navigator（导航员）** | 页面跳转、定位、上下文切换 | 受 Orchestrator 约束，不能随意打断 |

#### 8.7.3 角色硬约束（必须遵守）

**约束 1：角色必须绑定 Tool 白名单**

```typescript
interface RoleDefinition {
  id: string;
  name: string;
  
  // 工具白名单：只能调用这些工具
  allowedTools: string[];
  
  // 工具黑名单：绝对禁止的工具
  forbiddenTools?: string[];
  
  // 需要审批才能调用的工具
  requiresApproval?: string[];
}

// 示例
const legalExpert: RoleDefinition = {
  id: 'legal_expert',
  name: '法务专家',
  allowedTools: [
    'contract.parse',
    'contract.risk_scan',
    'contract.propose_patch',
    'contract.classify_clause'
  ],
  forbiddenTools: [
    'contract.apply_patch',  // 不能直接应用修改
    'contract.delete'        // 不能删除合同
  ]
};

const executor: RoleDefinition = {
  id: 'executor',
  name: '作业员',
  allowedTools: [
    'contract.apply_patch'
  ],
  requiresApproval: [
    'contract.apply_patch'  // 必须 Reviewer 通过后才能执行
  ]
};
```

**约束 2：角色必须绑定产物格式（Schema）**

```typescript
interface RoleOutputSchema {
  roleId: string;
  
  // 该角色的输出必须符合的 schema
  outputSchema: ZodSchema;
  
  // 必填字段
  requiredFields: string[];
}

// 示例：Legal Expert 的输出 schema
const legalExpertOutput = z.object({
  risks: z.array(z.object({
    id: z.string(),                    // 风险编号（必须）
    clauseLocation: z.object({         // 条款定位（必须）
      section: z.string(),
      paragraph: z.number(),
      lineRange: z.tuple([z.number(), z.number()])
    }),
    riskType: z.enum(['high', 'medium', 'low']),
    description: z.string(),           // 风险描述
    suggestedAction: z.enum([          // 建议动作
      'modify', 'delete', 'add_clause', 'negotiate', 'accept'
    ]),
    evidence: z.string(),              // 判断依据
    patchSuggestion: z.string().optional()  // 修订建议
  })),
  
  summary: z.object({
    totalRisks: z.number(),
    highRisks: z.number(),
    overallAssessment: z.string()
  }),
  
  // 可选：UI 建议
  uiSuggestion: z.object({
    componentId: z.string(),
    props: z.record(z.any())
  }).optional()
});
```

**约束 3：唯一事实源共享**

```
┌─────────────────────────────────────────────────────────────────────┐
│                        State Store（唯一事实源）                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   artifacts: { contractId, parsedContent, riskReport, patches }    │
│   eventLog: [ event1, event2, ... ]                                │
│   sessionState: { currentStep, decisions, approvals }              │
│                                                                     │
├─────────────────────────────────────────────────────────────────────┤
│           ↑              ↑              ↑              ↑            │
│       读取/写入       只读            只读          读取/写入        │
│           │              │              │              │            │
│    ┌──────┴──────┐ ┌─────┴─────┐ ┌─────┴─────┐ ┌──────┴──────┐    │
│    │ Orchestrator│ │Legal Expert│ │  Executor │ │  Reviewer   │    │
│    └─────────────┘ └───────────┘ └───────────┘ └─────────────┘    │
│                                                                     │
│   ❌ 角色不许各自"编故事"，引用的数据必须来自同一事实源              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 8.7.4 角色协作流程（合同预检示例）

```
┌─────────────────────────────────────────────────────────────────────┐
│                    角色协作流程：合同预检                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Step 1: Orchestrator 规划任务                                      │
│  ├─ 输入：用户上传合同                                              │
│  ├─ 输出：任务计划 [parse → scan → propose → review → apply]       │
│  └─ 分配：Legal Expert 执行 scan + propose                         │
│                                                                     │
│  Step 2: Legal Expert 执行风险扫描                                  │
│  ├─ 调用：contract.parse, contract.risk_scan                       │
│  ├─ 输出：风险报告（符合 schema，含条款定位、风险编号）             │
│  └─ uiSuggestion: AiReviewPanel                                    │
│                                                                     │
│  Step 3: Legal Expert 生成修订建议                                  │
│  ├─ 调用：contract.propose_patch                                   │
│  ├─ 输出：patch 列表（每条含理由、影响评估）                        │
│  └─ 状态：patches 写入 State Store                                 │
│                                                                     │
│  Step 4: Reviewer 逐条审批                                          │
│  ├─ 查看：从 State Store 读取 patches                              │
│  ├─ 判断：每条 patch 给 approve / reject / modify                  │
│  └─ 输出：审批结果 + 驳回原因（如有）                               │
│                                                                     │
│  Step 5: Executor 应用修订                                          │
│  ├─ 前置：只有 Reviewer approved 的 patch 才能执行                 │
│  ├─ 调用：contract.apply_patch                                     │
│  └─ 输出：修订后的合同                                              │
│                                                                     │
│  Step 6: Orchestrator 完成任务                                      │
│  └─ 输出最终结果 + 操作日志                                         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 8.7.5 Role Registry（角色注册表）

```typescript
interface RoleRegistry {
  // 角色定义
  roles: Map<string, RoleDefinition>;
  
  // 获取角色
  getRole(roleId: string): RoleDefinition;
  
  // 检查工具权限
  canUseTool(roleId: string, toolId: string): boolean;
  
  // 检查是否需要审批
  requiresApproval(roleId: string, toolId: string): boolean;
  
  // 获取角色的输出 schema
  getOutputSchema(roleId: string): ZodSchema;
  
  // 获取模块的推荐角色组合
  getRolesForModule(moduleId: string): string[];
}

// 角色-模块映射
const moduleRoles: Record<string, string[]> = {
  'contract': ['orchestrator', 'legal_expert', 'executor', 'reviewer'],
  'quote': ['orchestrator', 'pricing_analyst', 'executor', 'reviewer'],
  'crm': ['orchestrator', 'account_manager', 'executor'],
  'project': ['orchestrator', 'pm', 'executor', 'reviewer'],
  'finance': ['orchestrator', 'finance_controller', 'executor', 'reviewer']
};
```

#### 8.7.6 角色与 UI 的关系

**核心原则**：角色不和 UI 绑定

| 层 | 职责 | 示例 |
|---|------|------|
| **角色** | 决定思考/规划/检查方式 | Legal Expert 关注风险条款 |
| **UI** | 由交互调度器决定呈现方式 | 始终由 AIInteractionHost 渲染 |
| **连接** | 角色最多给 uiSuggestion | `{ componentId: 'AiReviewPanel', props: {...} }` |

```typescript
// 角色输出中的 uiSuggestion 只是"建议"，不是"命令"
interface RoleOutput {
  // 主要产物
  data: any;
  
  // UI 建议（可选，不强制）
  uiSuggestion?: {
    componentId: string;
    props: Record<string, any>;
    priority: 'required' | 'recommended' | 'optional';
  };
}

// 最终是否采用，由 Orchestrator 和交互调度器决定
```

---

### 8.8 四大核心机制

没有这四样，"包"只会成为代码组织方式，而不是 AI 操作系统。

**1. Tool Registry（工具注册表）**

```typescript
interface ToolRegistry {
  tools: Map<string, ToolDefinition>;
  getSchema(toolId: string): ZodSchema;
  getPermissions(toolId: string): Permission[];
  getVersion(toolId: string): string;
}
```

**2. UI Registry（组件注册表）**

```typescript
interface UIRegistry {
  components: Map<string, React.ComponentType>;
  getPropsSchema(componentId: string): ZodSchema;
  getEventsSchema(componentId: string): ZodSchema;
}
```

**3. Role Registry（角色注册表）** ⭐ 新增

```typescript
interface RoleRegistry {
  roles: Map<string, RoleDefinition>;
  
  // 角色定义
  getRole(roleId: string): RoleDefinition;
  
  // 权限检查
  canUseTool(roleId: string, toolId: string): boolean;
  requiresApproval(roleId: string, toolId: string): boolean;
  
  // 输出约束
  getOutputSchema(roleId: string): ZodSchema;
  
  // 模块映射
  getRolesForModule(moduleId: string): string[];
}
```

**4. Execution Runtime（执行运行时）**

```typescript
interface ToolExecutor {
  execute(toolId: string, params: any, context: ExecutionContext): Promise<ToolResult>;
  
  // 内置能力
  authenticate(context: ExecutionContext): boolean;
  checkRolePermission(roleId: string, toolId: string): boolean;  // ⭐ 新增
  rateLimit(toolId: string, userId: string): boolean;
  audit(execution: ExecutionRecord): void;
  retry(execution: FailedExecution): Promise<ToolResult>;
}

interface UIExecutor {
  render(spec: UISpec): React.ReactNode;
  validate(spec: UISpec): ValidationResult;
  handleEvent(event: UIEvent): void;
}
```

**5. State Store（状态存储）**

```typescript
interface StateStore {
  // 工作流会话状态
  sessions: Map<string, WorkflowSession>;
  
  // 结构化产物
  artifacts: Map<string, Artifact>;
  
  // 事件日志（可回放）
  eventLog: EventLog;
  
  // 审批状态 ⭐ 新增
  approvals: Map<string, ApprovalRecord>;
  
  // 操作
  getSession(sessionId: string): WorkflowSession;
  saveArtifact(artifact: Artifact): void;
  appendEvent(event: Event): void;
  replay(sessionId: string): Event[];
  
  // 审批操作 ⭐ 新增
  submitForApproval(item: ApprovalItem): void;
  approve(itemId: string, reviewerId: string): void;
  reject(itemId: string, reviewerId: string, reason: string): void;
}
```

---

### 8.8 完整执行链路

```
┌─────────────────────────────────────────────────────────────────────┐
│                         完整执行链路                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. Workflow Runtime 决定当前 state                                 │
│                         ↓                                           │
│  2. AI 在该 state 内：                                              │
│     ├─ 调用后端 Tool（通过 Tool Executor）                          │
│     │   → 鉴权 → 限流 → 执行 → 审计                                 │
│     │                                                               │
│     └─ 请求 UI（输出 UI Spec）                                      │
│         → 校验 Spec → 渲染组件                                      │
│                         ↓                                           │
│  3. UI Host 渲染组件，收集用户输入                                  │
│                         ↓                                           │
│  4. 用户操作产生 Event，回传给 Workflow                             │
│                         ↓                                           │
│  5. Workflow 根据 Event 迁移 State                                  │
│                         ↓                                           │
│  6. 继续下一轮，直到 Final State                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**关键保障**：
- AI 随时可调一切后端能力（Tool）✅
- AI 随时可调一切前端交互（Component）✅
- 所有东西都在"轨道"里 ✅
- 不自由发挥 UI ✅
- 不破坏 shadcn ✅

---

## 九、最小闭环验证（MVP）

> **核心原则**：不写新文档，不加新功能。先用新架构跑通一个最小闭环。

### 8.1 为什么要先做最小闭环

之前的问题是：
- 在一个局部功能里承载了整个系统复杂度
- 越做越累，体验越调越不对

现在要做的是：
- 用新架构验证"承载复杂度的位置"是否正确
- 如果最小闭环跑顺，之前所有的痛点都会自动消失

### 9.2 选择验证场景

**推荐场景 A：创建客户**
- 简单、直观、容易验证
- 涉及表单操作，可验证"画布"设计
- 后续可自然延伸到报价、合同

**推荐场景 B：分析一份合同（推荐）**
- 能验证工具调用（解析、风险扫描）
- 能验证实时流式反馈
- 能验证结果展示和人工接管
- 能验证完整的 Workflow 状态机

**analyze_document 工作流详细设计**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                    analyze_document 工作流                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  State 1: upload                                                    │
│  ├─ Tools: files.upload, files.extract_text                        │
│  ├─ UI: AiForm (文件上传)                                           │
│  └─ → file.uploaded → analyzing                                    │
│                                                                     │
│  State 2: analyzing                                                 │
│  ├─ Tools: contract.parse, contract.risk_scan                      │
│  ├─ UI: AiStepper + AiConsole (真实进度)                            │
│  └─ → analysis.complete → review                                   │
│                                                                     │
│  State 3: review                                                    │
│  ├─ Tools: contract.propose_patch                                  │
│  ├─ UI: AiReviewPanel + AiDetails (风险+修订建议)                   │
│  ├─ → user.approve → applying                                      │
│  └─ → user.reject → done                                           │
│                                                                     │
│  State 4: applying                                                  │
│  ├─ Tools: contract.apply_patch                                    │
│  ├─ UI: AiModalConfirm + AiConsole                                 │
│  └─ → patch.applied → done                                         │
│                                                                     │
│  State 5: done (Final)                                              │
│  └─ UI: AiDetails (最终结果)                                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

这一个闭环跑通，整套架构就立住了。

### 8.3 验证标准（必须全部满足）

| 要求 | 说明 |
|------|------|
| ✅ **只通过 AI 助手入口** | 不使用传统页面按钮 |
| ✅ **只用 Tool / Workflow** | 所有能力都是工具调用 |
| ✅ **只用对话流 + 画布** | 对话指挥，画布执行 |
| ✅ **人和 AI 操作完全等价** | 同一个 Command，谁都能触发 |
| ✅ **规划过程可见可改** | Agent 计划步骤可展示、可修改 |
| ✅ **决策分级生效** | 根据任务级别决定自动/确认 |

### 8.4 最小闭环的交互流程（以「创建客户」为例）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 步骤 1：用户唤起 AI 助手                                             │
├─────────────────────────────────┬───────────────────────────────────┤
│          对话流                  │              画布                 │
│                                 │                                   │
│ [点击右下角 AI 按钮]            │  ┌─────────────────────────────┐ │
│                                 │  │ 📍 当前：首页               │ │
│                                 │  │                             │ │
│ 🤖 你好！我是你的 AI 助手       │  │ 🛠️ 可用工具                  │ │
│    当前在首页，我可以帮你：     │  │ [搜索] [新建] [统计] [导航] │ │
│                                 │  │                             │ │
│    💡 快捷指令：                │  │ ⚡ 快捷工作流               │ │
│    [创建客户] [查看报价]        │  │ [创建客户] [生成报价]       │ │
│    [分析合同] [查看统计]        │  │                             │ │
│                                 │  └─────────────────────────────┘ │
└─────────────────────────────────┴───────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 步骤 2：用户发起指令                                                 │
├─────────────────────────────────┬───────────────────────────────────┤
│          对话流                  │              画布                 │
│                                 │                                   │
│ 👤 帮我创建一个客户，           │                                   │
│    叫做 XX 设计公司             │                                   │
│                                 │                                   │
│ 🤖 收到，我来帮你创建客户       │                                   │
│                                 │                                   │
│    ┌───────────────────────┐   │                                   │
│    │ 📋 执行计划            │   │                                   │
│    │                        │   │                                   │
│    │ 1. 调用「创建客户」工具│   │                                   │
│    │    参数：              │   │                                   │
│    │    - 名称: XX 设计公司 │   │                                   │
│    │    - 类型: 企业        │   │                                   │
│    │                        │   │                                   │
│    │ [确认执行] [修改] [取消]   │                                   │
│    └───────────────────────┘   │                                   │
│                                 │                                   │
└─────────────────────────────────┴───────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 步骤 3：用户确认，AI 在画布中打开表单                                │
├─────────────────────────────────┬───────────────────────────────────┤
│          对话流                  │              画布                 │
│                                 │                                   │
│ 👤 [点击确认执行]               │  ┌─────────────────────────────┐ │
│                                 │  │ ➕ 新建客户                 │ │
│ 🤖 好的，我打开了创建表单       │  ├─────────────────────────────┤ │
│    正在填写你提供的信息...      │  │                             │ │
│                                 │  │ 客户名称                    │ │
│    ┌───────────────────────┐   │  │ [XX 设计公司] ← AI 正在填   │ │
│    │ 🔄 正在填写表单        │   │  │  ↑ 高亮 + 打字动画          │ │
│    │ ████████░░ 80%         │   │  │                             │ │
│    └───────────────────────┘   │  │ 客户类型                    │ │
│                                 │  │ [企业 ▼] ← AI 自动选择      │ │
│                                 │  │                             │ │
│                                 │  │ 联系人  [          ]        │ │
│                                 │  │ 电话    [          ]        │ │
│                                 │  │ 地址    [          ]        │ │
│                                 │  │                             │ │
│                                 │  │ [保存] [取消]               │ │
│                                 │  └─────────────────────────────┘ │
└─────────────────────────────────┴───────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 步骤 4：AI 填写完成，等待用户补充或确认                              │
├─────────────────────────────────┬───────────────────────────────────┤
│          对话流                  │              画布                 │
│                                 │                                   │
│ 🤖 我已填入客户名称和类型       │  ┌─────────────────────────────┐ │
│    你可以补充联系人信息，       │  │ ➕ 新建客户                 │ │
│    或者直接保存                 │  ├─────────────────────────────┤ │
│                                 │  │                             │ │
│    💡 下一步：                  │  │ 客户名称                    │ │
│    [直接保存]                   │  │ [XX 设计公司] ✅            │ │
│    [我来补充联系人]             │  │                             │ │
│    [帮我查一下这个公司的信息]   │  │ 客户类型                    │ │
│                                 │  │ [企业 ▼] ✅                 │ │
│                                 │  │                             │ │
│                                 │  │ 联系人  [          ] ← 光标 │ │
│                                 │  │ 电话    [          ]        │ │
│                                 │  │ 地址    [          ]        │ │
│                                 │  │                             │ │
│                                 │  │ [保存] [取消]               │ │
│                                 │  └─────────────────────────────┘ │
│                                 │                                   │
│                                 │  用户可以直接在画布中手动填写    │
└─────────────────────────────────┴───────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 步骤 5：用户补充信息（人操作画布）                                   │
├─────────────────────────────────┬───────────────────────────────────┤
│          对话流                  │              画布                 │
│                                 │                                   │
│                                 │  ┌─────────────────────────────┐ │
│                                 │  │ ➕ 新建客户                 │ │
│                                 │  ├─────────────────────────────┤ │
│                                 │  │                             │ │
│                                 │  │ 客户名称 [XX 设计公司] ✅   │ │
│                                 │  │ 客户类型 [企业 ▼] ✅        │ │
│ 🤖 检测到你填写了联系人信息     │  │ 联系人   [张三] ← 用户输入  │ │
│    还需要补充电话和地址吗？     │  │ 电话     [138xxxx] ← 用户   │ │
│                                 │  │ 地址     [          ]       │ │
│    💡 快捷：                    │  │                             │ │
│    [不用了，直接保存]           │  │ [保存] [取消]               │ │
│    [帮我查一下公司地址]         │  └─────────────────────────────┘ │
│                                 │                                   │
└─────────────────────────────────┴───────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 步骤 6：保存完成，预判下一步                                         │
├─────────────────────────────────┬───────────────────────────────────┤
│          对话流                  │              画布                 │
│                                 │                                   │
│ 👤 [点击保存] 或 说"保存"       │  ┌─────────────────────────────┐ │
│                                 │  │ ✅ 客户创建成功             │ │
│ 🤖 客户「XX 设计公司」          │  ├─────────────────────────────┤ │
│    创建成功！                   │  │                             │ │
│                                 │  │ 客户名称：XX 设计公司       │ │
│    💡 下一步你可能想：          │  │ 联系人：张三                │ │
│                                 │  │ 电话：138xxxx               │ │
│    [为这个客户创建报价单]       │  │ 创建时间：2024-12-28        │ │
│    [添加更多联系人]             │  │                             │ │
│    [查看客户列表]               │  │ [编辑] [创建报价] [创建合同]│ │
│    [创建另一个客户]             │  └─────────────────────────────┘ │
│                                 │                                   │
└─────────────────────────────────┴───────────────────────────────────┘
```

### 8.5 验证检查清单

完成最小闭环后，逐项检查：

| 检查项 | 是否通过 |
|--------|---------|
| 整个流程只通过 AI 助手完成 | ☐ |
| 画布中的表单，人可以直接手动填写 | ☐ |
| AI 的执行计划在执行前可见 | ☐ |
| 用户可以修改 AI 的计划 | ☐ |
| AI 填写表单时有视觉反馈 | ☐ |
| 人的修改 AI 能实时感知 | ☐ |
| 创建操作需要用户确认（L3级） | ☐ |
| 点击画布按钮和 AI 执行走同一个 Command | ☐ |
| 操作记录在统一日志中 | ☐ |
| 完成后有合理的预判指令 | ☐ |

---

## 九、实施路线

| 阶段 | 内容 | 价值 |
|------|------|------|
| **P0** | 统一 AI 助手组件框架 + Agent 服务骨架 | 建立基础架构 |
| **P1** | 页面感知 + 5 个核心工具 + 导航能力 | 基本可用 |
| **P2** | 工作流引擎 + 3 个核心工作流 | 复杂任务自动化 |
| **P3** | 对话历史 + 上下文记忆 | 连续性体验 |
| **P4** | 主动提示 + 智能推荐 | 超越被动响应 |

---

## 九、关键风险与防护机制

> 以下三个风险是架构落地过程中最容易"悄悄炸掉"的地方，必须在设计阶段就建立防护机制。

### ⚠️ 风险 1：Agent 变成"超级黑盒"

**问题描述**：
意图识别 → 任务规划 → 工具执行 → 结果整合，这个流程在架构上是对的，但如果不刻意设计"规划过程的可见性"，Agent 会变成一个"看起来很聪明，但不可理解"的东西。

**风险表现**：
- 用户不知道 AI 为什么选了这个工具
- 用户不知道 AI 接下来要做什么
- 用户无法在执行前修正 AI 的计划
- 从"假交互 Workbench"变成"真执行但黑盒的超级 Agent"

**🔴 红线约束**：

> **Agent 的"规划结果"必须是结构化、可展示、可修改的。**

**具体要求**：

```
┌─────────────────────────────────────────────────────────────────────┐
│  🧠 AI 正在规划...                                                   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  📋 执行计划                                      [可编辑]    │   │
│  │                                                              │   │
│  │  1. 🔍 搜索客户「XX公司」                                    │   │
│  │     理由：需要获取客户ID                                     │   │
│  │                                                              │   │
│  │  2. 📄 调用「合同生成」工具                                   │   │
│  │     理由：用户要求创建合同                                   │   │
│  │     参数：客户ID, 模板=设计合同                              │   │
│  │                                                              │   │
│  │  3. ⚠️ 调用「风险扫描」工具                                   │   │
│  │     理由：自动检查生成的合同                                 │   │
│  │                                                              │   │
│  │  [✏️ 修改计划]  [▶️ 确认执行]  [❌ 取消]                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**必须暴露的信息**：
| 信息 | 说明 |
|------|------|
| **计划步骤列表** | 清晰列出要执行的每一步 |
| **选用的工具清单** | 每一步用什么工具 |
| **每一步的理由** | 简要说明为什么这么做 |
| **关键参数** | 显示将要传入的参数 |

**用户权限**：
- ✅ 可以修改计划顺序
- ✅ 可以删除某个步骤
- ✅ 可以添加步骤
- ✅ 可以修改参数
- ✅ 可以取消整个计划

---

### ⚠️ 风险 2：能力太多反噬体验

**问题描述**：
入口统一了、能力清晰了，但如果 AI 的决策逻辑不被限制，用户会从"不知道点哪里"变成"不知道 AI 在干嘛"，造成心理失控感。

**风险表现**：
- AI 自动做了很多事，用户感到不安
- 用户不知道 AI 会不会"搞砸"
- 用户不敢让 AI 处理重要任务
- 强 Agent + 强工具 = 强焦虑

**🔴 红线约束**：

> **引入"AI 决策透明度分级"，根据任务影响程度决定自动化程度。**

**分级机制**：

| 级别 | 任务类型 | AI 行为 | 示例 |
|------|---------|---------|------|
| **L1 - 自动** | 只读/查询/分析 | 直接执行，事后告知 | 搜索客户、查看统计、分析报告 |
| **L2 - 告知** | 小范围修改 | 先说明，再执行 | 更新单个字段、添加备注 |
| **L3 - 确认** | 创建/删除/重要修改 | 必须确认执行计划 | 创建合同、删除客户、批量修改 |
| **L4 - 逐步** | 复杂多步骤流程 | 每一步都需确认 | 合同全流程、批量操作 |

**交互示例**：

```
L1（自动执行）：
┌────────────────────────────────────┐
│ 🤖 已搜索到 3 个匹配的客户         │
│    [查看结果]                      │
└────────────────────────────────────┘

L2（先说明再执行）：
┌────────────────────────────────────┐
│ 🤖 我将把联系人电话更新为          │
│    138xxxx1234                     │
│    正在执行...                     │
└────────────────────────────────────┘

L3（必须确认）：
┌────────────────────────────────────┐
│ 🤖 我将为 XX公司 创建一份设计合同  │
│    使用模板：标准设计合同          │
│    预计金额：50,000 元             │
│                                    │
│    [确认创建] [修改参数] [取消]    │
└────────────────────────────────────┘

L4（逐步确认）：
┌────────────────────────────────────┐
│ 🤖 合同全流程（共4步）             │
│    ✅ 步骤1: 选择客户 - 已完成     │
│    ▶️ 步骤2: 生成合同 - 待确认     │
│    ⏸️ 步骤3: 风险扫描              │
│    ⏸️ 步骤4: 发送审批              │
│                                    │
│    [继续步骤2] [跳过] [终止流程]   │
└────────────────────────────────────┘
```

**用户可配置**：
- 用户可以调整自己的分级偏好（更激进 / 更保守）
- 某些工具可以被用户标记为"总是确认"
- 历史上出过问题的操作，自动提升确认级别

---

### ⚠️ 风险 3：IDE 化形似神不似

**问题描述**：
IDE 化真正的难点不在布局（命令面板、快捷键、工具栏），而在于"Everything is a Command"。如果底层操作依然是页面事件触发，IDE 化会是形似神不似。

**风险表现**：
- AI 调用的是一套逻辑
- 人在画布点的是另一套逻辑
- "人机双轨等价"被破坏
- 出现"AI 能做但人做不了"或"人能做但 AI 做不了"的情况

**🔴 红线约束**：

> **任何画布上的操作，背后都必须是 Command。人和 AI 共享同一套命令层。**

**架构要求**：

```
                    ┌─────────────────┐
                    │   Command Layer │
                    │   (统一命令层)   │
                    └────────┬────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
        ┌─────────┐   ┌─────────┐   ┌─────────┐
        │ AI 调用  │   │ UI 点击  │   │ 快捷键   │
        └─────────┘   └─────────┘   └─────────┘
              │              │              │
              └──────────────┼──────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  Tool Executor  │
                    │   (工具执行器)   │
                    └─────────────────┘
```

**具体要求**：

| 约束 | 说明 |
|------|------|
| **统一命令定义** | 每个操作都有唯一的 Command 定义 |
| **三种触发方式** | 同一 Command 可被 AI / UI / 快捷键触发 |
| **参数一致** | 无论谁触发，参数格式完全一致 |
| **结果一致** | 无论谁触发，执行结果完全相同 |
| **可追溯** | 所有执行都记录到统一的操作日志 |

**命令定义示例**：

```typescript
// 每个操作都是一个 Command
interface Command {
  id: string;                    // 唯一标识，如 'client.create'
  name: string;                  // 显示名称
  description: string;           // 功能描述
  params: ParamSchema;           // 参数定义
  execute: (params) => Promise;  // 执行函数
  canUndo: boolean;              // 是否可撤销
  level: 'L1' | 'L2' | 'L3' | 'L4';  // 决策级别
}

// 三种触发方式，调用同一个 Command
// 1. AI 调用
await executeCommand('client.create', { name: 'XX公司', ... });

// 2. UI 按钮点击
<Button onClick={() => executeCommand('client.create', formData)} />

// 3. 快捷键
registerShortcut('Ctrl+Shift+C', () => openCommandDialog('client.create'));
```

**验证标准**：
- ✅ 画布上的每个按钮，都能找到对应的 Command
- ✅ AI 执行的每个操作，人都能通过画布完成
- ✅ 操作日志不区分"AI操作"和"人工操作"
- ✅ 快捷键列表 = 命令列表 = AI 工具列表

---

## 十、核心原则

### 9.1 交互原则

1. **人只说话，AI 调度** - 用户表达需求，AI 负责执行
2. **一个入口解决所有问题** - 统一对话入口，无需寻找功能
3. **上下文感知** - AI 知道用户在哪、在做什么
4. **自然语言优先** - 像与专家对话一样交流

### 9.2 技术原则

1. **真实交互** - 每一步都是真实发生的，禁止假进度
2. **实时反馈** - 工具执行过程实时可见
3. **可中断** - 用户可随时停止执行
4. **透明执行** - 用户知道 AI 在调用什么工具

### 9.3 设计原则

1. **工具化** - 能力抽象为可复用的工具
2. **工作流化** - 复杂任务编排为工作流
3. **渐进增强** - 在现有系统基础上逐步升级
4. **体验一致** - 无论在哪个页面，AI 助手体验一致

### 9.4 IDE 化原则

1. **工作区思维** - 以工作区而非页面组织界面
2. **命令优先** - 所有操作可通过命令执行
3. **快捷键友好** - 常用操作都有快捷键
4. **可编程性** - 界面操作可被程序化调用

### 9.5 人机双轨原则

1. **操作等价** - AI 能做的，人也能手动做
2. **结果一致** - 无论谁触发，效果完全相同
3. **可审计** - 能看到 AI 做了什么操作
4. **可接管** - 人可随时接管，继续手动操作
5. **可回退** - AI 的操作可以被撤销或修改

### 9.6 对话流 + 画布原则

1. **对话是指挥，画布是执行** - 对话流负责沟通，画布负责操作
2. **画布内容可被双方操作** - 人可以直接在画布中操作，AI 也可以
3. **AI 操作有视觉反馈** - AI 在画布中操作时，有明确的视觉指示
4. **画布变化 AI 可感知** - 人在画布中的任何修改，AI 都能实时感知
5. **画布是标准组件** - 画布中的表单、列表与系统其他地方完全一致

### 9.7 AI 预判原则

1. **主动预测下一步** - AI 根据当前上下文，预判用户接下来可能的操作
2. **提供备选指令** - 每次对话后，显示 3-5 个最可能的后续指令
3. **一键触发** - 用户点击备选指令即可直接执行，无需打字
4. **动态更新** - 备选指令随上下文实时变化
5. **学习优化** - 根据用户选择习惯，优化预判准确率

### 9.8 能力可见性原则

1. **能力可见** - 用户进入任何模块，都能看到 AI 在此能做什么
2. **分类清晰** - 工具和工作流分开展示，便于理解和选择
3. **上下文相关** - 根据当前页面/选中内容动态显示相关工具
4. **可探索** - 支持悬停查看详情、搜索工具、询问 AI
5. **不打扰** - 工具栏可收起，不影响日常操作

---

## 🔴 架构红线（不可违反）

> 以下两条是"防止架构退化"的保险丝，必须在代码层面强制执行。

### 红线 1：Interaction Orchestrator 拥有 UI 最终裁决权

```
AI（任何角色）永远不能直接决定 UI 的呈现方式，只能提出请求。
```

| 角色 | 能做 | 不能做 |
|------|------|--------|
| Role | 提出 `uiSuggestion` | 直接调用 `render()` |
| Orchestrator | 决定是否呈现、如何呈现 | - |

**违反后果**：架构退化为"AI 控制 UI"，失去可控性。

### 红线 2：预判指令默认需人确认

```
任何 Predicted Action，默认必须是"需人确认"的。
绝对禁止：AI 看你可能要做 → 就帮你做了。
```

| 类型 | 点击后 | 绝对禁止 |
|------|--------|---------|
| execute | 显示确认 → 等待确认 → 执行 | 点击直接执行 |
| template | 填入输入框 → 等待补充 | 自动补充并执行 |
| question | 可直接发送（低风险） | - |

**违反后果**：变成"AI 自作主张"，重回用户最反感的体验。

---

## 附录 A：术语定义

| 术语 | 定义 |
|------|------|
| **AI 原生** | 以 AI 为核心设计的应用，而非在传统应用上添加 AI 功能 |
| **工具** | 封装的原子能力，AI 可根据意图自动调用 |
| **工作流** | 多个工具的编排，完成复杂任务 |
| **页面感知** | AI 自动识别用户当前所在页面和上下文 |
| **实时交互** | 工具执行过程实时反馈，非事后拼合 |
| **Agent** | 具备意图识别、任务规划、工具调用能力的 AI 服务 |
| **命令面板** | 类似 IDE 的快速命令入口，可搜索执行任何操作 |
| **人机双轨** | 同一操作可由人手动触发，也可由 AI 自动执行 |
| **IDE 化** | 借鉴 IDE 的设计理念，让系统更工具化、可编程化 |
| **对话流** | AI 助手中的对话区域，用于人机交流、指令下达 |
| **画布** | AI 助手中的操作区域，承载表单、列表等实际操作界面 |
| **投射** | AI 将操作界面显示到画布中的动作 |
| **画布操作** | 在画布中进行的操作，可由人或 AI 触发 |
| **预判指令** | AI 根据上下文预测的用户可能的下一步操作 |
| **快捷指令** | 可直接点击执行的预判指令 |
| **提示词模板** | 需要用户补充信息的预判指令 |
| **AI 能力工具栏** | 画布顶部显示当前模块可用的工具和工作流 |
| **能力可见性** | 让用户直观看到 AI 能做什么，降低学习成本 |
| **Tool Protocol** | AI 调用后端能力的协议规范 |
| **UI Protocol** | AI 请求渲染组件的协议规范 |
| **UI Spec** | AI 输出的结构化 UI 描述，而非 JSX |
| **交互原语** | 可被 AI 调用的最小 UI 单元（Form/List/Modal 等） |
| **AIInteractionHost** | 统一的组件宿主，负责渲染和事件回传 |
| **Registry** | 注册表，工具和组件的清单与元数据 |
| **Execution Runtime** | 执行运行时，负责鉴权、限流、审计 |
| **State Store** | 状态存储，工作流会话、产物、事件日志 |
| **Role（角色）** | 行为与权限的约束器，不是换皮的 prompt |
| **Orchestrator** | 调度官角色，负责规划步骤、选择 workflow |
| **Executor** | 作业员角色，按指令调用工具生成产物 |
| **Reviewer** | 质检官角色，审查产物，给通过/驳回 |
| **领域专家** | 按板块挂载的专业角色（Legal Expert 等） |
| **Role Registry** | 角色注册表，定义角色权限、工具白名单、输出 schema |
| **Tool 白名单** | 角色只能调用白名单内的工具 |
| **审批状态机** | Reviewer 通过后，Executor 才能执行敏感操作 |

---

## 附录 B：与传统企业后台的对比

| 维度 | 传统企业后台 | IDE 化 AI 原生后台 |
|------|-------------|-------------------|
| **布局** | 固定菜单 + 内容区 | 工作区 + 面板 + 命令面板 |
| **导航** | 层层点击菜单 | 命令面板快速跳转 |
| **操作** | 找到页面 → 找到按钮 → 点击 | 说出需求 或 输入命令 |
| **AI 定位** | 辅助功能，分散在各页面 | 核心交互方式，统一入口 |
| **学习成本** | 需要学习系统结构 | 会说话就会用 |
| **效率** | 依赖熟练度 | AI 自动优化路径 |
| **可扩展性** | 加功能 = 加页面 | 加功能 = 注册工具 |

---

## 附录 C：参考设计

**可参考的产品**：
- **VS Code / Cursor** - 命令面板、面板布局、AI 集成
- **Notion** - AI 助手交互、块编辑器
- **Linear** - 快捷键系统、命令面板
- **Raycast** - 命令面板设计、AI 扩展

**可参考的理念**：
- **Everything is a command** - 所有操作都是命令
- **Keyboard first** - 键盘优先
- **AI as co-pilot** - AI 作为副驾驶
- **Progressive disclosure** - 渐进式展示复杂功能

---

**文档结束**

> 本文档基于产品探讨整理，后续将根据实施情况持续更新。
> 
> **版本历史**：
> - v1.0 (2024-12-28) - 初始版本，包含核心理念
> - v1.1 (2024-12-28) - 增加 IDE 化设计理念和人机双轨原则
> - v1.2 (2024-12-28) - 增加对话流+画布双区设计，完善人机协作交互模式
> - v1.3 (2024-12-28) - 增加 AI 预判指令设计，包含快捷指令、模板、追问三种类型
> - v1.4 (2024-12-28) - 增加 AI 能力工具栏设计，实现能力可见性
> - v2.0 (2024-12-28) - **重大更新**：增加三大风险防护机制（Agent透明化、决策分级、Command统一层）；增加最小闭环验证方案
> - v3.0 (2024-12-28) - **架构定稿**：完整工程架构设计，包含 Tool Protocol、UI Protocol、包结构、8个交互原语组件、AIInteractionHost、Workflow 状态机
> - v3.1 (2024-12-28) - **多角色系统**：三层角色设计（系统角色+领域专家+工具角色）、Role Registry、工具白名单、产物 Schema、审批状态机
> - v3.2 (2024-12-28) - **架构红线封顶**：明确 Interaction Orchestrator 的 UI 最终裁决权；预判指令默认需人确认，禁止自动执行

