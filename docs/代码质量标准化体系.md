# dhs-atlas 代码质量标准化体系（v1.0）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 强制性质量标准  
> **约束范围**: 人类开发者与 AI（Cursor）产出

本文档定义 dhs-atlas 的代码质量"硬标准"。任何偏离均视为架构风险与质量缺陷，必须在合并前修正。

---

## 一、总则与质量目标

### 1.1 质量目标

| 目标 | 定义 |
|------|------|
| **可维护** | 新增功能不引入结构性复杂度，不破坏既有边界 |
| **可验证** | 每个关键行为可测试、可回放、可审计 |
| **可控** | AI 行为、权限、数据隔离均有硬约束，避免"看起来能用"的假交互 |
| **一致性** | 同类问题用同类方式解决；UI、错误、日志、schema、命名统一 |

### 1.2 红线（零容忍）

以下行为视为严重质量事故，必须立即修复：

| 红线 | 后果 |
|------|------|
| 未绑定 `enterpriseId` 的任何业务数据读写或 AI 产物存储 | 数据泄露风险 |
| 绕过 Tool / Workflow / UI Protocol 的直接业务逻辑（"临时代码"） | 架构崩塌 |
| UI 层包含业务决策逻辑（组件做了 tool/workflow 的事） | 不可维护 |
| 任何"假交互"：伪进度、伪流式、无真实执行却展示"已完成" | 欺骗用户 |
| shadcn 体系被随意魔改/引入第二套组件体系 | UI 不可控 |
| 使用 Emoji 作为状态或信息表达 | AI 无法解析 |

---

## 二、工程基线（强制）

### 2.1 TypeScript 强约束

**tsconfig 必须启用严格模式**：

```json
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "exactOptionalPropertyTypes": true,
    "noUncheckedIndexedAccess": true
  }
}
```

**规则**：

| 规则 | 说明 |
|------|------|
| 禁止 `any` | 除非有明确隔离边界的桥接层，并附注原因与替代计划 |
| 运行时校验 | 所有外部输入必须有运行时校验（见 4.1） |
| 类型推断 | 优先使用类型推断，避免冗余类型声明 |

### 2.2 依赖与包管理

| 规则 | 说明 |
|------|------|
| **Monorepo** | 使用 pnpm workspace |
| **版本锁定** | 依赖版本必须锁定，禁止 `^` 或 `~` |
| **禁止随意引入** | 禁止引入"便利但不必要"的库 |
| **公共能力** | 优先进入 `packages/*`，禁止复制粘贴形成影子实现 |

### 2.3 格式化与静态检查

| 工具 | 强制级别 | 说明 |
|------|---------|------|
| **Prettier** | CI 强制 | 统一格式 |
| **ESLint** | CI 强制 | 静态检查 |
| **TypeCheck** | CI 强制 | 类型检查 |

**eslint-disable 使用规则**：

```typescript
// ✅ 允许：精确到单行/单规则，并注释原因
// eslint-disable-next-line @typescript-eslint/no-explicit-any -- 第三方库类型不完整，计划在 v2.0 补充类型
const result = legacyLib.process(data) as any;

// ❌ 禁止：大范围禁用
/* eslint-disable */
```

---

## 三、架构边界与目录规范（反屎山核心）

### 3.1 分层原则

```
┌─────────────────────────────────────────────────────────────┐
│                         分层架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  UI 层 (ai-ui / app)                                 │   │
│  │  只负责呈现与收集输入；不含业务决策                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Agent/Workflow 层 (ai-core)                         │   │
│  │  规划、调度、状态机、权限策略                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Tool 层 (ai-tools)                                  │   │
│  │  原子能力执行（带审计、幂等、权限）                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  数据层 (db/repo)                                    │   │
│  │  数据访问与事务封装，不暴露业务语义到上层              │   │
│  └─────────────────────────────────────────────────────┘   │
│                           │                                 │
│                           ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  协议层 (schemas/protocol)                           │   │
│  │  Tool、UI、Event、Artifact 的 schema 定义与版本       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 禁止的耦合

| 禁止行为 | 原因 |
|---------|------|
| UI 组件直接调用数据库或绕过 Tool 执行写操作 | 破坏分层 |
| Tool 直接决定 UI 呈现方式 | 只能给 `uiSuggestion`，最终裁决在 Orchestrator |
| 业务模块各自实现一套"工具注册/事件日志/权限判断" | 形成影子系统 |

### 3.3 "唯一入口"要求

| 能力类型 | 注册位置 | 要求 |
|---------|---------|------|
| 可执行能力 | Tool Registry | 必须注册 |
| 可呈现交互 | UI Registry | 必须注册 |
| 流程 | Workflow Registry | 必须注册 |

> **未注册的能力/组件/流程不得在业务代码中被直接调用。**

---

## 四、数据、输入输出与多企业隔离

### 4.1 Schema First（硬标准）

| 输入来源 | 校验要求 |
|---------|---------|
| HTTP 请求 | 必须经过 schema 校验 |
| UI 事件 | 必须经过 schema 校验 |
| 模型输出 | 必须经过 schema 校验 |
| 第三方回调 | 必须经过 schema 校验 |

**实现要求**：

```typescript
// ✅ 正确：使用 Zod 校验
import { z } from 'zod';

const CreateClientSchema = z.object({
  name: z.string().min(1),
  type: z.enum(['enterprise', 'individual']),
  enterpriseId: z.string().uuid(), // 必须
});

export async function createClient(input: unknown) {
  const validated = CreateClientSchema.parse(input);
  // ...
}

// ❌ 错误：直接信任输入
export async function createClient(input: CreateClientInput) {
  // 没有运行时校验
}
```

**模型输出禁止"自然语言解析后硬凑"，必须走结构化 schema。**

### 4.2 Multi-Tenant 强制规则

| 规则 | 说明 |
|------|------|
| **enterpriseId 必须** | 任何 Tool、Workflow、Artifact、Event、DB 读写都必须显式携带 |
| **跨企业访问** | 必须由管理员级策略显式授权并记录审计事件 |
| **单企业体验** | 只是 UI 隐藏，不代表后端省略 multi-tenant 约束 |

```typescript
// ✅ 正确：显式携带 enterpriseId
const clients = await db.client.findMany({
  where: { enterpriseId: context.enterpriseId }
});

// ❌ 错误：缺少 enterpriseId
const clients = await db.client.findMany();
```

### 4.3 幂等与可回放

| 要求 | 实现 |
|------|------|
| **幂等** | Tool 调用必须支持 `requestId`（幂等键）或等价机制 |
| **可回放** | 关键操作必须产生事件日志（Event Log），支持回放（Replay） |
| **可审计** | 所有写操作必须可追溯（Audit） |

---

## 五、AI 相关质量标准（防假智能）

### 5.1 角色与权限

**角色不是提示词皮肤**，必须绑定：

```typescript
interface RoleDefinition {
  id: string;
  name: string;
  
  // 工具白名单（必须）
  allowedTools: string[];
  
  // 输出 schema（必须）
  outputSchema: ZodSchema;
  
  // 需要审批的动作（必须）
  requiresApproval: string[];
}
```

> **"可建议不可执行"的边界必须由代码实现，而不是文档约定。**

### 5.2 工具调用规范

Tool 必须满足：

| 要求 | 说明 |
|------|------|
| **单一职责** | 一个 Tool 只做一件事 |
| **明确 schema** | 输入/输出都有 schema |
| **可审计** | 写 event |
| **可失败** | 明确错误码与恢复建议 |
| **不吞错** | 不得返回"看似成功"的结果 |

```typescript
// ✅ 正确：明确错误处理
export async function createClient(params: CreateClientParams): Promise<ToolResult<Client>> {
  try {
    const client = await db.client.create({ data: params });
    await eventLog.write({
      type: 'client.created',
      enterpriseId: params.enterpriseId,
      data: { clientId: client.id }
    });
    return { success: true, data: client };
  } catch (error) {
    return {
      success: false,
      error: {
        code: 'CLIENT_CREATE_FAILED',
        message: error.message,
        recoverHint: '请检查客户名称是否重复'
      }
    };
  }
}

// ❌ 错误：吞错
export async function createClient(params: CreateClientParams) {
  try {
    return await db.client.create({ data: params });
  } catch {
    return null; // 吞掉错误
  }
}
```

### 5.3 交互规范

| 规则 | 说明 |
|------|------|
| **AI 不生成组件** | AI 只能返回 `componentId + props` |
| **UI schema 校验** | 必须通过 UI schema 校验 |
| **结构化回传** | UI 事件必须结构化回传，进入 workflow state transition |
| **禁止伪交互** | 任何进度展示必须来自真实执行状态或事件流 |

```typescript
// ✅ 正确：AI 返回 UI Spec
{
  "ui": {
    "componentId": "AiForm",
    "props": {
      "title": "创建客户",
      "schemaId": "client.create"
    }
  }
}

// ❌ 错误：AI 返回 JSX
{
  "ui": "<Form><Input name='name' /></Form>"
}
```

---

## 六、代码风格与可读性标准

### 6.1 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 模块/包 | kebab-case | `ai-tools` |
| TS 文件 | kebab-case | `create-client.ts` |
| 类 | PascalCase | `ClientService` |
| 函数/变量 | camelCase | `createClient` |
| 常量 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| 布尔值 | is/has/can/should 前缀 | `isActive`, `hasPermission` |

### 6.2 函数与模块复杂度

| 指标 | 建议值 | 超出处理 |
|------|--------|---------|
| 单函数行数 | ≤ 60 行 | 必须说明原因或拆分 |
| 单文件行数 | ≤ 300 行 | 需拆分或抽象 |
| 函数参数数 | ≤ 4 个 | 使用对象参数 |

**禁止"巨型服务类"**，应拆成：
- tool（能力）
- policy（策略）
- repo（数据访问）
- formatter（格式化）

### 6.3 注释原则

**不写"翻译代码"的注释**，只写：

| 注释类型 | 说明 |
|---------|------|
| **Why** | 为什么这么做 |
| **Edge cases** | 风险与边界 |
| **Policy/Protocol** | 约束来源 |

```typescript
// ✅ 正确：说明约束来源
// Multi-tenant 强制规则：所有查询必须携带 enterpriseId
// 参见：代码质量标准化体系 4.2
const clients = await db.client.findMany({
  where: { enterpriseId }
});

// ❌ 错误：翻译代码
// 查询所有客户
const clients = await db.client.findMany({
  where: { enterpriseId }
});
```

---

## 七、错误处理、日志与可观测性

### 7.1 错误模型统一

所有对外错误必须符合统一结构：

```typescript
interface StandardError {
  code: string;           // 错误码（可识别）
  message: string;        // 人类可读消息
  details?: unknown;      // 详细信息
  recoverHint?: string;   // 恢复建议
}
```

**禁止**：

```typescript
// ❌ 错误：随意抛出字符串
throw new Error("Something went wrong");

// ✅ 正确：使用标准错误
throw new AppError({
  code: 'CLIENT_NOT_FOUND',
  message: '客户不存在',
  recoverHint: '请检查客户 ID 是否正确'
});
```

### 7.2 日志与审计

**日志分离**：

| 类型 | 用途 | 要求 |
|------|------|------|
| **业务日志** | 调试与运行态 | 可选 |
| **审计日志** | 可追责 | 不可缺失 |

**审计日志必须记录**：

| 字段 | 说明 |
|------|------|
| who | 用户/角色 |
| where | 在哪个 enterprise |
| what | 调用了什么 tool |
| result | 产生了什么 artifact |

```typescript
// 审计日志示例
await auditLog.write({
  userId: context.userId,
  roleId: context.roleId,
  enterpriseId: context.enterpriseId,
  toolId: 'client.create',
  params: { name: 'XX公司' },
  result: { clientId: 'xxx' },
  timestamp: new Date()
});
```

### 7.3 性能与稳定性

**长任务必须支持**：

| 能力 | 实现 |
|------|------|
| **进度事件** | event stream |
| **可取消** | cancel token |
| **超时** | 明确超时时间 |
| **重试** | 明确重试策略 |

---

## 八、测试标准（最低合格线）

### 8.1 必测范围（强制）

| 测试对象 | 测试内容 |
|---------|---------|
| **Tool** | 输入校验、幂等、错误码、事件日志写入 |
| **Workflow** | 状态迁移正确性、`allowedTools`/`uiSlots` 限制 |
| **Multi-tenant** | 跨 enterprise 数据隔离、越权访问禁止 |
| **Role Policy** | 白名单与 `requiresApproval` 生效 |

### 8.2 测试类型与门槛

| 测试类型 | 覆盖要求 | 说明 |
|---------|---------|------|
| **单元测试** | 关键模块 ≥ 80% | 核心逻辑必须覆盖 |
| **契约测试** | 100% | Tool / UI 协议 schema 必须测试 |
| **端到端测试** | 至少 1 个闭环 | 最小闭环 workflow（MVP 基准） |

### 8.3 测试示例

```typescript
// Tool 测试示例
describe('createClient', () => {
  it('should validate input schema', async () => {
    await expect(createClient({})).rejects.toThrow('VALIDATION_ERROR');
  });

  it('should require enterpriseId', async () => {
    await expect(createClient({ name: 'Test' })).rejects.toThrow('ENTERPRISE_ID_REQUIRED');
  });

  it('should be idempotent with same requestId', async () => {
    const params = { name: 'Test', enterpriseId: 'xxx', requestId: 'req-1' };
    const result1 = await createClient(params);
    const result2 = await createClient(params);
    expect(result1.data.id).toBe(result2.data.id);
  });

  it('should write audit event', async () => {
    await createClient({ name: 'Test', enterpriseId: 'xxx' });
    expect(auditLog.write).toHaveBeenCalledWith(
      expect.objectContaining({ toolId: 'client.create' })
    );
  });
});

// Multi-tenant 测试示例
describe('multi-tenant isolation', () => {
  it('should not access data from other enterprise', async () => {
    const client = await createClient({ name: 'Test', enterpriseId: 'enterprise-1' });
    
    // 使用另一个 enterprise 的 context 查询
    const result = await getClient(client.id, { enterpriseId: 'enterprise-2' });
    
    expect(result).toBeNull();
  });
});
```

---

## 九、代码审查（Code Review）标准

### 9.1 合并门槛

**必须同时满足**：

| 门槛 | 检查方式 |
|------|---------|
| lint / typecheck / tests 全绿 | CI 自动 |
| 无红线违规（见 1.2） | 人工审查 |
| 多企业隔离检查通过 | enterpriseId 贯穿 |
| Tool/Workflow/UI Registry 未被绕开 | 人工审查 |
| 交互真实性 | 进度与结果来自真实执行 |

### 9.2 审查清单（Reviewer 必查）

- [ ] 是否引入重复实现/影子能力？
- [ ] 是否把业务逻辑写进 UI？
- [ ] 是否存在未审计的写操作？
- [ ] 是否有"为了快"而破坏协议的临时代码？
- [ ] 是否新增了难以测试的耦合点？
- [ ] enterpriseId 是否全链路贯穿？
- [ ] 是否使用了 Emoji？
- [ ] 是否绕过了 Registry？

---

## 十、CI/CD 与质量闸门

### 10.1 必备流水线

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - uses: actions/setup-node@v4
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint
        run: pnpm lint
      
      - name: Type Check
        run: pnpm typecheck
      
      - name: Unit Tests
        run: pnpm test
      
      - name: Contract Tests
        run: pnpm test:contract
      
      - name: E2E Tests
        run: pnpm test:e2e
```

### 10.2 质量闸门配置

| 闸门 | 阻断条件 |
|------|---------|
| **Lint** | 任何 error |
| **TypeCheck** | 任何 error |
| **Tests** | 覆盖率低于阈值或测试失败 |
| **Contract** | Schema 不兼容 |

---

## 十一、AI（Cursor）开发规范（强制）

### 11.1 输出约束

| 约束 | 说明 |
|------|------|
| **目录限制** | Cursor 只能在指定目录内工作（按包边界） |
| **Schema-first** | 必须先定义 schema |
| **Registry-first** | 必须先注册到 Registry |
| **enterpriseId 强制** | 全链路贯穿 |
| **不生成 UI** | 只调用交互原语 |

### 11.2 防"最短路径"机制

**禁止 Cursor 为了通过编译而**：

| 禁止行为 | 说明 |
|---------|------|
| 注释掉类型 | 破坏类型安全 |
| 大范围 `any` | 破坏类型安全 |
| 临时写死数据 | 形成技术债 |
| 伪造进度与结果 | 欺骗用户 |

> **任何此类行为视为质量事故，必须回滚并修复流程与约束。**

### 11.3 Cursor 自检指令

在生成代码前，Cursor 应自问：

```
1. 这个能力是否已注册到 Tool Registry？
2. 这个 UI 是否已注册到 UI Registry？
3. enterpriseId 是否全链路贯穿？
4. 是否有审计日志？
5. 是否有运行时 schema 校验？
6. 是否会产生假交互？
7. 是否引入了重复实现？
```

---

## 十二、版本化与演进规则

### 12.1 Protocol 版本化

所有协议必须版本化：

```typescript
// v1
interface ToolResultV1 {
  success: boolean;
  data?: unknown;
  error?: { code: string; message: string };
}

// v1.1 - 新增 recoverHint
interface ToolResultV1_1 extends ToolResultV1 {
  error?: { code: string; message: string; recoverHint?: string };
}
```

### 12.2 破坏性变更规则

| 要求 | 说明 |
|------|------|
| **版本号升级** | 必须升级 major 或 minor |
| **迁移策略** | 必须提供迁移文档 |
| **契约测试** | 必须通过新旧版本兼容测试 |

---

## 附录 A：最小合格定义（Definition of Done）

一个功能/流程的 DoD 必须满足：

| # | 要求 | 检查方式 |
|---|------|---------|
| 1 | 走 Tool / Workflow / UI Protocol，且均已注册 | 代码审查 |
| 2 | enterpriseId 全链路贯穿 | 代码审查 + 测试 |
| 3 | 有事件日志（可审计） | 测试 |
| 4 | 有可回放的最小记录 | 测试 |
| 5 | 有测试（至少覆盖核心逻辑 + 契约） | CI |
| 6 | UI 不包含业务决策 | 代码审查 |
| 7 | 无假交互 | 代码审查 |

---

## 附录 B：错误码规范

### B.1 错误码格式

```
[DOMAIN]_[ACTION]_[REASON]
```

**示例**：

| 错误码 | 含义 |
|-------|------|
| `CLIENT_CREATE_DUPLICATE` | 创建客户时名称重复 |
| `CLIENT_UPDATE_NOT_FOUND` | 更新客户时未找到 |
| `AUTH_LOGIN_INVALID_PASSWORD` | 登录密码错误 |
| `ENTERPRISE_ACCESS_DENIED` | 跨企业访问被拒绝 |

### B.2 通用错误码

| 错误码 | 含义 |
|-------|------|
| `VALIDATION_ERROR` | 输入校验失败 |
| `NOT_FOUND` | 资源不存在 |
| `PERMISSION_DENIED` | 权限不足 |
| `ENTERPRISE_ID_REQUIRED` | 缺少 enterpriseId |
| `RATE_LIMIT_EXCEEDED` | 超出速率限制 |

---

## 附录 C：审计事件类型

### C.1 标准事件类型

| 事件类型 | 触发场景 |
|---------|---------|
| `tool.invoked` | Tool 被调用 |
| `tool.completed` | Tool 执行完成 |
| `tool.failed` | Tool 执行失败 |
| `workflow.started` | Workflow 开始 |
| `workflow.state_changed` | Workflow 状态变更 |
| `workflow.completed` | Workflow 完成 |
| `data.created` | 数据创建 |
| `data.updated` | 数据更新 |
| `data.deleted` | 数据删除 |
| `auth.login` | 用户登录 |
| `auth.logout` | 用户登出 |
| `permission.granted` | 权限授予 |
| `permission.revoked` | 权限撤销 |

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**文档维护**: dhs-atlas 开发团队  
**最高约束**: [开发伦理与系统操作宪章](./开发伦理与系统操作宪章-最高指示.md)

