# dhs-atlas 微信小程序能力规划（v1.0）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 应用规划文档  
> **相关文档**: [领域划分与边界定义](../domain/领域划分与边界定义.md) · [用户后台功能架构](../domain/用户后台功能架构.md)

---

## 一、产品定位

### 1.1 双区架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      微信小程序双区架构                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐ │
│   │       公共区 (Public)        │  │     客户工作台 (Private)     │ │
│   │         微官网               │  │       客户协作入口           │ │
│   ├─────────────────────────────┤  ├─────────────────────────────┤ │
│   │                             │  │                             │ │
│   │  • 作品展示                  │  │  • 我的项目与进度           │ │
│   │  • 团队介绍                  │  │  • 提案查看与讨论           │ │
│   │  • 服务/报价展示             │  │  • 交付物获取               │ │
│   │  • 联系/咨询                 │  │  • 结算单获取               │ │
│   │                             │  │  • 发票管理                 │ │
│   │                             │  │                             │ │
│   │  ─────────────────────────  │  │  ─────────────────────────  │ │
│   │  职责：认知与信任            │  │  职责：协作与留痕            │ │
│   │  访问：无需登录              │  │  访问：微信登录 + 绑定       │ │
│   │                             │  │                             │ │
│   └─────────────────────────────┘  └─────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心原则

| 原则 | 说明 |
|------|------|
| **客户视角** | 小程序只围绕客户动作：看、选、评、收、取 |
| **真实交互** | 讨论与决策必须进入事件流，不能事后拟合 |
| **可审计** | 任何操作都必须留痕，可回溯 |
| **不做后台** | 小程序不是"第二个后台"，不做管理功能 |

---

## 二、信息架构（IA）

### 2.1 整体结构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         信息架构                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   微信小程序                                                        │
│   │                                                                 │
│   ├── 公共区（未登录可访问）                                         │
│   │   ├── 首页                                                     │
│   │   │   ├── 品牌主视觉                                           │
│   │   │   ├── 价值主张                                             │
│   │   │   ├── 代表作品入口                                         │
│   │   │   ├── 服务与报价入口                                       │
│   │   │   └── 联系/咨询入口                                        │
│   │   │                                                            │
│   │   ├── 作品展示（Portfolio）                                    │
│   │   │   ├── 分类浏览                                             │
│   │   │   ├── 作品详情                                             │
│   │   │   └── 关联服务                                             │
│   │   │                                                            │
│   │   ├── 团队介绍（Team）                                         │
│   │   │   ├── 团队成员                                             │
│   │   │   ├── 工作方式                                             │
│   │   │   └── 合作流程                                             │
│   │   │                                                            │
│   │   └── 报价展示（Quote Showcase）                               │
│   │       ├── 服务菜单                                             │
│   │       └── 套餐对比                                             │
│   │                                                                 │
│   └── 客户工作台（登录后可访问）                                     │
│       ├── Dashboard                                                │
│       │                                                            │
│       ├── 我的项目（Projects）                                     │
│       │   ├── 项目列表                                             │
│       │   ├── 项目详情                                             │
│       │   ├── 里程碑时间线                                         │
│       │   └── 待办事项                                             │
│       │                                                            │
│       ├── 提案协作（Proposals）                                    │
│       │   ├── 提案列表                                             │
│       │   ├── 提案详情                                             │
│       │   ├── 评论与批注                                           │
│       │   └── 选择/确认                                            │
│       │                                                            │
│       ├── 交付物（Deliverables）                                   │
│       │   ├── 交付包列表                                           │
│       │   ├── 文件下载                                             │
│       │   └── 验收操作                                             │
│       │                                                            │
│       ├── 结算单（Settlements）                                    │
│       │   ├── 结算单列表                                           │
│       │   └── 结算单详情                                           │
│       │                                                            │
│       └── 发票（Invoices）                                         │
│           ├── 发票列表                                             │
│           ├── 发票申请                                             │
│           └── 发票下载                                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 三、公共区详细设计

### 3.1 首页

**功能**：品牌展示与入口导航

| 区块 | 说明 | 数据来源 |
|------|------|---------|
| 品牌主视觉 | Logo、Slogan、主题图 | cms.Page (home) |
| 价值主张 | 核心优势描述 | cms.Page (home) |
| 代表作品 | 精选作品展示（3-6个） | cms.Article (portfolio) |
| 服务入口 | 服务分类快捷入口 | svc.Service |
| 联系入口 | 表单或微信会话 | 配置项 |

**页面结构**：

```typescript
interface HomePage {
  // 品牌区
  brand: {
    logo: string;
    slogan: string;
    heroImage: string;
    valueProposition: string[];
  };
  
  // 精选作品
  featuredWorks: PortfolioItem[];
  
  // 服务入口
  serviceCategories: ServiceCategory[];
  
  // 联系方式
  contact: {
    type: 'form' | 'wechat' | 'both';
    formFields?: FormField[];
    wechatId?: string;
  };
}
```

### 3.2 作品展示（Portfolio）

**功能**：展示企业作品案例

| 功能点 | 说明 | 数据来源 |
|--------|------|---------|
| 分类浏览 | 按服务类型/行业/主题 | cms.Category |
| 作品列表 | 封面、标题、简介 | cms.Article (portfolio) |
| 作品详情 | 图文/视频/案例说明 | cms.Article (portfolio) |
| 关联服务 | 跳转到报价展示 | svc.Service |

**数据模型**：

```typescript
interface PortfolioItem {
  id: string;
  title: string;
  coverImage: string;
  
  // 分类
  category: string;
  tags: string[];
  
  // 内容
  summary: string;
  content: string;              // 富文本
  images: string[];
  video?: string;
  
  // 案例信息
  client?: string;              // 客户名称（脱敏）
  industry?: string;
  completedAt?: Date;
  
  // 关联
  relatedServiceIds?: string[];
}
```

### 3.3 团队介绍（Team）

**功能**：展示团队实力与工作方式

| 区块 | 说明 | 数据来源 |
|------|------|---------|
| 团队成员 | 成员照片、角色、简介 | cms.Page (team) |
| 工作方式 | 交付理念、方法论 | cms.Page (team) |
| 合作流程 | 流程图示 | cms.Page (team) |

### 3.4 报价展示（Quote Showcase）

**功能**：展示标准服务菜单（公开参考版）

| 功能点 | 说明 | 数据来源 |
|--------|------|---------|
| 服务菜单 | 服务列表、分类 | svc.Service (public) |
| 价格区间 | 参考价格范围 | svc.Service.pricingModel |
| 套餐对比 | 基础/标准/高级对比 | svc.PricingPolicy |
| 服务详情 | 服务说明、交付内容 | svc.Service |

**重要说明**：

> 公开区展示的是"参考菜单"，不包含客户专属折扣与条款细节。
> 实际报价需要登录后查看专属报价单。

**数据模型**：

```typescript
interface PublicServiceMenu {
  id: string;
  name: string;
  description: string;
  
  // 分类
  category: string;
  serviceType: ServiceType;
  
  // 公开价格信息
  pricingDisplay: {
    type: 'fixed' | 'range' | 'from' | 'contact';
    minPrice?: number;
    maxPrice?: number;
    unit?: string;              // "起"、"每月"
  };
  
  // 套餐（如有）
  packages?: {
    name: string;
    price: number;
    features: string[];
  }[];
  
  // 交付说明
  deliverables: string[];
  estimatedDays?: string;       // "7-14天"
  
  // 状态
  isPublic: boolean;
}
```

---

## 四、客户工作台详细设计

### 4.1 Dashboard（入口）

**功能**：客户工作台首页，聚合关键信息

```typescript
interface CustomerDashboard {
  // 客户信息
  customer: {
    name: string;
    avatar?: string;
  };
  
  // 待办事项
  todos: {
    pendingAcceptance: number;    // 待验收
    pendingConfirmation: number;  // 待确认
    unreadProposals: number;      // 未读提案
  };
  
  // 进行中项目
  activeProjects: ProjectSummary[];
  
  // 最近动态
  recentActivities: Activity[];
}
```

### 4.2 我的项目（Projects）

**功能**：项目进度查看与待办处理

#### 4.2.1 项目列表

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 项目筛选 | 进行中/已完成 | ✅ |
| 项目搜索 | 按名称搜索 | ✅ |
| 项目卡片 | 名称、进度、状态 | - |

#### 4.2.2 项目详情

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 基本信息 | 项目名称、服务类型、时间 | - |
| 里程碑时间线 | 阶段进度可视化 | - |
| 当前阶段状态 | 阶段详情、剩余时间 | - |
| 待我确认事项 | 验收/补资料/确认提案 | ✅ |
| 项目团队 | 负责人、成员 | - |

**数据模型**：

```typescript
interface CustomerProjectView {
  id: string;
  name: string;
  
  // 服务信息
  serviceType: ServiceType;
  serviceName: string;
  
  // 状态
  status: ProjectStatus;
  progress: number;
  
  // 时间
  startDate: Date;
  estimatedEndDate: Date;
  
  // 里程碑
  milestones: MilestoneView[];
  currentMilestone?: MilestoneView;
  
  // 待办
  pendingActions: PendingAction[];
  
  // 团队
  manager: {
    name: string;
    avatar?: string;
  };
}

interface MilestoneView {
  id: string;
  name: string;
  order: number;
  
  status: 'pending' | 'in_progress' | 'completed';
  progress: number;
  
  startDate?: Date;
  endDate?: Date;
  
  // 交付物
  deliverableCount: number;
  acceptedCount: number;
}

interface PendingAction {
  id: string;
  type: 'acceptance' | 'confirmation' | 'material' | 'proposal_review';
  title: string;
  description: string;
  deadline?: Date;
  
  // 关联对象
  relatedType: 'deliverable' | 'proposal' | 'milestone';
  relatedId: string;
}
```

### 4.3 提案协作（Proposals）

**功能**：提案查看与讨论协作

#### 4.3.1 提案列表

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 提案筛选 | 按项目/状态筛选 | ✅ |
| 提案卡片 | 标题、状态、更新时间 | - |
| 未读标记 | 新提案/新评论标记 | - |

#### 4.3.2 提案详情

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 方案浏览 | 图片/文档/视频 | - |
| 版本切换 | 查看历史版本 | - |
| 评论讨论 | 评论线程 | ✅ (发布评论) |
| 批注 | 图片/文档点选批注 | ✅ (发布批注) |
| 选择确认 | 选定方案 | ✅ |
| 变更请求 | 选择题式 + 附加说明 | ✅ |

**关键约束**：

> **真实交互强制**：讨论与决策必须进入事件流，不能事后拟合。

**数据模型**：

```typescript
interface CustomerProposalView {
  id: string;
  projectId: string;
  
  // 基本信息
  title: string;
  description: string;
  
  // 版本
  currentVersion: number;
  versions: ProposalVersion[];
  
  // 状态
  status: ProposalStatus;
  
  // 内容
  content: ProposalContent;
  
  // 讨论
  comments: Comment[];
  annotations: Annotation[];
  
  // 时间
  createdAt: Date;
  updatedAt: Date;
}

interface ProposalContent {
  type: 'image' | 'document' | 'video' | 'mixed';
  
  // 图片方案
  images?: {
    url: string;
    thumbnail: string;
    description?: string;
  }[];
  
  // 文档
  documents?: {
    url: string;
    name: string;
    type: string;
  }[];
  
  // 视频
  videos?: {
    url: string;
    thumbnail: string;
    duration: number;
  }[];
}

// 评论
interface Comment {
  id: string;
  authorType: 'customer' | 'team';
  authorName: string;
  content: string;
  
  // 回复
  parentId?: string;
  replies?: Comment[];
  
  createdAt: Date;
}

// 批注（图片/文档点选）
interface Annotation {
  id: string;
  authorType: 'customer' | 'team';
  authorName: string;
  
  // 位置
  targetType: 'image' | 'document';
  targetId: string;
  position: {
    x: number;
    y: number;
    page?: number;              // 文档页码
  };
  
  content: string;
  
  createdAt: Date;
}
```

**客户操作 - 事件记录**：

```typescript
// 所有客户操作都必须写入事件流
type CustomerProposalEvents = 
  | 'mp.proposal.viewed'           // 查看提案
  | 'mp.proposal.comment.created'  // 发布评论
  | 'mp.proposal.annotation.created' // 发布批注
  | 'mp.proposal.selected'         // 选定方案
  | 'mp.proposal.change_requested' // 变更请求
  | 'mp.proposal.rejected';        // 否决

interface CustomerProposalEvent {
  eventId: string;
  enterpriseId: string;
  customerId: string;
  contactId: string;
  
  eventType: CustomerProposalEvents;
  
  // 关联
  proposalId: string;
  projectId: string;
  
  // 详情
  payload: {
    commentId?: string;
    annotationId?: string;
    selectedOptionId?: string;
    changeReason?: string;
    rejectReason?: string;
  };
  
  // 客户端信息
  clientInfo: {
    platform: 'miniprogram';
    openId: string;
    deviceInfo?: string;
  };
  
  timestamp: Date;
}
```

### 4.4 交付物（Deliverables）

**功能**：交付物获取与验收

#### 4.4.1 交付包列表

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 按项目筛选 | 项目维度查看 | ✅ |
| 按里程碑筛选 | 阶段维度查看 | ✅ |
| 交付包卡片 | 名称、文件数、状态 | - |

#### 4.4.2 交付物详情

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 文件列表 | 文件名、大小、版本 | - |
| 文件预览 | 图片/文档预览 | - |
| 文件下载 | 下载到本地 | ✅ |
| 验收操作 | 通过/需修改/拒绝 | ✅ |

**验收操作**：

```typescript
interface AcceptanceAction {
  deliverableId: string;
  
  // 验收结果
  result: 'accepted' | 'revision_needed' | 'rejected';
  
  // 原因（需修改/拒绝时必填）
  reason?: {
    // 选择题式原因
    reasonCode: string;           // 从原因库选择
    reasonText: string;
    
    // 附加说明
    additionalNotes?: string;
  };
}

// 原因库（受控选项）
const REVISION_REASONS = [
  { code: 'quality', text: '质量不符合预期' },
  { code: 'incomplete', text: '内容不完整' },
  { code: 'mismatch', text: '与需求不符' },
  { code: 'format', text: '格式/规格问题' },
  { code: 'other', text: '其他（请说明）' },
];
```

**交付留痕**：

```typescript
// 交付物相关事件
type CustomerDeliverableEvents = 
  | 'mp.deliverable.viewed'       // 查看交付物
  | 'mp.deliverable.downloaded'   // 下载文件
  | 'mp.deliverable.accepted'     // 验收通过
  | 'mp.deliverable.revision_requested' // 要求修改
  | 'mp.deliverable.rejected';    // 拒绝

interface CustomerDeliverableEvent {
  eventId: string;
  enterpriseId: string;
  customerId: string;
  contactId: string;
  
  eventType: CustomerDeliverableEvents;
  
  deliverableId: string;
  fileId?: string;                // 具体文件
  projectId: string;
  
  payload: {
    // 下载记录
    downloadedFiles?: string[];
    
    // 验收详情
    acceptanceResult?: string;
    reasonCode?: string;
    reasonText?: string;
    additionalNotes?: string;
  };
  
  timestamp: Date;
}
```

### 4.5 结算单（Settlements）

**功能**：结算单查看与下载

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 结算单列表 | 按状态/时间筛选 | ✅ |
| 结算单详情 | 金额、节点、说明 | - |
| 在线查看 | 结算单在线预览 | - |
| PDF 下载 | 下载结算单 PDF | ✅ |
| 分享 | 生成分享链接 | ✅ |

**数据模型**：

```typescript
interface CustomerSettlementView {
  id: string;
  settlementNo: string;
  
  // 关联
  projectId?: string;
  projectName?: string;
  
  // 金额
  items: {
    description: string;
    amount: number;
  }[];
  subtotal: number;
  adjustments?: number;
  total: number;
  currency: string;
  
  // 状态
  status: 'pending' | 'approved' | 'invoiced';
  
  // 时间
  periodStart?: Date;
  periodEnd?: Date;
  createdAt: Date;
  
  // 文件
  pdfUrl?: string;
}
```

### 4.6 发票（Invoices）

**功能**：发票查看、申请与下载

| 功能点 | 说明 | AI 可触发 |
|--------|------|----------|
| 发票列表 | 按状态筛选 | ✅ |
| 发票详情 | 发票信息 | - |
| 发票申请 | 提交开票信息 | ✅ |
| 发票下载 | 下载电子发票 | ✅ |

**发票申请**：

```typescript
interface InvoiceRequest {
  // 关联结算单
  settlementIds: string[];
  
  // 发票类型
  invoiceType: 'normal' | 'vat_normal' | 'vat_special';
  
  // 抬头信息
  buyerInfo: {
    name: string;
    taxNo?: string;
    address?: string;
    phone?: string;
    bankName?: string;
    bankAccount?: string;
  };
  
  // 邮寄信息（纸质发票）
  mailingInfo?: {
    recipient: string;
    phone: string;
    address: string;
  };
  
  // 备注
  remark?: string;
}
```

---

## 五、与用户后台的数据映射

### 5.1 公共区数据来源

| 小程序功能 | 后台域 | 数据对象 |
|-----------|--------|---------|
| 首页 | cms | Page (home) |
| 作品展示 | cms | Article (portfolio), Category |
| 团队介绍 | cms | Page (team) |
| 报价展示 | svc | Service (public), PricingPolicy |

### 5.2 客户工作台数据来源

| 小程序功能 | 后台域 | 数据对象 |
|-----------|--------|---------|
| 客户身份 | crm | Customer, Contact |
| 项目与进度 | proj | Project, Phase, Milestone |
| 待办事项 | proj | PendingAction (聚合) |
| 提案协作 | proj | Proposal, Comment, Annotation |
| 交付物 | proj, file | Deliverable, File |
| 结算单 | fin | Settlement |
| 发票 | fin | Invoice |
| 事件记录 | platform | EventLog |

### 5.3 数据流向

```
┌─────────────────────────────────────────────────────────────────────┐
│                         数据流向                                     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   用户后台 (Tenant Console)                                         │
│   │                                                                 │
│   │  cms.Page / cms.Article                                        │
│   │  svc.Service / svc.Quote                                       │
│   │  proj.Project / proj.Proposal / proj.Deliverable               │
│   │  fin.Settlement / fin.Invoice                                  │
│   │  crm.Customer / crm.Contact                                    │
│   │                                                                 │
│   └───────────────────────────┬─────────────────────────────────── │
│                               │                                     │
│                               ▼                                     │
│                     ┌─────────────────┐                            │
│                     │   Portal BFF    │  ◄─── 聚合、脱敏、鉴权     │
│                     │  (小程序专用)    │                            │
│                     └────────┬────────┘                            │
│                              │                                      │
│                              ▼                                      │
│                     ┌─────────────────┐                            │
│                     │   微信小程序     │                            │
│                     │  (客户使用)      │                            │
│                     └────────┬────────┘                            │
│                              │                                      │
│                              │ 客户操作事件                         │
│                              ▼                                      │
│                     ┌─────────────────┐                            │
│                     │   Event Log     │  ◄─── 可审计、可回溯        │
│                     │  (platform)     │                            │
│                     └─────────────────┘                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 六、权限与身份

### 6.1 登录与绑定

```
┌─────────────────────────────────────────────────────────────────────┐
│                       身份绑定关系                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   微信用户                                                          │
│   │                                                                 │
│   │  openId / unionId                                              │
│   │                                                                 │
│   └──────────────► Contact（联系人）                                │
│                       │                                             │
│                       │  contactId                                  │
│                       │                                             │
│                       └──────────► Customer（客户）                  │
│                                       │                             │
│                                       │  customerId                 │
│                                       │                             │
│                                       └──────────► Enterprise       │
│                                                    │                │
│                                                    │ enterpriseId   │
│                                                    │                │
│                                                    └───► 数据隔离   │
│                                                                     │
│   ─────────────────────────────────────────────────────────────    │
│                                                                     │
│   特殊情况：一个微信用户可能关联多个企业                             │
│   （多家供应商的客户）                                              │
│                                                                     │
│   需支持：企业上下文切换                                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**绑定数据模型**：

```typescript
interface WechatBinding {
  id: string;
  
  // 微信身份
  openId: string;
  unionId?: string;
  
  // 绑定关系（可能多个）
  bindings: {
    enterpriseId: string;
    enterpriseName: string;
    customerId: string;
    contactId: string;
    
    // 权限
    scopes: Scope[];
    
    // 绑定时间
    boundAt: Date;
  }[];
  
  // 当前选中的企业
  currentEnterpriseId?: string;
  
  createdAt: Date;
  updatedAt: Date;
}
```

### 6.2 权限范围（Scope）

```typescript
// 小程序权限范围
type Scope = 
  | 'view_public'           // 查看公共内容
  | 'view_projects'         // 查看项目
  | 'view_proposals'        // 查看提案
  | 'comment_proposals'     // 评论提案
  | 'accept_deliverables'   // 验收交付物
  | 'download_deliverables' // 下载交付物
  | 'view_finance_docs';    // 查看财务单据

// 权限配置（企业后台设置）
interface CustomerPermissionConfig {
  enterpriseId: string;
  customerId: string;
  contactId: string;
  
  // 允许的权限
  scopes: Scope[];
  
  // 特殊限制
  restrictions?: {
    // 只能查看指定项目
    projectIds?: string[];
    
    // 只能下载指定类型文件
    allowedFileTypes?: string[];
  };
  
  updatedAt: Date;
}
```

### 6.3 权限校验

```typescript
// 运行时强校验
async function checkPermission(
  openId: string,
  enterpriseId: string,
  requiredScope: Scope,
  resourceId?: string
): Promise<boolean> {
  // 1. 获取绑定关系
  const binding = await getWechatBinding(openId);
  if (!binding) return false;
  
  // 2. 查找企业绑定
  const enterpriseBinding = binding.bindings.find(
    b => b.enterpriseId === enterpriseId
  );
  if (!enterpriseBinding) return false;
  
  // 3. 检查 scope
  if (!enterpriseBinding.scopes.includes(requiredScope)) {
    return false;
  }
  
  // 4. 检查资源级权限（如有）
  if (resourceId) {
    const config = await getPermissionConfig(
      enterpriseId,
      enterpriseBinding.customerId,
      enterpriseBinding.contactId
    );
    
    // 检查项目限制
    if (config.restrictions?.projectIds) {
      const projectId = await getResourceProjectId(resourceId);
      if (!config.restrictions.projectIds.includes(projectId)) {
        return false;
      }
    }
  }
  
  return true;
}
```

---

## 七、BFF 架构

### 7.1 架构设计

```
┌─────────────────────────────────────────────────────────────────────┐
│                       Portal BFF 架构                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   微信小程序                                                        │
│       │                                                             │
│       │ HTTPS                                                       │
│       │                                                             │
│       ▼                                                             │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │                      Portal BFF                              │   │
│   │                    (小程序专用)                               │   │
│   ├─────────────────────────────────────────────────────────────┤   │
│   │                                                             │   │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │   │
│   │  │  鉴权   │  │  脱敏   │  │  缓存   │  │  限流   │       │   │
│   │  │ Auth    │  │ Mask    │  │ Cache   │  │  Rate   │       │   │
│   │  │         │  │         │  │         │  │  Limit  │       │   │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘       │   │
│   │                                                             │   │
│   │  ┌─────────────────────────────────────────────────────┐   │   │
│   │  │              DTO 聚合层                              │   │   │
│   │  │                                                     │   │   │
│   │  │  将复杂域对象聚合成小程序需要的"页面 DTO"            │   │   │
│   │  │                                                     │   │   │
│   │  └─────────────────────────────────────────────────────┘   │   │
│   │                                                             │   │
│   │  ┌─────────┐                                               │   │
│   │  │  审计   │  ◄─── 所有客户操作写入 Event Log             │   │
│   │  │ Audit   │                                               │   │
│   │  └─────────┘                                               │   │
│   │                                                             │   │
│   └───────────────────────────┬─────────────────────────────────┘   │
│                               │                                     │
│                               │ 内部 RPC / HTTP                     │
│                               │                                     │
│   ┌───────────────────────────┼─────────────────────────────────┐   │
│   │                           │                                 │   │
│   │   ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐   │   │
│   │   │  cms  │  │  svc  │  │  proj │  │  fin  │  │  crm  │   │   │
│   │   └───────┘  └───────┘  └───────┘  └───────┘  └───────┘   │   │
│   │                                                             │   │
│   │                      业务域服务                              │   │
│   │                                                             │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 BFF 职责

| 职责 | 说明 |
|------|------|
| **鉴权** | 微信登录、Session 管理、权限校验 |
| **脱敏** | 敏感信息脱敏（如客户内部备注不暴露） |
| **聚合** | 多域数据聚合成页面 DTO |
| **缓存** | 公共内容缓存、热点数据缓存 |
| **限流** | 防止滥用、保护后端服务 |
| **审计** | 所有客户操作写入 Event Log |

### 7.3 API 设计原则

```typescript
// BFF API 设计原则

// 1. 按页面聚合，不暴露域边界
// ❌ 错误
GET /api/cms/pages/{id}
GET /api/svc/services

// ✅ 正确
GET /api/portal/home          // 首页聚合数据
GET /api/portal/portfolio     // 作品列表
GET /api/portal/services      // 服务菜单

// 2. 客户工作台 API
GET /api/workspace/dashboard  // 工作台首页
GET /api/workspace/projects   // 项目列表
GET /api/workspace/projects/{id} // 项目详情
GET /api/workspace/proposals  // 提案列表
GET /api/workspace/proposals/{id} // 提案详情
POST /api/workspace/proposals/{id}/comments // 发布评论
POST /api/workspace/proposals/{id}/select // 选定方案
GET /api/workspace/deliverables // 交付物列表
POST /api/workspace/deliverables/{id}/accept // 验收
GET /api/workspace/settlements // 结算单列表
GET /api/workspace/invoices   // 发票列表
POST /api/workspace/invoices/request // 发票申请
```

---

## 八、分期交付

### 8.1 MP-1（最快形成客户价值）

**目标**：最小可用版本，覆盖核心场景

| 功能 | 优先级 | 说明 |
|------|--------|------|
| **公共区** | | |
| 首页 | P0 | 品牌展示、入口导航 |
| 作品展示 | P0 | 作品列表、详情 |
| 团队介绍 | P1 | 团队信息页 |
| 报价展示 | P0 | 服务菜单、套餐 |
| **客户工作台** | | |
| 微信登录 | P0 | 登录、绑定 |
| Dashboard | P0 | 工作台首页 |
| 项目进度 | P0 | 项目列表、详情、里程碑 |
| 提案查看 | P0 | 提案列表、详情 |
| 评论讨论 | P0 | 评论发布、回复 |
| 交付物下载 | P0 | 文件列表、下载 |

**交付标准**：
- 公共区可正常访问
- 客户可登录查看项目
- 客户可查看提案并评论
- 客户可下载交付物

### 8.2 MP-2（商务闭环补齐）

**目标**：补齐财务相关功能

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 结算单获取 | P0 | 列表、详情、下载 |
| 发票获取 | P0 | 列表、申请、下载 |
| 通知推送 | P1 | 交付/验收提醒 |
| 多企业切换 | P1 | 企业上下文切换 |

**交付标准**：
- 客户可查看结算单
- 客户可申请发票
- 客户可收到微信通知

### 8.3 MP-3（协作深化）

**目标**：增强协作能力

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 批注功能 | P0 | 图片/文档点选批注 |
| 提案决策 | P0 | 选定方案/否决/变更请求 |
| 验收增强 | P1 | 选择题式原因库 + 返工记录 |
| 消息中心 | P1 | 站内消息聚合 |

**交付标准**：
- 客户可在图片上批注
- 客户可正式选定/否决方案
- 验收流程有完整记录

---

## 九、关键约束

### 9.1 小程序边界

| 约束 | 说明 |
|------|------|
| **只围绕客户动作** | 看、选、评、收、取 |
| **不做管理功能** | 不是"第二个后台" |
| **不做后台级操作** | 财务凭证只做查看/下载/申请 |

### 9.2 数据一致性

| 约束 | 说明 |
|------|------|
| **强一致** | 小程序展示的数据与后台一致 |
| **单向写入** | 客户操作通过 BFF 写入后台 |
| **事件溯源** | 所有操作可审计、可回溯 |

### 9.3 真实交互

| 约束 | 说明 |
|------|------|
| **禁止事后拟合** | 讨论/决策必须实时记录 |
| **禁止伪交互** | 不允许假进度、假确认 |
| **可追责** | 谁在什么时候做了什么 |

---

## 十、Tool 清单

### 10.1 小程序可触发的 Tool

```typescript
// 小程序通过 BFF 间接触发的 Tool
const mpTriggerableTools = {
  // 公共区
  public: [
    'cms.page.get',
    'cms.article.list',
    'cms.article.get',
    'svc.service.list',
    'svc.service.get',
  ],
  
  // 客户工作台
  workspace: [
    // 项目
    'proj.project.list',
    'proj.project.get',
    
    // 提案
    'proj.proposal.list',
    'proj.proposal.get',
    'proj.proposal.comment.create',     // 客户发评论
    'proj.proposal.annotation.create',  // 客户发批注
    'proj.proposal.select',             // 客户选定方案
    'proj.proposal.change_request',     // 客户变更请求
    
    // 交付物
    'proj.deliverable.list',
    'proj.deliverable.get',
    'proj.deliverable.download',        // 客户下载
    'proj.deliverable.accept',          // 客户验收
    
    // 财务
    'fin.settlement.list',
    'fin.settlement.get',
    'fin.invoice.list',
    'fin.invoice.request',              // 客户申请发票
  ],
};
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [领域划分与边界定义](../domain/领域划分与边界定义.md)
- [用户后台功能架构](../domain/用户后台功能架构.md)
- [总体架构设计](../architecture/总体架构设计.md)

