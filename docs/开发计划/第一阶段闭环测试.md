# 第一阶段闭环测试

## 测试目标

验证核心业务流程的完整闭环：

```
Service → Quote → Order → Project → Deliverable
```

## 前置条件

1. Docker Compose 启动本地服务
2. 数据库迁移完成
3. 创建测试企业和用户

## 测试步骤

### 1. 启动服务

```bash
# 启动基础设施
docker compose up -d

# 运行数据库迁移
pnpm db:migrate

# 启动 API 服务
pnpm --filter @dhs-atlas/api dev

# 启动 Mock Server (可选，用于前端开发)
pnpm mock
```

### 2. 创建服务 (Service)

```bash
# POST /api/v1/services
curl -X POST http://localhost:4000/api/v1/services \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>" \
  -d '{
    "name": "企业注册服务",
    "serviceType": "代办服务",
    "pricingModel": {
      "basePrice": 1500,
      "unit": "次"
    }
  }'

# 预期结果：
# - 返回 201 状态码
# - 返回包含 id 的服务对象
# - event_log 表记录 service.created 事件
```

### 3. 创建客户 (Customer)

```bash
# POST /api/v1/customers
curl -X POST http://localhost:4000/api/v1/customers \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>" \
  -d '{
    "name": "测试客户公司",
    "type": "company",
    "level": "normal"
  }'

# 预期结果：
# - 返回 201 状态码
# - event_log 表记录 customer.created 事件
```

### 4. 创建报价 (Quote)

```bash
# POST /api/v1/quotes
curl -X POST http://localhost:4000/api/v1/quotes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>" \
  -d '{
    "customerId": "<customer-id>",
    "validUntil": "2025-02-28",
    "items": [
      {
        "serviceId": "<service-id>",
        "serviceName": "企业注册服务",
        "quantity": "1",
        "unitPrice": "1500"
      }
    ]
  }'

# 预期结果：
# - 返回 201 状态码
# - quote.status = "draft"
# - quote_item 表有对应记录
# - event_log 表记录 quote.created 事件
```

### 5. 发送报价

```bash
# POST /api/v1/quotes/:id/send
curl -X POST http://localhost:4000/api/v1/quotes/<quote-id>/send \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>"

# 预期结果：
# - quote.status 从 "draft" 变为 "sent"
# - event_log 表记录 quote.sent 事件
```

### 6. 转换为订单 (Order)

```bash
# POST /api/v1/quotes/:id/convert
curl -X POST http://localhost:4000/api/v1/quotes/<quote-id>/convert \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>"

# 预期结果：
# - 创建新的 order 记录
# - order.quoteId 指向原报价
# - order.status = "pending"
# - order_item 表复制 quote_item 数据
# - quote.status 变为 "accepted"
# - event_log 表记录 quote.converted 事件
```

### 7. 确认订单

```bash
# POST /api/v1/orders/:id/confirm
curl -X POST http://localhost:4000/api/v1/orders/<order-id>/confirm \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>"

# 预期结果：
# - order.status 从 "pending" 变为 "confirmed"
# - event_log 表记录 order.confirmed 事件
```

### 8. 开始执行（创建项目）

```bash
# POST /api/v1/orders/:id/start
curl -X POST http://localhost:4000/api/v1/orders/<order-id>/start \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>"

# 预期结果：
# - order.status 变为 "in_progress"
# - 自动创建 project 记录
# - project.orderId 指向订单
# - project.customerId 继承自订单
# - event_log 表记录 order.started 事件
```

### 9. 创建交付物 (Deliverable)

```bash
# POST /api/v1/deliverables
curl -X POST http://localhost:4000/api/v1/deliverables \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>" \
  -d '{
    "projectId": "<project-id>",
    "name": "营业执照",
    "description": "企业注册完成后的营业执照"
  }'

# 预期结果：
# - deliverable.status = "pending"
# - event_log 表记录 deliverable.created 事件
```

### 10. 提交交付物

```bash
# POST /api/v1/deliverables/:id/submit
curl -X POST http://localhost:4000/api/v1/deliverables/<deliverable-id>/submit \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>"

# 预期结果：
# - deliverable.status 从 "pending" 变为 "submitted"
# - deliverable.submittedAt 被设置
# - event_log 表记录 deliverable.submitted 事件
```

### 11. 验收交付物

```bash
# POST /api/v1/deliverables/:id/approve
curl -X POST http://localhost:4000/api/v1/deliverables/<deliverable-id>/approve \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>" \
  -d '{
    "notes": "验收通过，资料齐全"
  }'

# 预期结果：
# - deliverable.status 变为 "approved"
# - deliverable.reviewedAt 被设置
# - deliverable.reviewNotes 记录备注
# - event_log 表记录 deliverable.approved 事件
```

### 12. 完成订单

```bash
# POST /api/v1/orders/:id/complete
curl -X POST http://localhost:4000/api/v1/orders/<order-id>/complete \
  -H "Authorization: Bearer <token>" \
  -H "x-enterprise-id: <enterprise-id>"

# 预期结果：
# - order.status 变为 "completed"
# - event_log 表记录 order.completed 事件
```

## 验证清单

### 数据完整性

- [ ] 所有实体都绑定了 enterprise_id
- [ ] 外键关系正确（quote → customer, order → quote, project → order 等）
- [ ] 状态流转符合状态机定义

### 事件日志

- [ ] 每个操作都记录了 event_log
- [ ] event_log 包含 actor_type, actor_id, target_type, target_id
- [ ] 通过 /api/v1/timeline 可查询完整时间线

### 状态机

- [ ] Quote: draft → sent → accepted
- [ ] Order: draft → pending → confirmed → in_progress → completed
- [ ] Deliverable: pending → submitted → approved

### AI 可操作性

- [ ] 所有 API 都支持通过 HTTP 调用
- [ ] 无需 UI 即可完成完整流程
- [ ] 每个操作都有明确的输入/输出契约

## 自动化测试脚本

```typescript
// tests/e2e/closed-loop.test.ts
import { describe, it, expect } from 'vitest';

describe('Business Closed Loop', () => {
  it('should complete service to deliverable flow', async () => {
    // 1. Create service
    const service = await api.post('/services', { /* ... */ });
    expect(service.status).toBe(201);

    // 2. Create customer
    const customer = await api.post('/customers', { /* ... */ });
    expect(customer.status).toBe(201);

    // 3. Create and send quote
    const quote = await api.post('/quotes', { /* ... */ });
    await api.post(`/quotes/${quote.data.id}/send`);

    // 4. Convert to order
    const order = await api.post(`/quotes/${quote.data.id}/convert`);
    expect(order.data.status).toBe('pending');

    // 5. Confirm and start order
    await api.post(`/orders/${order.data.id}/confirm`);
    const startResult = await api.post(`/orders/${order.data.id}/start`);
    expect(startResult.data.project).toBeDefined();

    // 6. Create and approve deliverable
    const deliverable = await api.post('/deliverables', {
      projectId: startResult.data.project.id,
      name: '测试交付物',
    });
    await api.post(`/deliverables/${deliverable.data.id}/submit`);
    await api.post(`/deliverables/${deliverable.data.id}/approve`);

    // 7. Complete order
    await api.post(`/orders/${order.data.id}/complete`);
    const finalOrder = await api.get(`/orders/${order.data.id}`);
    expect(finalOrder.data.status).toBe('completed');

    // 8. Verify timeline
    const timeline = await api.get('/timeline', {
      params: { targetType: 'order', targetId: order.data.id },
    });
    expect(timeline.data.data.length).toBeGreaterThan(0);
  });
});
```

## 第一阶段完成标准

1. **工程骨架可运行** - `pnpm dev` 启动所有服务无报错
2. **四个应用壳齐全** - console, platform, portal, platform-web 都可访问
3. **业务闭环可走通** - 从 Service 到 Deliverable 全流程可执行
4. **契约系统完备** - OpenAPI 定义完整，Mock Server 可用
5. **AI 可操作** - 每个功能都可通过 API/Command 完成

