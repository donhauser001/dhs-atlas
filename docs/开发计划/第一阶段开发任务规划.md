# dhs-atlas 第一阶段开发任务规划（v1.0）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 工程执行计划  
> **目标**: 任何人 clone 后 10 分钟能跑起来，并具备"生产同构"的最小设施

---

## 一、总体目标

### 1.1 第一阶段交付物

| 交付物 | 说明 |
|--------|------|
| **可运行的工程骨架** | `docker compose up` / `pnpm dev` 一键启动 |
| **四个应用壳** | 平台前台 / 客户网站前台 / 平台后台 / 用户后台 |
| **一条业务闭环** | Service → Quote → Order → Project → Deliverable |
| **完整的契约体系** | OpenAPI / TypeScript 类型 / Mock Server |

### 1.2 四个应用定位

```
┌─────────────────────────────────────────────────────────────────────┐
│                         四个应用架构                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐ │
│   │       平台前台               │  │       平台后台               │ │
│   │   (Platform Website)        │  │  (Platform Console)         │ │
│   ├─────────────────────────────┤  ├─────────────────────────────┤ │
│   │  • 平台介绍                  │  │  • 租户管理                  │ │
│   │  • 功能展示                  │  │  • 订阅管理                  │ │
│   │  • 定价页面                  │  │  • 功能开关                  │ │
│   │  • 注册入口                  │  │  • 全局审计                  │ │
│   │                             │  │  • AI 网关监控               │ │
│   │  访问：公开                  │  │  访问：平台管理员            │ │
│   └─────────────────────────────┘  └─────────────────────────────┘ │
│                                                                     │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐ │
│   │     客户网站前台             │  │       用户后台               │ │
│   │    (Portal Website)         │  │  (Tenant Console)           │ │
│   ├─────────────────────────────┤  ├─────────────────────────────┤ │
│   │  • 作品展示                  │  │  • 项目管理                  │ │
│   │  • 团队介绍                  │  │  • 服务管理                  │ │
│   │  • 报价展示                  │  │  • 客户管理                  │ │
│   │  • 客户工作台                │  │  • 财务管理                  │ │
│   │                             │  │  • ...                      │ │
│   │  访问：公开 + 客户登录       │  │  访问：租户成员              │ │
│   └─────────────────────────────┘  └─────────────────────────────┘ │
│                                                                     │
│   ─────────────────────────────────────────────────────────────    │
│                                                                     │
│   apps/                                                            │
│   ├── platform-web/    # 平台前台                                  │
│   ├── platform/        # 平台后台                                  │
│   ├── portal/          # 客户网站前台                              │
│   └── console/         # 用户后台                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 不可违背的原则

| 原则 | 说明 |
|------|------|
| **接口先行** | 任何前端交互都必须对应一个后端接口（哪怕先返回 501） |
| **状态机驱动** | 任何流程必须有状态机字段，不靠前端推断 |
| **enterprise_id 强制** | 所有数据写入必须带 `enterprise_id` |
| **三态优先** | 所有页面先做 Empty / Loading / Error 三态 |
| **契约生成** | 前端类型从 OpenAPI 生成，不手写 |

---

## 二、Step 1：部署环境与工程骨架

### 2.1 任务清单

| 任务 ID | 任务名称 | 优先级 | 预估工时 |
|---------|---------|--------|---------|
| S1-01 | Monorepo 初始化 | P0 | 4h |
| S1-02 | 数据库与迁移框架 | P0 | 8h |
| S1-03 | Auth 基线 | P0 | 16h |
| S1-04 | 统一日志与审计 | P0 | 8h |
| S1-05 | Feature Flag 框架 | P0 | 8h |
| S1-06 | Docker Compose 配置 | P0 | 4h |
| S1-07 | 环境变量规范 | P0 | 2h |

**总预估**: 50h（约 6-7 个工作日）

---

### S1-01：Monorepo 初始化

**目标**：建立完整的项目结构

```
dhs-atlas/
├── apps/
│   ├── platform-web/              # 平台前台（Next.js）
│   │   ├── src/
│   │   │   ├── app/
│   │   │   └── components/
│   │   ├── package.json
│   │   └── next.config.ts
│   │
│   ├── platform/                  # 平台后台（Next.js）
│   │   ├── src/
│   │   │   ├── app/
│   │   │   └── components/
│   │   ├── package.json
│   │   └── next.config.ts
│   │
│   ├── portal/                    # 客户网站前台（Next.js）
│   │   ├── src/
│   │   │   ├── app/
│   │   │   └── components/
│   │   ├── package.json
│   │   └── next.config.ts
│   │
│   └── console/                   # 用户后台（Next.js）
│       ├── src/
│       │   ├── app/
│       │   └── components/
│       ├── package.json
│       └── next.config.ts
│
├── packages/
│   ├── ui/                        # 共享 UI 组件（shadcn/ui）
│   │   ├── src/
│   │   │   ├── components/
│   │   │   └── primitives/        # AI 交互原语
│   │   └── package.json
│   │
│   ├── shared/                    # 共享工具
│   │   ├── src/
│   │   │   ├── types/
│   │   │   ├── schemas/
│   │   │   ├── utils/
│   │   │   └── constants/
│   │   └── package.json
│   │
│   ├── database/                  # 数据库层
│   │   ├── src/
│   │   │   ├── schema/
│   │   │   ├── migrations/
│   │   │   └── client.ts
│   │   └── package.json
│   │
│   ├── auth/                      # 认证层
│   │   ├── src/
│   │   └── package.json
│   │
│   ├── logger/                    # 日志层
│   │   ├── src/
│   │   └── package.json
│   │
│   ├── event-log/                 # 事件日志
│   │   ├── src/
│   │   └── package.json
│   │
│   ├── feature-flags/             # 功能开关
│   │   ├── src/
│   │   └── package.json
│   │
│   └── api-client/                # API 客户端（从 OpenAPI 生成）
│       ├── src/
│       └── package.json
│
├── domains/                       # 业务域
│   ├── svc/                       # 服务域
│   ├── crm/                       # 客户域
│   ├── proj/                      # 项目域
│   ├── fin/                       # 财务域
│   ├── contract/                  # 合同域
│   ├── cms/                       # 内容域
│   ├── org/                       # 组织域
│   ├── file/                      # 文件域
│   └── settings/                  # 设置域
│
├── services/                      # 后端服务
│   ├── api/                       # 主 API 服务
│   │   ├── src/
│   │   │   ├── routes/
│   │   │   ├── middleware/
│   │   │   └── index.ts
│   │   └── package.json
│   │
│   └── bff/                       # BFF 服务
│       ├── portal/                # Portal BFF
│       └── tenant/                # Tenant BFF
│
├── docs/                          # 文档
│
├── docker/                        # Docker 配置
│   ├── docker-compose.yml
│   ├── docker-compose.dev.yml
│   └── Dockerfile
│
├── scripts/                       # 脚本
│   ├── setup.sh
│   └── seed.ts
│
├── .env.example
├── .env.local.example
├── pnpm-workspace.yaml
├── turbo.json
├── tsconfig.json
└── package.json
```

**验收标准**：
- [ ] `pnpm install` 成功
- [ ] `pnpm build` 全部通过
- [ ] `pnpm lint` 无错误
- [ ] `pnpm typecheck` 无错误

---

### S1-02：数据库与迁移框架

**技术选型**：
- ORM: Drizzle ORM（类型安全、性能优秀）
- 数据库: PostgreSQL 16
- 迁移: Drizzle Kit

**核心表结构（Phase 1 最小集）**：

```typescript
// packages/database/src/schema/platform.ts

// 租户运行时（从 Day 1 就存在）
export const tenantRuntime = pgTable('tenant_runtime', {
  id: uuid('id').primaryKey().defaultRandom(),
  enterpriseId: uuid('enterprise_id').notNull().unique(),
  
  // 隔离模式（预埋）
  isolationMode: varchar('isolation_mode', { length: 32 })
    .default('shared')
    .notNull(), // shared | dedicated_db | dedicated_instance
  
  // 数据源定位（预埋）
  databaseId: varchar('database_id', { length: 128 }),
  databaseHost: varchar('database_host', { length: 256 }),
  databaseName: varchar('database_name', { length: 128 }),
  
  // 实例定位（预埋）
  instanceId: varchar('instance_id', { length: 128 }),
  instanceHost: varchar('instance_host', { length: 256 }),
  
  // 域名
  primaryDomain: varchar('primary_domain', { length: 256 }),
  customDomains: jsonb('custom_domains').default([]),
  
  // 状态
  status: varchar('status', { length: 32 }).default('active').notNull(),
  
  // 元数据
  metadata: jsonb('metadata').default({}),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// 企业
export const enterprise = pgTable('enterprise', {
  id: uuid('id').primaryKey().defaultRandom(),
  name: varchar('name', { length: 256 }).notNull(),
  slug: varchar('slug', { length: 128 }).unique(),
  
  // 状态
  status: varchar('status', { length: 32 }).default('active').notNull(),
  
  // 配置
  settings: jsonb('settings').default({}),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// 用户
export const user = pgTable('user', {
  id: uuid('id').primaryKey().defaultRandom(),
  email: varchar('email', { length: 256 }).unique().notNull(),
  passwordHash: varchar('password_hash', { length: 256 }),
  name: varchar('name', { length: 256 }),
  avatar: varchar('avatar', { length: 512 }),
  
  // 状态
  status: varchar('status', { length: 32 }).default('active').notNull(),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// 成员关系
export const membership = pgTable('membership', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => user.id),
  enterpriseId: uuid('enterprise_id').notNull().references(() => enterprise.id),
  
  // 角色
  role: varchar('role', { length: 64 }).default('member').notNull(),
  
  // 状态
  status: varchar('status', { length: 32 }).default('active').notNull(),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => ({
  userEnterpriseUnique: uniqueIndex('membership_user_enterprise_idx')
    .on(table.userId, table.enterpriseId),
}));

// 订阅
export const subscription = pgTable('subscription', {
  id: uuid('id').primaryKey().defaultRandom(),
  enterpriseId: uuid('enterprise_id').notNull().references(() => enterprise.id),
  
  // 套餐
  planId: varchar('plan_id', { length: 64 }).notNull(),
  
  // 状态
  status: varchar('status', { length: 32 }).default('active').notNull(),
  
  // 时间
  startAt: timestamp('start_at').notNull(),
  endAt: timestamp('end_at'),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

// 功能点
export const featureGrant = pgTable('feature_grant', {
  id: uuid('id').primaryKey().defaultRandom(),
  enterpriseId: uuid('enterprise_id').notNull().references(() => enterprise.id),
  
  // 功能点
  featureKey: varchar('feature_key', { length: 128 }).notNull(),
  
  // 状态
  enabled: boolean('enabled').default(true).notNull(),
  
  // 配额（可选）
  quota: integer('quota'),
  quotaUsed: integer('quota_used').default(0),
  
  // 来源
  source: varchar('source', { length: 64 }).default('subscription').notNull(),
  
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
}, (table) => ({
  enterpriseFeatureUnique: uniqueIndex('feature_grant_enterprise_feature_idx')
    .on(table.enterpriseId, table.featureKey),
}));

// 事件日志
export const eventLog = pgTable('event_log', {
  id: uuid('id').primaryKey().defaultRandom(),
  enterpriseId: uuid('enterprise_id').notNull(),
  
  // 事件类型
  eventType: varchar('event_type', { length: 128 }).notNull(),
  
  // 主体
  actorType: varchar('actor_type', { length: 32 }).notNull(), // user | system | ai
  actorId: varchar('actor_id', { length: 128 }),
  
  // 目标
  targetType: varchar('target_type', { length: 64 }),
  targetId: varchar('target_id', { length: 128 }),
  
  // 详情
  payload: jsonb('payload').default({}),
  
  // 时间
  timestamp: timestamp('timestamp').defaultNow().notNull(),
  
  // 元数据
  metadata: jsonb('metadata').default({}),
});

// 审计日志
export const auditLog = pgTable('audit_log', {
  id: uuid('id').primaryKey().defaultRandom(),
  enterpriseId: uuid('enterprise_id'),
  
  // 操作
  action: varchar('action', { length: 128 }).notNull(),
  
  // 主体
  userId: uuid('user_id'),
  userEmail: varchar('user_email', { length: 256 }),
  
  // 目标
  resourceType: varchar('resource_type', { length: 64 }),
  resourceId: varchar('resource_id', { length: 128 }),
  
  // 详情
  before: jsonb('before'),
  after: jsonb('after'),
  
  // 请求信息
  ip: varchar('ip', { length: 64 }),
  userAgent: varchar('user_agent', { length: 512 }),
  
  // 时间
  timestamp: timestamp('timestamp').defaultNow().notNull(),
});
```

**验收标准**：
- [ ] `pnpm db:generate` 生成迁移文件
- [ ] `pnpm db:migrate` 执行迁移成功
- [ ] `pnpm db:studio` 可以查看数据库

---

### S1-03：Auth 基线

**技术选型**：
- Auth: Better Auth（开源、功能完整）
- Session: Database Session（支持多设备）

**实现范围**：

```typescript
// packages/auth/src/config.ts

import { betterAuth } from 'better-auth';
import { drizzleAdapter } from 'better-auth/adapters/drizzle';

export const auth = betterAuth({
  database: drizzleAdapter(db, {
    provider: 'pg',
  }),
  
  emailAndPassword: {
    enabled: true,
    requireEmailVerification: true,
  },
  
  session: {
    expiresIn: 60 * 60 * 24 * 7, // 7 days
    updateAge: 60 * 60 * 24,      // 1 day
  },
  
  // 扩展：企业上下文
  plugins: [
    enterprisePlugin(),           // 自定义插件
  ],
});

// 企业上下文中间件
export async function withEnterprise(request: Request) {
  const session = await auth.api.getSession({ headers: request.headers });
  if (!session) return null;
  
  // 获取用户的企业列表
  const memberships = await getMemberships(session.user.id);
  
  // 获取当前选中的企业
  const currentEnterpriseId = request.headers.get('x-enterprise-id') 
    || memberships[0]?.enterpriseId;
  
  // 验证权限
  const membership = memberships.find(m => m.enterpriseId === currentEnterpriseId);
  if (!membership) return null;
  
  return {
    user: session.user,
    enterpriseId: currentEnterpriseId,
    membership,
  };
}
```

**四个应用的 Auth 策略**：

| 应用 | Auth 策略 |
|------|----------|
| platform-web | 无需登录 / 注册入口 |
| platform | 平台管理员登录（独立用户体系） |
| portal | 公开 + 客户登录（微信/邮箱） |
| console | 租户成员登录（邮箱/密码） |

**验收标准**：
- [ ] console 登录/注册流程完整
- [ ] 登录后可获取企业上下文
- [ ] API 中间件正确注入 `enterpriseId`
- [ ] 多企业切换正常工作

---

### S1-04：统一日志与审计

**实现范围**：

```typescript
// packages/logger/src/index.ts

import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: process.env.NODE_ENV === 'development' 
    ? { target: 'pino-pretty' }
    : undefined,
});

// 带上下文的日志
export function createContextLogger(context: {
  enterpriseId?: string;
  userId?: string;
  requestId?: string;
}) {
  return logger.child(context);
}
```

```typescript
// packages/event-log/src/index.ts

export interface EventLogEntry {
  enterpriseId: string;
  eventType: string;
  actorType: 'user' | 'system' | 'ai';
  actorId?: string;
  targetType?: string;
  targetId?: string;
  payload?: Record<string, unknown>;
  metadata?: Record<string, unknown>;
}

export async function logEvent(entry: EventLogEntry): Promise<void> {
  await db.insert(eventLog).values({
    ...entry,
    timestamp: new Date(),
  });
}

// 审计日志
export async function logAudit(entry: {
  enterpriseId?: string;
  action: string;
  userId?: string;
  userEmail?: string;
  resourceType?: string;
  resourceId?: string;
  before?: unknown;
  after?: unknown;
  ip?: string;
  userAgent?: string;
}): Promise<void> {
  await db.insert(auditLog).values({
    ...entry,
    timestamp: new Date(),
  });
}
```

**验收标准**：
- [ ] 日志可以按级别输出
- [ ] 事件日志可以写入数据库
- [ ] 审计日志可以写入数据库
- [ ] 关键操作有审计记录

---

### S1-05：Feature Flag 框架

**实现范围**：

```typescript
// packages/feature-flags/src/index.ts

// 功能点定义
export const FEATURES = {
  // 服务域
  'svc.service.manage': { name: '服务管理', default: true },
  'svc.quote.create': { name: '创建报价', default: true },
  'svc.workflow.manage': { name: '流程管理', default: false },
  
  // 客户域
  'crm.customer.manage': { name: '客户管理', default: true },
  'crm.customer.import': { name: '客户导入', default: false },
  
  // 项目域
  'proj.project.manage': { name: '项目管理', default: true },
  'proj.deliverable.manage': { name: '交付管理', default: true },
  
  // 财务域
  'fin.order.manage': { name: '订单管理', default: true },
  'fin.invoice.manage': { name: '发票管理', default: false },
  
  // AI 功能
  'ai.assistant': { name: 'AI 助手', default: false },
  'ai.generation': { name: 'AI 生成', default: false },
} as const;

export type FeatureKey = keyof typeof FEATURES;

// 检查功能点
export async function checkFeature(
  enterpriseId: string,
  featureKey: FeatureKey
): Promise<boolean> {
  // 1. 查询数据库
  const grant = await db.query.featureGrant.findFirst({
    where: and(
      eq(featureGrant.enterpriseId, enterpriseId),
      eq(featureGrant.featureKey, featureKey)
    ),
  });
  
  // 2. 有记录则使用记录值
  if (grant) {
    return grant.enabled;
  }
  
  // 3. 无记录则使用默认值
  return FEATURES[featureKey]?.default ?? false;
}

// 检查配额
export async function checkQuota(
  enterpriseId: string,
  featureKey: FeatureKey
): Promise<{ allowed: boolean; quota?: number; used?: number }> {
  const grant = await db.query.featureGrant.findFirst({
    where: and(
      eq(featureGrant.enterpriseId, enterpriseId),
      eq(featureGrant.featureKey, featureKey)
    ),
  });
  
  if (!grant || !grant.enabled) {
    return { allowed: false };
  }
  
  if (grant.quota === null) {
    return { allowed: true };
  }
  
  return {
    allowed: (grant.quotaUsed ?? 0) < grant.quota,
    quota: grant.quota,
    used: grant.quotaUsed ?? 0,
  };
}

// 中间件
export function requireFeature(featureKey: FeatureKey) {
  return async (ctx: Context, next: Next) => {
    const { enterpriseId } = ctx.state;
    
    const allowed = await checkFeature(enterpriseId, featureKey);
    if (!allowed) {
      throw new ForbiddenError(`Feature '${featureKey}' is not enabled`);
    }
    
    await next();
  };
}
```

**验收标准**：
- [ ] `checkFeature` 函数正常工作
- [ ] `requireFeature` 中间件可以拦截请求
- [ ] 配额检查正常工作

---

### S1-06：Docker Compose 配置

```yaml
# docker/docker-compose.yml

version: '3.8'

services:
  # PostgreSQL
  postgres:
    image: postgres:16-alpine
    container_name: dhs-atlas-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-dhs_atlas}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redis（Session / Cache）
  redis:
    image: redis:7-alpine
    container_name: dhs-atlas-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # MinIO（对象存储）
  minio:
    image: minio/minio:latest
    container_name: dhs-atlas-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

volumes:
  postgres_data:
  redis_data:
  minio_data:
```

```yaml
# docker/docker-compose.dev.yml

version: '3.8'

services:
  postgres:
    extends:
      file: docker-compose.yml
      service: postgres

  redis:
    extends:
      file: docker-compose.yml
      service: redis

  minio:
    extends:
      file: docker-compose.yml
      service: minio

  # Mailpit（邮件测试）
  mailpit:
    image: axllent/mailpit:latest
    container_name: dhs-atlas-mailpit
    ports:
      - "8025:8025"  # Web UI
      - "1025:1025"  # SMTP
```

**验收标准**：
- [ ] `docker compose up -d` 启动成功
- [ ] PostgreSQL 可连接
- [ ] Redis 可连接
- [ ] MinIO 可访问

---

### S1-07：环境变量规范

```bash
# .env.example

# ========================================
# 基础配置
# ========================================
NODE_ENV=development
LOG_LEVEL=debug

# ========================================
# 数据库
# ========================================
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/dhs_atlas

# ========================================
# Redis
# ========================================
REDIS_URL=redis://localhost:6379

# ========================================
# 对象存储
# ========================================
S3_ENDPOINT=http://localhost:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=dhs-atlas

# ========================================
# 认证
# ========================================
AUTH_SECRET=your-auth-secret-change-in-production
AUTH_URL=http://localhost:3000

# ========================================
# 邮件
# ========================================
SMTP_HOST=localhost
SMTP_PORT=1025
SMTP_FROM=noreply@dhs-atlas.local

# ========================================
# 应用 URL
# ========================================
PLATFORM_WEB_URL=http://localhost:3000
PLATFORM_URL=http://localhost:3001
PORTAL_URL=http://localhost:3002
CONSOLE_URL=http://localhost:3003

# ========================================
# API
# ========================================
API_URL=http://localhost:4000
```

**验收标准**：
- [ ] `.env.example` 包含所有必需变量
- [ ] 本地开发环境可以启动
- [ ] 环境变量类型检查通过（zod schema）

---

## 三、Step 2：前端界面（IA + 协议优先）

### 3.1 任务清单

| 任务 ID | 任务名称 | 优先级 | 预估工时 |
|---------|---------|--------|---------|
| S2-01 | OpenAPI 契约定义 | P0 | 16h |
| S2-02 | Mock Server 搭建 | P0 | 8h |
| S2-03 | API 客户端生成 | P0 | 4h |
| S2-04 | UI 组件库初始化 | P0 | 8h |
| S2-05 | 用户后台壳 | P0 | 24h |
| S2-06 | 平台后台壳 | P1 | 16h |
| S2-07 | 客户网站前台壳 | P1 | 16h |
| S2-08 | 平台前台壳 | P2 | 8h |

**总预估**: 100h（约 12-13 个工作日）

---

### S2-01：OpenAPI 契约定义

**目标**：定义完整的 API 契约，前端后端同时开发

```yaml
# services/api/openapi/tenant.yaml

openapi: 3.1.0
info:
  title: dhs-atlas Tenant API
  version: 1.0.0
  description: 租户后台 API

servers:
  - url: /api/v1
    description: Tenant API

tags:
  - name: service
    description: 服务管理
  - name: customer
    description: 客户管理
  - name: project
    description: 项目管理
  - name: quote
    description: 报价管理

paths:
  # ========================================
  # 服务管理
  # ========================================
  /services:
    get:
      tags: [service]
      summary: 获取服务列表
      operationId: listServices
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/ServiceStatus'
        - name: categoryId
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceListResponse'
    
    post:
      tags: [service]
      summary: 创建服务
      operationId: createService
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateServiceRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '501':
          description: 未实现
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotImplementedError'

  /services/{id}:
    get:
      tags: [service]
      summary: 获取服务详情
      operationId: getService
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
    
    patch:
      tags: [service]
      summary: 更新服务
      operationId: updateService
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateServiceRequest'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
    
    delete:
      tags: [service]
      summary: 删除服务
      operationId: deleteService
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: 删除成功

  # ========================================
  # 客户管理
  # ========================================
  /customers:
    get:
      tags: [customer]
      summary: 获取客户列表
      operationId: listCustomers
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: keyword
          in: query
          schema:
            type: string
        - name: level
          in: query
          schema:
            $ref: '#/components/schemas/CustomerLevel'
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CustomerListResponse'
    
    post:
      tags: [customer]
      summary: 创建客户
      operationId: createCustomer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCustomerRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Customer'

  # ========================================
  # 项目管理
  # ========================================
  /projects:
    get:
      tags: [project]
      summary: 获取项目列表
      operationId: listProjects
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/PageSizeParam'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/ProjectStatus'
        - name: customerId
          in: query
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectListResponse'
    
    post:
      tags: [project]
      summary: 创建项目
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Project'

components:
  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    
    PageSizeParam:
      name: pageSize
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  schemas:
    # ========================================
    # 通用
    # ========================================
    PaginatedResponse:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        pageSize:
          type: integer
        totalPages:
          type: integer
      required: [total, page, pageSize, totalPages]

    NotImplementedError:
      type: object
      properties:
        code:
          type: string
          enum: [NOT_IMPLEMENTED]
        message:
          type: string
      required: [code, message]

    # ========================================
    # 服务
    # ========================================
    ServiceStatus:
      type: string
      enum: [draft, active, archived]

    Service:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        serviceType:
          type: string
        pricingModel:
          $ref: '#/components/schemas/PricingModel'
        status:
          $ref: '#/components/schemas/ServiceStatus'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, serviceType, status, createdAt, updatedAt]

    PricingModel:
      type: object
      properties:
        type:
          type: string
          enum: [fixed, milestone, hourly, daily, unit, subscription, hybrid]
        basePrice:
          type: number
        currency:
          type: string
          default: CNY

    CreateServiceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        description:
          type: string
        serviceType:
          type: string
        pricingModel:
          $ref: '#/components/schemas/PricingModel'
      required: [name, serviceType]

    UpdateServiceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        description:
          type: string
        serviceType:
          type: string
        pricingModel:
          $ref: '#/components/schemas/PricingModel'
        status:
          $ref: '#/components/schemas/ServiceStatus'

    ServiceListResponse:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/Service'
          required: [items]

    # ========================================
    # 客户
    # ========================================
    CustomerLevel:
      type: string
      enum: [normal, important, vip]

    CustomerStatus:
      type: string
      enum: [active, inactive, blocked]

    Customer:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        type:
          type: string
          enum: [company, individual]
        level:
          $ref: '#/components/schemas/CustomerLevel'
        status:
          $ref: '#/components/schemas/CustomerStatus'
        contacts:
          type: array
          items:
            $ref: '#/components/schemas/Contact'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, type, status, createdAt, updatedAt]

    Contact:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        phone:
          type: string
        email:
          type: string
        isPrimary:
          type: boolean

    CreateCustomerRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        type:
          type: string
          enum: [company, individual]
        level:
          $ref: '#/components/schemas/CustomerLevel'
        contacts:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              phone:
                type: string
              email:
                type: string
              isPrimary:
                type: boolean
      required: [name, type]

    CustomerListResponse:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/Customer'
          required: [items]

    # ========================================
    # 项目
    # ========================================
    ProjectStatus:
      type: string
      enum: [draft, in_progress, completed, cancelled, on_hold]

    Project:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        customerId:
          type: string
          format: uuid
        customerName:
          type: string
        serviceId:
          type: string
          format: uuid
        serviceName:
          type: string
        status:
          $ref: '#/components/schemas/ProjectStatus'
        progress:
          type: integer
          minimum: 0
          maximum: 100
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        phases:
          type: array
          items:
            $ref: '#/components/schemas/ProjectPhase'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [id, name, customerId, status, createdAt, updatedAt]

    ProjectPhase:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        order:
          type: integer
        status:
          type: string
          enum: [pending, in_progress, completed]
        progress:
          type: integer
          minimum: 0
          maximum: 100

    CreateProjectRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 256
        customerId:
          type: string
          format: uuid
        serviceId:
          type: string
          format: uuid
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
      required: [name, customerId]

    ProjectListResponse:
      allOf:
        - $ref: '#/components/schemas/PaginatedResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/Project'
          required: [items]
```

**验收标准**：
- [ ] OpenAPI 文件格式正确
- [ ] 所有第一阶段实体有 CRUD 接口定义
- [ ] Schema 定义完整

---

### S2-02：Mock Server 搭建

**技术选型**：Prism（OpenAPI Mock Server）

```json
// package.json scripts
{
  "scripts": {
    "mock": "prism mock services/api/openapi/tenant.yaml -p 4000"
  }
}
```

**验收标准**：
- [ ] Mock Server 可以启动
- [ ] 可以返回符合 Schema 的模拟数据
- [ ] 前端可以正常调用

---

### S2-03：API 客户端生成

**技术选型**：openapi-typescript + openapi-fetch

```typescript
// packages/api-client/src/tenant.ts

import createClient from 'openapi-fetch';
import type { paths } from './generated/tenant';

export const tenantApi = createClient<paths>({
  baseUrl: process.env.NEXT_PUBLIC_API_URL,
});

// 使用示例
const { data, error } = await tenantApi.GET('/services', {
  params: {
    query: {
      page: 1,
      pageSize: 20,
      status: 'active',
    },
  },
});
```

**验收标准**：
- [ ] 类型从 OpenAPI 生成
- [ ] API 客户端有完整类型提示
- [ ] 可以正常发起请求

---

### S2-04：UI 组件库初始化

**目标**：初始化 shadcn/ui 并定义 AI 交互原语

```
packages/ui/
├── src/
│   ├── components/                # shadcn/ui 组件
│   │   ├── button.tsx
│   │   ├── input.tsx
│   │   ├── table.tsx
│   │   ├── dialog.tsx
│   │   ├── form.tsx
│   │   └── ...
│   │
│   ├── primitives/                # AI 交互原语
│   │   ├── ai-form.tsx            # 表单
│   │   ├── ai-list.tsx            # 列表
│   │   ├── ai-details.tsx         # 详情
│   │   ├── ai-modal-confirm.tsx   # 确认弹窗
│   │   ├── ai-stepper.tsx         # 分步流程
│   │   └── index.ts
│   │
│   ├── layouts/                   # 布局组件
│   │   ├── page-layout.tsx
│   │   ├── list-layout.tsx
│   │   └── detail-layout.tsx
│   │
│   ├── states/                    # 状态组件
│   │   ├── empty-state.tsx
│   │   ├── loading-state.tsx
│   │   ├── error-state.tsx
│   │   └── index.ts
│   │
│   └── index.ts
```

**状态组件（必须先做）**：

```typescript
// packages/ui/src/states/empty-state.tsx

import { LucideIcon } from 'lucide-react';
import { Button } from '../components/button';

interface EmptyStateProps {
  icon?: LucideIcon;
  title: string;
  description?: string;
  action?: {
    label: string;
    onClick: () => void;
  };
}

export function EmptyState({
  icon: Icon,
  title,
  description,
  action,
}: EmptyStateProps) {
  return (
    <div className="flex flex-col items-center justify-center py-12">
      {Icon && (
        <div className="mb-4 rounded-full bg-muted p-3">
          <Icon className="h-6 w-6 text-muted-foreground" />
        </div>
      )}
      <h3 className="text-lg font-medium">{title}</h3>
      {description && (
        <p className="mt-1 text-sm text-muted-foreground">{description}</p>
      )}
      {action && (
        <Button className="mt-4" onClick={action.onClick}>
          {action.label}
        </Button>
      )}
    </div>
  );
}

// packages/ui/src/states/loading-state.tsx

import { Loader2 } from 'lucide-react';

interface LoadingStateProps {
  text?: string;
}

export function LoadingState({ text = '加载中...' }: LoadingStateProps) {
  return (
    <div className="flex flex-col items-center justify-center py-12">
      <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
      <p className="mt-2 text-sm text-muted-foreground">{text}</p>
    </div>
  );
}

// packages/ui/src/states/error-state.tsx

import { AlertCircle } from 'lucide-react';
import { Button } from '../components/button';

interface ErrorStateProps {
  title?: string;
  description?: string;
  retry?: () => void;
}

export function ErrorState({
  title = '加载失败',
  description = '请稍后重试',
  retry,
}: ErrorStateProps) {
  return (
    <div className="flex flex-col items-center justify-center py-12">
      <div className="mb-4 rounded-full bg-destructive/10 p-3">
        <AlertCircle className="h-6 w-6 text-destructive" />
      </div>
      <h3 className="text-lg font-medium">{title}</h3>
      <p className="mt-1 text-sm text-muted-foreground">{description}</p>
      {retry && (
        <Button variant="outline" className="mt-4" onClick={retry}>
          重试
        </Button>
      )}
    </div>
  );
}
```

**验收标准**：
- [ ] shadcn/ui 组件可以正常使用
- [ ] Empty/Loading/Error 三态组件可用
- [ ] 组件在四个应用中都可以导入

---

### S2-05：用户后台壳（Tenant Console）

**目标**：完成导航结构和关键页面壳

**导航结构**：

```typescript
// apps/console/src/config/navigation.ts

export const navigation = [
  {
    title: '工作台',
    icon: 'LayoutDashboard',
    href: '/dashboard',
  },
  {
    title: '项目管理',
    icon: 'FolderKanban',
    children: [
      { title: '项目列表', href: '/projects' },
      { title: '提案管理', href: '/proposals' },
      { title: '交付管理', href: '/deliverables' },
    ],
  },
  {
    title: '服务管理',
    icon: 'Package',
    children: [
      { title: '服务列表', href: '/services' },
      { title: '服务分类', href: '/service-categories' },
      { title: '报价菜单', href: '/quote-templates' },
    ],
  },
  {
    title: '客户管理',
    icon: 'Users',
    children: [
      { title: '客户列表', href: '/customers' },
      { title: '联系人', href: '/contacts' },
    ],
  },
  {
    title: '财务管理',
    icon: 'Wallet',
    children: [
      { title: '订单列表', href: '/orders' },
      { title: '结算单', href: '/settlements' },
      { title: '发票管理', href: '/invoices' },
    ],
  },
  {
    title: '合同管理',
    icon: 'FileText',
    children: [
      { title: '合同列表', href: '/contracts' },
      { title: '合同范本', href: '/contract-templates' },
    ],
  },
  {
    title: '内容管理',
    icon: 'Globe',
    children: [
      { title: '页面管理', href: '/pages' },
      { title: '文章管理', href: '/articles' },
      { title: '官网设置', href: '/website-settings' },
    ],
  },
  {
    title: '文件管理',
    icon: 'FolderOpen',
    href: '/files',
  },
  {
    title: '组织管理',
    icon: 'Building2',
    children: [
      { title: '企业信息', href: '/enterprise' },
      { title: '部门管理', href: '/departments' },
      { title: '员工管理', href: '/employees' },
      { title: '权限管理', href: '/permissions' },
    ],
  },
  {
    title: '系统设置',
    icon: 'Settings',
    href: '/settings',
  },
];
```

**页面结构**：

```
apps/console/src/app/
├── layout.tsx                     # 根布局
├── page.tsx                       # 重定向到 dashboard
│
├── (auth)/                        # 认证页面组
│   ├── login/
│   │   └── page.tsx
│   ├── register/
│   │   └── page.tsx
│   └── layout.tsx
│
├── (dashboard)/                   # 主布局页面组
│   ├── layout.tsx                 # 侧边栏布局
│   │
│   ├── dashboard/
│   │   └── page.tsx
│   │
│   ├── services/                  # 服务管理
│   │   ├── page.tsx               # 列表
│   │   ├── new/
│   │   │   └── page.tsx           # 创建
│   │   └── [id]/
│   │       ├── page.tsx           # 详情
│   │       └── edit/
│   │           └── page.tsx       # 编辑
│   │
│   ├── customers/                 # 客户管理
│   │   ├── page.tsx
│   │   ├── new/
│   │   │   └── page.tsx
│   │   └── [id]/
│   │       ├── page.tsx
│   │       └── edit/
│   │           └── page.tsx
│   │
│   ├── projects/                  # 项目管理
│   │   ├── page.tsx
│   │   ├── new/
│   │   │   └── page.tsx
│   │   └── [id]/
│   │       ├── page.tsx
│   │       └── edit/
│   │           └── page.tsx
│   │
│   └── ...                        # 其他模块
```

**页面壳示例**：

```typescript
// apps/console/src/app/(dashboard)/services/page.tsx

'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Plus, Search } from 'lucide-react';
import Link from 'next/link';

import { tenantApi } from '@dhs-atlas/api-client';
import { Button } from '@dhs-atlas/ui/components/button';
import { Input } from '@dhs-atlas/ui/components/input';
import {
  EmptyState,
  LoadingState,
  ErrorState,
} from '@dhs-atlas/ui/states';

export default function ServicesPage() {
  const [page, setPage] = useState(1);
  
  const { data, isLoading, isError, error, refetch } = useQuery({
    queryKey: ['services', { page }],
    queryFn: async () => {
      const { data, error } = await tenantApi.GET('/services', {
        params: {
          query: { page, pageSize: 20 },
        },
      });
      if (error) throw error;
      return data;
    },
  });

  return (
    <div className="space-y-6">
      {/* 页面标题 */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">服务管理</h1>
        <Button asChild>
          <Link href="/services/new">
            <Plus className="mr-2 h-4 w-4" />
            新建服务
          </Link>
        </Button>
      </div>

      {/* 筛选栏 */}
      <div className="flex items-center gap-4">
        <div className="relative flex-1 max-w-sm">
          <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
          <Input
            placeholder="搜索服务..."
            className="pl-9"
          />
        </div>
        {/* 更多筛选... */}
      </div>

      {/* 内容区 */}
      {isLoading ? (
        <LoadingState />
      ) : isError ? (
        <ErrorState
          description={error?.message}
          retry={() => refetch()}
        />
      ) : data?.items?.length === 0 ? (
        <EmptyState
          title="暂无服务"
          description="创建您的第一个服务"
          action={{
            label: '新建服务',
            onClick: () => {/* navigate to new */},
          }}
        />
      ) : (
        <ServiceList items={data?.items ?? []} />
      )}
    </div>
  );
}

function ServiceList({ items }: { items: Service[] }) {
  // 列表渲染...
  return (
    <div className="border rounded-lg">
      {/* Table */}
    </div>
  );
}
```

**验收标准**：
- [ ] 导航结构完整
- [ ] 服务/客户/项目三个模块有列表/详情/创建页面壳
- [ ] 所有页面支持 Empty/Loading/Error 三态
- [ ] 页面可以正常导航

---

### S2-06：平台后台壳（Platform Console）

**导航结构**：

```typescript
// apps/platform/src/config/navigation.ts

export const navigation = [
  {
    title: '概览',
    icon: 'LayoutDashboard',
    href: '/dashboard',
  },
  {
    title: '租户管理',
    icon: 'Building',
    children: [
      { title: '租户列表', href: '/tenants' },
      { title: '租户申请', href: '/tenant-requests' },
    ],
  },
  {
    title: '订阅管理',
    icon: 'CreditCard',
    children: [
      { title: '套餐配置', href: '/plans' },
      { title: '订阅列表', href: '/subscriptions' },
      { title: '功能开关', href: '/features' },
    ],
  },
  {
    title: '系统监控',
    icon: 'Activity',
    children: [
      { title: 'AI 网关', href: '/ai-gateway' },
      { title: '审计日志', href: '/audit-logs' },
      { title: '事件日志', href: '/event-logs' },
    ],
  },
  {
    title: '系统设置',
    icon: 'Settings',
    href: '/settings',
  },
];
```

**验收标准**：
- [ ] 导航结构完整
- [ ] 租户列表页面可用
- [ ] 套餐配置页面可用

---

### S2-07：客户网站前台壳（Portal）

**页面结构**：

```
apps/portal/src/app/
├── layout.tsx                     # 根布局
├── page.tsx                       # 首页
│
├── portfolio/                     # 作品展示
│   ├── page.tsx                   # 列表
│   └── [id]/
│       └── page.tsx               # 详情
│
├── team/                          # 团队介绍
│   └── page.tsx
│
├── services/                      # 报价展示
│   └── page.tsx
│
├── (workspace)/                   # 客户工作台（需登录）
│   ├── layout.tsx                 # 工作台布局
│   ├── dashboard/
│   │   └── page.tsx
│   ├── projects/
│   │   ├── page.tsx
│   │   └── [id]/
│   │       └── page.tsx
│   ├── proposals/
│   │   ├── page.tsx
│   │   └── [id]/
│   │       └── page.tsx
│   ├── deliverables/
│   │   └── page.tsx
│   ├── settlements/
│   │   └── page.tsx
│   └── invoices/
│       └── page.tsx
│
└── (auth)/
    ├── login/
    │   └── page.tsx
    └── layout.tsx
```

**验收标准**：
- [ ] 公共区页面可访问
- [ ] 客户工作台需要登录
- [ ] 页面支持三态

---

### S2-08：平台前台壳（Platform Web）

**页面结构**：

```
apps/platform-web/src/app/
├── layout.tsx
├── page.tsx                       # 首页
├── features/
│   └── page.tsx                   # 功能介绍
├── pricing/
│   └── page.tsx                   # 定价页面
├── about/
│   └── page.tsx                   # 关于我们
└── (auth)/
    ├── login/
    │   └── page.tsx
    └── register/
        └── page.tsx
```

**验收标准**：
- [ ] 首页可访问
- [ ] 定价页面可访问
- [ ] 注册入口可用

---

## 四、Step 3：后端能力（按域填充）

### 4.1 任务清单

| 任务 ID | 任务名称 | 优先级 | 预估工时 |
|---------|---------|--------|---------|
| S3-01 | API 框架搭建 | P0 | 8h |
| S3-02 | 服务域实现 | P0 | 16h |
| S3-03 | 客户域实现 | P0 | 12h |
| S3-04 | 报价域实现 | P0 | 16h |
| S3-05 | 订单域实现 | P0 | 12h |
| S3-06 | 项目域实现 | P0 | 24h |
| S3-07 | 交付域实现 | P0 | 16h |
| S3-08 | 第一条闭环测试 | P0 | 8h |

**总预估**: 112h（约 14 个工作日）

---

### S3-01：API 框架搭建

**技术选型**：Hono（轻量、类型安全、Edge 兼容）

```typescript
// services/api/src/index.ts

import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { logger } from 'hono/logger';

import { authMiddleware } from './middleware/auth';
import { enterpriseMiddleware } from './middleware/enterprise';
import { errorHandler } from './middleware/error';

import { serviceRoutes } from './routes/service';
import { customerRoutes } from './routes/customer';
import { projectRoutes } from './routes/project';
import { quoteRoutes } from './routes/quote';
import { orderRoutes } from './routes/order';
import { deliverableRoutes } from './routes/deliverable';

const app = new Hono();

// 中间件
app.use('*', cors());
app.use('*', logger());
app.use('*', errorHandler());

// 健康检查
app.get('/health', (c) => c.json({ status: 'ok' }));

// API v1
const v1 = new Hono();

// 认证中间件
v1.use('*', authMiddleware());
v1.use('*', enterpriseMiddleware());

// 路由
v1.route('/services', serviceRoutes);
v1.route('/customers', customerRoutes);
v1.route('/projects', projectRoutes);
v1.route('/quotes', quoteRoutes);
v1.route('/orders', orderRoutes);
v1.route('/deliverables', deliverableRoutes);

app.route('/api/v1', v1);

export default app;
```

**验收标准**：
- [ ] API 服务可以启动
- [ ] 健康检查接口正常
- [ ] 中间件正常工作

---

### S3-02 ~ S3-07：域实现

**每个域的标准实现结构**：

```
domains/{domain}/
├── entities/
│   └── {entity}.ts                # 实体定义
├── schemas/
│   └── {entity}.schema.ts         # Zod Schema
├── repos/
│   └── {entity}.repo.ts           # 数据访问
├── services/
│   └── {entity}.service.ts        # 业务逻辑
└── routes/
    └── {entity}.routes.ts         # API 路由
```

**示例：服务域**

```typescript
// domains/svc/schemas/service.schema.ts

import { z } from 'zod';

export const ServiceStatus = z.enum(['draft', 'active', 'archived']);

export const PricingModel = z.object({
  type: z.enum(['fixed', 'milestone', 'hourly', 'daily', 'unit', 'subscription', 'hybrid']),
  basePrice: z.number().optional(),
  currency: z.string().default('CNY'),
});

export const CreateServiceInput = z.object({
  name: z.string().min(1).max(256),
  description: z.string().optional(),
  serviceType: z.string(),
  pricingModel: PricingModel.optional(),
});

export const UpdateServiceInput = CreateServiceInput.partial().extend({
  status: ServiceStatus.optional(),
});
```

```typescript
// domains/svc/repos/service.repo.ts

import { db } from '@dhs-atlas/database';
import { service } from '@dhs-atlas/database/schema';
import { eq, and } from 'drizzle-orm';

export const serviceRepo = {
  async findMany(enterpriseId: string, options: {
    status?: string;
    page?: number;
    pageSize?: number;
  }) {
    const { status, page = 1, pageSize = 20 } = options;
    
    const conditions = [eq(service.enterpriseId, enterpriseId)];
    if (status) {
      conditions.push(eq(service.status, status));
    }
    
    const [items, [{ count }]] = await Promise.all([
      db.query.service.findMany({
        where: and(...conditions),
        limit: pageSize,
        offset: (page - 1) * pageSize,
        orderBy: (service, { desc }) => [desc(service.createdAt)],
      }),
      db.select({ count: sql`count(*)` })
        .from(service)
        .where(and(...conditions)),
    ]);
    
    return {
      items,
      total: Number(count),
      page,
      pageSize,
      totalPages: Math.ceil(Number(count) / pageSize),
    };
  },
  
  async findById(enterpriseId: string, id: string) {
    return db.query.service.findFirst({
      where: and(
        eq(service.enterpriseId, enterpriseId),
        eq(service.id, id)
      ),
    });
  },
  
  async create(enterpriseId: string, data: CreateServiceInput) {
    const [result] = await db.insert(service).values({
      ...data,
      enterpriseId,
      status: 'draft',
    }).returning();
    
    return result;
  },
  
  async update(enterpriseId: string, id: string, data: UpdateServiceInput) {
    const [result] = await db.update(service)
      .set({ ...data, updatedAt: new Date() })
      .where(and(
        eq(service.enterpriseId, enterpriseId),
        eq(service.id, id)
      ))
      .returning();
    
    return result;
  },
  
  async delete(enterpriseId: string, id: string) {
    await db.delete(service).where(and(
      eq(service.enterpriseId, enterpriseId),
      eq(service.id, id)
    ));
  },
};
```

```typescript
// domains/svc/routes/service.routes.ts

import { Hono } from 'hono';
import { zValidator } from '@hono/zod-validator';

import { serviceRepo } from '../repos/service.repo';
import { CreateServiceInput, UpdateServiceInput } from '../schemas/service.schema';
import { logEvent, logAudit } from '@dhs-atlas/event-log';

export const serviceRoutes = new Hono();

// 列表
serviceRoutes.get('/', async (c) => {
  const { enterpriseId } = c.var;
  const { page, pageSize, status } = c.req.query();
  
  const result = await serviceRepo.findMany(enterpriseId, {
    status,
    page: page ? parseInt(page) : undefined,
    pageSize: pageSize ? parseInt(pageSize) : undefined,
  });
  
  return c.json(result);
});

// 详情
serviceRoutes.get('/:id', async (c) => {
  const { enterpriseId } = c.var;
  const { id } = c.req.param();
  
  const service = await serviceRepo.findById(enterpriseId, id);
  if (!service) {
    return c.json({ error: 'Not found' }, 404);
  }
  
  return c.json(service);
});

// 创建
serviceRoutes.post('/',
  zValidator('json', CreateServiceInput),
  async (c) => {
    const { enterpriseId, user } = c.var;
    const data = c.req.valid('json');
    
    const service = await serviceRepo.create(enterpriseId, data);
    
    // 事件日志
    await logEvent({
      enterpriseId,
      eventType: 'svc.service.created',
      actorType: 'user',
      actorId: user.id,
      targetType: 'service',
      targetId: service.id,
      payload: data,
    });
    
    // 审计日志
    await logAudit({
      enterpriseId,
      action: 'service.create',
      userId: user.id,
      userEmail: user.email,
      resourceType: 'service',
      resourceId: service.id,
      after: service,
    });
    
    return c.json(service, 201);
  }
);

// 更新
serviceRoutes.patch('/:id',
  zValidator('json', UpdateServiceInput),
  async (c) => {
    const { enterpriseId, user } = c.var;
    const { id } = c.req.param();
    const data = c.req.valid('json');
    
    const before = await serviceRepo.findById(enterpriseId, id);
    if (!before) {
      return c.json({ error: 'Not found' }, 404);
    }
    
    const service = await serviceRepo.update(enterpriseId, id, data);
    
    // 审计日志
    await logAudit({
      enterpriseId,
      action: 'service.update',
      userId: user.id,
      userEmail: user.email,
      resourceType: 'service',
      resourceId: id,
      before,
      after: service,
    });
    
    return c.json(service);
  }
);

// 删除
serviceRoutes.delete('/:id', async (c) => {
  const { enterpriseId, user } = c.var;
  const { id } = c.req.param();
  
  const before = await serviceRepo.findById(enterpriseId, id);
  if (!before) {
    return c.json({ error: 'Not found' }, 404);
  }
  
  await serviceRepo.delete(enterpriseId, id);
  
  // 审计日志
  await logAudit({
    enterpriseId,
    action: 'service.delete',
    userId: user.id,
    userEmail: user.email,
    resourceType: 'service',
    resourceId: id,
    before,
  });
  
  return c.body(null, 204);
});
```

---

### S3-08：第一条闭环测试

**测试场景**：

```
Service → Quote → Order → Project → Deliverable
```

1. 创建服务（Service）
2. 基于服务创建报价菜单（QuoteTemplate）
3. 为客户创建报价单（Quote）
4. 报价单转为订单（Order）
5. 订单创建项目（Project）
6. 项目创建里程碑（Phase）
7. 里程碑上传交付物（Deliverable）
8. 交付物验收

**验收标准**：
- [ ] 完整流程可以跑通
- [ ] 每一步都有状态变更
- [ ] 每一步都有事件/审计日志
- [ ] 所有数据都带 `enterpriseId`

---

## 五、时间线

```
Week 1-2: Step 1 - 部署环境与工程骨架
  ├── Day 1-2: Monorepo 初始化 + Docker 配置
  ├── Day 3-4: 数据库与迁移
  ├── Day 5-7: Auth 基线
  └── Day 8-10: 日志/审计/Feature Flag

Week 3-4: Step 2 - 前端界面
  ├── Day 1-2: OpenAPI 契约 + Mock Server
  ├── Day 3: API 客户端生成
  ├── Day 4-5: UI 组件库
  ├── Day 6-8: 用户后台壳
  ├── Day 9: 平台后台壳
  └── Day 10: Portal + Platform Web 壳

Week 5-6: Step 3 - 后端能力
  ├── Day 1: API 框架
  ├── Day 2-3: 服务域 + 客户域
  ├── Day 4-5: 报价域 + 订单域
  ├── Day 6-8: 项目域 + 交付域
  └── Day 9-10: 闭环测试 + 修复

总计: 约 6 周
```

---

## 六、验收清单

### 6.1 工程骨架

- [ ] `git clone` + `pnpm install` + `docker compose up` 可以启动
- [ ] 四个应用都能访问
- [ ] 数据库迁移正常
- [ ] Auth 登录正常

### 6.2 前端

- [ ] 用户后台导航完整
- [ ] 服务/客户/项目三个模块有完整页面壳
- [ ] 所有页面支持 Empty/Loading/Error 三态
- [ ] API 调用类型安全

### 6.3 后端

- [ ] 所有 API 按 OpenAPI 契约实现
- [ ] 所有数据都带 `enterpriseId`
- [ ] 所有状态变更有状态机字段
- [ ] 关键操作有事件/审计日志

### 6.4 闭环

- [ ] Service → Quote → Order → Project → Deliverable 流程可跑通
- [ ] 每一步状态正确
- [ ] 日志可查询

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [领域划分与边界定义](../domain/领域划分与边界定义.md)
- [用户后台功能架构](../domain/用户后台功能架构.md)
- [总体架构设计](../architecture/总体架构设计.md)

