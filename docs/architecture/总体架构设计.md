# dhs-atlas 总体架构设计（v1.0）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 架构设计文档  
> **相关规范**: [代码质量标准化体系](../代码质量标准化体系.md) · [开发伦理与系统操作宪章](../开发伦理与系统操作宪章-最高指示.md)

---

## 一、项目定位

**项目名称**：dhs-atlas

**命名含义**：
- **dhs**：Donhauser System / 东合社系统前缀，代表一整套长期演进的系统家族
- **atlas**：承载、支撑、稳定、不可替代

**定位一句话**：

> dhs-atlas 是一个**多企业、AI 原生的业务操作系统**（AI-Native Business OS），用于承载服务、报价、客户、财务、项目、官网、组织、员工等大型业务域，并以统一的 Tool / Workflow / Role / UI Protocol 体系实现"人机同轨"的可控协作。

---

## 二、架构设计原则

### 2.1 AI 原生设计

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 原生架构核心                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    │
│   │    Human    │    │     AI      │    │   Script    │    │
│   │   Operator  │    │   Agent     │    │   Runner    │    │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    │
│          │                  │                  │            │
│          └──────────────────┼──────────────────┘            │
│                             │                               │
│                             ▼                               │
│               ┌─────────────────────────┐                   │
│               │   Unified Capability    │                   │
│               │   Channel (Tool/API)    │                   │
│               └─────────────────────────┘                   │
│                                                             │
│   • AI 是系统的一等执行者（First-Class Operator）            │
│   • AI 与人使用同一条能力通道                                │
│   • 任何能力必须可被 AI 操作                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 可控协作设计

| 原则 | 含义 |
|------|------|
| **可审计** | 任何 AI 行为必须产生审计日志 |
| **可回放** | 任何执行过程必须可完整回放 |
| **可追责** | 任何操作必须关联到 actor（人/AI/系统） |
| **可约束** | AI 行为在 Role/Policy/Workflow 轨道内执行 |

### 2.3 真实交互设计

| 要求 | 说明 |
|------|------|
| **禁止假进度** | 进度必须来自真实 Event Stream |
| **禁止假流式** | 流式输出必须是真实生成过程 |
| **禁止假完成** | 完成状态必须来自真实执行结果 |
| **UI 真实性** | UI 只能呈现真实状态（Event/Artifact/Workflow State） |

---

## 三、技术栈选型

### 3.1 语言与运行时

| 技术 | 版本 | 说明 |
|------|------|------|
| **TypeScript** | 5.x | 严格模式，强类型边界 |
| **Node.js** | 20+ | LTS 版本 |

### 3.2 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| **Next.js** | 15 | App Router |
| **React** | 19 | RSC-first |
| **shadcn/ui** | latest | 唯一 UI 组件库 |
| **Radix UI** | latest | 无障碍原语 |
| **Tailwind CSS** | v4 | 原子化样式 |

### 3.3 数据与持久化

| 技术 | 用途 |
|------|------|
| **PostgreSQL** | 主数据库（结构化 + JSONB） |
| **Event Log** | 行为真相源（审计、回放、进度） |
| **Artifact Store** | AI 产物与版本管理 |

### 3.4 实时与进度

| 技术 | 优先级 | 说明 |
|------|--------|------|
| **SSE** | 优先 | Server-Sent Events |
| **WebSocket** | 备选 | 双向通信场景 |

> 进度来自 Tool/Workflow 事件流，不允许伪造。

---

## 四、系统分层架构

### 4.1 架构总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                           dhs-atlas 系统架构                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      业务层（Domain Plugins）                   │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ │ │
│  │  │ Service │ │  Quote  │ │   CRM   │ │ Finance │ │ Project │ │ │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ │ │
│  │       │           │           │           │           │       │ │
│  │  ┌────┴───────────┴───────────┴───────────┴───────────┴────┐ │ │
│  │  │                    Domain Interface                      │ │ │
│  │  │            (Tools + Workflows + Data Model)              │ │ │
│  │  └────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                  │                                  │
│                                  ▼                                  │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      平台层（AI OS Layer）                      │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                    AI OS Runtime                         │ │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │ │ │
│  │  │  │  Agent   │ │   Role   │ │ Workflow │ │   Tool   │   │ │ │
│  │  │  │ Runtime  │ │  Router  │ │  Engine  │ │  Runner  │   │ │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │ │ │
│  │  │  ┌──────────┐ ┌──────────┐                             │ │ │
│  │  │  │Orchestr- │ │ UI Host  │                             │ │ │
│  │  │  │  ator    │ │          │                             │ │ │
│  │  │  └──────────┘ └──────────┘                             │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                    Registry Layer                        │ │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │ │ │
│  │  │  │   Tool   │ │    UI    │ │ Workflow │ │   Role   │   │ │ │
│  │  │  │ Registry │ │ Registry │ │ Registry │ │ Registry │   │ │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │                   Foundation Layer                       │ │ │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │ │ │
│  │  │  │  Multi-  │ │ Entitle- │ │  Event   │ │ Artifact │   │ │ │
│  │  │  │  Tenant  │ │  ments   │ │   Log    │ │  Store   │   │ │ │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 平台层（AI OS Layer）

平台层提供通用操作系统能力，**业务无关**：

| 组件 | 职责 |
|------|------|
| **Tool Runtime + Registry** | 能力执行与注册 |
| **Workflow Engine + Registry** | 状态机驱动与注册 |
| **Role/Policy System + Registry** | 行为约束与注册 |
| **Interaction Orchestrator** | AI 与 UI 的最终调度裁决者 |
| **UI Host + Registry** | UI 原语渲染与注册 |
| **Multi-tenant Boundary** | 企业边界隔离 |
| **Entitlements** | 订阅/功能开关层 |
| **Event Log / Artifact Store** | 审计/回放/产物管理 |

> 平台层不包含任何服务/报价/财务等业务语义。

### 4.3 业务层（Domain Plugins）

业务层按域组织，每个域以"插件"方式接入平台层：

| 接入方式 | 说明 |
|---------|------|
| **定义数据模型** | Repo/Entity（带 enterpriseId） |
| **注册 Tools** | 域内可执行原子能力 |
| **注册 Workflows** | 域内状态机流程 |
| **复用 UI 原语** | 不自造组件，只拼装已注册原语 |

---

## 五、Monorepo 目录结构

```
dhs-atlas/
├── apps/
│   ├── web/                        # Tenant Console（租户前端）
│   │   ├── app/                    # App Router
│   │   ├── components/             # 页面级组件（仅组装）
│   │   └── ...
│   │
│   └── platform/                   # Platform Console（平台后台）
│       ├── app/                    # 平台管理界面
│       └── ...
│
├── packages/
│   ├── ai-core/                    # AI OS 核心
│   │   ├── agent/                  # Agent Runtime
│   │   ├── role/                   # Role Router + Registry
│   │   ├── workflow/               # Workflow Engine + Registry
│   │   └── orchestrator/           # Interaction Orchestrator
│   │
│   ├── ai-tools/                   # Tool 系统
│   │   ├── protocol/               # Tool Protocol 定义
│   │   ├── registry/               # Tool Registry
│   │   ├── runner/                 # Tool Runner
│   │   └── implementations/        # Tool 实现（按域分组）
│   │
│   ├── ai-ui/                      # UI 系统
│   │   ├── protocol/               # UI Protocol 定义
│   │   ├── registry/               # UI Registry
│   │   ├── host/                   # UI Host
│   │   └── primitives/             # 8 个交互原语
│   │
│   ├── platform/                   # 平台基础服务（Tenant Plane）
│   │   ├── multi-tenant/           # 多企业隔离
│   │   ├── entitlements/           # 订阅/功能开关（消费快照）
│   │   ├── event-log/              # 事件日志
│   │   └── artifact/               # 产物存储
│   │
│   ├── control-plane/              # Control Plane 服务
│   │   ├── entitlements/           # 订阅管理（生成快照）
│   │   ├── billing/                # 支付/计费
│   │   ├── licensing/              # 许可/授权
│   │   ├── ai-gateway/             # AI 调用网关
│   │   ├── provisioning/           # 租户编排/部署
│   │   └── audit/                  # 全局审计/风控
│   │
│   ├── resources/                  # 资源抽象层（支持 Dedicated）
│   │   ├── database/               # 数据库抽象
│   │   ├── storage/                # 对象存储抽象
│   │   ├── queue/                  # 队列抽象
│   │   └── cache/                  # 缓存抽象
│   │
│   ├── db/                         # 数据层
│   │   ├── schema/                 # 数据库 Schema
│   │   ├── migrations/             # 迁移文件
│   │   └── repos/                  # Repository 实现
│   │
│   └── shared/                     # 共享工具
│       ├── types/                  # 公共类型
│       ├── schemas/                # Zod Schemas
│       ├── ids/                    # ID 生成
│       └── errors/                 # 错误定义
│
├── domains/                        # 业务域（可选独立包）
│   ├── service/                    # 服务域
│   ├── quote/                      # 报价域
│   ├── crm/                        # 客户域
│   ├── finance/                    # 财务域
│   ├── project/                    # 项目域
│   ├── cms/                        # 内容域
│   ├── org/                        # 组织域
│   └── hr/                         # 员工域
│
└── docs/
    └── architecture/               # 架构文档
```

---

## 六、四大核心协议

### 6.1 Tool Protocol（能力协议）

Tool 是系统**唯一可执行入口**。

#### 6.1.1 Tool 定义

```typescript
interface ToolDefinition {
  // 唯一标识
  toolId: string;                    // e.g., "crm.customer.create"
  
  // Schema 定义
  inputSchema: ZodSchema;
  outputSchema: ZodSchema;
  
  // 门禁配置
  requiredFeatures: string[];        // 订阅门禁
  requiredPermissions: string[];     // RBAC 门禁
  
  // 执行配置
  idempotency: {
    enabled: boolean;
    keyField: string;                // 幂等键字段
  };
  
  // 元信息
  description: string;
  domain: string;
}
```

#### 6.1.2 Tool Input 标准结构

```typescript
interface ToolInput<T = unknown> {
  // 必须字段（Multi-tenant + 审计）
  enterpriseId: string;
  actor: {
    type: 'user' | 'agent' | 'system';
    id: string;
    roleId?: string;
  };
  requestId: string;                  // 幂等键
  
  // 业务参数
  payload: T;
}
```

#### 6.1.3 Tool Result 标准结构

```typescript
interface ToolResult<T = unknown> {
  status: 'ok' | 'error';
  
  // 成功时
  data?: T;
  artifacts?: Artifact[];             // 产生的产物
  events?: ToolEvent[];               // 产生的事件（进度/节点）
  
  // 失败时
  error?: {
    code: string;
    message: string;
    details?: unknown;
    recoverHint?: string;
  };
  
  // UI 建议（仅建议，不裁决）
  uiSuggestion?: {
    componentId: string;
    props: unknown;
  };
}
```

### 6.2 UI Protocol（交互协议）

**AI 不生成 UI。AI 只能请求已注册 UI 原语。**

#### 6.2.1 UI Request 结构

```typescript
interface UIRequest {
  componentId: string;               // 已注册的组件 ID
  props: unknown;                    // 必须通过 schema 校验
  slot?: string;                     // 放置位置
}
```

#### 6.2.2 UI Event 结构

```typescript
interface UIEvent {
  eventId: string;
  componentId: string;
  eventType: string;                 // e.g., "submit", "cancel", "select"
  payload: unknown;                  // 结构化数据
  timestamp: Date;
  
  // 上下文
  enterpriseId: string;
  userId: string;
  workflowSessionId?: string;
}
```

#### 6.2.3 八个交互原语

| 原语 | 用途 |
|------|------|
| `AiForm` | 结构化表单输入 |
| `AiPicker` | 单选/多选/搜索选择 |
| `AiList` | 数据列表展示 |
| `AiDetails` | 详情展示 |
| `AiModalConfirm` | 确认对话框 |
| `AiReviewPanel` | 审批/审查面板 |
| `AiStepper` | 步骤引导器 |
| `AiConsole` | 执行日志/进度展示 |

### 6.3 Workflow Protocol（状态机协议）

#### 6.3.1 Workflow 定义

```typescript
interface WorkflowDefinition {
  workflowId: string;
  name: string;
  description: string;
  
  // 状态定义
  states: WorkflowState[];
  initialState: string;
  finalStates: string[];
  
  // 门禁
  requiredFeatures: string[];
}

interface WorkflowState {
  stateId: string;
  name: string;
  
  // 当前状态允许的能力
  allowedTools: string[];
  allowedUIComponents: string[];
  
  // 状态转移
  transitions: StateTransition[];
}

interface StateTransition {
  from: string;
  to: string;
  trigger: {
    type: 'tool_completed' | 'ui_event' | 'timeout' | 'manual';
    condition?: string;              // 条件表达式
  };
}
```

#### 6.3.2 Workflow Session

```typescript
interface WorkflowSession {
  sessionId: string;
  workflowId: string;
  
  // Multi-tenant
  enterpriseId: string;
  
  // 状态
  currentState: string;
  stateHistory: StateHistoryEntry[];
  
  // 上下文
  context: Record<string, unknown>;
  artifacts: string[];               // 关联的 artifact IDs
  
  // 时间
  startedAt: Date;
  updatedAt: Date;
  completedAt?: Date;
}
```

### 6.4 Event & Artifact Protocol

#### 6.4.1 Event Log 结构

```typescript
interface EventLog {
  eventId: string;
  
  // Multi-tenant（必须）
  enterpriseId: string;
  
  // 事件信息
  eventType: string;                 // e.g., "tool.invoked", "workflow.state_changed"
  source: {
    type: 'tool' | 'workflow' | 'ui' | 'system';
    id: string;
  };
  
  // Actor
  actor: {
    type: 'user' | 'agent' | 'system';
    id: string;
    roleId?: string;
  };
  
  // 数据
  payload: unknown;
  
  // 时间
  timestamp: Date;
  
  // 关联
  workflowSessionId?: string;
  requestId?: string;
}
```

#### 6.4.2 Artifact 结构

```typescript
interface Artifact {
  artifactId: string;
  
  // Multi-tenant（必须）
  enterpriseId: string;
  
  // 产物信息
  type: string;                      // e.g., "quote.draft", "report.pdf"
  name: string;
  
  // 版本
  version: number;
  previousVersionId?: string;
  
  // 内容
  content: unknown;                  // 结构化内容或引用
  contentType: string;
  
  // 来源
  source: {
    toolId?: string;
    workflowSessionId?: string;
    actorId: string;
  };
  
  // 时间
  createdAt: Date;
}
```

---

## 七、AI OS 运行时

### 7.1 运行时组件

```
┌─────────────────────────────────────────────────────────────────────┐
│                        AI OS Runtime                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Request Flow                              │   │
│  │                                                              │   │
│  │   User/AI Input                                              │   │
│  │        │                                                     │   │
│  │        ▼                                                     │   │
│  │   ┌──────────────┐                                          │   │
│  │   │    Agent     │  意图识别 + 计划生成                       │   │
│  │   │   Runtime    │  （不直接执行）                            │   │
│  │   └──────┬───────┘                                          │   │
│  │          │                                                   │   │
│  │          ▼                                                   │   │
│  │   ┌──────────────┐                                          │   │
│  │   │    Role      │  选择角色组合                              │   │
│  │   │   Router     │  (系统角色 + 领域专家)                     │   │
│  │   └──────┬───────┘                                          │   │
│  │          │                                                   │   │
│  │          ▼                                                   │   │
│  │   ┌──────────────┐                                          │   │
│  │   │  Workflow    │  推进状态机                                │   │
│  │   │   Engine     │  (状态验证 + 转移)                        │   │
│  │   └──────┬───────┘                                          │   │
│  │          │                                                   │   │
│  │          ▼                                                   │   │
│  │   ┌──────────────┐                                          │   │
│  │   │    Tool      │  执行 Tool                                │   │
│  │   │   Runner     │  (门禁 + 审计 + 幂等)                     │   │
│  │   └──────┬───────┘                                          │   │
│  │          │                                                   │   │
│  │          ▼                                                   │   │
│  │   ┌──────────────┐                                          │   │
│  │   │ Interaction  │  UI 呈现的最终裁决者                       │   │
│  │   │ Orchestrator │  (聚合 uiSuggestion → UI 指令)            │   │
│  │   └──────┬───────┘                                          │   │
│  │          │                                                   │   │
│  │          ▼                                                   │   │
│  │   ┌──────────────┐                                          │   │
│  │   │   UI Host    │  渲染交互原语                              │   │
│  │   │              │  产生 UIEvent                             │   │
│  │   └──────────────┘                                          │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 7.2 组件职责

| 组件 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **Agent Runtime** | 意图识别、计划生成 | 用户输入/上下文 | 执行计划 |
| **Role Router** | 选择角色组合 | 执行计划 | 角色集合 |
| **Workflow Engine** | 状态机推进 | 角色指令/事件 | 状态变更 |
| **Tool Runner** | Tool 执行 | ToolInput | ToolResult |
| **Interaction Orchestrator** | UI 最终裁决 | uiSuggestion[] | UI 指令 |
| **UI Host** | 原语渲染 | UI 指令 | UIEvent |

### 7.3 执行边界

```typescript
// Tool Runner 执行前必须通过的门禁
interface ToolExecutionContext {
  // 1. Multi-tenant 校验
  enterpriseId: string;              // 必须存在且有效
  
  // 2. Entitlements 校验
  requiredFeatures: string[];        // 订阅门禁
  
  // 3. Permission 校验
  requiredPermissions: string[];     // RBAC 门禁
  
  // 4. Workflow 校验（如果在 workflow 中）
  workflowSessionId?: string;
  currentState?: string;
  allowedTools?: string[];           // 当前状态允许的 tools
  
  // 5. 幂等校验
  requestId: string;
}
```

---

## 八、多角色体系

### 8.1 角色分类

```
┌─────────────────────────────────────────────────────────────┐
│                        角色体系                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  系统角色（通用）                                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ Orchestrator│ │  Executor   │ │  Reviewer   │           │
│  │  规划/调度   │ │  执行 tools │ │  审查/审批   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  领域角色（按域挂载）                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Service   │ │    Quote    │ │     CRM     │           │
│  │    Expert   │ │    Expert   │ │    Expert   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Finance   │ │   Project   │ │     CMS     │           │
│  │    Expert   │ │    Expert   │ │    Expert   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│  ┌─────────────┐ ┌─────────────┐                           │
│  │     Org     │ │     HR      │                           │
│  │    Expert   │ │    Expert   │                           │
│  └─────────────┘ └─────────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 角色定义结构

```typescript
interface RoleDefinition {
  roleId: string;
  name: string;
  type: 'system' | 'domain';
  domain?: string;                   // 领域角色所属域
  
  // 能力约束（必须绑定）
  allowedTools: string[];            // Tool 白名单
  outputSchema: ZodSchema;           // 输出 Schema
  
  // 审批约束
  requiresApproval: {
    tools: string[];                 // 需要审批的 tools
    approverRoles: string[];         // 可审批的角色
  };
  
  // 行为约束
  constraints: {
    maxTokensPerTurn?: number;
    maxToolCallsPerTurn?: number;
    timeoutMs?: number;
  };
}
```

### 8.3 角色硬约束

| 约束 | 说明 |
|------|------|
| **Tool 白名单** | 角色只能调用 `allowedTools` 内的 tools |
| **输出 Schema** | 角色输出必须符合 `outputSchema` |
| **审批策略** | `requiresApproval` 中的 tools 必须经过审批 |
| **Entitlements** | 角色可用性受订阅门禁限制 |

---

## 九、多企业架构（Multi-Tenant）

### 9.1 基础实体关系

```
┌─────────────────────────────────────────────────────────────┐
│                    Multi-Tenant 实体关系                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐                                         │
│   │  Enterprise  │─────────────────────────────────────┐   │
│   └──────┬───────┘                                     │   │
│          │ 1:N                                         │   │
│          ▼                                             │   │
│   ┌──────────────┐         ┌──────────────┐           │   │
│   │  Membership  │◄────────│     User     │           │   │
│   │              │ N:1     │              │           │   │
│   └──────┬───────┘         └──────────────┘           │   │
│          │                                             │   │
│          │ has                                         │   │
│          ▼                                             │   │
│   ┌──────────────┐                                     │   │
│   │  Role/Policy │                                     │   │
│   └──────────────┘                                     │   │
│                                                        │   │
│   ┌──────────────────────────────────────────────────┐│   │
│   │          Enterprise Scope (enterpriseId)         ││   │
│   │  ┌────────────┐ ┌────────────┐ ┌────────────┐   ││   │
│   │  │  Workflow  │ │  EventLog  │ │  Artifact  │   ││   │
│   │  │  Session   │ │            │ │            │   ││   │
│   │  └────────────┘ └────────────┘ └────────────┘   ││   │
│   │  ┌────────────┐ ┌────────────┐ ┌────────────┐   ││   │
│   │  │  Customer  │ │   Quote    │ │  Invoice   │   ││   │
│   │  │            │ │            │ │            │   ││   │
│   │  └────────────┘ └────────────┘ └────────────┘   ││   │
│   │               ... 所有业务数据 ...                ││   │
│   └──────────────────────────────────────────────────┘│   │
│                                                        │   │
└────────────────────────────────────────────────────────┘   │
                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 核心实体

```typescript
interface Enterprise {
  id: string;
  name: string;
  slug: string;
  
  // 订阅
  subscriptionId?: string;
  
  // 状态
  status: 'active' | 'suspended' | 'deleted';
  
  // 时间
  createdAt: Date;
  updatedAt: Date;
}

interface User {
  id: string;
  email: string;
  name: string;
  
  // 认证
  passwordHash?: string;
  
  // 状态
  status: 'active' | 'suspended' | 'deleted';
  
  // 时间
  createdAt: Date;
  updatedAt: Date;
}

interface Membership {
  id: string;
  
  // 关联
  userId: string;
  enterpriseId: string;
  
  // 角色
  roles: string[];                   // Role IDs
  
  // 状态
  status: 'active' | 'suspended' | 'removed';
  
  // 时间
  joinedAt: Date;
  updatedAt: Date;
}
```

### 9.3 单企业先行体验

| 阶段 | 用户体验 | 后端实现 |
|------|---------|---------|
| **Phase 0** | 单企业系统（无企业切换） | 严格 Multi-tenant |
| **Phase 1** | 内部多企业测试 | 验证隔离完整性 |
| **Phase 2** | 开放企业切换 UI | 解锁能力 |

**Phase 0 实现**：

```typescript
// 系统启动时创建 default enterprise
const DEFAULT_ENTERPRISE_ID = 'default';

// 用户注册时自动加入
async function registerUser(data: RegisterData) {
  const user = await createUser(data);
  await createMembership({
    userId: user.id,
    enterpriseId: DEFAULT_ENTERPRISE_ID,
    roles: ['member'],
  });
  return user;
}

// UI 隐藏企业切换，但后端仍然携带 enterpriseId
```

---

## 十、订阅与功能开关层（Entitlements）

### 10.1 层级定位

```
┌─────────────────────────────────────────────────────────────┐
│                      平台底座三大层                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Multi-Tenant Layer                      │   │
│   │              (数据隔离边界)                           │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              Entitlements Layer                      │   │
│   │              (功能开关/订阅门禁)                       │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              RBAC Layer                              │   │
│   │              (权限/角色)                              │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.2 Feature Key 体系

以"域.模块.能力"定义 feature key：

| Feature Key | 说明 |
|-------------|------|
| `svc.catalog.manage` | 服务目录管理 |
| `qt.quote.approve` | 报价审批 |
| `crm.customer.manage` | 客户管理 |
| `fin.report.export` | 财务报表导出 |
| `cms.site.publish` | 网站发布 |
| `org.member.invite` | 成员邀请 |
| `hr.employee.manage` | 员工管理 |

### 10.3 三层门禁

```
┌─────────────────────────────────────────────────────────────┐
│                        三层门禁                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  Layer 1: UI Gate                                    │   │
│   │  • 入口提示/禁用（体验优化）                           │   │
│   │  • 仅用于提示与降级                                   │   │
│   │  • 不作为唯一门禁                                     │   │
│   └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ▼                                   │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  Layer 2: Runtime Gate (核心)                        │   │
│   │  • Tool/Workflow 执行前硬校验                         │   │
│   │  • 必须通过才能执行                                   │   │
│   │  • 校验 requiredFeatures                            │   │
│   └─────────────────────────────────────────────────────┘   │
│                         │                                   │
│                         ▼                                   │
│   ┌─────────────────────────────────────────────────────┐   │
│   │  Layer 3: Data Gate                                  │   │
│   │  • 数据导出与范围控制                                 │   │
│   │  • 合规要求                                          │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 10.4 数据模型

```typescript
interface Plan {
  id: string;
  name: string;                      // e.g., "Free", "Pro", "Enterprise"
  features: FeatureGrant[];
}

interface FeatureGrant {
  featureKey: string;
  enabled: boolean;
  quota?: {
    limit: number;
    period: 'day' | 'month' | 'year';
  };
}

interface Subscription {
  id: string;
  enterpriseId: string;
  planId: string;
  
  // 状态
  status: 'active' | 'trial' | 'expired' | 'cancelled';
  
  // 周期
  startDate: Date;
  endDate?: Date;
  trialEndDate?: Date;
}

interface FeatureUsage {
  id: string;
  enterpriseId: string;
  featureKey: string;
  
  // 用量
  count: number;
  period: string;                    // e.g., "2025-01"
}
```

### 10.5 门禁接入点

| 接入点 | 校验内容 |
|--------|---------|
| **Tool Runner** | `tool.requiredFeatures` |
| **Workflow Engine** | `workflow.requiredFeatures` |
| **Role Router** | 角色可用性受 entitlements 限制 |
| **UI Host** | 提示与降级（非硬门禁） |

---

## 十一、业务域架构（Domain Map）

### 11.1 域分类

```
┌─────────────────────────────────────────────────────────────┐
│                       业务域架构                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   商业域（Business）                                         │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐                   │
│   │ Service  │ │  Quote   │ │   CRM    │                   │
│   │ 服务管理  │ │ 报价管理  │ │ 客户管理  │                   │
│   └──────────┘ └──────────┘ └──────────┘                   │
│   ┌──────────┐ ┌──────────┐                                │
│   │ Project  │ │ Finance  │                                │
│   │ 项目管理  │ │ 财务管理  │                                │
│   └──────────┘ └──────────┘                                │
│                                                             │
│   组织域（Org）                                              │
│   ┌──────────┐ ┌──────────┐ ┌──────────┐                   │
│   │   Org    │ │    HR    │ │  Access  │                   │
│   │ 组织管理  │ │ 员工管理  │ │ 权限安全  │                   │
│   └──────────┘ └──────────┘ └──────────┘                   │
│                                                             │
│   内容域（Content）                                          │
│   ┌──────────┐                                             │
│   │   CMS    │                                             │
│   │ 官网管理  │                                             │
│   └──────────┘                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 11.2 域接入规范

每个域必须以 Plugin 方式接入平台层：

```typescript
interface DomainPlugin {
  domainId: string;
  name: string;
  
  // 注册 Tools
  tools: ToolDefinition[];
  
  // 注册 Workflows
  workflows: WorkflowDefinition[];
  
  // 注册角色
  roles: RoleDefinition[];
  
  // 数据模型
  entities: EntityDefinition[];
  repos: RepoDefinition[];
  
  // 初始化
  setup: (platform: Platform) => Promise<void>;
}
```

### 11.3 域隔离规则

| 规则 | 说明 |
|------|------|
| **禁止跨域直连** | 域间通信必须通过 Tool |
| **禁止共享 Repo** | 每个域独立数据访问 |
| **允许共享 Schema** | 通过 `shared` 包 |
| **允许跨域 Workflow** | 通过 Tool 组合 |

---

## 十二、部署架构与租户模式

### 12.1 架构总览：Control Plane / Tenant Plane

dhs-atlas 采用**平台中枢 + 可选独立部署**的架构模式，同时支持：

1. **Shared Multi-tenant**（标准 SaaS）：一套系统，多企业隔离
2. **Dedicated Tenant**（独立部署）：每客户一套独立运行实例

```
┌─────────────────────────────────────────────────────────────────────┐
│                      dhs-atlas 部署架构                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    Control Plane（平台中枢）                    │ │
│  │                                                               │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │ │
│  │  │ Entitlements │ │   Billing    │ │  Licensing   │          │ │
│  │  │  订阅/功能开关  │ │   支付/计费   │ │   许可/授权   │          │ │
│  │  └──────────────┘ └──────────────┘ └──────────────┘          │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │ │
│  │  │  AI Gateway  │ │ Provisioning │ │ Global Audit │          │ │
│  │  │   AI 调用网关  │ │  租户编排/部署 │ │  全局审计/风控 │          │ │
│  │  └──────────────┘ └──────────────┘ └──────────────┘          │ │
│  │  ┌──────────────┐ ┌──────────────┐                           │ │
│  │  │Tool/Model Gov│ │Platform Admin│                           │ │
│  │  │ 工具/模型治理  │ │   平台后台    │                           │ │
│  │  └──────────────┘ └──────────────┘                           │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                  │                                  │
│              ┌───────────────────┼───────────────────┐              │
│              │                   │                   │              │
│              ▼                   ▼                   ▼              │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │
│  │  Tenant Plane   │ │  Tenant Plane   │ │  Tenant Plane   │       │
│  │    (Shared)     │ │   (Dedicated)   │ │   (Dedicated)   │       │
│  │                 │ │                 │ │                 │       │
│  │ ┌─────────────┐ │ │ ┌─────────────┐ │ │ ┌─────────────┐ │       │
│  │ │ Enterprise A│ │ │ │ Enterprise C│ │ │ │ Enterprise D│ │       │
│  │ │ Enterprise B│ │ │ │  (独立实例)   │ │ │  (独立实例)   │ │       │
│  │ │ Enterprise …│ │ │ └─────────────┘ │ │ └─────────────┘ │       │
│  │ └─────────────┘ │ │                 │ │                 │       │
│  │                 │ │ • 独立 DB       │ │ • 独立 DB       │       │
│  │ • 共享 DB       │ │ • 独立存储      │ │ • 独立存储      │       │
│  │ • 共享存储      │ │ • 独立域名      │ │ • 独立域名      │       │
│  │ • 共享资源      │ │ • 物理隔离      │ │ • 物理隔离      │       │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 12.2 两种租户形态

#### A. Shared Multi-tenant（标准 SaaS）

| 特点 | 说明 |
|------|------|
| **部署方式** | 一套系统，多企业逻辑隔离 |
| **隔离机制** | enterpriseId + entitlements + policy |
| **成本** | 最低 |
| **迭代** | 最快 |
| **适用客户** | 绝大多数客户 |

#### B. Dedicated Tenant（独立部署）

| 特点 | 说明 |
|------|------|
| **部署方式** | 每客户一套独立运行的 dhs-atlas |
| **域名** | 独立二级域名（可绑自有域名） |
| **数据隔离** | DB / 缓存 / 队列 / 存储 / 密钥物理隔离 |
| **平台联邦** | 统一的 AI 网关、授权、订阅、支付、工具治理 |
| **适用客户** | 高客单 / 政企 / 强合规需求 |

**关键结论**：

> Dedicated 不是"脱离平台"，而是"**运行时独立 + 平台能力联邦**"。

### 12.3 Control Plane 组件

Control Plane 负责平台级能力，与具体租户业务无关：

| 组件 | 职责 |
|------|------|
| **Entitlements** | 订阅与功能开关 |
| **Billing** | 支付与计费 |
| **Licensing** | 许可与授权（Token/License） |
| **AI Gateway** | AI 调用网关（路由/配额/计量/审计） |
| **Provisioning** | 租户编排与自动部署 |
| **Global Audit** | 全局审计与风控 |
| **Tool/Model Governance** | 工具/模型治理与版本管理 |
| **Platform Admin** | 平台管理后台 |

### 12.4 Tenant Plane 组件

每个租户实例（无论 Shared 还是 Dedicated）包含：

| 组件 | 说明 |
|------|------|
| **业务域** | 服务/报价/客户/财务/项目/官网/组织/员工 |
| **AI OS 内核** | Tool/Workflow/Role/UI Host/Event/Artifact |
| **数据存储** | 数据库/对象存储/队列（隔离级别取决于部署模式） |
| **Tenant Console** | 租户管理控制台 |

### 12.5 Dedicated 核心难点与解决方案

#### 难点 1：订阅/权限如何让租户实例"听平台的"

**解决方案**：许可证与能力快照下发

```typescript
interface EntitlementSnapshot {
  enterpriseId: string;
  
  // 订阅信息
  planId: string;
  status: 'active' | 'trial' | 'expired';
  expiresAt: Date;
  
  // 功能点
  features: FeatureGrant[];
  
  // 签名（防篡改）
  signature: string;
  issuedAt: Date;
  ttl: number;                        // 短 TTL + 强缓存
}
```

**工作流程**：

```
Control Plane                    Tenant Instance
      │                                │
      │  1. 生成 entitlement_snapshot  │
      │  ─────────────────────────────►│
      │                                │
      │                   2. 本地缓存 + 定期刷新
      │                                │
      │       3. Tool Runner 执行前校验
      │                                │
      │  4. 到期/降级立即生效（短 TTL）  │
      │◄─────────────────────────────  │
```

> 即使租户实例断网，也不会无限制使用付费能力（可设置 grace policy）。

#### 难点 2：AI 调用如何集中但不泄露数据

**解决方案**：AI Gateway 作为平台服务

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    Tenant    │────►│  AI Gateway  │────►│    Model     │
│   Instance   │     │  (Platform)  │     │   Provider   │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │  • 模型路由   │
                     │  • 配额管理   │
                     │  • 成本计量   │
                     │  • 审计日志   │
                     │  • 脱敏策略   │
                     └──────────────┘
```

**原则**：
- Tenant 只上传"最小必要上下文"（可配置）
- 支持 BYOK / BYO Model（大客户自带 Key 或自部署模型）

#### 难点 3：自动部署与升级

**解决方案**：从 Day 1 按"可批量运维"设计

| 策略 | 说明 |
|------|------|
| **同一镜像** | 所有租户实例使用同一镜像 + 配置注入 |
| **版本通道** | GitOps: stable / canary |
| **灰度升级** | 平台控制升级节奏与灰度比例 |
| **延迟窗口** | 租户可选"延迟升级窗口"（企业常见需求） |

#### 难点 4：域名与自有域绑定

| 阶段 | 能力 |
|------|------|
| **注册即分配** | `{tenantSlug}.yourdomain.com` |
| **后续支持** | CNAME 绑定自有域（校验 + 证书） |
| **实现方式** | 统一网关层（反向代理/ingress）+ ACME 自动证书 |

### 12.6 Dedicated 分级方案

避免上来就"每租户一套全家桶"，采用分级策略：

```
┌─────────────────────────────────────────────────────────────┐
│                    Dedicated 分级方案                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  L1: 共享应用 + 独立数据库                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ┌───────────┐     ┌───────────┐                    │   │
│  │  │   App     │────►│  DB (A)   │  每租户一个 DB      │   │
│  │  │  (Shared) │────►│  DB (B)   │  成本低、迁移简单   │   │
│  │  │           │────►│  DB (C)   │                    │   │
│  │  └───────────┘     └───────────┘                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  L2: 共享集群 + 独立命名空间                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  K8s Cluster                                        │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │ Namespace A │ │ Namespace B │ │ Namespace C │   │   │
│  │  │  App + DB   │ │  App + DB   │ │  App + DB   │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  L3: 完全独立部署                                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │ Instance A  │ │ Instance B  │ │ Instance C  │   │   │
│  │  │ App+DB+Store│ │ App+DB+Store│ │ App+DB+Store│   │   │
│  │  │ +Queue+…    │ │ +Queue+…    │ │ +Queue+…    │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| 级别 | 隔离程度 | 成本 | 适用场景 |
|------|---------|------|---------|
| **L1** | 数据隔离 | 低 | 大多数"要隔离"的企业客户 |
| **L2** | 资源隔离 | 中 | 需要资源保障的客户 |
| **L3** | 完全隔离 | 高 | 政企/极高客单/强合规客户 |

**产品路线建议**：先支持 L1/L2，把 L3 做成"高级套餐"。

### 12.7 两后台体系

| 后台 | 位置 | 职责 |
|------|------|------|
| **Tenant Console** | Tenant Plane | 租户业务管理 |
| **Platform Console** | Control Plane | 租户开通、形态选择、域名分配、订阅配额、升级、封禁、审计 |

### 12.8 当前阶段策略

**核心原则**：

> 先把产品按 **Shared Multi-tenant** 交付（迭代快），但底座设计必须允许将某个企业"迁移/新建为 Dedicated"。

**演进路径**：

| 阶段 | 策略 |
|------|------|
| **早期** | 默认 Shared，多企业隔离、订阅门禁、审计体系先跑通 |
| **中期** | 推出 Dedicated 作为高阶付费套餐（安全/合规/性能） |
| **技术上** | 两种形态共用同一套 Tool/Workflow/UI Protocol + Entitlements + Audit |

**Day 1 必须预埋的能力**：

| 预埋点 | 说明 |
|--------|------|
| **Entitlements 平台化** | 租户实例只消费快照，不自行管理订阅 |
| **AI Gateway 独立** | 未来 Dedicated 也复用 |
| **enterprise scope 清晰** | 所有对象都必须绑定，才能迁移 |
| **资源抽象层** | DB/对象存储/队列不能写死实现 |

**决策原则**：

> 现在把 Dedicated 当成"**架构能力**"，不要当成"**首发交付**"。

---

## 十三、实施路线图

### Phase 0：平台内核（必须先做）

| 任务 | 产出 |
|------|------|
| 四大协议 types + schemas | `packages/shared/schemas/` |
| Tool/UI/Workflow/Role Registry | `packages/ai-*/registry/` |
| Multi-tenant baseline | `packages/platform/multi-tenant/` |
| Entitlements baseline（平台服务化） | `packages/platform/entitlements/` |
| AI Gateway baseline | `packages/platform/ai-gateway/` |
| EventLog + Artifact Store | `packages/platform/event-log/`, `artifact/` |
| 资源抽象层（DB/Storage/Queue） | `packages/platform/resources/` |

### Phase 1：全域横向闭环 MVP（Shared 模式）

**目标**：验证 OS 级能力，而不是堆业务

**示例流程**：

```
创建服务 → 生成报价 → 创建项目 → 生成应收账单
    │           │           │           │
    ▼           ▼           ▼           ▼
svc.service  qt.quote   proj.project  fin.invoice
  .create     .create     .create      .create
```

**每一步都是**：
- Tool + Workflow + UI 原语 + Gate + Audit

### Phase 2：扩展域插件 + Control Plane

**域扩展**：逐域补齐子模块与高级能力，保持平台层不变。

| 域 | 核心模块 |
|------|---------|
| Service | 服务目录、定价、分类 |
| Quote | 报价单、模板、审批 |
| CRM | 客户、联系人、跟进 |
| Project | 项目、任务、里程碑 |
| Finance | 发票、收款、报表 |
| CMS | 页面、模板、发布 |
| Org | 组织结构、部门 |
| HR | 员工、考勤、薪资 |

**Control Plane 基础**：

| 任务 | 说明 |
|------|------|
| Platform Console | 平台管理后台 |
| Entitlement Snapshot 下发 | 支持 Dedicated 模式 |
| Provisioning 接口 | 租户编排能力预留 |

### Phase 3：Dedicated 模式（高阶套餐）

| 任务 | 说明 |
|------|------|
| L1 支持 | 共享应用 + 独立数据库 |
| L2 支持 | 共享集群 + 独立命名空间 |
| 域名管理 | 二级域名分配 + 自有域绑定 |
| 自动部署 | GitOps + 版本通道 |

### Phase 4：完全独立部署（L3）

| 任务 | 说明 |
|------|------|
| 完全独立部署 | App + DB + Store + Queue |
| BYOK/BYO Model | 大客户自带 Key/模型 |
| 延迟升级窗口 | 企业级升级控制 |

---

## 附录 A：协议版本规划

| 协议 | 当前版本 | 下一版本规划 |
|------|---------|-------------|
| Tool Protocol | v1.0 | v1.1: 批量执行支持 |
| UI Protocol | v1.0 | v1.1: 更多原语 |
| Workflow Protocol | v1.0 | v1.1: 并行分支 |
| Event Protocol | v1.0 | v1.1: 事件订阅 |

---

## 附录 B：关键决策记录

| 决策 | 原因 |
|------|------|
| **Tool 作为唯一执行入口** | 统一能力通道，便于审计和门禁 |
| **AI 不生成 UI** | 防止 AI 产生不可控的 UI 结构 |
| **Workflow 状态机** | 约束 AI 行为在可控轨道内 |
| **三层门禁** | 多层防护，防止绕过 |
| **单企业先行** | 降低用户认知负担，但架构不妥协 |
| **Control Plane / Tenant Plane 分离** | 支持 Shared + Dedicated 两种部署模式 |
| **Entitlements 平台服务化** | Dedicated 实例通过快照消费，不自行管理 |
| **AI Gateway 独立** | 集中管理 AI 调用，支持配额/计量/审计 |
| **Dedicated 分级（L1/L2/L3）** | 避免过早引入 L3 复杂度 |
| **Dedicated 作为架构能力而非首发** | 优先跑通 Shared 模式，预埋 Dedicated 能力 |

---

## 附录 C：资源抽象层接口

为支持 Dedicated 模式，所有资源访问必须通过抽象层：

```typescript
// 数据库抽象
interface DatabaseProvider {
  getConnection(enterpriseId: string): Connection;
  migrate(enterpriseId: string): Promise<void>;
}

// 对象存储抽象
interface StorageProvider {
  getBucket(enterpriseId: string): Bucket;
  upload(enterpriseId: string, key: string, data: Buffer): Promise<string>;
  download(enterpriseId: string, key: string): Promise<Buffer>;
}

// 队列抽象
interface QueueProvider {
  getQueue(enterpriseId: string, queueName: string): Queue;
  publish(enterpriseId: string, queueName: string, message: unknown): Promise<void>;
  subscribe(enterpriseId: string, queueName: string, handler: Handler): void;
}

// 缓存抽象
interface CacheProvider {
  getNamespace(enterpriseId: string): CacheNamespace;
  get(enterpriseId: string, key: string): Promise<unknown>;
  set(enterpriseId: string, key: string, value: unknown, ttl?: number): Promise<void>;
}
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |
| v1.1 | 2025-12-28 | 新增部署架构与租户模式章节 |

---

**相关文档**：
- [dhs-atlas 项目计划文档](../dhs-atlas项目计划文档.md)
- [代码质量标准化体系](../代码质量标准化体系.md)
- [开发伦理与系统操作宪章](../开发伦理与系统操作宪章-最高指示.md)
- [AI 原生架构升级规划](../AI原生架构升级规划.md)

