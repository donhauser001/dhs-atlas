# dhs-atlas 租户模式定义（Tenancy Modes）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 架构宪章  
> **相关文档**: [总体架构设计](./总体架构设计.md) · [租户开通工作流](./租户开通工作流.md)

---

## 一、概述

### 1.1 核心定位

dhs-atlas 采用**平台托管的部署化租户**（Hosted Dedicated Tenancy）模式：

- 租户可选择不同的隔离等级
- 所有租户实例都部署在**我们的平台基础设施**上
- **不允许租户自建服务器/自托管**
- 租户可绑定自有域名（CNAME）

### 1.2 设计原则

| 原则 | 说明 |
|------|------|
| **平台掌控** | 版本一致性、安全基线、运维标准由平台统一管理 |
| **隔离分级** | 提供多种隔离等级，满足不同客户需求与预算 |
| **可规模化** | Dedicated 必须可批量运维，不能拖死团队 |
| **统一门禁** | 无论哪种模式，订阅/权限/AI 调用都走平台服务 |

---

## 二、租户部署形态

### 2.1 形态总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                       租户部署形态                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Shared Multi-tenant（共享部署）                              │   │
│  │                                                             │   │
│  │  ┌───────────────────────────────────────────────────────┐ │   │
│  │  │                    共享应用实例                         │ │   │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │ │   │
│  │  │  │  Ent A  │ │  Ent B  │ │  Ent C  │ │  Ent …  │     │ │   │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘     │ │   │
│  │  └───────────────────────────────────────────────────────┘ │   │
│  │  ┌───────────────────────────────────────────────────────┐ │   │
│  │  │                    共享数据库                           │ │   │
│  │  │  enterpriseId 逻辑隔离                                 │ │   │
│  │  └───────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  D1: Dedicated - 独立数据库                                  │   │
│  │                                                             │   │
│  │  ┌───────────────────────────────────────────────────────┐ │   │
│  │  │                    共享应用实例                         │ │   │
│  │  └───────────────────────────────────────────────────────┘ │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                      │   │
│  │  │  DB A   │ │  DB B   │ │  DB C   │  每租户独立 DB        │   │
│  │  └─────────┘ └─────────┘ └─────────┘                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  D2: Dedicated - 独立实例                                    │   │
│  │                                                             │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │   │
│  │  │  Instance A │ │  Instance B │ │  Instance C │           │   │
│  │  │  App + DB   │ │  App + DB   │ │  App + DB   │           │   │
│  │  │  + Storage  │ │  + Storage  │ │  + Storage  │           │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘           │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 Shared Multi-tenant（共享部署）

**定义**：同一套应用与运行时，多企业逻辑隔离（enterprise scope）

| 维度 | 说明 |
|------|------|
| **应用** | 共享 |
| **数据库** | 共享（enterpriseId 隔离） |
| **对象存储** | 共享（路径隔离） |
| **队列** | 共享 |
| **域名** | 共享域名下的路径/子路径 |
| **成本** | 最低 |
| **迭代** | 最快 |
| **适用客户** | 中小企业、个人、试用 |

**数据隔离实现**：

```typescript
// 所有查询必须携带 enterpriseId
const customers = await db.customer.findMany({
  where: { enterpriseId: context.enterpriseId }
});
```

### 2.3 D1: Dedicated - 独立数据库

**定义**：应用共享或专属，但数据库独立

| 维度 | 说明 |
|------|------|
| **应用** | 可共享或专属 |
| **数据库** | **独立**（每租户一个 DB） |
| **对象存储** | 可共享（桶隔离）或独立 |
| **队列** | 可共享（topic 隔离） |
| **域名** | 二级域名 `{slug}.domain.com` |
| **成本** | 中等 |
| **运维复杂度** | 可接受 |
| **适用客户** | 中大型企业、需要数据隔离保证 |

**优势**：
- 数据物理隔离，安全性显著提升
- 数据库级备份与恢复
- 性能隔离（一定程度）
- 成本可控

**实现要点**：

```typescript
// 资源抽象层根据租户获取连接
const connection = await databaseProvider.getConnection(tenantId);

// 查询时不再需要 where enterpriseId（整个 DB 都是这个租户的）
const customers = await connection.customer.findMany();
```

### 2.4 D2: Dedicated - 独立实例

**定义**：每租户一套独立的应用 + 数据库（可选独立存储/队列）

| 维度 | 说明 |
|------|------|
| **应用** | **独立** |
| **数据库** | **独立** |
| **对象存储** | **独立**（推荐） |
| **队列** | **独立**（推荐） |
| **域名** | 二级域名 + 可绑定自有域 |
| **成本** | 高 |
| **运维复杂度** | 高（必须自动化） |
| **适用客户** | 大型企业、政企、强合规需求 |

**优势**：
- 完全物理隔离
- 爆炸半径最小
- 可定制化配置（资源规格）
- 可提供更强 SLA

---

## 三、隔离边界对比

### 3.1 详细对比表

| 维度 | Shared | D1 | D2 |
|------|--------|----|----|
| **应用进程** | 共享 | 可选 | 独立 |
| **数据库** | 共享 | 独立 | 独立 |
| **数据库连接池** | 共享 | 独立 | 独立 |
| **对象存储** | 共享桶 | 独立桶 | 独立存储账号 |
| **队列** | 共享 Topic | 独立 Topic | 独立队列实例 |
| **缓存** | 共享（前缀隔离） | 独立命名空间 | 独立实例 |
| **密钥/凭证** | 共享 + 租户级加密 | 独立密钥 | 独立密钥库 |
| **网络** | 共享 | 共享/可选隔离 | 可选 VPC |
| **域名** | 路径/子路径 | 二级域名 | 二级域名 + 自有域 |
| **证书** | 平台统一 | 平台托管 | 平台托管 + 自有证书 |
| **备份** | 统一策略 | 独立策略 | 独立策略 + 自定义 |
| **监控** | 聚合 | 独立面板 | 独立面板 + 可导出 |

### 3.2 安全边界

```
┌─────────────────────────────────────────────────────────────┐
│                        安全边界                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Shared:                                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  应用层隔离（enterpriseId）                           │   │
│  │  • 代码逻辑保证                                       │   │
│  │  • 依赖正确实现                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  D1:                                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  数据库层隔离                                         │   │
│  │  • 连接级隔离                                         │   │
│  │  • 无法跨 DB 访问                                     │   │
│  │  • 即使应用 Bug 也无法泄露其他租户数据                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  D2:                                                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  进程/实例级隔离                                      │   │
│  │  • 完全独立运行时                                     │   │
│  │  • 资源完全隔离                                       │   │
│  │  • 即使实例被攻破也不影响其他租户                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、产品套餐建议

### 4.1 套餐映射

| 套餐 | 部署模式 | 目标客户 |
|------|---------|---------|
| **Free** | Shared | 试用、个人 |
| **Pro** | Shared | 中小企业 |
| **Business** | D1 | 中大型企业 |
| **Enterprise** | D2 | 大型企业、政企 |

### 4.2 套餐能力矩阵

| 能力 | Free | Pro | Business | Enterprise |
|------|------|-----|----------|------------|
| 基础功能 | 有限 | 完整 | 完整 | 完整 + 高级 |
| 数据隔离 | 逻辑 | 逻辑 | 物理（DB） | 完全物理 |
| 自有域名 | - | - | 可选 | 包含 |
| SLA | - | 99.5% | 99.9% | 99.95% |
| 数据导出 | - | 标准 | 完整 | 完整 + 审计 |
| 专属支持 | - | - | 工单优先 | 专属客户经理 |
| 合规报告 | - | - | 按需 | 定期 |

---

## 五、平台承诺与租户权责

### 5.1 平台承诺

**所有模式通用**：

| 承诺 | 说明 |
|------|------|
| **版本一致性** | 所有租户运行经过验证的统一版本 |
| **安全基线** | 统一的密钥管理、网络策略、访问控制 |
| **升级可控** | 平台控制升级节奏，支持灰度与回滚 |
| **门禁一致** | AI 网关、订阅门禁、支付系统统一集成 |

**Dedicated 额外承诺（D1/D2）**：

| 承诺 | 说明 |
|------|------|
| **数据备份** | 独立备份策略，可配置 RPO/RTO |
| **高可用** | 独立故障隔离，其他租户故障不影响 |
| **性能保障** | 独立资源，不受邻居影响 |
| **合规支持** | 独立审计日志，可导出 |

### 5.2 租户权责

**租户拥有**：

| 权利 | 说明 |
|------|------|
| **数据所有权** | 租户数据归租户所有 |
| **域名入口** | 可绑定自有域名 |
| **数据导出** | 可导出自己的数据 |
| **审计访问** | 可查看自己的审计日志 |

**租户限制**：

| 限制 | 说明 |
|------|------|
| **不可自托管** | 不允许自建服务器部署 |
| **不可修改代码** | 不允许定制应用代码 |
| **不可绕过门禁** | 必须通过平台订阅/权限体系 |
| **不可直连模型** | AI 调用必须走平台网关（除非 BYOK） |

---

## 六、域名策略

### 6.1 二级域名分配

**分配规则**：

```
{tenantSlug}.yourdomain.com
```

| 规则 | 说明 |
|------|------|
| **唯一性** | slug 全局唯一 |
| **格式** | 小写字母、数字、连字符，3-32 字符 |
| **保留词** | 禁止使用 `www`、`api`、`admin`、`platform` 等 |
| **重命名** | 支持，旧域名保留 alias 30 天 |

### 6.2 自有域名绑定

**绑定流程**：

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   租户提交    │────►│   DNS 验证   │────►│   证书签发   │
│   域名申请    │     │   TXT 记录   │     │   自动化     │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐     ┌──────────────┐
                     │   CNAME 配置 │────►│   路由绑定   │
                     │   验证通过   │     │   生效       │
                     └──────────────┘     └──────────────┘
```

**配置要求**：

```
# 租户需要配置的 DNS 记录

# 1. 验证记录（TXT）
_dhs-verify.custom.example.com  TXT  "verify=abc123..."

# 2. 指向记录（CNAME）
custom.example.com  CNAME  {tenantSlug}.yourdomain.com
```

**限制**：

| 限制 | 说明 |
|------|------|
| **套餐限制** | Business 及以上可用 |
| **数量限制** | 每租户最多绑定 5 个自有域 |
| **验证有效期** | 验证记录需持续存在 |
| **证书** | 平台自动签发 Let's Encrypt 证书 |

---

## 七、订阅与门禁在不同模式下的实现

### 7.1 Shared 模式

```typescript
// 直接查询 Entitlements Service
const entitlements = await entitlementsService.get(enterpriseId);

// Tool Runner 执行前校验
if (!entitlements.hasFeature(tool.requiredFeatures)) {
  throw new FeatureNotEnabledError();
}
```

### 7.2 Dedicated 模式（D1/D2）

```typescript
// 从本地缓存获取签名快照
const snapshot = await entitlementCache.getSnapshot(tenantId);

// 验证签名
if (!verifySignature(snapshot)) {
  throw new InvalidSnapshotError();
}

// 检查 TTL
if (isExpired(snapshot)) {
  // 尝试刷新
  const newSnapshot = await refreshSnapshot(tenantId);
  if (!newSnapshot) {
    // 进入降级模式
    enterGraceMode();
  }
}

// Tool Runner 执行前校验
if (!snapshot.hasFeature(tool.requiredFeatures)) {
  throw new FeatureNotEnabledError();
}
```

### 7.3 Entitlement Snapshot 结构

```typescript
interface EntitlementSnapshot {
  // 标识
  tenantId: string;
  enterpriseId: string;
  
  // 订阅信息
  planId: string;
  status: 'active' | 'trial' | 'grace' | 'expired';
  
  // 有效期
  validFrom: Date;
  validUntil: Date;
  
  // 功能点
  features: {
    featureKey: string;
    enabled: boolean;
    quota?: {
      limit: number;
      used: number;
      period: string;
    };
  }[];
  
  // 签名（防篡改）
  signature: string;
  issuedAt: Date;
  
  // TTL（建议 5-15 分钟）
  ttl: number;
}
```

---

## 八、AI 调用在不同模式下的路由

### 8.1 统一通过 AI Gateway

无论哪种部署模式，AI 调用都必须通过平台 AI Gateway：

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│    Tenant    │────►│  AI Gateway  │────►│    Model     │
│   Instance   │     │  (Platform)  │     │   Provider   │
└──────────────┘     └──────────────┘     └──────────────┘
```

### 8.2 Gateway 职责

| 职责 | 说明 |
|------|------|
| **模型路由** | 根据请求类型选择最优模型 |
| **配额管理** | 按租户/套餐限制调用量 |
| **成本计量** | 记录 token 消耗，用于计费 |
| **审计记录** | 所有调用留痕 |
| **脱敏策略** | 可选的上下文脱敏 |
| **风控策略** | 检测异常调用模式 |

### 8.3 BYOK（Bring Your Own Key）

Enterprise 套餐可选：

```typescript
interface BYOKConfig {
  tenantId: string;
  provider: 'openai' | 'anthropic' | 'azure' | 'custom';
  
  // 加密存储的密钥
  encryptedApiKey: string;
  
  // 路由规则
  routeAllRequests: boolean;      // 所有请求都走自有 Key
  routeByModel?: string[];        // 指定模型走自有 Key
}
```

---

## 九、运维约束

### 9.1 版本管理

| 约束 | 说明 |
|------|------|
| **同一镜像** | 所有租户使用同一应用镜像 |
| **配置注入** | 差异通过配置/环境变量注入 |
| **版本通道** | stable / canary / beta |
| **升级窗口** | Enterprise 可配置延迟升级窗口 |

### 9.2 监控与告警

| 模式 | 监控策略 |
|------|---------|
| **Shared** | 聚合监控 + 按 enterpriseId 分组 |
| **D1** | 按租户独立 DB 监控面板 |
| **D2** | 完全独立监控面板 + 可导出 |

### 9.3 备份策略

| 模式 | 备份策略 |
|------|---------|
| **Shared** | 统一备份，按需恢复到新 enterprise |
| **D1** | 独立 DB 备份，可按租户恢复 |
| **D2** | 完全独立备份策略，可自定义 RPO/RTO |

---

## 十、迁移路径

### 10.1 Shared → D1

```
1. 创建独立 DB
2. 导出租户数据（按 enterpriseId）
3. 导入到独立 DB
4. 切换连接配置
5. 验证数据完整性
6. 更新 DNS/路由
7. 清理旧数据
```

### 10.2 D1 → D2

```
1. 创建独立实例
2. 配置独立资源（存储/队列/缓存）
3. 迁移数据库
4. 同步配置
5. 切换流量
6. 验证功能
7. 下线旧连接
```

### 10.3 迁移约束

| 约束 | 说明 |
|------|------|
| **只能升级** | Shared → D1 → D2，不支持降级 |
| **停机窗口** | 迁移需要短暂停机（计划维护窗口） |
| **数据验证** | 迁移后必须验证数据完整性 |
| **回滚预案** | 必须保留回滚能力 |

---

## 附录 A：数据模型

### A.1 Tenant 实体

```typescript
interface Tenant {
  id: string;
  
  // 基础信息
  name: string;
  slug: string;                      // 全局唯一
  
  // 部署模式
  deploymentMode: 'shared' | 'd1' | 'd2';
  
  // 资源配置
  resources: {
    databaseId?: string;             // D1/D2: 独立 DB ID
    instanceId?: string;             // D2: 独立实例 ID
    storageId?: string;              // 独立存储 ID
    queueId?: string;                // 独立队列 ID
  };
  
  // 域名
  domains: {
    primary: string;                 // {slug}.yourdomain.com
    custom: string[];                // 自有域名
  };
  
  // 订阅
  subscriptionId: string;
  
  // 状态
  status: 'provisioning' | 'active' | 'suspended' | 'deleted';
  
  // 时间
  createdAt: Date;
  updatedAt: Date;
}
```

### A.2 Enterprise 与 Tenant 关系

```
Tenant (1) ──────────────── (1) Enterprise (in Shared)
Tenant (1) ──────────────── (1) Enterprise (in D1/D2)
```

> 在当前设计中，一个 Tenant 对应一个 Enterprise。未来可扩展为一个 Tenant 包含多个 Enterprise。

---

## 附录 B：配置示例

### B.1 Shared 租户配置

```yaml
tenant:
  id: "tenant-001"
  deploymentMode: "shared"
  resources:
    database: "shared-main"
    storage: "shared-bucket"
  domains:
    primary: "acme.dhs-atlas.com"
```

### B.2 D1 租户配置

```yaml
tenant:
  id: "tenant-002"
  deploymentMode: "d1"
  resources:
    database: "tenant-002-db"        # 独立 DB
    storage: "shared-bucket/tenant-002"
  domains:
    primary: "bigcorp.dhs-atlas.com"
    custom:
      - "erp.bigcorp.com"
```

### B.3 D2 租户配置

```yaml
tenant:
  id: "tenant-003"
  deploymentMode: "d2"
  resources:
    instance: "tenant-003-instance"  # 独立实例
    database: "tenant-003-db"
    storage: "tenant-003-storage"
    queue: "tenant-003-queue"
  domains:
    primary: "megacorp.dhs-atlas.com"
    custom:
      - "work.megacorp.com"
      - "internal.megacorp.cn"
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [总体架构设计](./总体架构设计.md)
- [租户开通工作流](./租户开通工作流.md)
- [代码质量标准化体系](../代码质量标准化体系.md)

