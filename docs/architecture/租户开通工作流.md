# dhs-atlas 租户开通工作流（Provisioning Workflow）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 架构宪章  
> **相关文档**: [总体架构设计](./总体架构设计.md) · [租户模式定义](./租户模式定义.md)

---

## 一、概述

### 1.1 设计原则

租户开通（Provisioning）是 **平台级工作流**，必须：

| 原则 | 说明 |
|------|------|
| **状态机驱动** | 每一步都是明确的状态，可追溯、可回滚 |
| **幂等设计** | 重试不会产生重复资源或副作用 |
| **事件溯源** | 所有状态变更写 Event Log |
| **可观测** | 平台后台可实时查看进度 |
| **自动化优先** | 减少人工介入，支持批量操作 |

### 1.2 工作流类型

| 类型 | 触发场景 |
|------|---------|
| **租户创建** | 新租户注册/开通 |
| **租户升级** | Shared → D1 → D2 |
| **租户续费** | 订阅续期 |
| **租户封禁** | 欠费/违规 |
| **租户销毁** | 主动注销/过期清理 |
| **域名绑定** | 自有域名配置 |
| **版本升级** | 应用版本更新 |

---

## 二、租户创建工作流

### 2.1 状态机定义

```
┌─────────────────────────────────────────────────────────────────────┐
│                      租户创建状态机                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐                                                     │
│   │ REQUESTED │  用户提交开通请求                                   │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │VALIDATING│  校验：套餐/支付/合规                                │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ├─────────────────┐                                        │
│         │                 │ 校验失败                                │
│         ▼                 ▼                                        │
│   ┌──────────┐      ┌──────────┐                                  │
│   │ALLOCATING│      │ REJECTED │  终态：拒绝                       │
│   └─────┬────┘      └──────────┘                                  │
│         │                                                           │
│         │ 分配资源（slug/db/storage）                               │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ DEPLOYING│  部署应用/迁移 Schema                               │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ SEEDING  │  初始化数据（default enterprise、管理员）            │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ ISSUING  │  域名绑定/证书签发                                  │
│   │  DOMAIN  │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │  READY   │  终态：可登录                                       │
│   └──────────┘                                                     │
│                                                                     │
│   任意步骤失败 ──────────────►  ┌──────────┐                       │
│                                 │  FAILED  │  可重试/回滚          │
│                                 └──────────┘                       │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 状态定义

```typescript
type ProvisioningState =
  | 'requested'      // 已请求
  | 'validating'     // 校验中
  | 'rejected'       // 已拒绝（终态）
  | 'allocating'     // 分配资源中
  | 'deploying'      // 部署中
  | 'seeding'        // 初始化数据中
  | 'issuing_domain' // 域名/证书处理中
  | 'ready'          // 就绪（终态）
  | 'failed';        // 失败（可重试）

interface ProvisioningSession {
  id: string;
  tenantId: string;
  
  // 状态
  state: ProvisioningState;
  stateHistory: StateTransition[];
  
  // 请求参数
  request: ProvisioningRequest;
  
  // 分配的资源
  allocatedResources: {
    slug?: string;
    databaseId?: string;
    storageId?: string;
    instanceId?: string;
    domainId?: string;
  };
  
  // 错误信息
  error?: {
    code: string;
    message: string;
    step: ProvisioningState;
    retryable: boolean;
  };
  
  // 时间
  requestedAt: Date;
  completedAt?: Date;
}
```

### 2.3 各状态详细处理

#### 2.3.1 REQUESTED（已请求）

**输入**：

```typescript
interface ProvisioningRequest {
  // 租户信息
  tenantName: string;
  preferredSlug?: string;
  
  // 部署模式
  deploymentMode: 'shared' | 'd1' | 'd2';
  
  // 订阅
  planId: string;
  paymentMethod?: string;
  
  // 管理员
  adminEmail: string;
  adminName: string;
  
  // 可选
  customDomain?: string;
  region?: string;
}
```

**处理**：
- 创建 ProvisioningSession
- 写入请求事件
- 转入 VALIDATING

#### 2.3.2 VALIDATING（校验中）

**校验项**：

| 校验项 | 说明 |
|--------|------|
| **套餐有效性** | planId 存在且可用 |
| **支付验证** | 付费套餐需验证支付方式 |
| **slug 可用性** | preferredSlug 未被占用 |
| **管理员唯一性** | adminEmail 未关联其他租户 |
| **合规检查** | 黑名单/风控检查 |
| **配额检查** | 平台租户数量限制 |

**成功** → ALLOCATING  
**失败** → REJECTED

#### 2.3.3 ALLOCATING（分配资源中）

**Shared 模式**：

```typescript
async function allocateShared(session: ProvisioningSession) {
  // 1. 生成 slug
  const slug = await generateUniqueSlug(session.request.preferredSlug);
  
  // 2. 创建 Tenant 记录
  const tenant = await createTenant({
    name: session.request.tenantName,
    slug,
    deploymentMode: 'shared',
    resources: {
      databaseId: 'shared-main',
      storageId: 'shared-bucket',
    },
  });
  
  // 3. 更新 session
  session.allocatedResources = { slug };
  
  return { tenantId: tenant.id };
}
```

**D1 模式**：

```typescript
async function allocateD1(session: ProvisioningSession) {
  // 1. 生成 slug
  const slug = await generateUniqueSlug(session.request.preferredSlug);
  
  // 2. 创建独立数据库
  const database = await databaseProvider.create({
    name: `tenant-${slug}`,
    region: session.request.region,
  });
  
  // 3. 分配存储空间
  const storagePath = `tenants/${slug}`;
  
  // 4. 创建 Tenant 记录
  const tenant = await createTenant({
    name: session.request.tenantName,
    slug,
    deploymentMode: 'd1',
    resources: {
      databaseId: database.id,
      storageId: storagePath,
    },
  });
  
  session.allocatedResources = {
    slug,
    databaseId: database.id,
    storageId: storagePath,
  };
  
  return { tenantId: tenant.id };
}
```

**D2 模式**：

```typescript
async function allocateD2(session: ProvisioningSession) {
  // 1. 生成 slug
  const slug = await generateUniqueSlug(session.request.preferredSlug);
  
  // 2. 创建独立实例
  const instance = await instanceProvider.create({
    name: `tenant-${slug}`,
    region: session.request.region,
    spec: getInstanceSpec(session.request.planId),
  });
  
  // 3. 创建独立数据库
  const database = await databaseProvider.create({
    name: `tenant-${slug}`,
    region: session.request.region,
    instanceId: instance.id,
  });
  
  // 4. 创建独立存储
  const storage = await storageProvider.createBucket({
    name: `tenant-${slug}`,
    region: session.request.region,
  });
  
  // 5. 创建独立队列
  const queue = await queueProvider.createNamespace({
    name: `tenant-${slug}`,
  });
  
  // 6. 创建 Tenant 记录
  const tenant = await createTenant({
    name: session.request.tenantName,
    slug,
    deploymentMode: 'd2',
    resources: {
      instanceId: instance.id,
      databaseId: database.id,
      storageId: storage.id,
      queueId: queue.id,
    },
  });
  
  session.allocatedResources = {
    slug,
    instanceId: instance.id,
    databaseId: database.id,
    storageId: storage.id,
  };
  
  return { tenantId: tenant.id };
}
```

#### 2.3.4 DEPLOYING（部署中）

**处理**：

```typescript
async function deploy(session: ProvisioningSession) {
  const { deploymentMode } = session.request;
  const { databaseId, instanceId } = session.allocatedResources;
  
  if (deploymentMode === 'shared') {
    // Shared: 无需额外部署
    return;
  }
  
  if (deploymentMode === 'd1') {
    // D1: 执行数据库迁移
    await runMigrations(databaseId);
    return;
  }
  
  if (deploymentMode === 'd2') {
    // D2: 部署应用到独立实例
    await deployApplication(instanceId, {
      image: getCurrentStableImage(),
      config: getTenantConfig(session.tenantId),
    });
    
    // 执行数据库迁移
    await runMigrations(databaseId);
    
    // 等待实例就绪
    await waitForInstanceReady(instanceId);
  }
}
```

#### 2.3.5 SEEDING（初始化数据中）

**处理**：

```typescript
async function seed(session: ProvisioningSession) {
  const connection = await getConnection(session.tenantId);
  
  // 1. 创建 default enterprise
  const enterprise = await connection.enterprise.create({
    id: generateId(),
    name: session.request.tenantName,
    slug: session.allocatedResources.slug,
    status: 'active',
  });
  
  // 2. 创建管理员用户
  const admin = await connection.user.create({
    id: generateId(),
    email: session.request.adminEmail,
    name: session.request.adminName,
    status: 'active',
  });
  
  // 3. 创建 membership
  await connection.membership.create({
    userId: admin.id,
    enterpriseId: enterprise.id,
    roles: ['owner', 'admin'],
    status: 'active',
  });
  
  // 4. 创建订阅记录
  await connection.subscription.create({
    enterpriseId: enterprise.id,
    planId: session.request.planId,
    status: 'active',
    startDate: new Date(),
  });
  
  // 5. 初始化 Entitlement Snapshot
  await issueEntitlementSnapshot(session.tenantId, enterprise.id);
  
  // 6. 发送欢迎邮件（异步）
  await queueWelcomeEmail(admin.email, {
    tenantName: session.request.tenantName,
    loginUrl: `https://${session.allocatedResources.slug}.yourdomain.com`,
  });
}
```

#### 2.3.6 ISSUING_DOMAIN（域名/证书处理中）

**处理**：

```typescript
async function issueDomain(session: ProvisioningSession) {
  const { slug, customDomain } = session.allocatedResources;
  
  // 1. 配置二级域名路由
  await routingService.addRoute({
    domain: `${slug}.yourdomain.com`,
    target: getTargetForTenant(session.tenantId),
  });
  
  // 2. 签发二级域名证书（通常通配符证书已覆盖）
  // *.yourdomain.com 已有证书，无需单独签发
  
  // 3. 如果有自定义域名
  if (session.request.customDomain) {
    // 标记为待验证，后续异步处理
    await customDomainService.initiate({
      tenantId: session.tenantId,
      domain: session.request.customDomain,
    });
  }
  
  // 4. 更新 Tenant 域名记录
  await updateTenantDomains(session.tenantId, {
    primary: `${slug}.yourdomain.com`,
  });
}
```

#### 2.3.7 READY（就绪）

**处理**：

```typescript
async function markReady(session: ProvisioningSession) {
  // 1. 更新 Tenant 状态
  await updateTenantStatus(session.tenantId, 'active');
  
  // 2. 写入完成事件
  await eventLog.write({
    type: 'tenant.provisioned',
    tenantId: session.tenantId,
    data: {
      deploymentMode: session.request.deploymentMode,
      slug: session.allocatedResources.slug,
      duration: Date.now() - session.requestedAt.getTime(),
    },
  });
  
  // 3. 通知管理员
  await notifyAdmin(session.request.adminEmail, {
    type: 'tenant_ready',
    loginUrl: `https://${session.allocatedResources.slug}.yourdomain.com`,
  });
  
  // 4. 更新 session
  session.state = 'ready';
  session.completedAt = new Date();
}
```

#### 2.3.8 FAILED（失败）

**处理**：

```typescript
async function handleFailure(
  session: ProvisioningSession,
  error: Error,
  step: ProvisioningState
) {
  // 1. 记录错误
  session.error = {
    code: getErrorCode(error),
    message: error.message,
    step,
    retryable: isRetryable(error),
  };
  
  // 2. 写入失败事件
  await eventLog.write({
    type: 'tenant.provisioning_failed',
    tenantId: session.tenantId,
    data: {
      error: session.error,
      allocatedResources: session.allocatedResources,
    },
  });
  
  // 3. 如果需要回滚
  if (shouldRollback(error)) {
    await rollback(session);
  }
  
  // 4. 通知运维
  await alertOps({
    type: 'provisioning_failed',
    session,
  });
}
```

### 2.4 回滚策略

```typescript
async function rollback(session: ProvisioningSession) {
  const { allocatedResources } = session;
  
  // 逆序清理已分配的资源
  const rollbackSteps = [
    // 域名
    () => allocatedResources.domainId && 
      routingService.removeRoute(allocatedResources.domainId),
    
    // 数据库
    () => allocatedResources.databaseId && 
      databaseProvider.delete(allocatedResources.databaseId),
    
    // 存储
    () => allocatedResources.storageId && 
      storageProvider.delete(allocatedResources.storageId),
    
    // 实例
    () => allocatedResources.instanceId && 
      instanceProvider.delete(allocatedResources.instanceId),
    
    // Tenant 记录
    () => session.tenantId && 
      deleteTenant(session.tenantId),
  ];
  
  for (const step of rollbackSteps) {
    try {
      await step();
    } catch (error) {
      // 记录回滚错误但继续
      await logRollbackError(session.id, error);
    }
  }
  
  // 标记为已回滚
  session.state = 'rolled_back';
}
```

---

## 三、域名绑定工作流

### 3.1 状态机定义

```
┌─────────────────────────────────────────────────────────────────────┐
│                      域名绑定状态机                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐                                                     │
│   │ INITIATED│  租户提交域名绑定请求                                │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ PENDING  │  等待 DNS 验证                                      │
│   │VALIDATION│  生成 TXT 记录要求                                   │
│   └─────┬────┘                                                     │
│         │                                                           │
│         │◄─────── 定期检查 DNS ───────┐                            │
│         │                              │                            │
│         ▼                              │                            │
│   ┌──────────┐                   ┌──────────┐                      │
│   │VALIDATING│  检测 TXT 记录 ──►│  FAILED  │  超时/失败            │
│   └─────┬────┘                   └──────────┘                      │
│         │                                                           │
│         │ 验证通过                                                   │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ ISSUING  │  签发证书（Let's Encrypt）                          │
│   │   CERT   │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │CONFIGURING│ 配置路由/绑定                                      │
│   │  ROUTING │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │  ACTIVE  │  终态：域名生效                                     │
│   └──────────┘                                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 状态定义

```typescript
type DomainBindingState =
  | 'initiated'          // 已发起
  | 'pending_validation' // 待验证
  | 'validating'         // 验证中
  | 'issuing_cert'       // 签发证书中
  | 'configuring_routing'// 配置路由中
  | 'active'             // 生效（终态）
  | 'failed';            // 失败（终态）

interface DomainBindingSession {
  id: string;
  tenantId: string;
  
  // 域名
  domain: string;
  
  // 状态
  state: DomainBindingState;
  
  // 验证信息
  validation: {
    txtRecord: string;           // 需要配置的 TXT 记录
    txtValue: string;            // TXT 记录值
    cnameTarget: string;         // CNAME 目标
    verifiedAt?: Date;
  };
  
  // 证书信息
  certificate?: {
    id: string;
    expiresAt: Date;
  };
  
  // 错误
  error?: {
    code: string;
    message: string;
  };
  
  // 时间
  initiatedAt: Date;
  completedAt?: Date;
}
```

### 3.3 验证记录生成

```typescript
async function initiateDomainBinding(
  tenantId: string,
  domain: string
): Promise<DomainBindingSession> {
  // 1. 校验域名格式
  if (!isValidDomain(domain)) {
    throw new InvalidDomainError(domain);
  }
  
  // 2. 检查域名是否已被使用
  const existing = await findDomainBinding(domain);
  if (existing) {
    throw new DomainAlreadyBoundError(domain);
  }
  
  // 3. 生成验证记录
  const verificationToken = generateSecureToken();
  
  const session: DomainBindingSession = {
    id: generateId(),
    tenantId,
    domain,
    state: 'pending_validation',
    validation: {
      txtRecord: `_dhs-verify.${domain}`,
      txtValue: `dhs-verify=${verificationToken}`,
      cnameTarget: `${getTenantSlug(tenantId)}.yourdomain.com`,
    },
    initiatedAt: new Date(),
  };
  
  await saveDomainBindingSession(session);
  
  // 4. 通知租户配置 DNS
  await notifyTenant(tenantId, {
    type: 'domain_verification_required',
    domain,
    instructions: {
      txtRecord: session.validation.txtRecord,
      txtValue: session.validation.txtValue,
      cnameTarget: session.validation.cnameTarget,
    },
  });
  
  return session;
}
```

### 3.4 DNS 验证

```typescript
async function verifyDomain(session: DomainBindingSession): Promise<boolean> {
  const { txtRecord, txtValue, cnameTarget } = session.validation;
  
  // 1. 查询 TXT 记录
  const txtRecords = await dns.resolveTxt(txtRecord);
  const txtMatches = txtRecords.some(r => r.includes(txtValue));
  
  if (!txtMatches) {
    return false;
  }
  
  // 2. 查询 CNAME 记录
  try {
    const cnameRecords = await dns.resolveCname(session.domain);
    const cnameMatches = cnameRecords.includes(cnameTarget);
    
    if (!cnameMatches) {
      return false;
    }
  } catch (error) {
    // CNAME 不存在
    return false;
  }
  
  // 3. 验证通过
  session.validation.verifiedAt = new Date();
  session.state = 'issuing_cert';
  await saveDomainBindingSession(session);
  
  return true;
}
```

### 3.5 证书签发

```typescript
async function issueCertificate(session: DomainBindingSession): Promise<void> {
  // 使用 Let's Encrypt / ACME
  const certificate = await acmeClient.requestCertificate({
    domain: session.domain,
    challengeType: 'http-01', // 或 dns-01
  });
  
  // 存储证书
  await certificateStore.save({
    id: certificate.id,
    domain: session.domain,
    certificate: certificate.cert,
    privateKey: certificate.key,
    expiresAt: certificate.expiresAt,
  });
  
  session.certificate = {
    id: certificate.id,
    expiresAt: certificate.expiresAt,
  };
  session.state = 'configuring_routing';
  
  await saveDomainBindingSession(session);
}
```

### 3.6 路由配置

```typescript
async function configureRouting(session: DomainBindingSession): Promise<void> {
  const tenant = await getTenant(session.tenantId);
  
  // 1. 添加路由规则
  await routingService.addRoute({
    domain: session.domain,
    target: getTargetForTenant(session.tenantId),
    certificateId: session.certificate!.id,
  });
  
  // 2. 更新租户域名列表
  await updateTenantDomains(session.tenantId, {
    custom: [...tenant.domains.custom, session.domain],
  });
  
  // 3. 标记完成
  session.state = 'active';
  session.completedAt = new Date();
  
  await saveDomainBindingSession(session);
  
  // 4. 写入事件
  await eventLog.write({
    type: 'domain.bound',
    tenantId: session.tenantId,
    data: {
      domain: session.domain,
      certificateId: session.certificate!.id,
    },
  });
}
```

---

## 四、租户升级工作流

### 4.1 状态机定义

```
┌─────────────────────────────────────────────────────────────────────┐
│                      租户升级状态机                                  │
│                    (Shared → D1 → D2)                               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐                                                     │
│   │ REQUESTED│  升级请求                                           │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │SCHEDULING│  安排维护窗口                                        │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ALLOCATING│  分配新资源                                         │
│   │   NEW    │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │MIGRATING │  数据迁移                                           │
│   │   DATA   │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │SWITCHING │  切换流量                                           │
│   │ TRAFFIC  │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │VERIFYING │  验证功能                                           │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ├─────────────────┐                                        │
│         │                 │ 验证失败                                │
│         ▼                 ▼                                        │
│   ┌──────────┐      ┌──────────┐                                  │
│   │ CLEANUP  │      │ ROLLBACK │                                  │
│   │   OLD    │      │          │                                  │
│   └─────┬────┘      └─────┬────┘                                  │
│         │                 │                                        │
│         ▼                 ▼                                        │
│   ┌──────────┐      ┌──────────┐                                  │
│   │ UPGRADED │      │ ROLLED   │                                  │
│   │          │      │   BACK   │                                  │
│   └──────────┘      └──────────┘                                  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.2 数据迁移策略

#### Shared → D1（迁移数据库）

```typescript
async function migrateSharedToD1(session: UpgradeSession): Promise<void> {
  const { tenantId, enterpriseId } = session;
  
  // 1. 创建新数据库
  const newDb = await databaseProvider.create({
    name: `tenant-${session.slug}`,
  });
  
  // 2. 运行迁移脚本
  await runMigrations(newDb.id);
  
  // 3. 导出租户数据
  const sharedConnection = await getSharedConnection();
  const tables = await getTableList();
  
  for (const table of tables) {
    // 按 enterpriseId 导出
    const data = await sharedConnection.query(
      `SELECT * FROM ${table} WHERE enterprise_id = $1`,
      [enterpriseId]
    );
    
    // 导入到新数据库
    const newConnection = await getConnection(newDb.id);
    await newConnection.batchInsert(table, data);
  }
  
  // 4. 验证数据完整性
  await verifyDataIntegrity(sharedConnection, newDb.id, enterpriseId);
  
  // 5. 更新租户资源配置
  await updateTenantResources(tenantId, {
    databaseId: newDb.id,
    deploymentMode: 'd1',
  });
}
```

#### D1 → D2（迁移到独立实例）

```typescript
async function migrateD1ToD2(session: UpgradeSession): Promise<void> {
  const { tenantId, slug } = session;
  
  // 1. 创建独立实例
  const instance = await instanceProvider.create({
    name: `tenant-${slug}`,
    spec: getInstanceSpec(session.planId),
  });
  
  // 2. 创建独立存储
  const storage = await storageProvider.createBucket({
    name: `tenant-${slug}`,
  });
  
  // 3. 创建独立队列
  const queue = await queueProvider.createNamespace({
    name: `tenant-${slug}`,
  });
  
  // 4. 部署应用
  await deployApplication(instance.id, {
    image: getCurrentStableImage(),
    config: getTenantConfig(tenantId),
  });
  
  // 5. 迁移数据库（如果需要）
  // D1 已有独立 DB，可选择保留或迁移到实例内 DB
  
  // 6. 迁移存储数据
  await migrateStorageData(
    session.oldResources.storageId,
    storage.id,
    tenantId
  );
  
  // 7. 更新租户资源配置
  await updateTenantResources(tenantId, {
    instanceId: instance.id,
    storageId: storage.id,
    queueId: queue.id,
    deploymentMode: 'd2',
  });
}
```

---

## 五、租户封禁/销毁工作流

### 5.1 封禁流程

```typescript
async function suspendTenant(tenantId: string, reason: string): Promise<void> {
  // 1. 更新状态
  await updateTenantStatus(tenantId, 'suspended');
  
  // 2. 撤销 Entitlement Snapshot
  await revokeEntitlementSnapshot(tenantId);
  
  // 3. 记录事件
  await eventLog.write({
    type: 'tenant.suspended',
    tenantId,
    data: { reason },
  });
  
  // 4. 通知管理员
  await notifyTenantAdmins(tenantId, {
    type: 'tenant_suspended',
    reason,
  });
  
  // 注意：不删除数据，不停止实例，只阻止登录和能力执行
}
```

### 5.2 销毁流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                      租户销毁状态机                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐                                                     │
│   │ REQUESTED│  销毁请求                                           │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ GRACE    │  宽限期（30天）- 可恢复                              │
│   │ PERIOD   │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         │ 宽限期结束                                                │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ ARCHIVING│  归档数据（可选）                                   │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ DELETING │  删除资源                                           │
│   │RESOURCES │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ DELETED  │  终态                                               │
│   └──────────┘                                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 六、事件类型定义

### 6.1 Provisioning 事件

| 事件类型 | 说明 |
|---------|------|
| `tenant.provisioning.requested` | 开通请求已提交 |
| `tenant.provisioning.validated` | 校验通过 |
| `tenant.provisioning.rejected` | 校验拒绝 |
| `tenant.provisioning.resources_allocated` | 资源已分配 |
| `tenant.provisioning.deployed` | 部署完成 |
| `tenant.provisioning.seeded` | 初始化完成 |
| `tenant.provisioning.domain_issued` | 域名已配置 |
| `tenant.provisioned` | 开通成功 |
| `tenant.provisioning.failed` | 开通失败 |
| `tenant.provisioning.rolled_back` | 已回滚 |

### 6.2 Domain 事件

| 事件类型 | 说明 |
|---------|------|
| `domain.binding.initiated` | 绑定发起 |
| `domain.binding.verified` | 验证通过 |
| `domain.binding.cert_issued` | 证书签发 |
| `domain.bound` | 绑定成功 |
| `domain.binding.failed` | 绑定失败 |
| `domain.unbound` | 已解绑 |

### 6.3 Upgrade 事件

| 事件类型 | 说明 |
|---------|------|
| `tenant.upgrade.requested` | 升级请求 |
| `tenant.upgrade.scheduled` | 已安排 |
| `tenant.upgrade.migrating` | 迁移中 |
| `tenant.upgraded` | 升级完成 |
| `tenant.upgrade.rolled_back` | 升级回滚 |

### 6.4 Lifecycle 事件

| 事件类型 | 说明 |
|---------|------|
| `tenant.suspended` | 已封禁 |
| `tenant.reactivated` | 已恢复 |
| `tenant.deletion.requested` | 销毁请求 |
| `tenant.deletion.grace_period` | 进入宽限期 |
| `tenant.deleted` | 已删除 |

---

## 七、平台后台界面要求

### 7.1 租户实例管理

| 功能 | 说明 |
|------|------|
| **租户列表** | 查看所有租户，按状态/模式筛选 |
| **创建租户** | 手动创建 Dedicated 租户 |
| **查看详情** | 资源配置、域名、订阅、事件日志 |
| **封禁/恢复** | 管理租户状态 |
| **销毁** | 触发销毁流程 |

### 7.2 开通进度监控

| 功能 | 说明 |
|------|------|
| **进行中列表** | 查看所有进行中的开通流程 |
| **状态时间线** | 每个步骤的开始/结束时间 |
| **重试** | 对失败步骤重试 |
| **手动推进** | 紧急情况下手动推进状态 |
| **回滚** | 触发回滚 |

### 7.3 域名管理

| 功能 | 说明 |
|------|------|
| **域名列表** | 所有已绑定域名 |
| **绑定状态** | 验证/证书/路由状态 |
| **证书续期** | 自动续期状态与手动触发 |
| **解绑** | 解除域名绑定 |

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [总体架构设计](./总体架构设计.md)
- [租户模式定义](./租户模式定义.md)
- [代码质量标准化体系](../代码质量标准化体系.md)

