# dhs-atlas 租户隔离三阶段路线图（v1.0）

> **版本**: v1.0  
> **创建日期**: 2025-12-28  
> **文档性质**: 工程执行文档  
> **相关文档**: [总体架构设计](./总体架构设计.md) · [租户模式定义](./租户模式定义.md) · [开通蓝图](./租户开通蓝图.md)

---

## 一、总原则

### 1.1 三阶段目标

| 阶段 | 目标 | 核心价值 |
|------|------|---------|
| **Phase 1** | 公共平台（Shared Multi-tenant） | 交付速度优先 |
| **Phase 2** | 独立数据库（DB-per-tenant） | 隔离与合规 |
| **Phase 3** | 独立实例（Dedicated Hosted） | 高阶套餐 |

### 1.2 贯穿三阶段的底座（不变）

```
┌─────────────────────────────────────────────────────────────────────┐
│                      三阶段不变的底座                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │              Protocol Layer（协议层）                        │   │
│   │  Tool Protocol · Workflow Protocol · Role Protocol · UI Protocol │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │              Platform Services（平台服务）                   │   │
│   │  Multi-tenant Boundary · Entitlements · Event Log · Artifact │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │              两后台（Apps）                                   │   │
│   │  Tenant Console (apps/console) + Platform Console (apps/platform) │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 1.3 架构铁律（防止后期崩盘）

| 铁律 | 说明 |
|------|------|
| **Tool 执行点受控** | 付费与权限不能只靠 UI |
| **Workflow 状态机** | 流程由状态机推进，避免页面流程屎山 |
| **Event Log 可回放** | 所有关键行为写日志，真实交互与责任链 |
| **Platform Console 是治理中心** | 订阅/隔离/风控/部署都在这里 |
| **Tenant Console 只负责经营** | 不负责平台治理 |

---

## 二、Phase 1：公共平台（Shared Multi-tenant）

### 2.1 阶段目标

> 以最小运维成本跑通全域平台的"操作系统内核"，交付多模块骨架，重点是平台级能力与跨域闭环。

### 2.2 必交付清单（平台层）

#### 2.2.1 Multi-tenant 基线

```typescript
// 核心实体
interface Enterprise {
  id: string;
  name: string;
  slug: string;
  status: 'active' | 'suspended' | 'deleted';
  createdAt: Date;
  updatedAt: Date;
}

interface User {
  id: string;
  email: string;
  name: string;
  status: 'active' | 'suspended' | 'deleted';
  createdAt: Date;
  updatedAt: Date;
}

interface Membership {
  id: string;
  userId: string;
  enterpriseId: string;
  roles: string[];
  status: 'active' | 'suspended' | 'removed';
  joinedAt: Date;
}

interface Role {
  id: string;
  enterpriseId: string;
  name: string;
  type: 'system' | 'custom';
  permissions: string[];
}

interface Policy {
  id: string;
  enterpriseId: string;
  type: string;
  rules: PolicyRule[];
}
```

#### 2.2.2 Entitlements 基线

```typescript
// Feature Key 模型
interface FeatureKey {
  key: string;                       // e.g., "svc.catalog.manage"
  name: string;
  description: string;
  domain: string;
  defaultEnabled: boolean;
}

// 配额模型
interface Quota {
  featureKey: string;
  limit: number;
  period: 'day' | 'month' | 'year' | 'unlimited';
}

// 订阅计划
interface Plan {
  id: string;
  name: string;                      // Free, Pro, Business, Enterprise
  features: FeatureGrant[];
  quotas: Quota[];
  price: number;
  billingCycle: 'monthly' | 'yearly';
}

// 企业订阅
interface Subscription {
  id: string;
  enterpriseId: string;
  planId: string;
  status: 'active' | 'trial' | 'expired' | 'cancelled';
  startDate: Date;
  endDate?: Date;
  trialEndDate?: Date;
}
```

**门禁实现**：

```typescript
// Tool Runner Gate
async function executeToolWithGate(input: ToolInput): Promise<ToolResult> {
  // 1. 获取企业订阅
  const subscription = await getSubscription(input.enterpriseId);
  
  // 2. 获取 Tool 定义
  const tool = await toolRegistry.get(input.toolId);
  
  // 3. 检查功能点
  for (const feature of tool.requiredFeatures) {
    if (!hasFeature(subscription, feature)) {
      return { status: 'error', error: { code: 'FEATURE_NOT_ENABLED' } };
    }
  }
  
  // 4. 检查配额
  for (const quota of tool.requiredQuotas) {
    if (!checkQuota(input.enterpriseId, quota)) {
      return { status: 'error', error: { code: 'QUOTA_EXCEEDED' } };
    }
  }
  
  // 5. 执行 Tool
  return await tool.execute(input);
}
```

#### 2.2.3 Event Log + Artifact Store

```typescript
// Event Log
interface EventLog {
  id: string;
  enterpriseId: string;
  eventType: string;
  source: { type: string; id: string };
  actor: { type: string; id: string; roleId?: string };
  payload: unknown;
  timestamp: Date;
  workflowSessionId?: string;
  requestId?: string;
}

// Artifact
interface Artifact {
  id: string;
  enterpriseId: string;
  type: string;
  name: string;
  version: number;
  content: unknown;
  contentType: string;
  source: { toolId?: string; workflowSessionId?: string; actorId: string };
  createdAt: Date;
}
```

#### 2.2.4 AI Gateway（最简实现）

```typescript
// AI Gateway 服务边界（即使最简也要独立存在）
interface AIGatewayService {
  // 调用模型
  invoke(request: AIRequest): Promise<AIResponse>;
  
  // 获取使用量
  getUsage(enterpriseId: string, period: string): Promise<UsageStats>;
}

interface AIRequest {
  enterpriseId: string;
  model: string;
  messages: Message[];
  tools?: ToolDefinition[];
  maxTokens?: number;
}

interface AIResponse {
  id: string;
  content: string;
  toolCalls?: ToolCall[];
  usage: { inputTokens: number; outputTokens: number };
}
```

#### 2.2.5 两后台应用壳

```
apps/
├── console/                         # Tenant Console（用户后台）
│   ├── app/
│   │   ├── (auth)/                  # 认证相关页面
│   │   ├── (dashboard)/             # 工作台
│   │   ├── service/                 # 服务管理
│   │   ├── quote/                   # 报价管理
│   │   ├── crm/                     # 客户管理
│   │   └── ...
│   └── ...
│
└── platform/                        # Platform Console（平台后台）
    ├── app/
    │   ├── (auth)/                  # 平台管理员认证
    │   ├── enterprises/             # 企业管理
    │   ├── subscriptions/           # 订阅管理
    │   ├── features/                # 功能开关管理
    │   ├── audit/                   # 审计日志
    │   └── ...
    └── ...
```

### 2.3 必交付清单（业务层）

#### 2.3.1 各域最小可行骨架

| 域 | 最小骨架 |
|------|---------|
| **Service** | 服务 CRUD + 分类 |
| **Quote** | 报价单 CRUD + 状态流转 |
| **CRM** | 客户 CRUD + 联系人 |
| **Project** | 项目 CRUD |
| **Finance** | 发票 CRUD |
| **CMS** | 页面 CRUD |
| **Org** | 组织结构 |
| **HR** | 员工 CRUD |

#### 2.3.2 一条跨域闭环 Workflow

```
建服务 → 出报价 → 建项目 → 生成应收
   │         │         │         │
   ▼         ▼         ▼         ▼
svc.service.create → qt.quote.create → proj.project.create → fin.invoice.create
```

**Workflow 定义**：

```typescript
const crossDomainWorkflow: WorkflowDefinition = {
  workflowId: 'business.service-to-invoice',
  name: '服务到发票全流程',
  
  states: [
    {
      stateId: 'init',
      name: '初始化',
      allowedTools: ['svc.service.create'],
      transitions: [
        { to: 'service_created', trigger: { type: 'tool_completed', toolId: 'svc.service.create' } }
      ]
    },
    {
      stateId: 'service_created',
      name: '服务已创建',
      allowedTools: ['qt.quote.create'],
      transitions: [
        { to: 'quote_created', trigger: { type: 'tool_completed', toolId: 'qt.quote.create' } }
      ]
    },
    {
      stateId: 'quote_created',
      name: '报价已创建',
      allowedTools: ['proj.project.create'],
      transitions: [
        { to: 'project_created', trigger: { type: 'tool_completed', toolId: 'proj.project.create' } }
      ]
    },
    {
      stateId: 'project_created',
      name: '项目已创建',
      allowedTools: ['fin.invoice.create'],
      transitions: [
        { to: 'completed', trigger: { type: 'tool_completed', toolId: 'fin.invoice.create' } }
      ]
    },
    {
      stateId: 'completed',
      name: '已完成',
      allowedTools: [],
      transitions: []
    }
  ],
  
  initialState: 'init',
  finalStates: ['completed']
};
```

### 2.4 必须预埋（为 Phase 2/3 准备）

#### 2.4.1 Tenant 运行时表（Day 1 必须存在）

```sql
CREATE TABLE tenant_runtime (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  enterprise_id UUID NOT NULL UNIQUE REFERENCES enterprise(id),
  
  -- 隔离模式（Phase 1 全部是 shared）
  isolation_mode VARCHAR(32) NOT NULL DEFAULT 'shared',
  -- shared | dedicated_db | dedicated_instance
  
  -- 数据库路由（Phase 1 全部是 NULL，指向默认）
  database_id VARCHAR(128),
  database_host VARCHAR(256),
  database_name VARCHAR(128),
  
  -- 实例路由（Phase 3 使用）
  instance_id VARCHAR(128),
  instance_host VARCHAR(256),
  
  -- 域名
  primary_domain VARCHAR(256) NOT NULL,
  custom_domains JSONB DEFAULT '[]',
  
  -- 状态
  status VARCHAR(32) NOT NULL DEFAULT 'active',
  -- active | provisioning | migrating | suspended
  
  -- 元数据
  metadata JSONB DEFAULT '{}',
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_tenant_runtime_enterprise ON tenant_runtime(enterprise_id);
CREATE INDEX idx_tenant_runtime_isolation ON tenant_runtime(isolation_mode);
```

#### 2.4.2 TenantDbResolver（统一数据访问层）

```typescript
// 即使 Phase 1 都指向同一个 DB，也必须通过这层访问
interface TenantDbResolver {
  // 获取租户数据库连接
  getConnection(enterpriseId: string): Promise<DatabaseConnection>;
  
  // 获取租户运行时信息
  getRuntime(enterpriseId: string): Promise<TenantRuntime>;
}

// Phase 1 实现（全部返回默认连接）
class SharedTenantDbResolver implements TenantDbResolver {
  private defaultConnection: DatabaseConnection;
  
  async getConnection(enterpriseId: string): Promise<DatabaseConnection> {
    // Phase 1: 所有租户共享同一个连接
    return this.defaultConnection;
  }
  
  async getRuntime(enterpriseId: string): Promise<TenantRuntime> {
    return await db.tenantRuntime.findUnique({
      where: { enterpriseId }
    });
  }
}
```

#### 2.4.3 所有数据表必须包含 enterprise_id

```typescript
// 这是 shared 隔离的基础，也是未来迁移的基础
interface BaseEntity {
  id: string;
  enterpriseId: string;  // 必须
  createdAt: Date;
  updatedAt: Date;
}

// 所有业务实体继承
interface Customer extends BaseEntity {
  name: string;
  // ...
}

interface Service extends BaseEntity {
  name: string;
  // ...
}
```

### 2.5 Platform Console 最低能力（Phase 1）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **企业列表** | 查看所有企业，按状态筛选 | P0 |
| **企业状态管理** | active/suspended 切换 | P0 |
| **套餐分配** | 为企业分配/更换套餐（手动） | P0 |
| **Feature 开关** | 管理 feature keys 启用/禁用 | P0 |
| **配额调整** | 调整企业配额（管理口） | P1 |
| **全局审计查询** | 跨企业只读审计日志 | P1 |

### 2.6 Phase 1 验收标准

- [ ] Multi-tenant 基线：enterprise/user/membership/role/policy CRUD 完成
- [ ] Entitlements 基线：plan/subscription/feature 模型完成，Tool Gate 生效
- [ ] Event Log：关键操作写入日志，可查询
- [ ] AI Gateway：作为独立服务存在，调用可计量
- [ ] Tenant Console：用户可登录，完成基本业务操作
- [ ] Platform Console：管理员可登录，完成企业/订阅管理
- [ ] 跨域 Workflow：服务→报价→项目→发票流程跑通
- [ ] tenant_runtime 表存在，所有记录 isolation_mode = 'shared'
- [ ] TenantDbResolver 层存在，所有访问通过该层

---

## 三、Phase 2：独立数据库（DB-per-tenant）

### 3.1 阶段目标

> 在不改变业务代码结构的前提下，实现"数据库级隔离"，提升合规/安全与企业采购友好度。

### 3.2 核心交付清单

#### 3.2.1 Provisioning 工作流（数据库级）

```typescript
// Provisioning 请求
interface DbProvisioningRequest {
  enterpriseId: string;
  targetMode: 'dedicated_db';
  
  // 可选配置
  region?: string;
  dbSpec?: 'small' | 'medium' | 'large';
}

// Provisioning Session
interface DbProvisioningSession {
  id: string;
  enterpriseId: string;
  
  state: DbProvisioningState;
  stateHistory: StateTransition[];
  
  request: DbProvisioningRequest;
  
  // 分配的资源
  allocatedDb?: {
    databaseId: string;
    host: string;
    name: string;
    credentials: EncryptedCredentials;
  };
  
  error?: ProvisioningError;
  
  requestedAt: Date;
  completedAt?: Date;
}

type DbProvisioningState =
  | 'requested'
  | 'allocating_db'
  | 'running_migrations'
  | 'migrating_data'
  | 'verifying'
  | 'switching'
  | 'ready'
  | 'failed'
  | 'rolled_back';
```

**状态机**：

```
┌─────────────────────────────────────────────────────────────────────┐
│                      DB Provisioning 状态机                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌──────────┐                                                     │
│   │ REQUESTED│                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ALLOCATING│  创建独立数据库实例                                  │
│   │    DB    │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │ RUNNING  │  执行 schema migrations                             │
│   │MIGRATIONS│                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │MIGRATING │  从 shared DB 迁移数据                              │
│   │   DATA   │                                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │VERIFYING │  验证数据完整性                                     │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │SWITCHING │  切换 TenantDbResolver 路由                         │
│   └─────┬────┘                                                     │
│         │                                                           │
│         ▼                                                           │
│   ┌──────────┐                                                     │
│   │  READY   │  完成                                               │
│   └──────────┘                                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 TenantDbResolver 扩展

```typescript
// Phase 2 实现（支持 dedicated_db）
class HybridTenantDbResolver implements TenantDbResolver {
  private defaultConnection: DatabaseConnection;
  private connectionPool: Map<string, DatabaseConnection> = new Map();
  
  async getConnection(enterpriseId: string): Promise<DatabaseConnection> {
    const runtime = await this.getRuntime(enterpriseId);
    
    if (runtime.isolationMode === 'shared') {
      return this.defaultConnection;
    }
    
    if (runtime.isolationMode === 'dedicated_db') {
      // 从连接池获取或创建
      if (!this.connectionPool.has(runtime.databaseId)) {
        const conn = await createConnection({
          host: runtime.databaseHost,
          database: runtime.databaseName,
          // credentials from secure storage
        });
        this.connectionPool.set(runtime.databaseId, conn);
      }
      return this.connectionPool.get(runtime.databaseId)!;
    }
    
    throw new Error(`Unknown isolation mode: ${runtime.isolationMode}`);
  }
}
```

#### 3.2.3 数据迁移能力

```typescript
interface DataMigrationJob {
  id: string;
  enterpriseId: string;
  
  sourceDb: string;
  targetDb: string;
  
  // 迁移状态
  status: 'pending' | 'running' | 'verifying' | 'completed' | 'failed';
  
  // 进度
  progress: {
    totalTables: number;
    completedTables: number;
    totalRows: number;
    migratedRows: number;
  };
  
  // 验证结果
  verification?: {
    passed: boolean;
    discrepancies: Discrepancy[];
  };
  
  startedAt?: Date;
  completedAt?: Date;
}

// 迁移执行器
async function migrateEnterpriseData(
  enterpriseId: string,
  sourceDb: DatabaseConnection,
  targetDb: DatabaseConnection
): Promise<void> {
  const tables = await getTableList();
  
  for (const table of tables) {
    // 1. 导出数据
    const data = await sourceDb.query(
      `SELECT * FROM ${table} WHERE enterprise_id = $1`,
      [enterpriseId]
    );
    
    // 2. 批量插入
    if (data.length > 0) {
      await targetDb.batchInsert(table, data);
    }
    
    // 3. 更新进度
    await updateMigrationProgress(enterpriseId, table);
  }
  
  // 4. 验证数据完整性
  await verifyDataIntegrity(enterpriseId, sourceDb, targetDb);
}
```

#### 3.2.4 备份策略

```typescript
interface BackupPolicy {
  enterpriseId: string;
  databaseId: string;
  
  // 备份配置
  schedule: string;                  // cron expression
  retentionDays: number;
  
  // 最近备份
  lastBackup?: {
    id: string;
    timestamp: Date;
    sizeBytes: number;
    status: 'success' | 'failed';
  };
}

// 备份服务
interface BackupService {
  // 创建备份
  createBackup(databaseId: string): Promise<Backup>;
  
  // 恢复备份
  restoreBackup(backupId: string, targetDbId: string): Promise<void>;
  
  // 列出备份
  listBackups(databaseId: string): Promise<Backup[]>;
}
```

### 3.3 Entitlement Snapshot（预埋）

```typescript
// 为 Phase 3 预埋，Phase 2 可选实现
interface EntitlementSnapshot {
  enterpriseId: string;
  planId: string;
  status: 'active' | 'trial' | 'grace' | 'expired';
  
  features: FeatureGrant[];
  quotas: QuotaGrant[];
  
  validFrom: Date;
  validUntil: Date;
  
  signature: string;
  issuedAt: Date;
  ttl: number;
}

// 快照服务
interface EntitlementSnapshotService {
  // 生成快照
  issue(enterpriseId: string): Promise<EntitlementSnapshot>;
  
  // 验证快照
  verify(snapshot: EntitlementSnapshot): boolean;
  
  // 刷新快照
  refresh(enterpriseId: string): Promise<EntitlementSnapshot>;
}
```

### 3.4 Platform Console 新增能力（Phase 2）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **隔离模式切换** | shared → dedicated_db | P0 |
| **Provisioning 面板** | 状态机进度展示 | P0 |
| **数据迁移管理** | 迁移作业列表、进度、回滚 | P0 |
| **备份管理** | 查看备份、触发恢复 | P1 |
| **数据库监控** | 连接数、性能指标 | P1 |

### 3.5 Phase 2 验收标准

- [ ] DB Provisioning 工作流完成
- [ ] TenantDbResolver 支持 shared/dedicated_db 两种模式
- [ ] 数据迁移作业可执行、可回滚
- [ ] 备份策略配置并执行
- [ ] Platform Console 支持隔离模式切换
- [ ] 切换后业务代码无需修改

---

## 四、Phase 3：独立实例（Dedicated Hosted）

### 4.1 阶段目标

> 为高阶客户提供"爆炸半径最小"的托管 Dedicated，租户不自建服务器，仍在平台内统一运维。

### 4.2 核心交付清单

#### 4.2.1 Provisioning 扩展（实例级）

```typescript
interface InstanceProvisioningRequest {
  enterpriseId: string;
  targetMode: 'dedicated_instance';
  
  // 实例配置
  instanceSpec: 'small' | 'medium' | 'large' | 'xlarge';
  region: string;
  
  // 域名
  preferredSlug?: string;
  customDomain?: string;
}

interface InstanceProvisioningSession {
  id: string;
  enterpriseId: string;
  
  state: InstanceProvisioningState;
  stateHistory: StateTransition[];
  
  request: InstanceProvisioningRequest;
  
  // 分配的资源
  allocatedResources?: {
    instanceId: string;
    instanceHost: string;
    databaseId: string;
    storageId: string;
    queueId: string;
    domainId: string;
  };
  
  error?: ProvisioningError;
  
  requestedAt: Date;
  completedAt?: Date;
}

type InstanceProvisioningState =
  | 'requested'
  | 'allocating_instance'
  | 'allocating_db'
  | 'allocating_storage'
  | 'deploying_app'
  | 'running_migrations'
  | 'migrating_data'
  | 'configuring_domain'
  | 'issuing_cert'
  | 'verifying'
  | 'ready'
  | 'failed'
  | 'rolled_back';
```

#### 4.2.2 域名体系

```typescript
// 域名管理服务
interface DomainService {
  // 分配二级域名
  allocateSubdomain(slug: string): Promise<Domain>;
  
  // 绑定自有域名
  bindCustomDomain(tenantId: string, domain: string): Promise<DomainBinding>;
  
  // 验证 DNS
  verifyDns(bindingId: string): Promise<boolean>;
  
  // 签发证书
  issueCertificate(domain: string): Promise<Certificate>;
}

interface Domain {
  id: string;
  tenantId: string;
  domain: string;
  type: 'subdomain' | 'custom';
  status: 'pending' | 'verified' | 'active' | 'failed';
  certificateId?: string;
}
```

#### 4.2.3 Entitlement Snapshot 强化

```typescript
// Phase 3: 强制使用签名快照
class DedicatedEntitlementGate {
  private snapshotCache: Map<string, EntitlementSnapshot> = new Map();
  private readonly TTL = 5 * 60 * 1000; // 5 分钟
  
  async checkFeature(enterpriseId: string, feature: string): Promise<boolean> {
    const snapshot = await this.getSnapshot(enterpriseId);
    
    // 验证签名
    if (!this.verifySignature(snapshot)) {
      throw new InvalidSnapshotError();
    }
    
    // 检查有效期
    if (new Date() > new Date(snapshot.validUntil)) {
      // 尝试刷新
      const refreshed = await this.refreshSnapshot(enterpriseId);
      if (!refreshed) {
        // 进入降级模式
        return this.checkGraceMode(enterpriseId, feature);
      }
    }
    
    return snapshot.features.some(f => f.featureKey === feature && f.enabled);
  }
  
  private async refreshSnapshot(enterpriseId: string): Promise<boolean> {
    try {
      const snapshot = await platformApi.getEntitlementSnapshot(enterpriseId);
      this.snapshotCache.set(enterpriseId, snapshot);
      return true;
    } catch (error) {
      // 平台不可达，使用缓存
      return false;
    }
  }
}
```

#### 4.2.4 AI Gateway 强制

```typescript
// Dedicated 实例必须通过平台 AI Gateway
class DedicatedAIClient {
  private gateway: AIGatewayClient;
  
  constructor(
    private readonly tenantId: string,
    private readonly gatewayUrl: string
  ) {
    this.gateway = new AIGatewayClient(gatewayUrl);
  }
  
  async invoke(request: AIRequest): Promise<AIResponse> {
    // 添加租户标识
    const enrichedRequest = {
      ...request,
      tenantId: this.tenantId,
      instanceId: process.env.INSTANCE_ID,
    };
    
    // 通过网关调用
    return this.gateway.invoke(enrichedRequest);
  }
}
```

#### 4.2.5 Release Governance

```typescript
// 版本通道
type ReleaseChannel = 'stable' | 'canary' | 'beta';

interface ReleasePolicy {
  tenantId: string;
  
  // 版本通道
  channel: ReleaseChannel;
  
  // 升级窗口
  maintenanceWindow?: {
    dayOfWeek: number;           // 0-6
    startHour: number;           // 0-23
    durationHours: number;
  };
  
  // 延迟升级
  upgradeDelay?: number;         // 天数
  
  // 自动升级
  autoUpgrade: boolean;
}

// 部署服务
interface DeploymentService {
  // 获取当前版本
  getCurrentVersion(instanceId: string): Promise<string>;
  
  // 部署新版本
  deploy(instanceId: string, version: string): Promise<Deployment>;
  
  // 回滚
  rollback(instanceId: string, targetVersion: string): Promise<Deployment>;
  
  // 灰度发布
  canaryDeploy(instanceIds: string[], version: string, percentage: number): Promise<CanaryDeployment>;
}
```

### 4.3 Platform Console 新增能力（Phase 3）

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **实例管理** | 创建、查看、销毁实例 | P0 |
| **版本管理** | 查看版本、触发升级、回滚 | P0 |
| **健康监控** | 实例健康状态、资源使用 | P0 |
| **域名管理** | 二级域名、自有域绑定、证书 | P0 |
| **跨实例审计** | 强审计授权，风控 | P1 |
| **维护窗口** | 配置升级时间窗口 | P1 |

### 4.4 Phase 3 验收标准

- [ ] Instance Provisioning 工作流完成
- [ ] 域名系统：二级域名自动分配 + 自有域绑定
- [ ] Entitlement Snapshot：签名验证、TTL 刷新、降级模式
- [ ] AI Gateway：Dedicated 实例强制走网关
- [ ] Release Governance：版本通道、灰度、回滚
- [ ] Platform Console：实例管理、版本管理、域名管理

---

## 五、数据模型演进

### 5.1 Phase 1 数据模型

```sql
-- 核心表（Phase 1）
CREATE TABLE enterprise (...);
CREATE TABLE "user" (...);
CREATE TABLE membership (...);
CREATE TABLE role (...);
CREATE TABLE policy (...);
CREATE TABLE plan (...);
CREATE TABLE subscription (...);
CREATE TABLE feature_key (...);
CREATE TABLE event_log (...);
CREATE TABLE artifact (...);

-- 预埋表（Phase 1 必须创建）
CREATE TABLE tenant_runtime (
  id UUID PRIMARY KEY,
  enterprise_id UUID NOT NULL UNIQUE,
  isolation_mode VARCHAR(32) DEFAULT 'shared',
  database_id VARCHAR(128),
  database_host VARCHAR(256),
  database_name VARCHAR(128),
  instance_id VARCHAR(128),
  instance_host VARCHAR(256),
  primary_domain VARCHAR(256),
  custom_domains JSONB DEFAULT '[]',
  status VARCHAR(32) DEFAULT 'active',
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 5.2 Phase 2 新增表

```sql
-- DB Provisioning
CREATE TABLE db_provisioning_session (
  id UUID PRIMARY KEY,
  enterprise_id UUID NOT NULL,
  state VARCHAR(32) NOT NULL,
  state_history JSONB DEFAULT '[]',
  request JSONB NOT NULL,
  allocated_db JSONB,
  error JSONB,
  requested_at TIMESTAMPTZ NOT NULL,
  completed_at TIMESTAMPTZ
);

-- 数据迁移作业
CREATE TABLE data_migration_job (
  id UUID PRIMARY KEY,
  enterprise_id UUID NOT NULL,
  source_db VARCHAR(128) NOT NULL,
  target_db VARCHAR(128) NOT NULL,
  status VARCHAR(32) NOT NULL,
  progress JSONB DEFAULT '{}',
  verification JSONB,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ
);

-- 备份策略
CREATE TABLE backup_policy (
  id UUID PRIMARY KEY,
  enterprise_id UUID NOT NULL,
  database_id VARCHAR(128) NOT NULL,
  schedule VARCHAR(64) NOT NULL,
  retention_days INT NOT NULL,
  last_backup JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 备份记录
CREATE TABLE backup (
  id UUID PRIMARY KEY,
  database_id VARCHAR(128) NOT NULL,
  status VARCHAR(32) NOT NULL,
  size_bytes BIGINT,
  storage_path VARCHAR(512),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 5.3 Phase 3 新增表

```sql
-- Instance Provisioning
CREATE TABLE instance_provisioning_session (
  id UUID PRIMARY KEY,
  enterprise_id UUID NOT NULL,
  state VARCHAR(32) NOT NULL,
  state_history JSONB DEFAULT '[]',
  request JSONB NOT NULL,
  allocated_resources JSONB,
  error JSONB,
  requested_at TIMESTAMPTZ NOT NULL,
  completed_at TIMESTAMPTZ
);

-- 域名
CREATE TABLE domain (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  domain VARCHAR(256) NOT NULL UNIQUE,
  type VARCHAR(32) NOT NULL,
  status VARCHAR(32) NOT NULL,
  certificate_id VARCHAR(128),
  verification JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 证书
CREATE TABLE certificate (
  id UUID PRIMARY KEY,
  domain VARCHAR(256) NOT NULL,
  status VARCHAR(32) NOT NULL,
  issued_at TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,
  storage_path VARCHAR(512)
);

-- Entitlement Snapshot
CREATE TABLE entitlement_snapshot (
  id UUID PRIMARY KEY,
  enterprise_id UUID NOT NULL,
  plan_id UUID NOT NULL,
  status VARCHAR(32) NOT NULL,
  features JSONB NOT NULL,
  quotas JSONB NOT NULL,
  valid_from TIMESTAMPTZ NOT NULL,
  valid_until TIMESTAMPTZ NOT NULL,
  signature TEXT NOT NULL,
  issued_at TIMESTAMPTZ NOT NULL
);

-- 版本策略
CREATE TABLE release_policy (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  channel VARCHAR(32) NOT NULL DEFAULT 'stable',
  maintenance_window JSONB,
  upgrade_delay INT,
  auto_upgrade BOOLEAN DEFAULT true
);

-- 部署记录
CREATE TABLE deployment (
  id UUID PRIMARY KEY,
  instance_id VARCHAR(128) NOT NULL,
  version VARCHAR(64) NOT NULL,
  status VARCHAR(32) NOT NULL,
  started_at TIMESTAMPTZ NOT NULL,
  completed_at TIMESTAMPTZ
);
```

---

## 六、接口预埋清单

### 6.1 Phase 1 必须存在的接口

```typescript
// TenantDbResolver（即使只返回默认连接）
interface TenantDbResolver {
  getConnection(enterpriseId: string): Promise<DatabaseConnection>;
  getRuntime(enterpriseId: string): Promise<TenantRuntime>;
}

// EntitlementService（直接查询）
interface EntitlementService {
  checkFeature(enterpriseId: string, feature: string): Promise<boolean>;
  checkQuota(enterpriseId: string, quota: string): Promise<QuotaStatus>;
  getSubscription(enterpriseId: string): Promise<Subscription>;
}

// AIGateway（即使最简实现）
interface AIGateway {
  invoke(request: AIRequest): Promise<AIResponse>;
  getUsage(enterpriseId: string, period: string): Promise<UsageStats>;
}
```

### 6.2 Phase 2 新增接口

```typescript
// DbProvisioningService
interface DbProvisioningService {
  initiate(request: DbProvisioningRequest): Promise<DbProvisioningSession>;
  getStatus(sessionId: string): Promise<DbProvisioningSession>;
  retry(sessionId: string): Promise<void>;
  rollback(sessionId: string): Promise<void>;
}

// DataMigrationService
interface DataMigrationService {
  startMigration(enterpriseId: string): Promise<DataMigrationJob>;
  getProgress(jobId: string): Promise<DataMigrationJob>;
  verify(jobId: string): Promise<VerificationResult>;
  rollback(jobId: string): Promise<void>;
}

// BackupService
interface BackupService {
  createBackup(databaseId: string): Promise<Backup>;
  restoreBackup(backupId: string, targetDbId: string): Promise<void>;
  listBackups(databaseId: string): Promise<Backup[]>;
  configurePolicy(policy: BackupPolicy): Promise<void>;
}
```

### 6.3 Phase 3 新增接口

```typescript
// InstanceProvisioningService
interface InstanceProvisioningService {
  initiate(request: InstanceProvisioningRequest): Promise<InstanceProvisioningSession>;
  getStatus(sessionId: string): Promise<InstanceProvisioningSession>;
  retry(sessionId: string): Promise<void>;
  rollback(sessionId: string): Promise<void>;
}

// DomainService
interface DomainService {
  allocateSubdomain(slug: string): Promise<Domain>;
  bindCustomDomain(tenantId: string, domain: string): Promise<DomainBinding>;
  verifyDns(bindingId: string): Promise<boolean>;
  issueCertificate(domain: string): Promise<Certificate>;
  unbind(domainId: string): Promise<void>;
}

// EntitlementSnapshotService
interface EntitlementSnapshotService {
  issue(enterpriseId: string): Promise<EntitlementSnapshot>;
  verify(snapshot: EntitlementSnapshot): boolean;
  refresh(enterpriseId: string): Promise<EntitlementSnapshot>;
}

// DeploymentService
interface DeploymentService {
  getCurrentVersion(instanceId: string): Promise<string>;
  deploy(instanceId: string, version: string): Promise<Deployment>;
  rollback(instanceId: string, targetVersion: string): Promise<Deployment>;
  canaryDeploy(instanceIds: string[], version: string, percentage: number): Promise<CanaryDeployment>;
  configurePolicy(tenantId: string, policy: ReleasePolicy): Promise<void>;
}
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-12-28 | 初始版本 |

---

**相关文档**：
- [总体架构设计](./总体架构设计.md)
- [租户模式定义](./租户模式定义.md)
- [租户开通蓝图](./租户开通蓝图.md)

