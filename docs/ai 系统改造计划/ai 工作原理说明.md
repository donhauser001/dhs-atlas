# AI 工作原理说明

## 概述

本文档定义了 AI 助手的核心工作机制，包括意图识别、工具调用、AI 地图执行等关键流程。

---

## 一、AI 工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户发送消息                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     AI 分析用户意图                              │
│                  （闲聊 or 任务？）                               │
│                                                                  │
│   ⚠️ 不要过多束缚 AI，它足够聪明，能准确理解用户意图              │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              ▼                               ▼
┌──────────────────────┐          ┌──────────────────────┐
│       闲聊            │          │       任务           │
│   直接对话回复        │          │   进入任务处理流程    │
└──────────────────────┘          └──────────────────────┘
                                              │
                                              ▼
                              ┌───────────────────────────┐
                              │   判断任务类型             │
                              │   简单查询 or 复杂任务？   │
                              └───────────────────────────┘
                                              │
                    ┌─────────────────────────┴─────────────────────────┐
                    ▼                                                   ▼
        ┌──────────────────────┐                        ┌──────────────────────┐
        │     简单查询          │                        │     复杂任务         │
        │  直接调用核心工具      │                        │  查找 AI 地图模板    │
        └──────────────────────┘                        └──────────────────────┘
                    │                                                   │
                    ▼                                   ┌───────────────┴───────────────┐
        ┌──────────────────────┐                        ▼                               ▼
        │   db.query 查询      │            ┌──────────────────┐          ┌──────────────────┐
        │   返回结果给用户      │            │   有对应地图      │          │   无对应地图      │
        └──────────────────────┘            │   按步骤执行      │          │   提醒用户创建    │
                                            └──────────────────┘          └──────────────────┘
```

---

## 二、核心组件

### 1. 核心工具（始终可用）

核心工具用于**直接查询数据**，AI 无需 AI 地图也可以使用。

| 工具 ID | 名称 | 用途 | 使用场景 |
|---------|------|------|----------|
| `schema.search` | 搜索数据表 | 查找相关数据表和字段结构 | 不知道查哪个表时使用 |
| `db.query` | 数据库查询 | 查询、统计、聚合数据 | 简单数据查询 |
| `map.search` | 搜索 AI 地图 | 查找任务模板 | 复杂任务时使用 |

**示例场景**：
- "帮我查一下中信出版社的信息" → 直接用 `db.query`
- "中信出版社有哪些联系人" → 直接用 `db.query`
- "帮我生成一份合同" → 需要 AI 地图

### 2. AI 地图（任务模板）

AI 地图是**多步骤任务的执行模板**，适用于：

| 场景 | 说明 | 示例 |
|------|------|------|
| **两步以上的查询** | 需要先查 A 再查 B | 查客户的联系人的项目统计 |
| **写入数据** | 创建、修改、删除 | 新建客户、创建合同 |
| **复杂运算** | 需要计算、聚合 | 利润统计、报价计算 |

**AI 地图的结构**：

```
AI 地图
├── 名称：生成合同
├── 描述：根据客户信息生成合同
├── 触发关键词：生成合同、创建合同
└── 步骤：
    ├── Step 1: 获取客户信息
    │   ├── 工具：db.query
    │   ├── 参数：{"collection": "clients", "query": {...}}
    │   └── 输出：客户数据 → 传递给下一步
    │
    ├── Step 2: 匹配合同模板
    │   ├── 工具：contract.template.match
    │   └── 输出：模板内容 → 传递给下一步
    │
    └── Step 3: 生成合同
        ├── 工具：contract.generate
        └── 输出：最终合同 → 返回给用户
```

### 3. 数据模型（动态缓存）

数据模型是**动态生成**的，不再使用静态配置。

**作用**：让 AI 实时了解系统中所有数据表的：
- 表结构（字段名、类型）
- 字段说明
- 表之间的关联关系

**获取方式**：
- `schema.search` - 搜索相关表
- `datamodel.get` - 获取单个表的完整结构

---

## 三、任务类型判断

### 简单查询（直接用核心工具）

以下场景 AI 可以直接使用 `db.query` 查询，**不需要 AI 地图**：

| 用户说 | AI 做法 |
|--------|---------|
| "查一下中信出版社的信息" | `db.query` → clients 表 |
| "中信出版社有哪些联系人" | `db.query` → users 表 |
| "中信出版社有哪些项目" | `db.query` → projects 表 |
| "帮我统计有多少个客户" | `db.query` → count 操作 |

### 复杂任务（需要 AI 地图）

以下场景需要查找并执行 **AI 地图**：

| 用户说 | 为什么需要 AI 地图 |
|--------|-------------------|
| "帮我生成一份合同" | 需要多步骤：选模板 → 填数据 → 生成 |
| "新建一个客户" | 需要写入数据 |
| "统计各联系人的项目金额" | 需要多表关联 + 聚合计算 |

---

## 四、AI 地图执行流程

当 AI 识别到需要执行复杂任务时：

```
1. 调用 map.search 搜索相关 AI 地图
   ↓
2. 如果找到匹配的地图：
   ├── 读取地图的步骤定义
   ├── 依次执行每个步骤
   ├── 步骤输出传递给下一步
   └── 最终结果返回给用户
   
3. 如果没有找到地图：
   └── 提醒用户："目前没有这个任务的执行模板，
       请先创建对应的 AI 地图，我下次就知道如何完成了"
```

---

## 五、核心原则

### 原则 1：AI 地图是 AI 的认知版图

- ✅ AI 地图决定了 AI 能做什么
- ✅ AI 无法执行任务 → **不是 AI 不够好，是地图不够完善**
- ✅ 解决方案：完善 AI 地图，而不是责怪 AI

### 原则 2：AI 地图必须调用工具

- ✅ AI 地图的每个步骤都要调用工具
- ✅ 地图无法完成任务 → **不是地图不够好，是工具集不够完善**
- ✅ 解决方案：完善工具集，而不是修改地图逻辑

### 原则 3：AI 绝不直接生成数据（最高原则）

- ✅ **所有数据必须来自工具返回**
- ✅ AI 只能格式化、整理工具返回的数据
- ❌ **禁止 AI 凭空编造任何数据**
- ❌ **禁止 AI 猜测、推断数据内容**

```
正确流程：用户问 → AI 调工具 → 工具返回数据 → AI 格式化输出
错误流程：用户问 → AI 直接编造答案（❌ 严禁）
```

### 原则 4：样例模板是输出格式参考

- ✅ 样例模板指导 AI 如何格式化输出
- ✅ AI 优先参考模板的输出格式
- ✅ 找不到合适模板时，AI 可自行决定格式
- ❌ 样例模板不是数据来源

### 原则 5：核心工具用于简单查询

- ✅ 简单查询 → 直接用 `db.query`
- ✅ 复杂任务 → 查找并执行 AI 地图
- ❌ 不要为每个查询都创建专用工具

### 原则 6：数据模型动态获取

- ✅ 使用动态生成的数据模型缓存
- ✅ AI 通过 `schema.search` 实时获取表结构
- ❌ 不要在代码中硬编码数据结构

---

## 六、工具与 AI 地图的关系

```
┌─────────────────────────────────────────────────────────────────┐
│                          AI 助手                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────────┐       ┌─────────────────────────────┐     │
│   │   核心工具       │       │        AI 地图               │     │
│   │                 │       │                             │     │
│   │  • schema.search│       │  地图1: 生成合同            │     │
│   │  • db.query     │◄──────│    Step1 → Step2 → Step3   │     │
│   │  • map.search   │       │                             │     │
│   │                 │       │  地图2: 新建客户            │     │
│   │                 │       │    Step1 → Step2           │     │
│   │                 │       │                             │     │
│   │                 │       │  地图3: 项目金额统计        │     │
│   │                 │       │    Step1 → Step2 → Step3   │     │
│   └─────────────────┘       └─────────────────────────────┘     │
│          ▲                              │                        │
│          │                              │                        │
│          │         AI 地图的每个步骤     │                        │
│          └──────────  调用核心工具  ─────┘                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 七、总结

| 组件 | 定义位置 | 用途 |
|------|----------|------|
| **核心工具** | 系统内置 | 直接查询数据 |
| **AI 地图** | 数据库配置 | 定义复杂任务的执行步骤 |
| **数据模型** | 动态生成 | 让 AI 了解数据结构 |
| **样例模板** | 地图内配置 | 输出格式参考 |

**AI 的工作方式**：
1. 理解用户意图
2. 简单查询 → 直接用核心工具
3. 复杂任务 → 查找并执行 AI 地图
4. 没有地图 → 提醒用户创建

**最高原则**：

```
⚠️ AI 绝不直接生成数据

数据流向：
用户 → AI 地图（认知版图） → 工具调用 → 工具返回数据 → AI 格式化 → 用户
                              ↑
                         数据唯一来源

责任链：
AI 做不到 → 完善 AI 地图
地图做不到 → 完善工具集
```

---

*文档版本：v1.1*  
*最后更新：2024年12月*
