# AI 架构 V2：智能 AI + 系统守门

> ⚠️ **本文档已更新**
> 
> 本文档与 `ai 工作原理说明.md` 保持一致。
> 如有冲突，以 `ai 工作原理说明.md` 为准。

---

> **核心理念**：AI 每次只做一件事，系统负责步骤编排和流程控制。

---

## 1. 设计哲学

### 1.1 三层结构（核心）

```
┌─────────────────────────────────────────────────────────────────┐
│                        三层架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐                                           │
│  │    样例模板       │  输出参照 - AI 格式化结果时的参考          │
│  │  (OutputTemplate) │  定义：标题、表格列、字段映射等            │
│  └────────┬─────────┘                                           │
│           │                                                      │
│  ┌────────▼─────────┐                                           │
│  │     AI 地图       │  步骤耦合器 - 任务模板/指导方针            │
│  │    (AiMap)        │  定义：每步用什么工具、查什么数据、         │
│  │                   │       输出什么格式、下一步提示词           │
│  └────────┬─────────┘                                           │
│           │                                                      │
│  ┌────────▼─────────┐                                           │
│  │      工具         │  最小颗粒度执行命令                        │
│  │    (AiTool)       │  只做一件事：查询/创建/更新/删除           │
│  └──────────────────┘                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心原则

| 原则 | 说明 |
|------|------|
| **每次只做一件事** | AI 每次只执行一个工具，不要一口气做多个任务 |
| **及时反馈** | 每步执行结果立即反馈到聊天界面 |
| **系统编排** | 系统负责自动触发下一步，不是 AI 自己决定 |
| **精确定义** | 地图中每步都精确规定：工具、参数、输出格式 |
| **不让 AI 盲猜** | 所有信息都在地图中写清楚，AI 只需执行 |

### 1.3 执行流程

```
用户输入
    │
    ▼
AI 理解意图 → 简单查询？ → 直接调用工具 → 返回结果
    │
    │ 复杂任务？
    ▼
调用 map.search 找地图
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│                    步骤式执行循环                          │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  步骤 1: AI 执行工具 A                                    │
│      │                                                    │
│      ▼                                                    │
│  系统: 「✅ 步骤 1 完成，结果: xxx」 ← 立即反馈给用户      │
│      │                                                    │
│      ▼                                                    │
│  系统: 注入下一步提示词（来自地图）                        │
│      │                                                    │
│      ▼                                                    │
│  步骤 2: AI 执行工具 B                                    │
│      │                                                    │
│      ▼                                                    │
│  系统: 「✅ 步骤 2 完成，结果: yyy」 ← 立即反馈给用户      │
│      │                                                    │
│      ▼                                                    │
│  ... 循环直到所有步骤完成 ...                             │
│      │                                                    │
│      ▼                                                    │
│  系统: 「📋 全部完成，请汇总输出」                         │
│      │                                                    │
│      ▼                                                    │
│  AI: 按样例模板格式化最终结果                             │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

### 1.4 为什么这样设计

| 之前的问题 | 现在的解决 |
|-----------|-----------|
| AI 一口气做多个任务，容易出错 | 每次只做一件事，可控 |
| 用户不知道 AI 在干什么 | 每步实时反馈，透明 |
| AI 自己决定下一步，不可预测 | 系统按地图编排，可预测 |
| AI 盲猜参数和格式 | 地图精确定义一切 |
| 出错难以定位 | 每步独立，容易调试 |

---

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           AI 对话流程 V2                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  用户输入                                                               │
│      │                                                                  │
│      ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                         AI 分析意图                              │   │
│  │                                                                  │   │
│  │   闲聊？ → 直接回复                                              │   │
│  │   任务？ → 判断任务类型                                          │   │
│  │                                                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│      │                                                                  │
│      │ 如果是任务                                                       │
│      ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      任务类型判断                                 │   │
│  │                                                                   │   │
│  │  ┌─────────────────────┐    ┌─────────────────────┐              │   │
│  │  │     简单查询         │    │     复杂任务        │              │   │
│  │  │                     │    │                     │              │   │
│  │  │  直接用核心工具：    │    │  查找 AI 地图：     │              │   │
│  │  │  • schema.search    │    │  • map.search       │              │   │
│  │  │  • db.query         │    │  • 按步骤执行       │              │   │
│  │  │                     │    │  • 无地图则提醒     │              │   │
│  │  └─────────────────────┘    └─────────────────────┘              │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│      │                                                                  │
│      │ 调用工具                                                         │
│      ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      系统守门层                                   │   │
│  │                                                                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │   权限检查    │  │   参数验证    │  │   审计记录    │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│      │                                                                  │
│      │ 权限通过                                                         │
│      ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      执行层                                       │   │
│  │                                                                   │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │  数据库查询   │  │  外部 API    │  │  文件操作    │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  │                                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│      │                                                                  │
│      │ 返回结果                                                         │
│      ▼                                                                  │
│  AI 组织输出，回复用户                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心组件

### 3.1 核心工具（始终可用）

核心工具用于**直接查询数据**，AI 无需 AI 地图也可以使用。

| 工具 ID | 名称 | 用途 | 使用场景 |
|---------|------|------|----------|
| `schema.search` | 搜索数据表 | 查找相关数据表和字段结构 | 不知道查哪个表时使用 |
| `db.query` | 数据库查询 | 查询、统计、聚合数据 | 简单数据查询 |
| `map.search` | 搜索 AI 地图 | 查找任务模板 | 复杂任务时使用 |

### 3.2 AI 地图（步骤耦合器/任务模板）

AI 地图是**步骤耦合器**，精确定义每一步该做什么。

> ⚠️ **核心原则**：地图中的每一步都要精确规定，不让 AI 盲猜！

**地图结构**：

```typescript
interface AiMap {
    // 基本信息
    mapId: string;
    name: string;
    description: string;
    module: string;           // 所属模块
    triggers: string[];       // 触发关键词
    
    // ⭐⭐⭐ 执行步骤（核心中的核心）
    steps: AiMapStep[];
    
    // 完整示例（给 AI 参考）
    examples: string;
}

interface AiMapStep {
    order: number;            // 步骤序号
    name: string;             // 步骤名称
    action: string;           // 动作描述
    
    // 精确定义：用什么工具
    toolId: string;           // 工具 ID
    
    // 精确定义：查什么数据
    paramsTemplate: {         // 参数模板（支持变量引用）
        collection?: string;
        query?: object;
        // ...其他参数
    };
    
    // 精确定义：输出什么
    outputKey: string;        // 输出变量名，供下一步使用
    
    // ⭐ 下一步提示词（关键！）
    nextStepPrompt: string;   // 步骤完成后，系统自动注入给 AI 的提示
                              // 包含：完成状态、下一步指令、工具调用示例
}
```

**步骤提示词示例**：

```
✅ 步骤 1 完成。从客户信息中获取到 quotationId: {{clientInfo.quotationId}}

📍 下一步：请调用 db.query 查询 quotations 表，获取报价单详情。

\`\`\`tool_call
{"toolId": "db.query", "params": {"collection": "quotations", "query": {"_id": "{{clientInfo.quotationId}}"}, "limit": 1}}
\`\`\`
```

**为什么需要 nextStepPrompt**：

| 没有 nextStepPrompt | 有 nextStepPrompt |
|---------------------|-------------------|
| AI 盲猜下一步该做什么 | 系统明确告诉 AI 下一步 |
| AI 可能用错工具 | 工具调用示例写好了 |
| AI 可能传错参数 | 参数模板写好了 |
| 不可控，随机性大 | 完全可控，可预测 |

### 3.3 完整地图示例

```json
{
    "mapId": "query_client_quotation",
    "name": "查询客户报价单",
    "description": "查询指定客户使用的报价单及其包含的服务价格",
    "module": "pricing",
    "triggers": ["报价单", "价格单", "定价方案", "用什么价格"],
    
    "steps": [
        {
            "order": 1,
            "name": "获取客户信息",
            "action": "查询客户详情，获取 quotationId",
            "toolId": "crm.client_detail",
            "paramsTemplate": { "clientName": "{{用户提供的客户名称}}" },
            "outputKey": "clientInfo",
            "nextStepPrompt": "✅ 步骤 1 完成。获取到 quotationId: {{clientInfo.quotationId}}\n\n📍 下一步：请查询报价单详情。\n```tool_call\n{\"toolId\": \"db.query\", \"params\": {\"collection\": \"quotations\", \"query\": {\"_id\": \"{{clientInfo.quotationId}}\"}, \"limit\": 1}}\n```"
        },
        {
            "order": 2,
            "name": "获取报价单详情",
            "action": "用 quotationId 查询报价单，获取 selectedServices",
            "toolId": "db.query",
            "paramsTemplate": { "collection": "quotations", "query": { "_id": "{{clientInfo.quotationId}}" } },
            "outputKey": "quotationInfo",
            "nextStepPrompt": "✅ 步骤 2 完成。报价单: {{quotationInfo.name}}，包含 {{quotationInfo.selectedServices.length}} 个服务。\n\n📍 下一步：请查询服务价格列表。\n```tool_call\n{\"toolId\": \"db.query\", \"params\": {\"collection\": \"servicepricings\", \"query\": {\"_id\": {\"$in\": {{quotationInfo.selectedServices}}}}, \"limit\": 50}}\n```"
        },
        {
            "order": 3,
            "name": "获取服务价格列表",
            "action": "查询 selectedServices 对应的服务价格",
            "toolId": "db.query",
            "paramsTemplate": { "collection": "servicepricings", "query": { "_id": { "$in": "{{quotationInfo.selectedServices}}" } } },
            "outputKey": "services",
            "nextStepPrompt": "✅ 全部步骤完成！\n\n📋 请将查询结果汇总，用 Markdown 表格展示给用户：\n- 报价单名称\n- 服务列表（服务名称、分类、单价、单位）"
        }
    ],
    
    "examples": "完整执行示例..."
}
```

### 3.4 样例模板（输出参照）

样例模板定义 AI 格式化输出时的参考格式。

```typescript
interface AiTemplate {
    templateId: string;
    name: string;
    description: string;
    
    // 输出格式定义
    format: {
        type: 'table' | 'list' | 'card' | 'text';
        columns?: string[];      // 表格列
        fields?: string[];       // 字段映射
    };
    
    // 示例输出
    example: string;
}
```

**示例**：

```json
{
    "templateId": "quotation_services",
    "name": "报价单服务列表",
    "format": {
        "type": "table",
        "columns": ["服务名称", "分类", "单价", "单位", "说明"]
    },
    "example": "| 服务名称 | 分类 | 单价 | 单位 | 说明 |\n|----------|------|------|------|------|\n| 平装单封 | 封面设计 | 3500 | 本 | 初稿10个工作日 |"
}
```

---

## 4. 执行机制

### 4.1 步骤式执行（核心！）

> ⚠️ **每次只让 AI 做一件事，及时反馈，系统自动编排下一步**

```
┌─────────────────────────────────────────────────────────────┐
│                   步骤式执行流程                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  第 1 轮对话:                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 用户: "中信出版社的报价单"                            │   │
│  │ AI: 调用 map.search("报价单")                        │   │
│  │ 系统: 返回地图，注入步骤 1 提示                       │   │
│  │ AI: 调用 crm.client_detail                          │   │
│  │ → 结果立即反馈给用户: "✅ 步骤 1 完成..."             │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  第 2 轮对话 (系统自动触发):                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 系统: 注入步骤 2 提示词（来自地图 nextStepPrompt）    │   │
│  │ AI: 调用 db.query (quotations)                      │   │
│  │ → 结果立即反馈给用户: "✅ 步骤 2 完成..."             │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  第 3 轮对话 (系统自动触发):                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 系统: 注入步骤 3 提示词                              │   │
│  │ AI: 调用 db.query (servicepricings)                 │   │
│  │ → 结果立即反馈给用户: "✅ 步骤 3 完成..."             │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓                                  │
│  最终输出:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 系统: 注入"全部完成"提示                             │   │
│  │ AI: 按样例模板格式化，输出最终结果                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 简单查询 vs 复杂任务

| 类型 | 判断标准 | 执行方式 |
|------|----------|----------|
| **简单查询** | 一步就能完成 | 直接调用工具，返回结果 |
| **复杂任务** | 需要多步骤 | 查地图，步骤式执行 |

**简单查询示例**：

| 用户说 | AI 做法 |
|--------|---------|
| "查一下中信出版社的信息" | `crm.client_detail` → 返回结果 |
| "有多少个客户" | `db.query` + count → 返回数量 |

**复杂任务示例**：

| 用户说 | 需要地图 |
|--------|----------|
| "中信出版社的报价单" | 需要 3 步：查客户 → 查报价单 → 查服务价格 |
| "帮我生成合同" | 需要多步：选模板 → 填数据 → 生成 |

### 4.3 任务机制（TaskList）

> ⭐ **核心功能**：让用户看到 AI 在做什么，让 AI 知道自己做到哪了

当 AI 匹配到地图并开始执行复杂任务时，系统会自动生成一个**任务列表（TaskList）**：

```
┌─────────────────────────────────────────────────────────────┐
│                      任务机制流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户: "中信出版社的报价单"                                  │
│      │                                                      │
│      ▼                                                      │
│  AI: 调用 map.search → 找到「查询客户报价单」地图            │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           系统自动生成任务列表                        │   │
│  │                                                      │   │
│  │   📋 任务计划：查询客户报价单（共 3 步）              │   │
│  │   ┌────────────────────────────────────────────┐    │   │
│  │   │ ○ 步骤 1: 获取客户信息      [待执行]        │    │   │
│  │   │ ○ 步骤 2: 获取报价单详情    [待执行]        │    │   │
│  │   │ ○ 步骤 3: 获取服务价格列表  [待执行]        │    │   │
│  │   └────────────────────────────────────────────┘    │   │
│  │                                                      │   │
│  │   → 立即返回给前端，用户可以看到整体计划             │   │
│  │   → 同时作为 AI 的上下文，AI 知道要做什么            │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           步骤执行 + 实时更新                         │   │
│  │                                                      │   │
│  │   📋 任务进度：查询客户报价单                         │   │
│  │   ┌────────────────────────────────────────────┐    │   │
│  │   │ ✅ 步骤 1: 获取客户信息      [已完成]        │    │   │
│  │   │    → 获取到 quotationId: xxx               │    │   │
│  │   │ ● 步骤 2: 获取报价单详情    [执行中...]     │    │   │
│  │   │ ○ 步骤 3: 获取服务价格列表  [待执行]        │    │   │
│  │   └────────────────────────────────────────────┘    │   │
│  │                                                      │   │
│  │   → 每完成一步，立即更新前端显示                     │   │
│  │   → 用户实时看到进度                                │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│      │                                                      │
│      ▼                                                      │
│  全部完成，显示最终结果                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.1 为什么需要任务机制

| 问题 | 任务机制的解决 |
|------|----------------|
| 用户不知道 AI 在干什么 | 任务列表清晰展示计划和进度 |
| AI 执行中途可能"忘记"后续步骤 | 任务列表作为 AI 的可查阅上下文 |
| 出错时不知道是哪一步出问题 | 每步状态清晰，便于定位 |
| 用户等待焦虑 | 实时进度反馈，提升体验 |

#### 4.3.2 任务列表数据结构

```typescript
/**
 * 任务状态
 */
type TaskStatus = 'pending' | 'in_progress' | 'completed' | 'failed';

/**
 * 任务项（对应地图的一个步骤）
 */
interface TaskItem {
    /** 步骤序号（从 1 开始） */
    stepNumber: number;
    /** 任务名称 */
    name: string;
    /** 任务描述 */
    description: string;
    /** 对应的工具 ID */
    toolId: string;
    /** 任务状态 */
    status: TaskStatus;
    /** 执行结果摘要（成功时显示） */
    resultSummary?: string;
    /** 错误信息（失败时显示） */
    error?: string;
    /** 开始时间 */
    startTime?: Date;
    /** 结束时间 */
    endTime?: Date;
}

/**
 * 任务列表（地图执行时的整体进度）
 */
interface TaskList {
    /** 任务列表 ID */
    id: string;
    /** 关联的地图 ID */
    mapId: string;
    /** 地图名称 */
    mapName: string;
    /** 任务列表 */
    tasks: TaskItem[];
    /** 当前执行的步骤（从 1 开始，0 表示未开始） */
    currentStep: number;
    /** 总步骤数 */
    totalSteps: number;
    /** 整体状态 */
    status: 'pending' | 'running' | 'completed' | 'failed';
    /** 创建时间 */
    createdAt: Date;
    /** 更新时间 */
    updatedAt: Date;
}
```

#### 4.3.3 任务机制的两大作用

**作用一：反馈给前端，用户可见**

```
┌─────────────────────────────────────────────────┐
│  🤖 AI 助手                                      │
├─────────────────────────────────────────────────┤
│                                                 │
│  用户: 中信出版社的报价单                         │
│                                                 │
│  ┌───────────────────────────────────────────┐ │
│  │  📋 正在执行：查询客户报价单                │ │
│  │                                           │ │
│  │  ✅ 1. 获取客户信息          完成         │ │
│  │     → 中信出版社，quotationId: 682...     │ │
│  │                                           │ │
│  │  ● 2. 获取报价单详情         执行中...    │ │
│  │                                           │ │
│  │  ○ 3. 获取服务价格列表       等待中       │ │
│  │                                           │ │
│  │  ━━━━━━━━━━━━━━━━━━━━ 66%                │ │
│  └───────────────────────────────────────────┘ │
│                                                 │
└─────────────────────────────────────────────────┘
```

**作用二：作为 AI 上下文，AI 可查阅**

系统会把任务列表注入到 AI 的提示词中：

```
当前任务进度：
📋 任务：查询客户报价单（共 3 步）
✅ 步骤 1: 获取客户信息 - 已完成
   结果: 获取到 quotationId: 6823a0f...
● 步骤 2: 获取报价单详情 - 当前步骤
○ 步骤 3: 获取服务价格列表 - 待执行

请继续执行步骤 2...
```

这样 AI 就知道：
- 整体任务是什么
- 已经完成了什么
- 当前要做什么
- 还剩什么没做

#### 4.3.4 完整执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                    任务机制完整流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1️⃣ 用户发起请求                                            │
│     用户: "中信出版社的报价单"                               │
│                                                             │
│  2️⃣ AI 查找地图                                             │
│     AI 调用 map.search("报价单")                            │
│     → 找到地图: query_client_quotation                      │
│                                                             │
│  3️⃣ 系统生成任务列表                                        │
│     ┌─────────────────────────────────────────┐            │
│     │ TaskList {                              │            │
│     │   mapId: "query_client_quotation",      │            │
│     │   mapName: "查询客户报价单",             │            │
│     │   currentStep: 0,                       │            │
│     │   totalSteps: 3,                        │            │
│     │   status: "pending",                    │            │
│     │   tasks: [                              │            │
│     │     { stepNumber: 1, status: "pending", │            │
│     │       name: "获取客户信息", ... },       │            │
│     │     { stepNumber: 2, status: "pending", │            │
│     │       name: "获取报价单详情", ... },     │            │
│     │     { stepNumber: 3, status: "pending", │            │
│     │       name: "获取服务价格列表", ... }    │            │
│     │   ]                                     │            │
│     │ }                                       │            │
│     └─────────────────────────────────────────┘            │
│     → 返回给前端显示                                        │
│                                                             │
│  4️⃣ 开始步骤式执行                                          │
│     ┌─────────────────────────────────────────┐            │
│     │ 步骤 1 开始:                            │            │
│     │   - 更新: currentStep = 1               │            │
│     │   - 更新: tasks[0].status = "in_progress"│           │
│     │   - 返回前端（显示步骤 1 执行中）         │            │
│     │   - AI 执行 crm.client_detail           │            │
│     │   - 执行完成                            │            │
│     │   - 更新: tasks[0].status = "completed" │            │
│     │   - 更新: tasks[0].resultSummary = ...  │            │
│     │   - 返回前端（显示步骤 1 完成）          │            │
│     └─────────────────────────────────────────┘            │
│                       ↓                                     │
│     ┌─────────────────────────────────────────┐            │
│     │ 步骤 2 开始:                            │            │
│     │   - 更新: currentStep = 2               │            │
│     │   - 更新: tasks[1].status = "in_progress"│           │
│     │   - 返回前端（显示步骤 2 执行中）         │            │
│     │   - AI 执行 db.query (quotations)       │            │
│     │   - ... 同上 ...                        │            │
│     └─────────────────────────────────────────┘            │
│                       ↓                                     │
│     ┌─────────────────────────────────────────┐            │
│     │ 步骤 3 开始:                            │            │
│     │   - ... 同上 ...                        │            │
│     │   - 执行完成                            │            │
│     │   - 更新: status = "completed"          │            │
│     └─────────────────────────────────────────┘            │
│                                                             │
│  5️⃣ 全部完成                                                │
│     - 返回最终任务列表（全部步骤已完成）                     │
│     - AI 汇总输出最终结果                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.5 API 响应格式

`AgentResponse` 增加 `taskList` 字段：

```typescript
interface AgentResponse {
    /** AI 的文本回复 */
    content: string;
    /** 执行的工具调用结果 */
    toolResults?: Array<{ toolId: string; result: ToolResult }>;
    /** 需要渲染的 UI */
    uiSpec?: UISpec;
    /** 预判的下一步操作 */
    predictedActions?: PredictedAction[];
    /** 待确认的工具调用 */
    pendingToolCalls?: ToolCallRequest[];
    /** 会话 ID */
    sessionId?: string;
    
    /** ⭐ 新增：任务列表（地图执行时） */
    taskList?: TaskList;
}
```

前端收到 `taskList` 后：
- 如果 `taskList` 存在，显示任务进度面板
- 每次收到更新，刷新任务状态
- 全部完成后，可以折叠或隐藏任务面板

#### 4.3.6 前端任务面板设计

```
┌─────────────────────────────────────────────────────────────┐
│  任务面板 UI 设计                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  状态一：任务开始                                            │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  📋 查询客户报价单                        ▼ 展开/折叠  │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 0%          │ │
│  │                                                       │ │
│  │  ○ 1. 获取客户信息                                    │ │
│  │  ○ 2. 获取报价单详情                                  │ │
│  │  ○ 3. 获取服务价格列表                                │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  状态二：执行中                                              │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  📋 查询客户报价单                        ▼ 展开/折叠  │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 33%         │ │
│  │                                                       │ │
│  │  ✅ 1. 获取客户信息                                   │ │
│  │     └─ 中信出版社，quotationId: 682...                │ │
│  │  ● 2. 获取报价单详情  ⏳ 执行中...                    │ │
│  │  ○ 3. 获取服务价格列表                                │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  状态三：全部完成                                            │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  ✅ 查询客户报价单 - 已完成               ▼ 展开/折叠  │ │
│  │  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 100%        │ │
│  │                                                       │ │
│  │  ✅ 1. 获取客户信息                                   │ │
│  │  ✅ 2. 获取报价单详情                                 │ │
│  │  ✅ 3. 获取服务价格列表                               │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
│  状态四：部分失败                                            │
│  ┌───────────────────────────────────────────────────────┐ │
│  │  ⚠️ 查询客户报价单 - 执行出错             ▼ 展开/折叠  │ │
│  │                                                       │ │
│  │  ✅ 1. 获取客户信息                                   │ │
│  │  ❌ 2. 获取报价单详情                                 │ │
│  │     └─ 错误：未找到对应的报价单                       │ │
│  │  ○ 3. 获取服务价格列表 (已跳过)                       │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 4.3.7 与 nextStepPrompt 的配合

任务机制和 `nextStepPrompt` 是互补的：

| 组件 | 作用 | 面向对象 |
|------|------|----------|
| **TaskList** | 宏观进度管理 | 用户 + AI |
| **nextStepPrompt** | 微观步骤指导 | AI |

配合流程：

```
步骤 N 执行完成
    │
    ├──→ 更新 TaskList（tasks[N].status = "completed"）
    │        └──→ 返回前端，用户看到进度更新
    │
    └──→ 注入 nextStepPrompt 给 AI
             └──→ AI 知道下一步该做什么
```

---

## 5. AI 的能力边界

### 5.1 AI 可以做的（自由）

| 能力 | 说明 | 示例 |
|------|------|------|
| **理解意图** | 理解用户的真实需求 | "我想查一个客户" → 查询客户 |
| **理解上下文** | 结合对话历史理解 | 上文说查客户，"中信" → 客户名 |
| **直接查询** | 简单查询直接用核心工具 | 查客户信息 → `db.query` |
| **查询地图** | 复杂任务时查找地图 | 生成合同 → `map.search` |
| **执行地图** | 按地图步骤执行 | 步骤 1 → 步骤 2 → 步骤 3 |
| **组织输出** | 整理结果给用户 | 把 JSON 整理成表格 |
| **追问信息** | 信息不足时追问 | "请问是哪个客户？" |

### 5.2 AI 不能做的（系统守护）

| 边界 | 说明 | 守护方式 |
|------|------|----------|
| **越权访问** | 不能访问无权限的数据 | 系统检查用户权限 |
| **伪造数据** | 不能编造不存在的数据 | 工具返回真实数据 |
| **跳过审计** | 所有操作必须被记录 | 系统自动审计 |
| **直接操作数据库** | 不能绕过工具直接操作 | 只能通过注册的工具 |

### 5.3 最高原则：AI 绝不直接生成数据

```
⚠️ 这是系统的最高原则，不可违反

正确流程：
用户问 → AI 调工具 → 工具返回数据 → AI 格式化输出
         ↑                ↑
      地图指引          数据唯一来源

错误流程：
用户问 → AI 直接编造答案（❌ 严禁）
```

**责任链**：
- AI 无法执行任务 → 是 **AI 地图不够完善**（完善地图）
- AI 地图无法完成 → 是 **工具集不够完善**（完善工具）
- 工具返回数据后 → AI 按 **样例模板格式化**（参考模板）

---

## 6. 系统守门层

### 6.1 权限检查

```typescript
class PermissionGuard {
    async checkToolPermission(
        userId: string,
        toolId: string
    ): Promise<{ allowed: boolean; reason?: string }> {
        const user = await User.findById(userId);
        const roles = user.roles;
        
        const tool = await AiTool.findOne({ toolId });
        const requiredPermissions = tool.permissions || [];
        
        const hasPermission = requiredPermissions.every(
            p => roles.some(r => r.permissions.includes(p))
        );
        
        return {
            allowed: hasPermission,
            reason: hasPermission ? undefined : '权限不足'
        };
    }
}
```

### 6.2 参数验证

```typescript
class ParamValidator {
    async validate(
        toolId: string,
        params: Record<string, any>
    ): Promise<{ valid: boolean; errors?: string[] }> {
        const tool = await AiTool.findOne({ toolId });
        const schema = tool.parameterSchema;
        
        const result = validateSchema(schema, params);
        
        return {
            valid: result.success,
            errors: result.errors
        };
    }
}
```

### 6.3 审计记录

```typescript
class AuditLogger {
    async log(entry: {
        userId: string;
        toolId: string;
        params: Record<string, any>;
        result: any;
        success: boolean;
        timestamp: Date;
    }): Promise<void> {
        await AuditLog.create(entry);
    }
}
```

---

## 7. 数据模型（动态缓存）

数据模型是**动态生成**的，不再使用静态配置。

**作用**：让 AI 实时了解系统中所有数据表的：
- 表结构（字段名、类型）
- 字段说明
- 表之间的关联关系

**获取方式**：
- `schema.search` - 搜索相关表
- `datamodel.get` - 获取单个表的完整结构

---

## 8. 前端 AI 面板

### 8.1 简化设计

由于 AI 自己判断意图和行动，前端不再需要：
- ❌ 意图分类显示
- ❌ 地图匹配置信度
- ❌ 触发词命中提示

前端只需要：
- ✅ 对话消息展示
- ✅ 工具执行状态（加载中/成功/失败）
- ✅ 危险操作确认弹窗
- ✅ 快捷操作按钮

### 8.2 交互流程

```
用户输入
    ↓
显示 "AI 正在思考..."
    ↓
AI 回复（可能包含工具调用）
    ↓
如果有工具调用：显示 "正在执行..."
    ↓
如果需要确认：弹出确认框
    ↓
显示最终结果
```

---

## 9. 预期效果

### 9.1 对话示例

```
用户: 你好
AI: 你好！有什么我可以帮你的吗？

用户: 我想查一个客户
AI: 好的，请问是哪个客户？

用户: 中信出版社
AI: 正在查询...（直接用 db.query，不需要地图）

| 字段 | 信息 |
|------|------|
| 客户名称 | 中信出版社 |
| 地址 | 北京市朝阳区惠新东街甲4号... |
| 发票类型 | 增值税专用发票 |

还需要其他帮助吗？

用户: 帮我生成一份合同
AI: 好的，我来查找合同生成流程...（需要地图，调用 map.search）

找到"生成合同"流程，请问：
- 和哪个客户签？
- 什么类型的合同？

用户: 设计合同，跟中信出版社签
AI: 好的，正在按流程生成...（按地图步骤执行）

Step 1: 获取客户信息 ✓
Step 2: 匹配合同模板 ✓
Step 3: 生成合同 ✓

合同已生成：
- 合同类型：设计服务合同
- 甲方：中信出版社
- 合同编号：HT-2025-001

需要我进行修改吗？
```

### 9.2 与之前对比

| 场景 | 之前 | 现在 |
|------|------|------|
| "查一下中信出版社" | 需要匹配地图 | 直接用 db.query |
| "生成合同" | 需要匹配触发词 | 查找地图，按步骤执行 |
| 没有对应地图 | 不知道怎么办 | 提醒用户创建地图 |

---

## 10. 总结

### 核心变化

| 之前 | 现在 |
|------|------|
| 所有任务都要查地图 | 简单查询直接用核心工具 |
| 地图是"参考知识" | 地图是"可执行的任务模板" |
| AI 灵活解读地图 | AI 按地图步骤严格执行 |
| 系统控制一切 | 系统只守门 |

### 组件关系

| 组件 | 定义位置 | 用途 |
|------|----------|------|
| **核心工具** | 系统内置 | 直接查询数据 |
| **AI 地图** | 数据库配置 | 定义复杂任务的执行步骤 |
| **数据模型** | 动态生成 | 让 AI 了解数据结构 |

### 设计理念

> **让 AI 像人一样聪明地工作，系统只确保它不越界。**

- 简单任务 → 直接做（核心工具）
- 复杂任务 → 查模板（AI 地图）
- 没有模板 → 提醒创建

### 最高原则

> **AI 绝不直接生成数据，所有数据必须来自工具返回。**

```
AI 的能力边界 = AI 地图的完善程度 + 工具集的完善程度

AI 做不到 → 完善地图
地图做不到 → 完善工具
工具返回数据 → AI 格式化输出
```

这才是真正的 **AI-Native**。

---

## 附录：测试原则

### 工具与地图测试流程

> **核心原则：先单元测试，后集成测试**

每个工具和 AI 地图在投入使用前，必须经过两阶段测试：

#### 阶段 1：单元测试（必须通过）

直接调用工具/地图，验证其独立功能：

```typescript
// 单元测试示例
const result = await ToolExecutor.execute(
    'crm.client_detail',
    { clientName: '中信出版社' },
    { userId: 'test', sessionId: 'test', requestId: 'test-001' }
);
console.log('成功:', result.success);
console.log('数据:', result.data);
```

**验证要点：**
- ✅ 工具是否正确执行
- ✅ 参数是否正确解析
- ✅ 返回数据是否完整
- ✅ 错误处理是否正常

#### 阶段 2：AI 对话测试（单元测试通过后）

通过 AI Agent 调用，验证端到端流程：

```typescript
// AI 对话测试示例
const result = await processAgentRequest({
    message: '查一下中信出版社的详细信息',
    userId: 'test-user',
    context: { module: 'clients', pageType: 'list', pathname: '/clients' }
});
console.log('工具调用:', result.toolResults?.map(t => t.toolId));
console.log('AI 回复:', result.content);
```

**验证要点：**
- ✅ AI 是否正确理解意图
- ✅ AI 是否调用了正确的工具
- ✅ AI 是否正确格式化输出
- ✅ 输出是否基于真实数据（无幻觉）

### 测试状态标记

| 状态 | 含义 |
|------|------|
| 🔴 未测试 | 尚未进行任何测试 |
| 🟡 单元测试通过 | 工具独立执行正常 |
| 🟢 全部通过 | 单元测试 + AI 对话测试均通过 |
| ❌ 失败 | 测试未通过，需要修复 |

---

*文档版本：v2.3*  
*最后更新：2024年12月30日*

**更新日志**：
- v2.3: 新增 4.3 任务机制（TaskList）章节，定义任务列表数据结构和前端展示设计
- v2.2: 新增步骤式执行机制和 nextStepPrompt
- v2.1: 初始架构设计
