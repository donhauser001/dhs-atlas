import EmailSettingService from './EmailSettingService'
import formService from './FormService'
import { IForm } from '../models/Form'
import { IFormData } from '../models/FormData'
import { NotificationTemplate } from '../models/Form'
import path from 'path'
import fs from 'fs'

interface PlaceholderData {
    // åŸºæœ¬ä¿¡æ¯
    form_title?: string
    form_description?: string
    submission_id?: string
    submission_date?: string
    submission_time?: string

    // æäº¤è€…ä¿¡æ¯
    submitter_ip?: string
    submitter_email?: string
    submitter_name?: string
    submitter_username?: string
    submitter_company?: string
    submitter_enterprise?: string
    submitter_department?: string
    submitter_position?: string
    submitter_phone?: string
    submitter_role?: string

    // ç³»ç»Ÿä¿¡æ¯
    admin_email?: string
    site_title?: string
    site_url?: string

    // åŠ¨æ€å­—æ®µï¼ˆè¡¨å•ç»„ä»¶æ•°æ®ï¼‰
    [key: string]: any
}

class FormNotificationService {

    /**
     * å¤„ç†è¡¨å•æäº¤æ—¶çš„é‚®ä»¶é€šçŸ¥
     */
    async handleFormSubmissionNotification(
        formData: IFormData,
        form: IForm,
        submitterInfo?: any,
        requestInfo?: any
    ): Promise<void> {
        console.log('ğŸš¨ğŸš¨ğŸš¨ FormNotificationService.handleFormSubmissionNotification è¢«è°ƒç”¨!');
        console.log('ğŸš¨ formData._id:', formData._id);
        console.log('ğŸš¨ form.name:', form.name);
        try {
            // æ£€æŸ¥è¡¨å•æ˜¯å¦é…ç½®äº†é€šçŸ¥æ¨¡æ¿
            const notificationTemplates = form.settings?.notification?.templates
            if (!notificationTemplates || notificationTemplates.length === 0) {
                console.log('è¡¨å•æœªé…ç½®é€šçŸ¥æ¨¡æ¿ï¼Œè·³è¿‡é‚®ä»¶å‘é€')
                return
            }

            // è¿‡æ»¤å‡ºå¯ç”¨çš„ä¸”åŒ…å«'submit'è§¦å‘æ¡ä»¶çš„æ¨¡æ¿
            const submitTemplates = notificationTemplates.filter(
                template => template.enabled && template.triggers.includes('submit')
            )

            if (submitTemplates.length === 0) {
                console.log('æ²¡æœ‰å¯ç”¨çš„æäº¤é€šçŸ¥æ¨¡æ¿ï¼Œè·³è¿‡é‚®ä»¶å‘é€')
                return
            }

            // æ„å»ºå ä½ç¬¦æ•°æ®
            const placeholderData = this.buildPlaceholderData(formData, form, submitterInfo, requestInfo)

            // å‘é€æ¯ä¸ªæ¨¡æ¿çš„é‚®ä»¶
            for (const template of submitTemplates) {
                try {
                    await this.sendTemplateEmail(template, placeholderData, form, submitterInfo, formData)
                    console.log(`è¡¨å• ${form.name} çš„é€šçŸ¥æ¨¡æ¿ ${template.name} å‘é€æˆåŠŸ`)
                } catch (error) {
                    console.error(`è¡¨å• ${form.name} çš„é€šçŸ¥æ¨¡æ¿ ${template.name} å‘é€å¤±è´¥:`, error)
                    // ç»§ç»­å‘é€å…¶ä»–æ¨¡æ¿ï¼Œä¸å› ä¸ºä¸€ä¸ªæ¨¡æ¿å¤±è´¥è€Œåœæ­¢
                }
            }

        } catch (error) {
            console.error('è¡¨å•é€šçŸ¥å‘é€å¤±è´¥:', error)
            // é‚®ä»¶å‘é€å¤±è´¥ä¸åº”è¯¥å½±å“è¡¨å•æäº¤æˆåŠŸ
        }
    }

    /**
     * å‘é€æ¨¡æ¿é‚®ä»¶
     */
    private async sendTemplateEmail(
        template: NotificationTemplate,
        placeholderData: PlaceholderData,
        form: IForm,
        submitterInfo?: any,
        formData?: IFormData
    ): Promise<void> {
        try {
            // æ›¿æ¢ä¸»é¢˜ä¸­çš„å ä½ç¬¦
            const subject = this.replacePlaceholders(template.subject, placeholderData)

            // æ›¿æ¢å†…å®¹ä¸­çš„å ä½ç¬¦
            const rawContent = this.replacePlaceholders(template.content, placeholderData)

            // åŒ…è£…é‚®ä»¶å†…å®¹åˆ°1200pxå®¹å™¨ä¸­
            const content = this.wrapEmailContent(rawContent)

            // ç¡®å®šæ”¶ä»¶äººé‚®ç®±
            const recipients = await this.getRecipients(template, submitterInfo)

            if (recipients.length === 0) {
                console.warn(`æ¨¡æ¿ ${template.name} æ²¡æœ‰æœ‰æ•ˆçš„æ”¶ä»¶äººé‚®ç®±`)
                return
            }

            // å¤„ç†é‚®ä»¶é™„ä»¶ - ä»åŸå§‹è¡¨å•æ•°æ®ä¸­æå–
            const attachments = await this.prepareEmailAttachments(placeholderData, form, formData)

            // å‘é€é‚®ä»¶ç»™æ¯ä¸ªæ”¶ä»¶äºº
            for (const recipient of recipients) {
                await EmailSettingService.sendEmail(recipient, subject, content, true, attachments)
                console.log(`é‚®ä»¶å‘é€æˆåŠŸ: ${template.name} -> ${recipient}${attachments.length > 0 ? ` (${attachments.length}ä¸ªé™„ä»¶)` : ''}`)
            }

        } catch (error) {
            console.error(`æ¨¡æ¿ ${template.name} é‚®ä»¶å‘é€å¤±è´¥:`, error)
            throw error
        }
    }

    /**
     * æ„å»ºå ä½ç¬¦æ•°æ®
     */
    private buildPlaceholderData(
        formData: IFormData,
        form: IForm,
        submitterInfo?: any,
        requestInfo?: any
    ): PlaceholderData {
        const now = new Date()

        const data: PlaceholderData = {
            // åŸºæœ¬ä¿¡æ¯
            form_title: form.name,
            form_description: form.description || '',
            submission_id: formData._id?.toString() || 'unknown',
            submission_date: now.toLocaleDateString('zh-CN'),
            submission_time: now.toLocaleTimeString('zh-CN'),

            // æäº¤è€…ä¿¡æ¯
            submitter_name: formData.submitterName || 'åŒ¿åç”¨æˆ·',
            submitter_ip: requestInfo?.ip || '',

            // ç³»ç»Ÿä¿¡æ¯
            admin_email: process.env.ADMIN_EMAIL || '',
            site_title: process.env.SITE_TITLE || 'è¡¨å•ç³»ç»Ÿ',
            site_url: process.env.SITE_URL || 'http://localhost:3000'
        }

        // æ·»åŠ æäº¤è€…è¯¦ç»†ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯ç™»å½•ç”¨æˆ·ï¼‰
        if (submitterInfo) {
            data.submitter_email = submitterInfo.email || ''
            data.submitter_username = submitterInfo.username || ''
            data.submitter_company = submitterInfo.company || ''
            data.submitter_enterprise = submitterInfo.enterprise || ''
            data.submitter_department = submitterInfo.department || ''
            data.submitter_position = submitterInfo.position || ''
            data.submitter_phone = submitterInfo.phone || ''
            data.submitter_role = submitterInfo.role || ''
        }

        // è°ƒè¯•æ—¥å¿—ï¼šæ‰“å°è¡¨å•æ•°æ®å’Œç»“æ„
        console.log('ğŸ” é‚®ä»¶é€šçŸ¥è°ƒè¯• - è¡¨å•åŸºæœ¬ä¿¡æ¯:', {
            formName: form.name,
            formId: formData.formId,
            submissionDataExists: !!formData.submissionData,
            submissionDataType: typeof formData.submissionData,
            formContentExists: !!form.content,
            formContentType: typeof form.content
        })

        console.log('ğŸ” é‚®ä»¶é€šçŸ¥è°ƒè¯• - æäº¤æ•°æ®è¯¦æƒ…:', {
            submissionData: formData.submissionData,
            submissionDataKeys: formData.submissionData ? Object.keys(formData.submissionData) : [],
        })

        console.log('ğŸ” é‚®ä»¶é€šçŸ¥è°ƒè¯• - è¡¨å•å†…å®¹ç»“æ„:', {
            formContent: form.content,
            hasComponents: !!(form.content && form.content.components),
            componentsCount: form.content?.components?.length || 0
        })

        // ğŸ”¥ æ–°æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨å‰ç«¯çš„æ¸²æŸ“é€»è¾‘ç”Ÿæˆé‚®ä»¶å†…å®¹
        if (formData.submissionData && typeof formData.submissionData === 'object') {
            console.log('ğŸ” é‚®ä»¶é€šçŸ¥è°ƒè¯• - å¼€å§‹ç”Ÿæˆè¡¨å•æ•°æ®å±•ç¤ºå†…å®¹')

            // ç›´æ¥å¤„ç†å‰ç«¯æ ¼å¼çš„æäº¤æ•°æ®ï¼Œç”Ÿæˆå¯è¯»çš„å†…å®¹
            const formattedContent = this.generateFormattedContent(formData.submissionData)
            console.log('ğŸ” ç”Ÿæˆçš„æ ¼å¼åŒ–å†…å®¹:', formattedContent)

            // å°†æ ¼å¼åŒ–å†…å®¹ä½œä¸ºä¸€ä¸ªæ•´ä½“å ä½ç¬¦æ·»åŠ 
            data['form_data'] = formattedContent

            // ğŸ¯ åŒæ—¶ä¸ºæ¯ä¸ªç»„ä»¶æ ‡ç­¾ç”Ÿæˆå•ç‹¬çš„å ä½ç¬¦ï¼ˆå…¼å®¹æ—§é‚®ä»¶æ¨¡æ¿ï¼‰
            for (const [componentId, componentData] of Object.entries(formData.submissionData)) {
                if (componentData && typeof componentData === 'object' && 'value' in componentData) {
                    const { value, label, type } = componentData as any

                    // è·³è¿‡ç©ºå€¼
                    if (this.isEmpty(value)) {
                        continue
                    }

                    // ğŸ”¥ æ’é™¤å›¾ç‰‡å±•ç¤ºå­—æ®µå’Œå€’è®¡æ—¶å­—æ®µ
                    if (type === 'image' || type === 'countdown') {
                        console.log(`ğŸš« è·³è¿‡ç»„ä»¶å ä½ç¬¦: ${type} - ${label}`)
                        continue
                    }

                    // ğŸ”¥ ç‰¹æ®Šå¤„ç†ç»„ä»¶ï¼šç›´æ¥ç”ŸæˆHTML
                    let formattedValue;
                    if (type === 'order' && Array.isArray(value)) {
                        console.log(`ğŸ” å¤„ç†è®¢å•ç»„ä»¶å ä½ç¬¦ ${label}:`, { type, valueType: typeof value, isArray: Array.isArray(value), firstItem: value[0] });
                        formattedValue = this.generateOrderTable(value);
                        console.log(`âœ… è®¢å•ç»„ä»¶å ä½ç¬¦ ${label} ç”ŸæˆHTMLè¡¨æ ¼æˆåŠŸ`);
                    } else if (type === 'upload' && Array.isArray(value)) {
                        console.log(`ğŸ” å¤„ç†æ–‡ä»¶ä¸Šä¼ ç»„ä»¶å ä½ç¬¦ ${label}:`, { type, valueType: typeof value, isArray: Array.isArray(value), firstItem: value[0] });
                        formattedValue = this.generateFileList(value);
                        console.log(`âœ… æ–‡ä»¶ä¸Šä¼ ç»„ä»¶å ä½ç¬¦ ${label} ç”ŸæˆHTMLåˆ—è¡¨æˆåŠŸ`);
                    } else if (type === 'quotation' && value && typeof value === 'object') {
                        console.log(`ğŸ” å¤„ç†æŠ¥ä»·å•ç»„ä»¶å ä½ç¬¦ ${label}:`, { type, valueType: typeof value, hasServices: !!(value.services) });

                        // ğŸ”¥ ä¸ºæŠ¥ä»·å•ç”Ÿæˆä¸¤ç§ä¸“ç”¨å ä½ç¬¦
                        // 1. æŠ¥ä»·å•åç§°å ä½ç¬¦
                        const nameKey = this.labelToPlaceholder(label + 'åç§°');
                        const nameValue = value.name || 'æœªçŸ¥æŠ¥ä»·å•';
                        data[nameKey] = nameValue;
                        console.log(`âœ… æ·»åŠ æŠ¥ä»·å•åç§°å ä½ç¬¦: {${nameKey}} = "${nameValue}"`);

                        // 2. æŠ¥ä»·å•å†…å®¹å ä½ç¬¦
                        const contentKey = this.labelToPlaceholder(label + 'å†…å®¹');
                        const contentValue = this.generateQuotationTable(value);
                        data[contentKey] = contentValue;
                        console.log(`âœ… æ·»åŠ æŠ¥ä»·å•å†…å®¹å ä½ç¬¦: {${contentKey}} = HTMLè¡¨æ ¼`);

                        // ğŸ”¥ æŠ¥ä»·å•ç»„ä»¶ä¸ç”Ÿæˆé»˜è®¤å ä½ç¬¦ï¼Œè·³è¿‡
                        continue;
                    } else {
                        formattedValue = this.formatValueForEmail(value, type);
                    }

                    if (formattedValue !== undefined) {
                        const placeholderKey = this.labelToPlaceholder(label)
                        data[placeholderKey] = formattedValue

                        console.log(`ğŸ” æ·»åŠ ç»„ä»¶å ä½ç¬¦: {${placeholderKey}} = "${formattedValue.substring(0, 100)}..."`)
                    }
                }
            }

            console.log('ğŸ” é‚®ä»¶é€šçŸ¥è°ƒè¯• - å®Œæˆæ·»åŠ è¡¨å•æ•°æ®å†…å®¹ï¼Œæœ€ç»ˆå ä½ç¬¦æ•°æ®:', data)
        } else {
            console.log('âš ï¸ é‚®ä»¶é€šçŸ¥è°ƒè¯• - è·³è¿‡è¡¨å•æ•°æ®ï¼šsubmissionDataä¸å­˜åœ¨æˆ–ä¸æ˜¯å¯¹è±¡')
        }

        return data
    }

    /**
     * ç”Ÿæˆæ ¼å¼åŒ–çš„è¡¨å•å†…å®¹ï¼ˆç±»ä¼¼å‰ç«¯çš„æ¸²æŸ“é€»è¾‘ï¼‰
     */
    private generateFormattedContent(submissionData: any): string {
        const lines: string[] = []

        for (const [componentId, componentData] of Object.entries(submissionData)) {
            if (componentData && typeof componentData === 'object' && 'value' in componentData) {
                const { value, label, type } = componentData as any

                // è·³è¿‡ç©ºå€¼
                if (this.isEmpty(value)) {
                    continue
                }

                // ğŸ”¥ æ’é™¤å›¾ç‰‡å±•ç¤ºå­—æ®µå’Œå€’è®¡æ—¶å­—æ®µ
                if (type === 'image' || type === 'countdown') {
                    continue
                }

                // ğŸ”¥ ç‰¹æ®Šå¤„ç†ç»„ä»¶ï¼šç›´æ¥å¤„ç†åŸå§‹æ•°ç»„æ•°æ®
                if (type === 'order' && Array.isArray(value)) {
                    console.log(`ğŸ” æ ¼å¼åŒ–è®¢å•å­—æ®µ ${label}:`, { type, valueType: typeof value, isArray: Array.isArray(value), firstItem: value[0] });
                    const tableHtml = this.generateOrderTable(value);
                    console.log(`âœ… è®¢å•å­—æ®µ ${label} ç”ŸæˆHTMLè¡¨æ ¼æˆåŠŸ`);
                    lines.push(`${label}: ${tableHtml}`);
                } else if (type === 'upload' && Array.isArray(value)) {
                    console.log(`ğŸ” æ ¼å¼åŒ–æ–‡ä»¶ä¸Šä¼ å­—æ®µ ${label}:`, { type, valueType: typeof value, isArray: Array.isArray(value), firstItem: value[0] });
                    const fileListHtml = this.generateFileList(value);
                    console.log(`âœ… æ–‡ä»¶ä¸Šä¼ å­—æ®µ ${label} ç”ŸæˆHTMLåˆ—è¡¨æˆåŠŸ`);
                    lines.push(`${label}: ${fileListHtml}`);
                } else if (type === 'quotation' && value && typeof value === 'object') {
                    console.log(`ğŸ” æ ¼å¼åŒ–æŠ¥ä»·å•å­—æ®µ ${label}:`, { type, valueType: typeof value, hasServices: !!(value.services) });
                    // ğŸ”¥ æŠ¥ä»·å•åœ¨æ•´ä½“å†…å®¹ä¸­åªæ˜¾ç¤ºåç§°ï¼Œè¯¦ç»†å†…å®¹é€šè¿‡ä¸“ç”¨å ä½ç¬¦è·å–
                    const quotationName = value.name || 'æœªçŸ¥æŠ¥ä»·å•';
                    console.log(`âœ… æŠ¥ä»·å•å­—æ®µ ${label} æ˜¾ç¤ºåç§°: ${quotationName}`);
                    lines.push(`${label}: ${quotationName}`);
                } else {
                    const formattedValue = this.formatValueForEmail(value, type)
                    console.log(`ğŸ” æ ¼å¼åŒ–å­—æ®µ ${label} (${type}):`, { value, formattedValue: formattedValue.substring(0, 100) + '...' });
                    lines.push(`${label}: ${formattedValue}`);
                }
            } else {
                // å¤„ç†ç®€å•æ ¼å¼çš„æ•°æ®
                const formattedValue = this.formatValueForEmail(componentData, 'text')
                lines.push(`${componentId}: ${formattedValue}`)
            }
        }

        return lines.join('\n')
    }

    /**
     * æ ¼å¼åŒ–å€¼ç”¨äºé‚®ä»¶æ˜¾ç¤ºï¼ˆç±»ä¼¼å‰ç«¯çš„ formatValue å‡½æ•°ï¼‰
     */
    private formatValueForEmail(val: any, type: string): string {
        // æ£€æŸ¥ç©ºå€¼
        if (this.isEmpty(val)) {
            return '(ç©º)'
        }

        // å¤„ç†æ•°ç»„
        if (Array.isArray(val)) {
            if (val.length === 0) {
                return '(ç©ºåˆ—è¡¨)'
            }

            // ğŸ”¥ ç‰¹æ®Šå¤„ç†ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ä¸Šä¼ æ•°ç»„æ•°æ®
            if (val.length > 0 && val[0] && typeof val[0] === 'object') {
                const firstItem = val[0];

                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶å¯¹è±¡ï¼ˆåŒ…å« name, size, type ç­‰æ–‡ä»¶å±æ€§ï¼‰
                if (firstItem.name && (firstItem.size !== undefined || firstItem.type)) {
                    console.log('âœ… æ£€æµ‹åˆ°æ–‡ä»¶ä¸Šä¼ æ•°æ®ï¼Œç”Ÿæˆæ–‡ä»¶åˆ—è¡¨');
                    return this.generateFileList(val);
                }

                // æ£€æŸ¥æ˜¯å¦æ˜¯è®¢å•æ•°ç»„æ•°æ®
                console.log('ğŸ” æ£€æŸ¥è®¢å•æ•°ç»„æ•°æ®:', {
                    hasServiceName: !!(firstItem.serviceName || firstItem['æœåŠ¡åç§°']),
                    hasUnitPrice: !!(firstItem.unitPrice || firstItem['å•ä»·']),
                    hasQuantity: !!(firstItem.quantity || firstItem['æ•°é‡']),
                    firstItem: firstItem
                });

                if ((firstItem.serviceName || firstItem['æœåŠ¡åç§°']) &&
                    (firstItem.unitPrice || firstItem['å•ä»·']) &&
                    (firstItem.quantity || firstItem['æ•°é‡'])) {
                    console.log('âœ… æ£€æµ‹åˆ°è®¢å•æ•°æ®ï¼Œç”ŸæˆHTMLè¡¨æ ¼');
                    return this.generateOrderTable(val);
                }
            }

            // å¦‚æœæ•°ç»„åŒ…å«å¯¹è±¡ï¼Œæ ¼å¼åŒ–æ˜¾ç¤º
            if (typeof val[0] === 'object') {
                return val.map(item => {
                    if (item && typeof item === 'object') {
                        return Object.entries(item)
                            .map(([k, v]) => `${k}: ${v}`)
                            .join(', ')
                    }
                    return String(item)
                }).join('; ')
            }

            // æ™®é€šæ•°ç»„ï¼ˆå¦‚é€‰æ‹©æŒ‰é’®çš„å€¼ï¼‰
            return val.join(', ')
        }

        // å¤„ç†å¤æ‚å¯¹è±¡
        if (typeof val === 'object' && val !== null) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šå¯¹è±¡æ ¼å¼
            if (val.name || val.title) {
                return val.name || val.title
            }

            // ğŸ”¥ ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯è®¢å•æ•°ç»„æ•°æ®ï¼Œç”ŸæˆHTMLè¡¨æ ¼
            if (Array.isArray(val) && val.length > 0 && val[0] && typeof val[0] === 'object') {
                // æ£€æŸ¥æ˜¯å¦åŒ…å«è®¢å•é¡¹çš„å…¸å‹å­—æ®µ
                const firstItem = val[0];
                if ((firstItem.serviceName || firstItem['æœåŠ¡åç§°']) &&
                    (firstItem.unitPrice || firstItem['å•ä»·']) &&
                    (firstItem.quantity || firstItem['æ•°é‡'])) {
                    return this.generateOrderTable(val);
                }
            }

            // é€šç”¨å¯¹è±¡æ ¼å¼åŒ–
            return Object.entries(val)
                .map(([k, v]) => `${k}: ${v}`)
                .join(', ')
        }

        // æ ¹æ®ç±»å‹ç‰¹æ®Šå¤„ç†
        switch (type) {
            case 'date':
                return new Date(val).toLocaleDateString('zh-CN')

            case 'textarea':
            case 'presetText':
            case 'instruction':
            case 'articleContent':
                // ä¿æŒæ¢è¡Œæ ¼å¼
                return String(val).replace(/\n/g, '\n')

            case 'checkbox':
                return val ? 'æ˜¯' : 'å¦'

            case 'slider':
                return `${val} åˆ†`

            default:
                return String(val)
        }
    }

    /**
     * æ£€æŸ¥å€¼æ˜¯å¦ä¸ºç©º
     */
    private isEmpty(val: any): boolean {
        return val === null ||
            val === undefined ||
            val === '' ||
            (Array.isArray(val) && val.length === 0) ||
            (typeof val === 'object' && val !== null && Object.keys(val).length === 0)
    }

    /**
     * ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨HTML
     */
    private generateFileList(files: any[]): string {
        if (!Array.isArray(files) || files.length === 0) {
            return 'æš‚æ— æ–‡ä»¶';
        }

        // ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨HTML - é€‚åº”é‚®ä»¶å®¹å™¨å®½åº¦
        let fileListHtml = `
<div style="width: 100%; margin: 32px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); overflow: hidden; border: 1px solid #e8e8e8;">
    <div style="padding: 28px 40px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-bottom: 1px solid #e8e8e8;">
        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px;">é™„ä»¶æ–‡ä»¶</h3>
        <p style="margin: 6px 0 0; font-size: 14px; color: #666; font-weight: 400; opacity: 0.8;">File Attachments Â· å…± ${files.length} ä¸ªæ–‡ä»¶ Â· å·²ä½œä¸ºé‚®ä»¶é™„ä»¶å‘é€</p>
    </div>
    <div style="padding: 0;">`;

        files.forEach((file, index) => {
            if (file && typeof file === 'object') {
                const fileName = file.name || 'æœªçŸ¥æ–‡ä»¶';
                const fileSize = file.size ? (file.size / 1024 / 1024).toFixed(2) : '0';
                const fileType = file.type || '';

                // æ ¹æ®æ–‡ä»¶ç±»å‹è·å–çº¿æ€§SVGå›¾æ ‡ï¼ˆå†…è”SVGæ›´å…¼å®¹é‚®ä»¶å®¢æˆ·ç«¯ï¼‰
                let svgIcon = '';
                if (fileType.startsWith('image/')) {
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21,15 16,10 5,21"/></svg>';
                } else if (fileType.includes('pdf')) {
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>';
                } else if (fileType.includes('word') || fileType.includes('document')) {
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>';
                } else if (fileType.includes('excel') || fileType.includes('spreadsheet')) {
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#388e3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><path d="M8,13h8"/><path d="M8,17h8"/><path d="M8,9h2"/></svg>';
                } else if (fileType.includes('powerpoint') || fileType.includes('presentation')) {
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><path d="M9,17v-4h3a2 2 0 0 0 0-4H9"/></svg>';
                } else if (fileType.includes('zip') || fileType.includes('archive')) {
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#795548" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21,8 21,21 3,21 3,8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>';
                } else {
                    // é»˜è®¤æ–‡æ¡£å›¾æ ‡
                    svgIcon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/></svg>';
                }

                // æ–‡ä»¶è¡Œæ ·å¼
                const borderBottom = index < files.length - 1 ? 'border-bottom: 1px solid #f5f5f5;' : '';

                fileListHtml += `
        <div style="padding: 24px 40px; display: flex; align-items: center; ${borderBottom} transition: background-color 0.2s ease;">
            <div style="width: 24px; height: 24px; margin-right: 20px; display: flex; align-items: center; justify-content: center;">
                ${svgIcon}
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-size: 14px; font-weight: 500; color: #1a1a1a; line-height: 1.4; word-break: break-all; margin-bottom: 6px;">${fileName}</div>
                <div style="font-size: 14px; color: #888; font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; letter-spacing: 0.5px;">${fileSize} MB</div>
            </div>
        </div>`;
            }
        });

        fileListHtml += `
    </div>
</div>`;

        return fileListHtml;
    }

    /**
     * ç”ŸæˆæŠ¥ä»·å•HTMLè¡¨æ ¼
     */
    private generateQuotationTable(quotationData: any): string {
        if (!quotationData || typeof quotationData !== 'object') {
            return 'æš‚æ— æŠ¥ä»·å•æ•°æ®';
        }

        const quotationName = quotationData.name || 'æœªçŸ¥æŠ¥ä»·å•';
        const services = quotationData.services || [];
        const totalAmount = quotationData.totalAmount || 0;
        const description = quotationData.description || '';

        if (!Array.isArray(services) || services.length === 0) {
            return `
<div style="width: 100%; margin: 32px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); overflow: hidden; border: 1px solid #e8e8e8;">
    <div style="padding: 28px 40px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-bottom: 1px solid #e8e8e8;">
        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px;">${quotationName}</h3>
        <p style="margin: 6px 0 0; font-size: 14px; color: #666; font-weight: 400; opacity: 0.8;">Quotation Details Â· æš‚æ— æœåŠ¡é¡¹ç›®</p>
    </div>
    <div style="padding: 40px; text-align: center; color: #999;">
        <p style="margin: 0; font-size: 14px;">è¯¥æŠ¥ä»·å•æš‚æ— æœåŠ¡é¡¹ç›®</p>
    </div>
</div>`;
        }

        // ç”Ÿæˆæç®€é£æ ¼çš„HTMLè¡¨æ ¼å¡ç‰‡ - é€‚åº”é‚®ä»¶å®¹å™¨å®½åº¦
        let tableHtml = `
<div style="width: 100%; margin: 32px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); overflow: hidden; border: 1px solid #e8e8e8;">
    <div style="padding: 28px 40px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-bottom: 1px solid #e8e8e8;">
        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px;">${quotationName}</h3>
        <p style="margin: 6px 0 0; font-size: 14px; color: #666; font-weight: 400; opacity: 0.8;">Quotation Details${description ? ' Â· ' + description : ''}</p>
    </div>
    <table style="width: 100%; border-collapse: collapse; background: #ffffff;">
        <thead>
            <tr style="background: #ffffff; border-bottom: 1px solid #f0f0f0;">
                <th style="padding: 20px 32px; text-align: center; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 50px;">No.</th>
                <th style="padding: 20px 32px; text-align: left; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px;">æœåŠ¡é¡¹ç›®</th>
                <th style="padding: 20px 32px; text-align: left; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 90px;">åˆ†ç±»</th>
                <th style="padding: 20px 32px; text-align: left; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 120px;">ä»·æ ¼è¯´æ˜</th>
                <th style="padding: 20px 32px; text-align: right; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 100px;">å•ä»·</th>
            </tr>
        </thead>
        <tbody>`;

        services.forEach((service, index) => {
            if (service && typeof service === 'object') {
                const serviceName = service.serviceName || service.name || 'æœªçŸ¥æœåŠ¡';
                const category = service.categoryName || service.category || 'æœªåˆ†ç±»';
                const priceDescription = service.renderedPriceDescription || service.priceDescription || service.description || 'â€”';
                const unitPrice = parseFloat(service.unitPrice || service.price || 0);

                // æç®€è¡Œæ ·å¼
                const isLast = index === services.length - 1;
                const borderBottom = isLast ? 'none' : '1px solid #f5f5f5';

                tableHtml += `
            <tr style="border-bottom: ${borderBottom}; transition: background-color 0.2s ease;">
                <td style="padding: 24px 32px; text-align: center; font-size: 14px; color: #999; font-weight: 500;">${String(index + 1).padStart(2, '0')}</td>
                <td style="padding: 24px 32px; font-size: 14px; color: #1a1a1a; font-weight: 500; line-height: 1.4;">${serviceName}</td>
                <td style="padding: 24px 32px; font-size: 13px; color: #666; font-weight: 400;">${category}</td>
                <td style="padding: 24px 32px; font-size: 13px; color: #666; font-weight: 400; line-height: 1.4; max-width: 200px; word-wrap: break-word;">${priceDescription}</td>
                <td style="padding: 24px 32px; text-align: right; font-size: 15px; color: #333; font-weight: 500; font-family: 'SF Mono', Monaco, monospace;">Â¥${unitPrice.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            </tr>`;
            }
        });

        // æ·»åŠ æ€»è®¡è¡Œ
        tableHtml += `
        </tbody>
    </table>
    <div style="padding: 32px 40px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-top: 1px solid #e8e8e8;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 14px; color: #555; font-weight: 500; margin-bottom: 6px; letter-spacing: 0.5px;">æŠ¥ä»·æ€»é¢</div>
                <div style="font-size: 14px; color: #888; opacity: 0.8;">Total Quotation Amount</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 28px; font-weight: 800; color: #1a1a1a; font-family: 'SF Mono', Monaco, monospace; letter-spacing: -1px;">Â¥${totalAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                <div style="font-size: 14px; color: #888; margin-top: 4px; opacity: 0.7;">å«ç¨ä»·æ ¼</div>
            </div>
        </div>
    </div>
</div>`;

        return tableHtml;
    }

    /**
     * ç”Ÿæˆè®¢å•HTMLè¡¨æ ¼
     */
    private generateOrderTable(orderItems: any[]): string {
        if (!Array.isArray(orderItems) || orderItems.length === 0) {
            return 'æš‚æ— è®¢å•é¡¹';
        }

        // ç”Ÿæˆæç®€é£æ ¼çš„HTMLè¡¨æ ¼å¡ç‰‡ - é€‚åº”é‚®ä»¶å®¹å™¨å®½åº¦
        let tableHtml = `
<div style="width: 100%; margin: 32px 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #ffffff; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); overflow: hidden; border: 1px solid #e8e8e8;">
    <div style="padding: 28px 40px 24px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-bottom: 1px solid #e8e8e8;">
        <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px;">è®¢å•æ˜ç»†</h3>
        <p style="margin: 6px 0 0; font-size: 14px; color: #666; font-weight: 400; opacity: 0.8;">Order Details</p>
    </div>
    <table style="width: 100%; border-collapse: collapse; background: #ffffff;">
        <thead>
            <tr style="background: #ffffff; border-bottom: 1px solid #f0f0f0;">
                <th style="padding: 20px 32px; text-align: center; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 50px;">No.</th>
                <th style="padding: 20px 32px; text-align: left; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px;">æœåŠ¡é¡¹ç›®</th>
                <th style="padding: 20px 32px; text-align: left; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 90px;">åˆ†ç±»</th>
                <th style="padding: 20px 32px; text-align: right; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 100px;">å•ä»·</th>
                <th style="padding: 20px 32px; text-align: center; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 60px;">æ•°é‡</th>
                <th style="padding: 20px 32px; text-align: right; font-size: 14px; font-weight: 500; color: #555; text-transform: uppercase; letter-spacing: 1px; width: 120px;">å°è®¡</th>
            </tr>
        </thead>
        <tbody>`;

        let totalAmount = 0;

        orderItems.forEach((item, index) => {
            if (item && typeof item === 'object') {
                const serviceName = item.æœåŠ¡åç§° || item.serviceName || 'æœªçŸ¥æœåŠ¡';
                const category = item.åˆ†ç±» || item.categoryName || 'æœªåˆ†ç±»';
                const unitPrice = parseFloat(item.å•ä»· || item.unitPrice || 0);
                const quantity = item.æ•°é‡ || item.quantity || 0;
                const unit = item.å•ä½ || item.unit || 'é¡¹';
                const subtotal = parseFloat(item.å°è®¡ || item.subtotal || 0);

                totalAmount += subtotal;

                // æç®€è¡Œæ ·å¼
                const isLast = index === orderItems.length - 1;
                const borderBottom = isLast ? 'none' : '1px solid #f5f5f5';

                tableHtml += `
            <tr style="border-bottom: ${borderBottom}; transition: background-color 0.2s ease;">
                <td style="padding: 24px 32px; text-align: center; font-size: 14px; color: #999; font-weight: 500;">${String(index + 1).padStart(2, '0')}</td>
                <td style="padding: 24px 32px; font-size: 14px; color: #1a1a1a; font-weight: 500; line-height: 1.4;">${serviceName}</td>
                <td style="padding: 24px 32px; font-size: 13p'x; color: #666; font-weight: 400;">${category}</td>
                <td style="padding: 24px 32px; text-align: right; font-size: 15px; color: #333; font-weight: 500; font-family: 'SF Mono', Monaco, monospace;">Â¥${unitPrice.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                <td style="padding: 24px 32px; text-align: center; font-size: 14px; color: #666; font-weight: 500;">${quantity}<span style="font-size: 12px; color: #999; margin-left: 3px;">${unit}</span></td>
                <td style="padding: 24px 32px; text-align: right; font-size: 14px; color: #1a1a1a; font-weight: 700; font-family: 'SF Mono', Monaco, monospace;">Â¥${subtotal.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            </tr>`;
            }
        });

        // æ·»åŠ æ€»è®¡è¡Œ
        tableHtml += `
        </tbody>
    </table>
    <div style="padding: 32px 40px; background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%); border-top: 1px solid #e8e8e8;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 14px; color: #555; font-weight: 500; margin-bottom: 6px; letter-spacing: 0.5px;">è®¢å•æ€»é¢</div>
                <div style="font-size: 14px; color: #888; opacity: 0.8;">Total Amount</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 28px; font-weight: 800; color: #1a1a1a; font-family: 'SF Mono', Monaco, monospace; letter-spacing: -1px;">Â¥${totalAmount.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                <div style="font-size: 14px; color: #888; margin-top: 4px; opacity: 0.7;">å«ç¨ä»·æ ¼</div>
            </div>
        </div>
    </div>
</div>`;

        return tableHtml;
    }

    /**
     * æ·»åŠ è¡¨å•å­—æ®µå ä½ç¬¦ï¼ˆä¿ç•™åŸæ–¹æ³•ä»¥é˜²éœ€è¦ï¼‰
     */
    private addFormFieldPlaceholders(
        data: PlaceholderData,
        submissionData: any,
        formContent: any,
        componentLabels?: any
    ): void {
        try {
            // ğŸ”¥ ä¿®å¤ï¼šä»è¡¨å•å†…å®¹çš„æ­£ç¡®è·¯å¾„æå–ç»„ä»¶é…ç½®
            // è¡¨å•é…ç½®ç»“æ„: { config: { components: [...] } }
            const components = formContent?.config?.components || formContent?.components || []
            console.log(`ğŸ” è¡¨å•ç»„ä»¶åˆ†æ - æ€»ç»„ä»¶æ•°: ${components.length}`)
            console.log(`ğŸ” è¡¨å•ç»„ä»¶é…ç½®è·¯å¾„æ£€æŸ¥:`, {
                hasFormContent: !!formContent,
                hasConfig: !!formContent?.config,
                hasConfigComponents: !!formContent?.config?.components,
                hasDirectComponents: !!formContent?.components,
                configComponentsLength: formContent?.config?.components?.length || 0,
                directComponentsLength: formContent?.components?.length || 0
            })

            for (let i = 0; i < components.length; i++) {
                const component = components[i]
                const componentId = component.id

                // ğŸ”¥ ä¼˜å…ˆä½¿ç”¨ä»å‰ç«¯æäº¤æ•°æ®ä¸­æå–çš„æ ‡ç­¾ï¼Œå…¶æ¬¡ä½¿ç”¨è¡¨å•é…ç½®ä¸­çš„æ ‡ç­¾
                const componentLabel = (componentLabels && componentLabels[componentId]) ||
                    component.label ||
                    component.placeholder || ''

                console.log(`ğŸ” ç»„ä»¶[${i}] - ID: ${componentId}, ç±»å‹: ${component.type}, æ ‡ç­¾: "${componentLabel}"`)
                console.log(`ğŸ” ç»„ä»¶[${i}] - æ ‡ç­¾æ¥æº: ${componentLabels && componentLabels[componentId] ? 'å‰ç«¯æ•°æ®' : 'è¡¨å•é…ç½®'}`)

                // è·³è¿‡ä¸éœ€è¦ç”Ÿæˆå ä½ç¬¦çš„ç»„ä»¶ç±»å‹
                const excludeTypes = ['divider', 'html', 'steps', 'group', 'columnContainer', 'pagination']
                if (excludeTypes.includes(component.type)) {
                    console.log(`â­ï¸ ç»„ä»¶[${i}] - è·³è¿‡ï¼Œç±»å‹ ${component.type} ä¸éœ€è¦å ä½ç¬¦`)
                    continue
                }

                // è·å–è¯¥ç»„ä»¶çš„æäº¤æ•°æ®
                const fieldValue = submissionData[componentId]
                console.log(`ğŸ” ç»„ä»¶[${i}] - æäº¤æ•°æ®å€¼:`, fieldValue, `(ç±»å‹: ${typeof fieldValue})`)

                if (fieldValue !== undefined && fieldValue !== null) {
                    // ç”Ÿæˆå ä½ç¬¦é”®åï¼ˆåŸºäºæ ‡ç­¾ï¼‰
                    const placeholderKey = this.labelToPlaceholder(componentLabel)
                    console.log(`ğŸ” ç»„ä»¶[${i}] - ç”Ÿæˆå ä½ç¬¦é”®å: "${placeholderKey}" (ä»æ ‡ç­¾: "${componentLabel}")`)

                    // æ ¼å¼åŒ–å­—æ®µå€¼
                    const formattedValue = this.formatFieldValue(fieldValue, component.type)
                    data[placeholderKey] = formattedValue
                    console.log(`âœ… ç»„ä»¶[${i}] - æ·»åŠ å ä½ç¬¦: {${placeholderKey}} = "${formattedValue}"`)
                } else {
                    console.log(`âš ï¸ ç»„ä»¶[${i}] - è·³è¿‡ï¼Œæäº¤æ•°æ®ä¸ºç©ºæˆ–æœªå®šä¹‰`)
                }
            }

            console.log('ğŸ” æœ€ç»ˆç”Ÿæˆçš„æ‰€æœ‰å ä½ç¬¦é”®å:', Object.keys(data).filter(key =>
                !['form_title', 'form_description', 'submission_id', 'submission_date', 'submission_time',
                    'submitter_name', 'submitter_ip', 'submitter_email', 'submitter_username', 'submitter_company',
                    'submitter_enterprise', 'submitter_department', 'submitter_position', 'submitter_phone',
                    'submitter_role', 'admin_email', 'site_title', 'site_url'].includes(key)
            ))
        } catch (error) {
            console.error('âŒ æ·»åŠ è¡¨å•å­—æ®µå ä½ç¬¦å¤±è´¥:', error)
        }
    }

    /**
     * å°†æ ‡ç­¾è½¬æ¢ä¸ºå ä½ç¬¦æ ¼å¼
     */
    private labelToPlaceholder(label: string): string {
        // ğŸ”¥ ä¿®å¤ï¼šä¿æŒä¸­æ–‡çš„åŸå§‹å¤§å°å†™ï¼Œåªå¯¹è‹±æ–‡è¿›è¡Œå°å†™è½¬æ¢
        return label
            .replace(/[^\u4e00-\u9fa5a-zA-Z0-9]/g, '')  // åªä¿ç•™ä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—
            .replace(/[a-zA-Z]/g, (match) => match.toLowerCase())  // åªå¯¹è‹±æ–‡å­—æ¯è½¬å°å†™ï¼Œä¿æŒä¸­æ–‡ä¸å˜
    }

    /**
     * æ ¼å¼åŒ–å­—æ®µå€¼
     */
    private formatFieldValue(value: any, componentType: string): string {
        if (value === null || value === undefined) {
            return ''
        }

        switch (componentType) {
            case 'checkbox':
                // å¤é€‰æ¡†è¿”å›é€‰ä¸­çš„é€‰é¡¹
                if (Array.isArray(value)) {
                    return value.join(', ')
                }
                return String(value)

            case 'upload':
                // æ–‡ä»¶ä¸Šä¼ è¿”å›æ–‡ä»¶ååˆ—è¡¨
                if (Array.isArray(value)) {
                    return value.map(file => {
                        if (file && typeof file === 'object') {
                            const fileName = file.name || file.originalname || 'æœªçŸ¥æ–‡ä»¶'
                            const fileSize = file.size ? ` (${(file.size / 1024 / 1024).toFixed(2)}MB)` : ''
                            return `${fileName}${fileSize}`
                        }
                        return String(file)
                    }).join('ã€')
                }
                return String(value)

            case 'date':
                // æ—¥æœŸæ ¼å¼åŒ–
                if (value instanceof Date) {
                    return value.toLocaleDateString('zh-CN')
                }
                return String(value)

            case 'amount':
                // é‡‘é¢æ ¼å¼åŒ–
                if (typeof value === 'number') {
                    return `Â¥${value.toFixed(2)}`
                }
                return String(value)



            case 'order':
                // è®¢å•æ ¼å¼åŒ– - ç”ŸæˆHTMLè¡¨æ ¼
                if (Array.isArray(value)) {
                    if (value.length === 0) {
                        return 'æš‚æ— è®¢å•é¡¹';
                    }

                    // ç”ŸæˆHTMLè¡¨æ ¼
                    let tableHtml = `
<table style="width: 100%; border-collapse: collapse; margin: 16px 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <thead>
        <tr style="background-color: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
            <th style="padding: 12px 8px; text-align: left; border: 1px solid #e0e0e0; font-weight: 500; color: #333;">åºå·</th>
            <th style="padding: 12px 8px; text-align: left; border: 1px solid #e0e0e0; font-weight: 500; color: #333;">æœåŠ¡åç§°</th>
            <th style="padding: 12px 8px; text-align: left; border: 1px solid #e0e0e0; font-weight: 500; color: #333;">åˆ†ç±»</th>
            <th style="padding: 12px 8px; text-align: right; border: 1px solid #e0e0e0; font-weight: 500; color: #333;">å•ä»·</th>
            <th style="padding: 12px 8px; text-align: center; border: 1px solid #e0e0e0; font-weight: 500; color: #333;">æ•°é‡</th>
            <th style="padding: 12px 8px; text-align: right; border: 1px solid #e0e0e0; font-weight: 500; color: #333;">å°è®¡</th>
        </tr>
    </thead>
    <tbody>`;

                    let totalAmount = 0;

                    value.forEach((item, index) => {
                        if (item && typeof item === 'object') {
                            const serviceName = item.æœåŠ¡åç§° || item.serviceName || 'æœªçŸ¥æœåŠ¡';
                            const category = item.åˆ†ç±» || item.categoryName || 'æœªåˆ†ç±»';
                            const unitPrice = item.å•ä»· || item.unitPrice || 0;
                            const quantity = item.æ•°é‡ || item.quantity || 0;
                            const unit = item.å•ä½ || item.unit || 'é¡¹';
                            const subtotal = item.å°è®¡ || item.subtotal || 0;

                            totalAmount += parseFloat(subtotal) || 0;

                            // è¡Œæ ·å¼ - äº¤æ›¿èƒŒæ™¯è‰²
                            const rowBg = index % 2 === 0 ? '#ffffff' : '#fafafa';

                            tableHtml += `
        <tr style="background-color: ${rowBg};">
            <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #666;">${index + 1}</td>
            <td style="padding: 10px 8px; border: 1px solid #e0e0e0; color: #333; font-weight: 500;">${serviceName}</td>
            <td style="padding: 10px 8px; border: 1px solid #e0e0e0; color: #666;">${category}</td>
            <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: right; color: #333;">Â¥${parseFloat(unitPrice).toFixed(2)}</td>
            <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: center; color: #333;">${quantity}${unit}</td>
            <td style="padding: 10px 8px; border: 1px solid #e0e0e0; text-align: right; color: #333; font-weight: 500;">Â¥${parseFloat(subtotal).toFixed(2)}</td>
        </tr>`;
                        }
                    });

                    // æ·»åŠ æ€»è®¡è¡Œ
                    tableHtml += `
        <tr style="background-color: #f0f8ff; border-top: 2px solid #1890ff;">
            <td colspan="5" style="padding: 12px 8px; border: 1px solid #e0e0e0; text-align: right; font-weight: 500; color: #333; font-size: 14px;">æ€»è®¡ï¼š</td>
            <td style="padding: 12px 8px; border: 1px solid #e0e0e0; text-align: right; font-weight: 500; color: #1890ff; font-size: 14px;">Â¥${totalAmount.toFixed(2)}</td>
        </tr>
    </tbody>
</table>`;

                    return tableHtml;
                }
                return String(value)

            default:
                // å…¶ä»–ç±»å‹ç›´æ¥è½¬å­—ç¬¦ä¸²
                if (typeof value === 'object') {
                    return JSON.stringify(value)
                }
                return String(value)
        }
    }

    /**
     * åŒ…è£…é‚®ä»¶å†…å®¹åˆ°1200pxå®¹å™¨ä¸­
     */
    private wrapEmailContent(content: string): string {
        return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨å•é€šçŸ¥</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        .email-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background-color: #ffffff; 
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            overflow: hidden;
            margin-top: 40px;
            margin-bottom: 40px;
        }
        .email-content { 
            padding: 60px 80px; 
            line-height: 1.7; 
            color: #333; 
            font-size: 14px;
        }
        

        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .email-container { 
                margin: 20px; 
                border-radius: 12px; 
            }
            .email-content { 
                padding: 40px 32px; 
                font-size: 15px;
            }
        }
        @media (max-width: 480px) {
            .email-container { 
                margin: 10px; 
                border-radius: 8px; 
            }
            .email-content { 
                padding: 24px 20px; 
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="email-content">
            ${content}
        </div>
    </div>
</body>
</html>`;
    }

    /**
* å‡†å¤‡é‚®ä»¶é™„ä»¶
*/
    private async prepareEmailAttachments(data: PlaceholderData, form?: IForm, formData?: IFormData): Promise<any[]> {
        const attachments: any[] = [];

        try {
            console.log('ğŸ” å¼€å§‹å‡†å¤‡é‚®ä»¶é™„ä»¶ï¼Œæ£€æŸ¥åŸå§‹è¡¨å•æ•°æ®');

            // å¦‚æœæœ‰åŸå§‹è¡¨å•æ•°æ®ï¼Œç›´æ¥ä»ä¸­æå–æ–‡ä»¶ä¿¡æ¯
            if (formData && formData.submissionData) {
                console.log('ğŸ” ä»åŸå§‹è¡¨å•æ•°æ®ä¸­æŸ¥æ‰¾æ–‡ä»¶ç»„ä»¶');

                // éå†åŸå§‹æäº¤æ•°æ®
                for (const [componentId, componentData] of Object.entries(formData.submissionData)) {
                    if (componentData && typeof componentData === 'object' && 'type' in componentData) {
                        const { type, value } = componentData as any;

                        console.log(`ğŸ” æ£€æŸ¥ç»„ä»¶ ${componentId} (${type}):`, {
                            type,
                            valueType: typeof value,
                            isArray: Array.isArray(value),
                            length: Array.isArray(value) ? value.length : 'N/A'
                        });

                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ä¸Šä¼ ç»„ä»¶
                        if (type === 'upload' && Array.isArray(value) && value.length > 0) {
                            console.log(`ğŸ“ å‘ç°æ–‡ä»¶ä¸Šä¼ ç»„ä»¶: ${componentId}, æ–‡ä»¶æ•°é‡: ${value.length}`);
                            console.log(`ğŸ“ æ–‡ä»¶æ•°æ®:`, value);

                            // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                            for (const file of value) {
                                try {
                                    const attachment = await this.createEmailAttachment(file);
                                    if (attachment) {
                                        attachments.push(attachment);
                                    }
                                } catch (error) {
                                    console.error(`å¤„ç†æ–‡ä»¶é™„ä»¶å¤±è´¥: ${file.name || 'unknown'}`, error);
                                    // ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶ï¼Œä¸å› ä¸ºä¸€ä¸ªæ–‡ä»¶å¤±è´¥è€Œåœæ­¢
                                }
                            }
                        }
                    }
                }
            } else {
                console.log('ğŸ” åŸå§‹è¡¨å•æ•°æ®ä¸å¯ç”¨ï¼Œå›é€€åˆ°å ä½ç¬¦æ•°æ®æ£€æŸ¥');

                // å›é€€åˆ°åŸæ¥çš„é€»è¾‘ï¼ˆæ£€æŸ¥å ä½ç¬¦æ•°æ®ï¼‰
                for (const [key, value] of Object.entries(data)) {
                    if (Array.isArray(value) && value.length > 0) {
                        const firstItem = value[0];
                        if (firstItem && typeof firstItem === 'object' && firstItem.name && firstItem.size && firstItem.url) {
                            console.log(`ğŸ“ å‘ç°æ–‡ä»¶ä¸Šä¼ å­—æ®µ: ${key}, æ–‡ä»¶æ•°é‡: ${value.length}`);

                            for (const file of value) {
                                try {
                                    const attachment = await this.createEmailAttachment(file);
                                    if (attachment) {
                                        attachments.push(attachment);
                                    }
                                } catch (error) {
                                    console.error(`å¤„ç†æ–‡ä»¶é™„ä»¶å¤±è´¥: ${file.name}`, error);
                                }
                            }
                        }
                    }
                }
            }

            if (attachments.length > 0) {
                console.log(`âœ… æˆåŠŸå‡†å¤‡ ${attachments.length} ä¸ªé‚®ä»¶é™„ä»¶`);
            }

        } catch (error) {
            console.error('å‡†å¤‡é‚®ä»¶é™„ä»¶æ—¶å‡ºé”™:', error);
            // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå…è®¸é‚®ä»¶å‘é€ç»§ç»­è¿›è¡Œï¼Œå³ä½¿æ²¡æœ‰é™„ä»¶
        }

        return attachments;
    }

    /**
     * åˆ›å»ºå•ä¸ªé‚®ä»¶é™„ä»¶
     */
    private async createEmailAttachment(fileData: any): Promise<any | null> {
        try {
            const fileName = fileData.name || fileData.originalname;
            // æ–‡ä»¶URLå¯èƒ½åœ¨ä¸åŒçš„ä½ç½®ï¼Œä¼˜å…ˆæ£€æŸ¥response.data.url
            const fileUrl = fileData.url || (fileData.response && fileData.response.data && fileData.response.data.url);

            console.log('ğŸ” åˆ›å»ºé‚®ä»¶é™„ä»¶ - æ–‡ä»¶ä¿¡æ¯:', {
                fileName,
                fileUrl,
                hasResponse: !!fileData.response,
                responseData: fileData.response?.data
            });

            if (!fileName || !fileUrl) {
                console.warn('æ–‡ä»¶ä¿¡æ¯ä¸å®Œæ•´ï¼Œè·³è¿‡:', {
                    fileName,
                    fileUrl,
                    fileData: JSON.stringify(fileData, null, 2)
                });
                return null;
            }

            // ä»URLæ„å»ºæ–‡ä»¶è·¯å¾„
            // URLæ ¼å¼é€šå¸¸æ˜¯: /uploads/forms/general/filename æˆ– /uploads/forms/{formId}/filename
            const relativePath = fileUrl.startsWith('/') ? fileUrl.substring(1) : fileUrl;
            const filePath = path.join(__dirname, '../../', relativePath);

            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if (!fs.existsSync(filePath)) {
                console.warn(`æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: ${filePath}`);
                return null;
            }

            // è·å–æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
            const stats = fs.statSync(filePath);
            if (!stats.isFile()) {
                console.warn(`è·¯å¾„ä¸æ˜¯æ–‡ä»¶ï¼Œè·³è¿‡: ${filePath}`);
                return null;
            }

            console.log(`ğŸ“ å‡†å¤‡é™„ä»¶: ${fileName} (${(stats.size / 1024 / 1024).toFixed(2)}MB)`);

            // åˆ›å»ºnodemaileré™„ä»¶å¯¹è±¡
            return {
                filename: fileName,
                path: filePath,
                cid: `attachment_${Date.now()}_${Math.random().toString(36).substring(7)}` // å¯é€‰çš„Content-ID
            };

        } catch (error) {
            console.error('åˆ›å»ºé‚®ä»¶é™„ä»¶å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * æ›¿æ¢å ä½ç¬¦
     */
    private replacePlaceholders(template: string, data: PlaceholderData): string {
        console.log('ğŸ” å ä½ç¬¦æ›¿æ¢å¼€å§‹ - æ¨¡æ¿å†…å®¹:', template)
        console.log('ğŸ” å ä½ç¬¦æ›¿æ¢ - å¯ç”¨æ•°æ®:', data)

        let result = template

        // æ›¿æ¢æ‰€æœ‰å ä½ç¬¦ {key}
        for (const [key, value] of Object.entries(data)) {
            const placeholder = `{${key}}`
            const replacement = String(value || '')

            // æ£€æŸ¥æ¨¡æ¿ä¸­æ˜¯å¦åŒ…å«è¿™ä¸ªå ä½ç¬¦
            if (template.includes(placeholder)) {
                console.log(`âœ… å ä½ç¬¦æ›¿æ¢: "${placeholder}" -> "${replacement}"`)
                result = result.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), replacement)
            }
        }

        console.log('ğŸ” å ä½ç¬¦æ›¿æ¢ç»“æœ:', result)
        return result
    }

    /**
     * è·å–æ”¶ä»¶äººé‚®ç®±åˆ—è¡¨
     */
    private async getRecipients(template: NotificationTemplate, submitterInfo?: any): Promise<string[]> {
        const recipients: string[] = []

        switch (template.to) {
            case 'admin':
                try {
                    // ä»é‚®ä»¶è®¾ç½®ä¸­è·å–ç®¡ç†å‘˜é‚®ç®±
                    const emailSetting = await EmailSettingService.getEmailSetting()
                    console.log('è·å–åˆ°çš„é‚®ä»¶è®¾ç½®:', {
                        senderEmail: emailSetting?.senderEmail,
                        replyEmail: emailSetting?.replyEmail,
                        senderName: emailSetting?.senderName
                    })
                    if (emailSetting?.senderEmail) {
                        recipients.push(emailSetting.senderEmail)
                        console.log(`ä½¿ç”¨ç³»ç»Ÿé…ç½®çš„å‘ä»¶äººé‚®ç®±ä½œä¸ºç®¡ç†å‘˜é‚®ç®±: ${emailSetting.senderEmail}`)
                    }
                } catch (error) {
                    console.error('è·å–é‚®ä»¶è®¾ç½®å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç¯å¢ƒå˜é‡:', error)
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
                    const adminEmail = process.env.ADMIN_EMAIL
                    if (adminEmail) {
                        recipients.push(adminEmail)
                        console.log(`ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å‘˜é‚®ç®±: ${adminEmail}`)
                    }
                }
                break

            case 'submitter':
                const submitterEmail = submitterInfo?.email
                if (submitterEmail) {
                    recipients.push(submitterEmail)
                }
                break

            case 'custom':
                if (template.customEmails) {
                    const emails = template.customEmails
                        .split(',')
                        .map(email => email.trim())
                        .filter(email => this.isValidEmail(email))
                    recipients.push(...emails)
                }
                break
        }

        return recipients
    }

    /**
     * éªŒè¯é‚®ç®±æ ¼å¼
     */
    private isValidEmail(email: string): boolean {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        return emailRegex.test(email)
    }

    /**
     * æµ‹è¯•å‘é€é€šçŸ¥æ¨¡æ¿
     */
    async testNotificationTemplate(
        templateId: string,
        formId: string,
        testEmail: string
    ): Promise<void> {
        try {
            const form = await formService.getFormById(formId)
            if (!form) {
                throw new Error('è¡¨å•ä¸å­˜åœ¨')
            }

            const template = form.settings?.notification?.templates?.find(
                t => t.id === templateId
            )
            if (!template) {
                throw new Error('é€šçŸ¥æ¨¡æ¿ä¸å­˜åœ¨')
            }

            // æ„å»ºæµ‹è¯•å ä½ç¬¦æ•°æ®
            const testPlaceholderData: PlaceholderData = {
                form_title: form.name,
                form_description: form.description || '',
                submission_id: 'TEST_SUBMISSION_ID',
                submission_date: new Date().toLocaleDateString('zh-CN'),
                submission_time: new Date().toLocaleTimeString('zh-CN'),
                submitter_name: 'æµ‹è¯•ç”¨æˆ·',
                submitter_email: testEmail,
                submitter_ip: '192.168.1.100',
                admin_email: process.env.ADMIN_EMAIL || '',
                site_title: process.env.SITE_TITLE || 'è¡¨å•ç³»ç»Ÿ',
                site_url: process.env.SITE_URL || 'http://localhost:3000',
                // æ·»åŠ ä¸€äº›ç¤ºä¾‹å­—æ®µæ•°æ®
                'å§“å': 'å¼ ä¸‰',
                'ç”µè¯': '13800138000',
                'é‚®ç®±': testEmail,
                'å…¬å¸': 'æµ‹è¯•å…¬å¸'
            }

            // æ›¿æ¢å ä½ç¬¦
            const subject = this.replacePlaceholders(template.subject, testPlaceholderData)
            const content = this.replacePlaceholders(template.content, testPlaceholderData)

            // å‘é€æµ‹è¯•é‚®ä»¶
            await EmailSettingService.sendEmail(testEmail, `[æµ‹è¯•] ${subject}`, content, true)

        } catch (error) {
            console.error('æµ‹è¯•é‚®ä»¶å‘é€å¤±è´¥:', error)
            throw error
        }
    }
}

export default new FormNotificationService()
